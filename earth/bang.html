<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>UPlanet ORIGIN - Une Expérience Interactive et Ẑen</title>
    <script src="/ipfs/QmaksH4EXYK3Hyw8Sn6tF5BcZY8Cx89WqUdezw3Ai9Npqu/p5.min.js"></script>
    <style>
        :root {
            --bg-color: #0c0a14;
            --text-color: #e0e0e0;
            --primary-color: #00d4ff;
            --influence-color: #ff1a4d;
            --synthesis-color: #ffffff;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-color);
            color: var(--text-color); font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow-x: hidden;
        }
        #app-container { display: flex; width: 100%; height: 100%; flex-direction: column-reverse; }
        @media (min-width: 768px) { #app-container { flex-direction: row; } }

        #side-panel {
            width: 100%; height: 40%;
            background-color: rgba(10, 10, 20, 0.9); backdrop-filter: blur(8px);
            padding: 1.5em; box-sizing: border-box; overflow-y: auto;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.5s ease-in-out; cursor: default;
        }
        @media (min-width: 768px) { #side-panel { width: 400px; height: 100%; border-right: 1px solid rgba(0, 212, 255, 0.2); } }
        #side-panel.hidden { transform: translateX(-110%); }

        #explanation-content h1 { color: var(--primary-color); font-weight: 500; font-size: 1.5em; margin-bottom: 1em; cursor: pointer; position: relative;}
        #explanation-content p { font-size: 1em; line-height: 1.7; font-weight: 300; }
        b, strong { color: var(--primary-color); font-weight: 500;}
        pre { font-family: 'Courier New', monospace; background-color: rgba(0,0,0,0.2); padding: 0.5em; border-radius: 5px; opacity: 0.8; }

        #nav-controls { transition: max-height 0.5s ease-in-out, opacity 0.5s; }
        .slider-group { margin-top: 1.5em; }
        .slider-group label { display: block; margin-bottom: 0.5em; font-size: 0.9em; opacity: 0.8; }
        .slider { width: 100%; -webkit-appearance: none; appearance: none; background: transparent; }
        .slider::-webkit-slider-runnable-track { height: 5px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -10px; width: 25px; height: 25px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 3px solid var(--bg-color); }

        #chapter-nav-buttons { display: flex; justify-content: space-between; margin-top: 1.5em;}
        .nav-button { padding: 10px 20px; background-color: #333; color: #fff; border: 1px solid #555; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .nav-button:hover:not(:disabled) { background-color: #444; }
        .nav-button:disabled { opacity: 0.4; cursor: not-allowed; }

        #main-content { flex-grow: 1; height: 60%; position: relative; }
        @media (min-width: 768px) { #main-content { height: 100%; } }
        #p5-canvas-container { width: 100%; height: 100%; cursor: crosshair; }
        
        @media (max-width: 767px) {
            #nav-controls {
                max-height: 500px !important;
                opacity: 1 !important;
                overflow: visible !important;
                transition: none;
            }
            #explanation-content h1::after { display: none; }
        }

        #final-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; z-index: 200; padding: 2em; box-sizing: border-box; cursor: default;
        }
        #final-screen img { max-width: 250px; margin-bottom: 2em; animation: float 6s ease-in-out infinite; }
        @media (min-width: 768px) { #final-screen img { max-width: 300px; } }
        #final-screen h1 { font-size: 2em; color: var(--primary-color); }
        @media (min-width: 768px) { #final-screen h1 { font-size: 2.5em; } }
        #final-screen p { font-size: 1.1em; max-width: 600px; }
        @media (min-width: 768px) { #final-screen p { font-size: 1.2em; } }
        .cta-button {
            display: inline-block; margin-top: 20px; padding: 15px 30px;
            background: linear-gradient(45deg, var(--primary-color), #33ff99);
            color: #0d0d1a; text-decoration: none; font-weight: bold;
            border-radius: 5px; transition: all 0.3s; cursor: pointer;
        }
        .cta-button:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--primary-color); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }

        #header-controls {
            width: 100vw;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            background: rgba(10,10,20,0.95);
            padding: 0.5em 1em;
            box-sizing: border-box;
            position: fixed;
            top: 0; left: 0; z-index: 100;
        }
        #speed-group, #chapter-group {
            display: flex;
            align-items: center;
        }
        #chapter-group label {
            margin: 0 0.5em;
        }
        #app-container { margin-top: 60px; }
        @media (max-width: 767px) {
            #header-controls { flex-direction: column; align-items: stretch; gap: 0.5em; }
            #app-container { margin-top: 110px; flex-direction: column-reverse; height: calc(100vh - 110px); }
            #side-panel {
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100vw;
                height: 38vh;
                min-height: 120px;
                max-height: 50vh;
                overflow-y: auto;
                padding-bottom: 1em;
                z-index: 101;
                border-top: 1px solid rgba(0,212,255,0.2);
                border-right: none;
                background-color: rgba(10, 10, 20, 0.97);
            }
            #main-content {
                height: 62vh;
                min-height: 200px;
            }
        }
        /* Hide old nav-controls in side-panel */
        #side-panel #nav-controls { display: none !important; }
    </style>
</head>
<body>
    <!-- HEADER CONTROLS -->
    <div id="header-controls">
        <div class="slider-group" id="speed-group">
            <label for="speed-slider">Vitesse du Flux</label>
            <input type="range" min="0.1" max="3" value="1" step="0.1" id="speed-slider" class="slider">
        </div>
    </div>
    <div id="app-container">
        <div id="side-panel">
            <div id="explanation-content">
                <h1></h1>
                <div id="story-nav-buttons" style="display:flex;align-items:center;justify-content:space-between;margin:1em 0 1.5em 0;gap:0.5em;">
                    <button class="nav-button" id="prev-chapter">Précédent</button>
                    <label for="chapter-slider" style="margin:0 0.5em;">Chapitres</label>
                    <input type="range" min="0" max="4" value="0" id="chapter-slider" class="slider" style="width:90px;display:inline-block;vertical-align:middle;">
                    <button class="nav-button" id="next-chapter">Suivant</button>
                </div>
                <p></p>
            </div>
            <!-- Remove nav-controls from here, only keep story navigation -->
        </div>
        <div id="main-content">
            <div id="p5-canvas-container"></div>
        </div>
    </div>
    <div id="final-screen">
        <img src="/ipfs/QmagEQC8KJUsjuDXbcuWHxmA8vwRF9y9d6LGtc3iSEqZE2/uplanet.png" alt="Logo UPlanet" id="final-logo">
        <h1>Découvrez la Sérénité Numérique</h1>
        <a href="welcome.html" class="cta-button">Créez un MULTIPASS</a>
        <p id="final-text"></p>
    </div>

    <script>
    const sketch = (p) => {
        const explanationH1 = document.querySelector('#explanation-content h1');
        const explanationP = document.querySelector('#explanation-content p');
        const chapterSlider = document.getElementById('chapter-slider');
        const speedSlider = document.getElementById('speed-slider');
        const prevButton = document.getElementById('prev-chapter');
        const nextButton = document.getElementById('next-chapter');
        const finalScreen = document.getElementById('final-screen');
        const finalTextBox = document.getElementById('final-text');
        const sidePanel = document.getElementById('side-panel');
        const explanationContent = document.getElementById('explanation-content');
        
        let particles = [], vectors = [];
        let colorIndex = 0, currentChapterIndex = 0;
        let speedMultiplier = 1;
        let web2ClickCount = 0;

        const PLAYER_COLORS = ['#00ffdd', '#ff00ff', '#ffff00', '#ff9900', '#00d4ff', '#ff5733', '#c70039'];
        const chapters = [
            { title: "L’Étincelle Originelle", mode: 'INTRO', text: "Tout commence par une étincelle. Dans l’obscurité numérique, une première idée jaillit. Elle ne connaît ni frontières ni règles, mais elle cherche à se connecter. <strong>Vous êtes le détonateur.</strong> Observez comment, d’un simple geste, naît une constellation d’informations." },
            { title: "Le Réseau Humain", mode: 'N1', text: "<strong>(~1500 - 1980)</strong> Avant les machines, le réseau, c’était nous. Les idées voyageaient de bouche à oreille, de cœur à cœur. Chaque transmission était un acte de confiance, une chaîne fragile mais authentique. Ici, chaque interaction est précieuse, chaque relais est un choix humain." },
            { title: "L’Ère du Bruit", mode: 'WEB2', text: "<strong>(~1980 - Aujourd'hui)</strong> Puis vint l’ère du haut-parleur. Les idées se déversent en masse, saturant l’espace. Le plus bruyant domine, le subtil s’efface. Dans ce tumulte, vos propres idées luttent pour exister. <strong>Saurez-vous faire entendre votre voix</strong> sans vous perdre dans le bruit ?" },
            { title: "L’Intelligence Collective", mode: 'WEB3', text: "<strong>(Demain ?)</strong> La sérénité et le calme reviennent. Ici, chaque rencontre est une conversation. Les idées fusionnent, s’enrichissent, évoluent. La diversité devient force, la synthèse, une nouvelle lumière. Vous n’êtes plus seul : chaque interaction <strong>construit une intelligence collective</strong>, un réseau vivant." },
            { title: "Devenir Souverain Numérique", mode: 'FINAL', text: "Vous avez traversé les âges du réseau. Maintenant, le futur vous appartient. Devenez souverain numérique : créez votre MULTIPASS sur UPlanet, invitez vos amis, bâtissez votre constellation informative. Chaque invitation est une graine d’avenir, chaque conversation, une brique du monde à venir." }
        ];

        p.setup = () => {
            const canvasContainer = document.getElementById('p5-canvas-container');
            let cnv = p.createCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            cnv.parent(canvasContainer);
            
            chapterSlider.max = chapters.length - 1;
            chapterSlider.addEventListener('input', () => setChapter(parseInt(chapterSlider.value)));
            speedSlider.addEventListener('input', () => speedMultiplier = parseFloat(speedSlider.value));
            prevButton.addEventListener('click', () => setChapter(currentChapterIndex - 1));
            nextButton.addEventListener('click', () => setChapter(currentChapterIndex + 1));
            explanationH1.addEventListener('click', () => { explanationContent.classList.toggle('active'); });
            
            setChapter(0);
        };

        p.draw = () => {
            if (chapters[currentChapterIndex].mode === 'FINAL') {
                p.background(12, 10, 20); return;
            }
            p.background(12, 10, 20, 150);
            let dt = p.deltaTime / 1000 * speedMultiplier;

            vectors.forEach(v => {
                v.update(dt, particles);
                v.show();
            });
            vectors = vectors.filter(v => v.life > 0);

            particles.forEach(part => part.show(dt));
        };

        function setChapter(index) {
            if (index < 0 || index >= chapters.length) return;
            currentChapterIndex = index;
            chapterSlider.value = index;
            const chapter = chapters[index];
            
            prevButton.disabled = (index === 0);
            nextButton.disabled = (index === chapters.length - 1);
            
            if (chapter.mode === 'FINAL') {
                sidePanel.classList.add('hidden');
                finalScreen.style.display = 'flex';
                finalTextBox.innerHTML = chapter.text;
            } else {
                sidePanel.classList.remove('hidden');
                finalScreen.style.display = 'none';
                explanationH1.textContent = chapter.title;
                explanationP.innerHTML = chapter.text;
            }
            resetSimulation();
        }

        function resetSimulation() {
            vectors = []; colorIndex = 0; web2ClickCount = 0;
            p.background(12, 10, 20);
            initParticles();
        }

        function initParticles() {
            particles = [];
            let numParticles = (p.width * p.height) / 800;
            if (numParticles > 2000) numParticles = 2000;
            for (let i = 0; i < numParticles; i++) {
                particles.push(new Particle(p, p.random(p.width), p.random(p.height)));
            }
        }

        p.windowResized = () => {
            const canvasContainer = document.getElementById('p5-canvas-container');
            p.resizeCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            resetSimulation();
        };

        p.mousePressed = () => {
            if (p.mouseX < 0 || p.mouseX > p.width || p.mouseY < 0 || p.mouseY > p.height) return;
            const mode = chapters[currentChapterIndex].mode;
            if (mode === 'FINAL') return;

            const color = PLAYER_COLORS[colorIndex % PLAYER_COLORS.length];
            
            switch (mode) {
                case 'INTRO': vectors.push(new Vector(p, p.mouseX, p.mouseY, 'INTRO', 'var(--synthesis-color)')); break;
                case 'N1': vectors.push(new Vector(p, p.mouseX, p.mouseY, 'N1', color)); colorIndex++; break;
                case 'WEB2':
                    if (web2ClickCount === 0) {
                        for (let i = 0; i < 20; i++) { vectors.push(new Vector(p, p.mouseX, p.mouseY, 'influence', 'var(--influence-color)')); }
                    } else {
                        vectors.push(new Vector(p, p.mouseX, p.mouseY, 'user_web2', color));
                        colorIndex++;
                    }
                    web2ClickCount++;
                    break;
                case 'WEB3': vectors.push(new Vector(p, p.mouseX, p.mouseY, 'WEB3', color)); colorIndex++; break;
            }
        };

        class Particle {
            constructor(p, x, y) {
                this.p = p; this.pos = p.createVector(x, y);
                this.baseColor = p.color(25, 20, 40);
                this.color = p.color(25, 20, 40);
                this.glow = 0;
            }

            applyColor(vector) {
                this.glow = 20;
                if (vector.type === 'influence' || (vector.type === 'influence_relay')) {
                    this.color = vector.color; // Red overwrites everything
                } else { // Additive for all other types
                    let r = p.min(255, this.color.levels[0] + vector.color.levels[0] * 0.5);
                    let g = p.min(255, this.color.levels[1] + vector.color.levels[1] * 0.5);
                    let b = p.min(255, this.color.levels[2] + vector.color.levels[2] * 0.5);
                    this.color.setRed(r); this.color.setGreen(g); this.color.setBlue(b);
                }
            }
            
            isBaseColor() {
                const c = this.color.levels; const b = this.baseColor.levels;
                return Math.abs(c[0] - b[0]) < 1 && Math.abs(c[1] - b[1]) < 1 && Math.abs(c[2] - b[2]) < 1;
            }
            isRed() { return (this.color.levels[0] > 200 && this.color.levels[1] < 50); }

            show(dt) {
                this.glow = p.lerp(this.glow, 0, dt * 5);
                
                // Autonomous Re-emission Logic
                const mode = chapters[currentChapterIndex].mode;
                if (!this.isBaseColor() && mode !== 'N0' && p.random() < 0.001) {
                    let type, color = this.color;
                    switch(mode) {
                        case 'INTRO': type = 'INTRO_RELAY'; break;
                        case 'N1': type = 'N1'; break;
                        case 'WEB2': type = this.isRed() ? 'influence' : 'user_web2'; break;
                        case 'WEB3': type = 'WEB3'; break;
                    }
                    if (type) vectors.push(new Vector(this.p, this.pos.x, this.pos.y, type, color));
                }
                
                this.p.noStroke(); this.p.fill(this.color);
                if (this.glow > 1) { this.p.drawingContext.shadowBlur = this.glow; this.p.drawingContext.shadowColor = this.color.toString(); }
                this.p.ellipse(this.pos.x, this.pos.y, 4, 4);
                this.p.drawingContext.shadowBlur = 0;
            }
        }

        class Vector {
            constructor(p, x, y, type, color) {
                this.p = p; this.pos = p.createVector(x, y); this.type = type;
                this.color = (typeof color === 'string') ? p.color(color.startsWith('var') ? getComputedStyle(document.documentElement).getPropertyValue(color.match(/--[a-z-]+/)[0]).trim() : color) : p.color(color.levels[0], color.levels[1], color.levels[2]);
                this.life = 5; let angle = p.random(p.TWO_PI);
                
                switch (type) {
                    case 'INTRO': this.vel = p5.Vector.fromAngle(angle, 180); this.maxInteractions = 9999; this.life = 9999; break;
                    case 'INTRO_RELAY': this.vel = p5.Vector.fromAngle(angle, 180); this.maxInteractions = 9999; this.life = 20; break;
                    case 'N0': this.vel = p5.Vector.fromAngle(angle, 150); this.maxInteractions = 1; break;
                    case 'N1': this.vel = p5.Vector.fromAngle(angle, 200); this.maxInteractions = 2; break;
                    case 'influence': this.vel = p5.Vector.fromAngle(angle, p.random(300, 450)); this.maxInteractions = 7; this.life = 10; break;
                    case 'user_web2': this.vel = p5.Vector.fromAngle(angle, 250); this.maxInteractions = 2; this.life = 3; break;
                    case 'WEB3': this.vel = p5.Vector.fromAngle(angle, p.random(200, 250)); this.maxInteractions = 4; break;
                }
                this.interactions = 0; this.history = []; this.lastParticleHit = null;
            }

            update(dt, particles) {
                this.pos.add(p5.Vector.mult(this.vel, dt));
                this.life -= dt;
                this.history.push(this.pos.copy());
                if(this.history.length > 20) this.history.splice(0,1);
                
                if(this.interactions >= this.maxInteractions) { this.life = 0; }

                if (this.pos.x <= 0 || this.pos.x >= p.width) { this.vel.x *= -1; if(this.type === 'influence') this.interactions++;}
                if (this.pos.y <= 0 || this.pos.y >= p.height) { this.vel.y *= -1; if(this.type === 'influence') this.interactions++;}
                
                for (let particle of particles) {
                    if (particle !== this.lastParticleHit && this.p.dist(this.pos.x, this.pos.y, particle.pos.x, particle.pos.y) < 15) {
                        particle.applyColor(this);
                        this.lastParticleHit = particle;
                        if(this.type !== 'influence') this.interactions++;
                        
                        let deflect = p5.Vector.sub(this.pos, particle.pos);
                        this.vel.reflect(deflect); this.vel.rotate(p.random(-0.5, 0.5));
                        
                        if (this.type === 'WEB3' || this.type === 'INTRO' || this.type === 'INTRO_RELAY') { this.color = p.lerpColor(this.color, particle.color, 0.5); }
                        return;
                    }
                }
            }

            show() {
                this.p.noFill(); this.p.stroke(this.color); this.p.strokeWeight(1.5);
                this.p.beginShape();
                for (let v of this.history) { this.p.vertex(v.x, v.y); }
                this.p.endShape();
            }
        }
    };
    new p5(sketch, document.getElementById('p5-canvas-container'));
    // Reload page if logo is clicked in final screen
    document.addEventListener('DOMContentLoaded', () => {
        const finalLogo = document.getElementById('final-logo');
        if(finalLogo) {
            finalLogo.addEventListener('click', () => { window.location.reload(); });
            finalLogo.style.cursor = 'pointer';
            finalLogo.title = 'Recharger la page';
        }
    });
    </script>
</body>
</html>