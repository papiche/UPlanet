<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Ã‰diteur Collaboratif - UMAP Commons</title>
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    
    <!-- Nostr integration -->
    <script src="nostr.bundle.js"></script>
    <!-- Common UPlanet JavaScript -->
    <script src="common.js"></script>
    <!-- Markdown parser (local) -->
    <script src="marked.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CSS VARIABLES - Coherent with umap_index.html
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #232d42;
            --bg-editor: #0d1117;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-violet: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a4f;
            --glow-cyan: rgba(6, 182, 212, 0.3);
            --glow-emerald: rgba(16, 185, 129, 0.3);
            --selection: rgba(6, 182, 212, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(6, 182, 212, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FIXED CONNECTION BADGE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .connection-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(10, 15, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            cursor: pointer;
            min-width: 180px;
        }
        
        .connection-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
        }
        
        .connection-badge.authenticated {
            border-color: var(--accent-emerald);
            background: rgba(16, 185, 129, 0.15);
        }
        
        .connection-badge.connected-not-auth {
            border-color: var(--accent-amber);
            background: rgba(245, 158, 11, 0.15);
        }
        
        .connection-badge.disconnected {
            border-color: var(--border-color);
        }
        
        .badge-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 2px solid var(--accent-cyan);
            object-fit: cover;
        }
        
        .badge-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }
        
        .badge-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .badge-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .badge-actions {
            display: flex;
            gap: 6px;
        }
        
        .badge-btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .badge-btn:hover {
            background: var(--bg-card-hover);
            color: var(--accent-cyan);
        }
        
        .badge-btn.primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-emerald));
            color: var(--bg-primary);
        }
        
        /* Badge dropdown panel */
        .badge-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }
        
        .badge-panel.show {
            display: block;
        }
        
        .panel-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .panel-row:last-child {
            border-bottom: none;
        }
        
        .panel-row-icon {
            font-size: 1.2rem;
        }
        
        .panel-row-content {
            flex: 1;
        }
        
        .panel-row-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .panel-row-value {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .panel-row-value a {
            color: var(--accent-cyan);
            text-decoration: none;
        }
        
        .panel-row-value a:hover {
            text-decoration: underline;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .back-link:hover {
            background: var(--bg-card-hover);
            color: var(--accent-cyan);
        }

        .editor-title-input {
            background: transparent;
            border: none;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            width: 350px;
            outline: none;
            font-family: inherit;
        }

        .editor-title-input:focus {
            border-bottom: 2px solid var(--accent-cyan);
        }

        .editor-title-input::placeholder {
            color: var(--text-muted);
        }

        .umap-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(16, 185, 129, 0.2));
            border: 1px solid var(--accent-cyan);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-cyan);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-emerald));
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px var(--glow-cyan);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-cyan);
            background: var(--bg-card-hover);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-rose);
        }

        .status-dot.connected {
            background: var(--accent-emerald);
            box-shadow: 0 0 10px var(--accent-emerald);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           META BAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .editor-meta-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            flex-wrap: wrap;
            gap: 12px;
        }

        .meta-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .version-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-emerald);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .author-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .author-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--accent-cyan);
        }

        .doc-type-selector {
            display: flex;
            gap: 6px;
        }

        .doc-type-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .doc-type-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }

        .doc-type-btn.active {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .collaborators {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collaborator-avatars {
            display: flex;
        }

        .collaborator-avatars img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
            margin-left: -8px;
        }

        .collaborator-avatars img:first-child {
            margin-left: 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN CONTAINER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .editor-container {
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
            min-height: calc(100vh - 140px);
            position: relative;
            z-index: 1;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EDITOR MAIN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .editor-main {
            flex: 1;
            padding: 24px 40px;
            overflow-y: auto;
        }

        .toolbar {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 12px 12px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-cyan);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 6px 8px;
        }

        .editor-wrapper {
            background: var(--bg-editor);
            border: 1px solid var(--border-color);
            border-radius: 0 0 12px 12px;
            min-height: 500px;
            position: relative;
        }

        .editor-wrapper:focus-within {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px var(--glow-cyan);
        }

        /* Split Editor Layout */
        .editor-split {
            display: flex;
            min-height: 500px;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .edit-pane {
            border-right: 1px solid var(--border-color);
        }

        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .pane-toggle {
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            display: none;
        }

        .pane-toggle.active {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        #markdown-editor {
            flex: 1;
            width: 100%;
            padding: 24px;
            background: var(--bg-editor);
            border: none;
            outline: none;
            resize: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
            tab-size: 4;
        }

        #markdown-editor::placeholder {
            color: var(--text-muted);
        }

        #markdown-preview {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        /* Markdown Preview Styling */
        #markdown-preview h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-cyan);
            margin: 1.5em 0 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 2px solid var(--border-color);
        }

        #markdown-preview h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-emerald);
            margin: 1.2em 0 0.4em;
        }

        #markdown-preview h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1em 0 0.3em;
        }

        #markdown-preview p {
            margin: 0.8em 0;
        }

        #markdown-preview code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(6, 182, 212, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--accent-cyan);
        }

        #markdown-preview pre {
            background: #000;
            border-radius: 8px;
            padding: 16px 20px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            margin: 1em 0;
        }

        #markdown-preview pre code {
            background: transparent;
            padding: 0;
            color: #e6edf3;
        }

        #markdown-preview blockquote {
            border-left: 4px solid var(--accent-cyan);
            padding-left: 16px;
            margin: 1em 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        #markdown-preview ul,
        #markdown-preview ol {
            padding-left: 24px;
            margin: 0.8em 0;
        }

        #markdown-preview li {
            margin: 0.3em 0;
        }

        #markdown-preview input[type="checkbox"] {
            margin-right: 8px;
        }

        #markdown-preview a {
            color: var(--accent-cyan);
            text-decoration: none;
            border-bottom: 1px dashed var(--accent-cyan);
        }

        #markdown-preview a:hover {
            border-bottom-style: solid;
        }

        #markdown-preview img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1em 0;
        }

        #markdown-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        #markdown-preview th,
        #markdown-preview td {
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            text-align: left;
        }

        #markdown-preview th {
            background: var(--bg-card);
            font-weight: 600;
        }

        #markdown-preview ::selection {
            background: var(--selection);
        }

        /* Mobile: show toggle buttons */
        @media (max-width: 768px) {
            .editor-split {
                flex-direction: column;
            }
            .edit-pane {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .pane-toggle {
                display: block;
            }
            .editor-pane.hidden {
                display: none;
            }
        }

        #markdown-preview > *:first-child {
            margin-top: 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .editor-sidebar {
            width: 340px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 24px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 28px;
        }

        .sidebar-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Workflow Guide */
        .workflow-steps {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .workflow-step {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .workflow-step:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .workflow-step:first-child {
            padding-top: 0;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .step-number.completed {
            background: var(--accent-emerald);
            color: var(--bg-primary);
        }

        .step-content h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .step-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Proposals */
        .proposal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .proposal-card.pending {
            border-color: var(--accent-amber);
        }

        .proposal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .proposal-author {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .proposal-author img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .proposal-summary {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .proposal-votes {
            display: flex;
            gap: 8px;
        }

        .vote-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .vote-btn.approve {
            background: rgba(34, 197, 94, 0.2);
        }

        .vote-btn.approve:hover {
            background: rgba(34, 197, 94, 0.4);
        }

        .vote-btn.reject {
            background: rgba(239, 68, 68, 0.2);
        }

        .vote-btn.reject:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .vote-btn.fork {
            background: rgba(139, 92, 246, 0.2);
        }

        .vote-btn.fork:hover {
            background: rgba(139, 92, 246, 0.4);
        }

        .vote-count {
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* History */
        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
        }

        .history-action {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Info Panel */
        .info-panel {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODALS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           NOTIFICATIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .notification-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
        }

        .notification-toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
            margin-top: 12px;
        }

        .notification-toast.success {
            border-color: var(--accent-emerald);
        }

        .notification-toast.error {
            border-color: var(--accent-rose);
        }

        .notification-toast.info {
            border-color: var(--accent-cyan);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 1200px) {
            .editor-sidebar {
                width: 300px;
            }
            .editor-main {
                padding: 20px 24px;
            }
        }

        @media (max-width: 900px) {
            .editor-container {
                flex-direction: column;
            }
            .editor-sidebar {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
            .editor-header {
                flex-direction: column;
                gap: 16px;
            }
            .header-left, .header-actions {
                width: 100%;
                justify-content: center;
            }
            .editor-title-input {
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 600px) {
            .toolbar {
                justify-content: center;
            }
            .toolbar-divider {
                display: none;
            }
            #markdown-editor {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FIXED CONNECTION BADGE
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="connection-badge disconnected" id="connection-badge" onclick="toggleBadgePanel()">
        <img class="badge-avatar" id="badge-avatar" src="https://robohash.org/anonymous?set=set4&size=36x36" alt="">
        <div class="badge-info">
            <span class="badge-status" id="badge-status">Non connectÃ©</span>
            <span class="badge-name" id="badge-name">Cliquez pour connecter</span>
        </div>
        <div class="badge-actions">
            <button class="badge-btn primary" id="badge-connect-btn" onclick="event.stopPropagation(); connectNostr()">ğŸ”‘</button>
        </div>
        
        <!-- Dropdown Panel -->
        <div class="badge-panel" id="badge-panel" onclick="event.stopPropagation()">
            <div class="panel-row" id="panel-pubkey-row" style="display: none;">
                <span class="panel-row-icon">ğŸ”‘</span>
                <div class="panel-row-content">
                    <div class="panel-row-label">Public Key</div>
                    <div class="panel-row-value" id="panel-pubkey">...</div>
                </div>
            </div>
            <div class="panel-row" id="panel-udrive-row" style="display: none;">
                <span class="panel-row-icon">ğŸ“</span>
                <div class="panel-row-content">
                    <div class="panel-row-label">uDRIVE</div>
                    <div class="panel-row-value"><a href="#" id="panel-udrive-link" target="_blank">Ouvrir le stockage</a></div>
                </div>
            </div>
            <div class="panel-row" id="panel-wallet-row" style="display: none;">
                <span class="panel-row-icon">ğŸ’°</span>
                <div class="panel-row-content">
                    <div class="panel-row-label">Wallet G1</div>
                    <div class="panel-row-value" id="panel-wallet">...</div>
                </div>
            </div>
            <div class="panel-row" id="panel-auth-row">
                <span class="panel-row-icon" id="panel-auth-icon">âš ï¸</span>
                <div class="panel-row-content">
                    <div class="panel-row-label">Authentification NIP-42</div>
                    <div class="panel-row-value" id="panel-auth-status">Non authentifiÃ©</div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         HEADER
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="editor-header">
        <div class="header-left">
            <a href="plantnet.html" class="back-link">
                â† Retour
            </a>
            <input type="text" class="editor-title-input" id="doc-title" 
                   placeholder="Titre du document..." value="">
            <div class="umap-badge" id="umap-badge">
                <span>ğŸ—ºï¸</span>
                <span id="umap-coords">Chargement...</span>
            </div>
        </div>
        <div class="header-actions">
            <div class="connection-status">
                <span class="status-dot" id="connection-dot"></span>
                <span id="connection-text">Non connectÃ©</span>
            </div>
            <button class="btn btn-secondary" id="btn-connect" onclick="connectNostr()">
                ğŸ”‘ Connexion
            </button>
            <button class="btn btn-secondary" id="btn-load" onclick="openLoadModal()">
                ğŸ“‚ Charger
            </button>
            <button class="btn btn-primary" id="btn-publish" onclick="proposeDocument()" disabled>
                ğŸ“¤ Proposer
            </button>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         META BAR
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="editor-meta-bar">
        <div class="meta-left">
            <span class="version-badge" id="version-badge">Nouveau</span>
            <div class="author-info">
                <span>Auteur:</span>
                <img class="author-avatar" id="author-avatar" src="https://robohash.org/anonymous?set=set4&size=24x24" alt="Author">
                <span id="author-name">Non connectÃ©</span>
            </div>
            <div class="doc-type-selector">
                <button class="doc-type-btn active" data-type="commons" title="RÃ¨gles et ressources partagÃ©es">ğŸ¤ Commun</button>
                <button class="doc-type-btn" data-type="project" title="Projet collectif">ğŸ¯ Projet</button>
                <button class="doc-type-btn" data-type="decision" title="Proposition de dÃ©cision">ğŸ—³ï¸ DÃ©cision</button>
                <button class="doc-type-btn" data-type="garden" title="Plan de jardin">ğŸŒ± Jardin</button>
                <button class="doc-type-btn" data-type="resource" title="Inventaire ressources">ğŸ“¦ Ressource</button>
                <button class="doc-type-btn" data-type="crowdfund" title="Crowdfunding - Acquisition collaborative">ğŸ¡ Crowdfund</button>
            </div>
        </div>
        <div class="collaborators" id="collaborators-section" style="display: none;">
            <span style="color: var(--text-secondary); margin-right: 8px;">Ã‰diteurs:</span>
            <div class="collaborator-avatars" id="collaborator-avatars"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MAIN CONTAINER
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="editor-container">
        <!-- Editor Main -->
        <main class="editor-main">
            <!-- Toolbar -->
            <div class="toolbar">
                <button class="toolbar-btn" data-cmd="bold" title="Gras (Ctrl+B)">ğ</button>
                <button class="toolbar-btn" data-cmd="italic" title="Italique (Ctrl+I)">ğ¼</button>
                <button class="toolbar-btn" data-cmd="strike" title="BarrÃ©">SÌ¶</button>
                <button class="toolbar-btn" data-cmd="code" title="Code">&lt;/&gt;</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-cmd="h1" title="Titre 1">H1</button>
                <button class="toolbar-btn" data-cmd="h2" title="Titre 2">H2</button>
                <button class="toolbar-btn" data-cmd="h3" title="Titre 3">H3</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-cmd="bullet" title="Liste Ã  puces">â€¢</button>
                <button class="toolbar-btn" data-cmd="ordered" title="Liste numÃ©rotÃ©e">1.</button>
                <button class="toolbar-btn" data-cmd="task" title="TÃ¢ches">â˜‘ï¸</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-cmd="quote" title="Citation">â</button>
                <button class="toolbar-btn" data-cmd="link" title="Lien">ğŸ”—</button>
                <button class="toolbar-btn" data-cmd="image" title="Image URL">ğŸ”—ğŸ–¼ï¸</button>
                <label class="toolbar-btn" for="image-upload-input" title="Uploader une image (NIP-42 requis)" style="cursor: pointer;">ğŸ“¤ğŸ–¼ï¸</label>
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <button class="toolbar-btn" data-cmd="table" title="Tableau">âŠ</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" data-cmd="undo" title="Annuler">â†©ï¸</button>
                <button class="toolbar-btn" data-cmd="redo" title="Refaire">â†ªï¸</button>
            </div>

            <!-- Editor - Split view: Edit | Preview -->
            <div class="editor-wrapper">
                <div class="editor-split">
                    <div class="editor-pane edit-pane">
                        <div class="pane-header">
                            <span>ğŸ“ Ã‰dition Markdown</span>
                            <button class="pane-toggle active" data-mode="edit">Ã‰diter</button>
                        </div>
                        <textarea id="markdown-editor" placeholder="Commencez Ã  rÃ©diger votre document collaboratif..."></textarea>
                    </div>
                    <div class="editor-pane preview-pane">
                        <div class="pane-header">
                            <span>ğŸ‘ï¸ AperÃ§u</span>
                            <button class="pane-toggle" data-mode="preview">AperÃ§u</button>
                        </div>
                        <div id="markdown-preview" class="markdown-body"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar -->
        <aside class="editor-sidebar">
            <!-- Workflow Guide -->
            <section class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“‹ Workflow Collaboratif</h3>
                <div class="workflow-steps">
                    <div class="workflow-step">
                        <div class="step-number" id="step-1">1</div>
                        <div class="step-content">
                            <h4>Connexion Nostr</h4>
                            <p>Connectez-vous pour identifier l'auteur du document</p>
                        </div>
                    </div>
                    <div class="workflow-step">
                        <div class="step-number" id="step-2">2</div>
                        <div class="step-content">
                            <h4>RÃ©daction</h4>
                            <p>RÃ©digez ou modifiez le document avec l'Ã©diteur Markdown</p>
                        </div>
                    </div>
                    <div class="workflow-step">
                        <div class="step-number" id="step-3">3</div>
                        <div class="step-content">
                            <h4>Proposition</h4>
                            <p>Soumettez aux Ã©diteurs de l'UMAP pour validation</p>
                        </div>
                    </div>
                    <div class="workflow-step">
                        <div class="step-number" id="step-4">4</div>
                        <div class="step-content">
                            <h4>Validation ou Fork</h4>
                            <p>La communautÃ© valide âœ…, rejette âŒ ou fork ğŸ”€</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pending Proposals -->
            <section class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“ Propositions en attente</h3>
                <div id="proposals-container">
                    <p style="color: var(--text-muted); font-size: 0.85rem;">
                        Connectez-vous pour voir les propositions de cette UMAP
                    </p>
                </div>
            </section>

            <!-- Version History -->
            <section class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“œ Historique</h3>
                <div id="history-container">
                    <p style="color: var(--text-muted); font-size: 0.85rem;">
                        Aucun historique disponible
                    </p>
                </div>
            </section>

            <!-- Document Info -->
            <section class="sidebar-section">
                <h3 class="sidebar-title">â„¹ï¸ Informations</h3>
                <div class="info-panel">
                    <div class="info-row">
                        <span class="info-label">Type</span>
                        <span class="info-value" id="info-type">ğŸ¤ Commun</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Gouvernance</span>
                        <span class="info-value" id="info-governance">MajoritÃ© (2 votes)</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fork</span>
                        <span class="info-value" id="info-fork">AutorisÃ©</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Likes</span>
                        <span class="info-value" id="info-likes">0 â¤ï¸</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">SignÃ© par</span>
                        <span class="info-value" id="info-signer">UMAP</span>
                    </div>
                </div>
            </section>
        </aside>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LOAD DOCUMENT MODAL
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal-overlay" id="load-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“‚ Charger un document</h2>
                <button class="modal-close" onclick="closeLoadModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Documents de cette UMAP</label>
                <div id="umap-documents-list" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: var(--text-muted); font-size: 0.85rem;">Chargement...</p>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Ou charger par ID d'Ã©vÃ©nement Nostr</label>
                <input type="text" class="form-input" id="load-event-id" placeholder="nevent1... ou note1...">
            </div>
            <button class="btn btn-primary" onclick="loadDocumentById()" style="width: 100%;">
                Charger
            </button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PROPOSE MODAL
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal-overlay" id="propose-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“¤ Proposer le document</h2>
                <button class="modal-close" onclick="closeProposeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">RÃ©sumÃ© des modifications</label>
                <textarea class="form-textarea" id="change-summary" placeholder="DÃ©crivez briÃ¨vement vos modifications..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Quorum requis</label>
                <select class="form-select" id="quorum-select">
                    <option value="1">1 validation</option>
                    <option value="2" selected>2 validations (majoritÃ©)</option>
                    <option value="3">3 validations</option>
                    <option value="all">UnanimitÃ©</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Politique de fork</label>
                <select class="form-select" id="fork-policy">
                    <option value="allowed" selected>AutorisÃ©</option>
                    <option value="restricted">Sur rejet seulement</option>
                    <option value="forbidden">Interdit</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="submitProposal()" style="width: 100%;">
                ğŸ“¤ Soumettre la proposition
            </button>
        </div>
    </div>

    <!-- Notifications Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         JAVASCRIPT - Using local marked.js library
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GLOBAL STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.appState = {
            isConnected: false,
            userPubkey: null,
            userNpub: null,
            relay: null,
            umapLat: null,
            umapLon: null,
            umapPubkey: null,  // UMAP's Nostr pubkey (hex) for document tagging
            currentDocId: null,
            currentDocEvent: null,
            docType: 'commons',
            markdown: ''
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', () => {
            // Configure marked.js
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    gfm: true,
                    breaks: true,
                    tables: true
                });
            }
            
            // Parse URL parameters
            const params = new URLSearchParams(window.location.search);
            const rawLat = params.get('lat');
            const rawLon = params.get('lon');
            const rawUmap = params.get('umap');
            
            // Validate UMAP parameters - CRITICAL for document association
            window.appState.umapLat = rawLat || null;
            window.appState.umapLon = rawLon || null;
            window.appState.umapPubkey = rawUmap || null;  // UMAP pubkey (hex)
            window.appState.pendingDocId = params.get('doc') || null;
            
            // Check if UMAP configuration is valid
            const hasValidUmap = rawUmap && rawUmap.length >= 32; // hex pubkey should be 64 chars
            const hasValidCoords = rawLat && rawLon && rawLat !== '_LAT_' && rawLon !== '_LON_';
            window.appState.isUmapConfigured = hasValidUmap && hasValidCoords;
            
            // Warn if UMAP is not properly configured
            if (!window.appState.isUmapConfigured) {
                console.warn('âš ï¸ UMAP not properly configured!');
                console.warn('   - lat:', rawLat || 'MISSING');
                console.warn('   - lon:', rawLon || 'MISSING');
                console.warn('   - umap:', rawUmap ? `${rawUmap.substring(0,8)}... (${rawUmap.length} chars)` : 'MISSING');
                
                // Show warning in UI
                setTimeout(() => {
                    showNotification('âš ï¸ UMAP non configurÃ©e - AccÃ©dez via une page UMAP valide', 'error');
                    document.getElementById('btn-publish').disabled = true;
                    document.getElementById('btn-publish').title = 'Publication dÃ©sactivÃ©e: UMAP non configurÃ©e';
                }, 500);
            }
            
            // Update UMAP badge
            const displayLat = window.appState.umapLat || '???';
            const displayLon = window.appState.umapLon || '???';
            document.getElementById('umap-coords').textContent = 
                window.appState.isUmapConfigured 
                    ? `UMAP ${displayLat}, ${displayLon}`
                    : `âš ï¸ UMAP non configurÃ©e`;
            document.getElementById('info-signer').textContent = 
                window.appState.umapPubkey 
                    ? `UMAP ${window.appState.umapPubkey.substring(0,8)}...`
                    : `âš ï¸ Non dÃ©fini`;
            
            console.log('ğŸ“ UMAP:', displayLat, displayLon);
            console.log('ğŸ”‘ UMAP Pubkey:', window.appState.umapPubkey || 'NOT PROVIDED');
            console.log('âœ… UMAP Configured:', window.appState.isUmapConfigured);
            if (window.appState.pendingDocId) {
                console.log('ğŸ“„ Document to load:', window.appState.pendingDocId);
            }
            
            // Initialize editor
            initEditor();
            
            // Setup document type selector
            setupDocTypeSelector();
            
            // Setup toolbar
            setupToolbar();
            
            // Auto-connect to relay if document ID is provided (for read-only viewing)
            if (window.appState.pendingDocId) {
                autoConnectAndLoadDocument();
            } else {
                // Load saved draft only if no document to load
                loadDraft();
            }
            
            console.log('âœ… Markdown editor initialized (using marked.js)');
        });

        // Auto-connect to relay and load document (for direct links)
        async function autoConnectAndLoadDocument() {
            console.log('ğŸ”„ Auto-connecting to relay to load document...');
            
            try {
                // Connect to relay
                await connectRelay();
                
                // Load the document
                if (window.appState.pendingDocId && window.appState.relay) {
                    await loadDocument(window.appState.pendingDocId);
                    window.appState.pendingDocId = null;
                } else if (window.appState.pendingDocId) {
                    // Retry with fallback if relay not connected
                    console.log('âš ï¸ Relay not connected, retrying...');
                    setTimeout(async () => {
                        await connectRelay();
                        if (window.appState.relay) {
                            await loadDocument(window.appState.pendingDocId);
                        } else {
                            showNotification('Impossible de charger le document - connectez-vous manuellement', 'error');
                        }
                    }, 2000);
                }
            } catch (e) {
                console.error('Auto-connect failed:', e);
                showNotification('Connexion automatique Ã©chouÃ©e - cliquez sur Connexion', 'info');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MARKDOWN EDITOR (Simple split view)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initEditor() {
            const defaultContent = getDefaultContent();
            const editor = document.getElementById('markdown-editor');
            const preview = document.getElementById('markdown-preview');
            
            // Set default content
            editor.value = defaultContent;
            window.appState.markdown = defaultContent;
            updatePreview();
            
            // Live preview on input
            editor.addEventListener('input', () => {
                window.appState.markdown = editor.value;
                updatePreview();
                saveDraft();
            });
            
            // Tab key support
            editor.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 4;
                    window.appState.markdown = editor.value;
                    updatePreview();
                }
            });
        }

        function updatePreview() {
            const preview = document.getElementById('markdown-preview');
            const markdown = window.appState.markdown || '';
            
            if (typeof marked !== 'undefined') {
                preview.innerHTML = marked.parse(markdown);
            } else {
                // Fallback: basic markdown to HTML
                preview.innerHTML = basicMarkdownParse(markdown);
            }
        }

        function basicMarkdownParse(md) {
            return md
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/\n/gim, '<br>');
        }

        function setEditorContent(content) {
            const editor = document.getElementById('markdown-editor');
            editor.value = content;
            window.appState.markdown = content;
            updatePreview();
        }

        function getDefaultContent() {
            const templates = {
                commons: `# DÃ©finition du Commun

## ğŸ¯ Objectif

DÃ©crivez ici l'objectif principal de cette ressource commune.

## ğŸ“‹ RÃ¨gles de Gestion

### AccÃ¨s
- Qui peut accÃ©der Ã  cette ressource ?
- Quelles sont les conditions ?

### Utilisation
- Comment utiliser cette ressource ?
- Quelles sont les limites ?

### Maintenance
- [ ] TÃ¢che de maintenance 1
- [ ] TÃ¢che de maintenance 2

## ğŸ¤ ResponsabilitÃ©s

| RÃ´le | ResponsabilitÃ© | Personne |
|------|----------------|----------|
| Coordinateur | Organiser les rÃ©unions | Ã€ dÃ©finir |
| Mainteneur | Entretien rÃ©gulier | Ã€ dÃ©finir |

## ğŸ“… Calendrier

- **RÃ©union mensuelle**: Premier lundi du mois
- **Bilan annuel**: DÃ©cembre

---

*Document collaboratif de l'UMAP - Likez pour soutenir!*

#UPlanet #commons #collaborative`,

                project: `# Projet Collectif

## ğŸ¯ Vision

Quelle est la vision de ce projet ?

## ğŸ“‹ Objectifs

1. Objectif principal
2. Objectif secondaire

## ğŸ—“ï¸ Planning

### Phase 1 : PrÃ©paration
- [ ] TÃ¢che 1
- [ ] TÃ¢che 2

### Phase 2 : RÃ©alisation
- [ ] TÃ¢che 3
- [ ] TÃ¢che 4

## ğŸ‘¥ Ã‰quipe

| RÃ´le | Personne |
|------|----------|
| Porteur | Ã€ dÃ©finir |
| Contributeurs | Ouverts |

## ğŸ’° Ressources

- Budget estimÃ©: Ã€ dÃ©finir
- Besoins matÃ©riels: Ã€ lister

---

#UPlanet #project #collaborative`,

                decision: `# Proposition de DÃ©cision

## ğŸ“ RÃ©sumÃ©

DÃ©crivez briÃ¨vement la dÃ©cision Ã  prendre.

## ğŸ” Contexte

Pourquoi cette dÃ©cision est-elle nÃ©cessaire ?

## ğŸ¯ Options

### Option A
- Avantages: 
- InconvÃ©nients:

### Option B
- Avantages:
- InconvÃ©nients:

## ğŸ“Š Recommandation

Quelle option est recommandÃ©e et pourquoi ?

## ğŸ—³ï¸ Vote

> Likez ce document pour voter POUR cette dÃ©cision.
> Forkez pour proposer une alternative.

---

#UPlanet #decision #vote`,

                garden: `# Plan de Jardin

## ğŸŒ± Description

DÃ©crivez le jardin et son emplacement.

## ğŸ“‹ Cultures

| LÃ©gume | Surface | PÃ©riode | Responsable |
|--------|---------|---------|-------------|
| Tomates | 10mÂ² | Mars-Sept | Ã€ dÃ©finir |
| Salades | 5mÂ² | Avril-Oct | Ã€ dÃ©finir |

## ğŸ“… Calendrier de Maintenance

- [ ] **Janvier**: PrÃ©paration du sol
- [ ] **Mars**: Semis
- [ ] **Ã‰tÃ©**: Arrosage rÃ©gulier
- [ ] **Automne**: RÃ©colte

## ğŸ’§ SystÃ¨me d'Arrosage

DÃ©crire le systÃ¨me et les responsabilitÃ©s.

## ğŸ¤ Participation

Comment rejoindre ce projet jardin ?

---

#UPlanet #garden #ORE #collaborative`,

                resource: `# Inventaire des Ressources

## ğŸ“¦ Description

Quelle ressource est partagÃ©e ?

## ğŸ“ Localisation

OÃ¹ se trouve cette ressource ?

## ğŸ“‹ Inventaire

| Item | QuantitÃ© | Ã‰tat | DisponibilitÃ© |
|------|----------|------|---------------|
| - | - | - | - |

## ğŸ“ RÃ¨gles d'Emprunt

1. Comment emprunter ?
2. DurÃ©e maximum ?
3. Comment rendre ?

## ğŸ”§ Maintenance

- [ ] VÃ©rification mensuelle
- [ ] Nettoyage aprÃ¨s usage

---

#UPlanet #resource #inventory`,

                crowdfund: `# ğŸŒ³ Nom du Bien - Crowdfunding

## ğŸ“ Localisation

**CoordonnÃ©es**: ${window.appState.umapLat || '___'}, ${window.appState.umapLon || '___'}
**Surface**: ___ hectares (ou mÂ²)

---

## ğŸ¯ PrÃ©sentez votre Bien !

**DÃ©crivez le bien** que vous souhaitez acquÃ©rir collectivement :
- Qu'est-ce que c'est ? (terrain, local, Ã©quipement...)
- OÃ¹ se situe-t-il prÃ©cisÃ©ment ?
- Quelle est sa surface / capacitÃ© ?
- Pourquoi ce bien est important pour la communautÃ© ?

---

## ğŸ’° Montant Total et Parts des PropriÃ©taires

### Indiquez le prix total et la rÃ©partition souhaitÃ©e :

| PropriÃ©taire | Mode | Montant souhaitÃ© | Description |
|--------------|------|------------------|-------------|
| email@exemple.com | ğŸ¤ CAPITAL | 500 áºen | Part transfÃ©rÃ©e aux Communs |
| email2@exemple.com | ğŸ’¶ CASH | 1000â‚¬ | Part Ã  racheter en â‚¬ |

### Explications des modes :

- **ğŸ¤ CAPITAL (Commons)**: Le propriÃ©taire fait don de sa part aux Communs
  - ReÃ§oit des áºen non-convertibles en â‚¬
  - Obtient l'accÃ¨s Ã  tous les lieux du rÃ©seau UPlanet
  - Le bien est gÃ©rÃ© collectivement

- **ğŸ’¶ CASH (â‚¬)**: Le propriÃ©taire souhaite une vente en euros
  - NÃ©cessite une collecte de áºen convertibles
  - Les sociÃ©taires votent pour valider l'utilisation des fonds ASSETS
  - Paiement en â‚¬ via le portefeuille coopÃ©ratif

---

## ğŸ“Š Objectifs de la Collecte

### áºen Ã  collecter (pour parts CASH)

| Objectif | Pour quoi |
|----------|-----------|
| ___ áºen | Rachat des parts CASH (1 áºen = 0.10â‚¬) |

### Don Ä1 complÃ©mentaire (optionnel)

| Objectif | Pour quoi |
|----------|-----------|
| ___ Ä1 | Alimentation du fonds coopÃ©ratif |

---

## â¤ï¸ Comment Soutenir ce Projet ?

### 1. Likez ce document ! 
Un simple like (+1 áºen) montre votre soutien.

### 2. Contribuez en áºen
Via l'interface [Crowdfunding](crowdfunding.html), envoyez des áºen directement au projet.
Plus vous envoyez de áºen, plus vous participez Ã  l'acquisition collective !

### 3. Partagez !
Diffusez ce projet sur vos rÃ©seaux pour mobiliser la communautÃ©.

---

## ğŸ’³ Vous n'avez pas encore de áºen ?

Devenez SociÃ©taire sur [OpenCollective UPlanet](https://opencollective.com/uplanet-zero) :
- ğŸ›¡ï¸ **Satellite**: 54â‚¬/an â†’ 540 áºen
- ğŸŒŸ **Constellation**: 540â‚¬/an â†’ 5400 áºen + accÃ¨s IA

---

## ğŸ—³ï¸ Vote ASSETS

Si le projet contient des parts CASH et que le portefeuille ASSETS peut les couvrir, 
un **vote des sociÃ©taires** sera nÃ©cessaire pour valider l'utilisation des fonds.

Votez en envoyant des áºen avec le tag vote sur l'interface crowdfunding !

---

*Ce document sera transformÃ© en projet crowdfunding lors de la publication.*
*L'identitÃ© NOSTR du Bien sera gÃ©nÃ©rÃ©e automatiquement.*

#UPlanet #crowdfunding #commons`
            };
            
            return templates[window.appState.docType] || templates.commons;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOOLBAR FUNCTIONALITY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setupToolbar() {
            document.querySelectorAll('.toolbar-btn[data-cmd]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const cmd = btn.dataset.cmd;
                    executeToolbarCommand(cmd);
                });
            });
        }

        function executeToolbarCommand(cmd) {
            const editor = document.getElementById('markdown-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selectedText = text.substring(start, end);
            
            let insertion = '';
            let cursorOffset = 0;
            
            switch(cmd) {
                case 'bold':
                    insertion = `**${selectedText || 'texte'}**`;
                    cursorOffset = selectedText ? insertion.length : 2;
                    break;
                case 'italic':
                    insertion = `*${selectedText || 'texte'}*`;
                    cursorOffset = selectedText ? insertion.length : 1;
                    break;
                case 'strike':
                    insertion = `~~${selectedText || 'texte'}~~`;
                    cursorOffset = selectedText ? insertion.length : 2;
                    break;
                case 'code':
                    insertion = selectedText.includes('\n') ? 
                        `\`\`\`\n${selectedText || 'code'}\n\`\`\`` : 
                        `\`${selectedText || 'code'}\``;
                    cursorOffset = selectedText ? insertion.length : 1;
                    break;
                case 'h1':
                    insertion = `# ${selectedText || 'Titre'}`;
                    break;
                case 'h2':
                    insertion = `## ${selectedText || 'Sous-titre'}`;
                    break;
                case 'h3':
                    insertion = `### ${selectedText || 'Section'}`;
                    break;
                case 'bullet':
                    insertion = `- ${selectedText || 'Ã©lÃ©ment'}`;
                    break;
                case 'ordered':
                    insertion = `1. ${selectedText || 'Ã©lÃ©ment'}`;
                    break;
                case 'task':
                    insertion = `- [ ] ${selectedText || 'tÃ¢che'}`;
                    break;
                case 'quote':
                    insertion = `> ${selectedText || 'citation'}`;
                    break;
                case 'link':
                    insertion = `[${selectedText || 'lien'}](url)`;
                    break;
                case 'image':
                    insertion = `![${selectedText || 'image'}](url)`;
                    break;
                case 'table':
                    insertion = `| Col1 | Col2 | Col3 |\n|------|------|------|\n| A | B | C |`;
                    break;
                case 'undo':
                    // Browser handles undo with Ctrl+Z
                    document.execCommand('undo');
                    return;
                case 'redo':
                    document.execCommand('redo');
                    return;
            }
            
            // Insert text
            editor.value = text.substring(0, start) + insertion + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + (cursorOffset || insertion.length);
            editor.focus();
            
            // Update state and preview
            window.appState.markdown = editor.value;
            updatePreview();
            saveDraft();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DOCUMENT TYPE SELECTOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setupDocTypeSelector() {
            const buttons = document.querySelectorAll('.doc-type-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const type = btn.dataset.type;
                    window.appState.docType = type;
                    
                    // Update info panel
                    const typeLabels = {
                        commons: 'ğŸ¤ Commun',
                        project: 'ğŸ¯ Projet',
                        decision: 'ğŸ—³ï¸ DÃ©cision',
                        garden: 'ğŸŒ± Jardin',
                        resource: 'ğŸ“¦ Ressource',
                        crowdfund: 'ğŸ¡ Crowdfund'
                    };
                    document.getElementById('info-type').textContent = typeLabels[type];
                    
                    // Ask to load template if new document
                    if (!window.appState.currentDocId) {
                        if (confirm('Charger le template pour ce type de document ?')) {
                            setEditorContent(getDefaultContent());
                        }
                    }
                });
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONNECTION BADGE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.toggleBadgePanel = function() {
            const panel = document.getElementById('badge-panel');
            panel.classList.toggle('show');
        };
        
        // Close badge panel when clicking outside
        document.addEventListener('click', (e) => {
            const badge = document.getElementById('connection-badge');
            const panel = document.getElementById('badge-panel');
            if (badge && panel && !badge.contains(e.target)) {
                panel.classList.remove('show');
            }
        });
        
        function updateConnectionBadge(state, profile = null) {
            const badge = document.getElementById('connection-badge');
            const avatar = document.getElementById('badge-avatar');
            const status = document.getElementById('badge-status');
            const name = document.getElementById('badge-name');
            const connectBtn = document.getElementById('badge-connect-btn');
            
            badge.className = 'connection-badge ' + state;
            
            switch(state) {
                case 'disconnected':
                    status.textContent = 'Non connectÃ©';
                    name.textContent = 'Cliquez pour connecter';
                    avatar.src = 'https://robohash.org/anonymous?set=set4&size=36x36';
                    connectBtn.innerHTML = 'ğŸ”‘';
                    connectBtn.style.display = 'block';
                    break;
                    
                case 'connected-not-auth':
                    status.textContent = 'ğŸŸ¡ ConnectÃ©';
                    name.textContent = profile?.name || profile?.display_name || window.appState.userNpub?.substring(0, 12) + '...';
                    avatar.src = profile?.picture || `https://robohash.org/${window.appState.userPubkey}?set=set4&size=36x36`;
                    connectBtn.innerHTML = 'ğŸ”';
                    connectBtn.onclick = (e) => { e.stopPropagation(); authenticateNIP42(); };
                    break;
                    
                case 'authenticated':
                    status.textContent = 'ğŸŸ¢ AuthentifiÃ©';
                    name.textContent = profile?.name || profile?.display_name || window.appState.userNpub?.substring(0, 12) + '...';
                    avatar.src = profile?.picture || `https://robohash.org/${window.appState.userPubkey}?set=set4&size=36x36`;
                    connectBtn.style.display = 'none';
                    break;
            }
            
            // Update panel info
            if (window.appState.userPubkey) {
                document.getElementById('panel-pubkey-row').style.display = 'flex';
                document.getElementById('panel-pubkey').textContent = 
                    window.appState.userNpub?.substring(0, 20) + '...';
            }
            
            // Update uDRIVE if available
            if (window.appState.userProfile?.ipns_vault) {
                const udriveRow = document.getElementById('panel-udrive-row');
                const udriveLink = document.getElementById('panel-udrive-link');
                udriveRow.style.display = 'flex';
                const ipfsGw = window.appState.userProfile.ipfs_gw || 'https://ipfs.copylaradio.com';
                udriveLink.href = `${ipfsGw}/ipns/${window.appState.userProfile.ipns_vault}`;
                udriveLink.textContent = 'Ouvrir le stockage';
            }
            
            // Update G1 wallet if available
            if (window.appState.userProfile?.g1_address || window.appState.userProfile?.g1_address_v2) {
                document.getElementById('panel-wallet-row').style.display = 'flex';
                const addr = window.appState.userProfile.g1_address || window.appState.userProfile.g1_address_v2;
                document.getElementById('panel-wallet').textContent = addr.substring(0, 12) + '...';
            }
        }
        
        // Fetch user profile from Nostr (kind 0)
        async function fetchUserProfile(pubkey) {
            if (!window.appState.pool || !window.appState.relayUrls) {
                console.warn('No relay pool available for profile fetch');
                return null;
            }
            
            try {
                const events = await window.appState.pool.querySync(
                    window.appState.relayUrls,
                    [{ kinds: [0], authors: [pubkey], limit: 1 }],
                    { timeout: 5000 }
                );
                
                if (events && events.length > 0) {
                    const profileEvent = events[0];
                    const profile = JSON.parse(profileEvent.content);
                    
                    // Extract additional data from 'i' tags (UPlanet extensions)
                    if (profileEvent.tags) {
                        profileEvent.tags.forEach(tag => {
                            if (tag[0] === 'i') {
                                const [type, value] = tag[1].split(':');
                                switch(type) {
                                    case 'g1pub': profile.g1_address = value; break;
                                    case 'g1pubv2': profile.g1_address_v2 = value; break;
                                    case 'zencard': profile.zen_address = value; break;
                                    case 'ipfs_gw': profile.ipfs_gw = value; break;
                                    case 'ipns_vault': profile.ipns_vault = value; break;
                                }
                            }
                        });
                    }
                    
                    window.appState.userProfile = profile;
                    console.log('ğŸ“ User profile loaded:', profile);
                    return profile;
                }
            } catch (error) {
                console.error('Error fetching profile:', error);
            }
            return null;
        }
        
        // NIP-42 Authentication for uDRIVE access
        async function authenticateNIP42() {
            if (!window.appState.userPubkey) {
                showNotification('Connectez-vous d\'abord avec Nostr', 'error');
                return;
            }
            
            try {
                // Create NIP-42 AUTH event
                const authEvent = {
                    kind: 22242,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['relay', 'wss://relay.copylaradio.com'],
                        ['challenge', window.appState.authChallenge || 'uplanet-collaborative']
                    ],
                    content: ''
                };
                
                // Sign the event
                const signedEvent = await window.nostr.signEvent(authEvent);
                window.appState.nip42Auth = signedEvent;
                window.appState.isAuthenticated = true;
                
                // Update badge
                updateConnectionBadge('authenticated', window.appState.userProfile);
                
                // Update panel auth status
                document.getElementById('panel-auth-icon').textContent = 'âœ…';
                document.getElementById('panel-auth-status').textContent = 'AuthentifiÃ© (NIP-42)';
                
                showNotification('Authentification NIP-42 rÃ©ussie - Upload images activÃ©', 'success');
                
            } catch (error) {
                console.error('NIP-42 auth error:', error);
                showNotification('Erreur d\'authentification: ' + error.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOSTR CONNECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.connectNostr = async function() {
            if (!window.nostr) {
                showNotification('Extension Nostr non dÃ©tectÃ©e (nos2x, Alby...)', 'error');
                return;
            }
            
            try {
                const pubkey = await window.nostr.getPublicKey();
                window.appState.userPubkey = pubkey;
                window.appState.isConnected = true;
                
                // Convert to npub for display
                if (window.NostrTools && window.NostrTools.nip19) {
                    window.appState.userNpub = window.NostrTools.nip19.npubEncode(pubkey);
                } else {
                    window.appState.userNpub = pubkey.substring(0, 8) + '...' + pubkey.substring(pubkey.length - 4);
                }
                
                // Update UI (legacy header)
                document.getElementById('connection-dot').classList.add('connected');
                document.getElementById('connection-text').textContent = 'ConnectÃ©';
                document.getElementById('btn-connect').textContent = 'âœ… ' + window.appState.userNpub.substring(0, 12) + '...';
                document.getElementById('btn-connect').disabled = true;
                document.getElementById('btn-publish').disabled = false;
                
                document.getElementById('author-name').textContent = window.appState.userNpub.substring(0, 16) + '...';
                document.getElementById('author-avatar').src = `https://robohash.org/${pubkey}?set=set4&size=24x24`;
                
                // Mark step 1 as completed
                document.getElementById('step-1').classList.add('completed');
                document.getElementById('step-1').textContent = 'âœ“';
                
                // Connect to relay
                await connectRelay();
                
                // Fetch user profile for uDRIVE info
                const profile = await fetchUserProfile(pubkey);
                
                // Update fixed badge
                updateConnectionBadge('connected-not-auth', profile);
                
                // Load UMAP documents
                await loadUMAPDocuments();
                
                showNotification('ConnectÃ©! Cliquez sur ğŸ” pour activer l\'upload d\'images', 'success');
                
            } catch (error) {
                console.error('Nostr connection error:', error);
                showNotification('Erreur de connexion: ' + error.message, 'error');
            }
        };

        async function connectRelay() {
            const relayUrls = [
                'wss://relay.copylaradio.com',
                'wss://relay.damus.io',
                'wss://nos.lol'
            ];
            
            // Try SimplePool first (can query multiple relays)
            if (window.NostrTools && window.NostrTools.SimplePool) {
                window.appState.pool = new window.NostrTools.SimplePool();
                window.appState.relayUrls = relayUrls;
                // Create a proxy object that uses pool for subscriptions
                window.appState.relay = {
                    subscribe: (filters, handlers) => {
                        return window.appState.pool.subscribeMany(relayUrls, filters, handlers);
                    },
                    publish: async (event) => {
                        return window.appState.pool.publish(relayUrls, event);
                    }
                };
                console.log('âœ… Connected to relay pool:', relayUrls);
                return;
            }
            
            // Fallback to single relay connection
            for (const relayUrl of relayUrls) {
                try {
                    if (window.NostrTools && window.NostrTools.Relay) {
                        window.appState.relay = await window.NostrTools.Relay.connect(relayUrl);
                        console.log('âœ… Connected to relay:', relayUrl);
                        return;
                    } else if (typeof connectToNostrRelay === 'function') {
                        window.appState.relay = await connectToNostrRelay(relayUrl);
                        console.log('âœ… Connected to relay:', relayUrl);
                        return;
                    }
                } catch (error) {
                    console.warn('Relay connection failed:', relayUrl, error);
                }
            }
            
            console.error('Failed to connect to any relay');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DOCUMENT OPERATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadUMAPDocuments() {
            if (!window.appState.relay) return;
            
            const container = document.getElementById('umap-documents-list');
            container.innerHTML = '<p style="color: var(--text-muted);">Chargement des documents...</p>';
            
            try {
                const geoTag = `${window.appState.umapLat},${window.appState.umapLon}`;
                
                const filter = {
                    kinds: [30023],
                    '#t': ['collaborative', 'UPlanet'],
                    '#g': [geoTag],
                    limit: 20
                };
                
                const events = [];
                
                const sub = window.appState.relay.subscribe([filter], {
                    onevent(event) {
                        events.push(event);
                    },
                    oneose() {
                        renderDocumentsList(events, container);
                    }
                });
                
                // Timeout fallback
                setTimeout(() => {
                    if (events.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted);">Aucun document trouvÃ© pour cette UMAP</p>';
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Error loading documents:', error);
                container.innerHTML = '<p style="color: var(--text-muted);">Erreur de chargement</p>';
            }
        }

        function renderDocumentsList(events, container) {
            if (events.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Aucun document trouvÃ©</p>';
                return;
            }
            
            container.innerHTML = '';
            
            events.sort((a, b) => b.created_at - a.created_at);
            
            events.forEach(event => {
                const title = event.tags.find(t => t[0] === 'title')?.[1] || 'Sans titre';
                const version = event.tags.find(t => t[0] === 'version')?.[1] || '1';
                const date = new Date(event.created_at * 1000).toLocaleDateString('fr-FR');
                
                const item = document.createElement('div');
                item.style.cssText = 'padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; cursor: pointer;';
                item.innerHTML = `
                    <div style="font-weight: 500; color: var(--text-primary);">${title}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">v${version} â€¢ ${date}</div>
                `;
                item.addEventListener('click', () => {
                    loadDocument(event.id);
                    closeLoadModal();
                });
                container.appendChild(item);
            });
        }

        window.loadDocument = async function(eventId) {
            if (!window.appState.relay) {
                showNotification('Non connectÃ© au relay', 'error');
                return;
            }
            
            try {
                // Decode NIP-19 encoded IDs (note1..., nevent1...)
                let hexId = eventId;
                if (eventId.startsWith('note1') || eventId.startsWith('nevent1')) {
                    try {
                        if (window.NostrTools && window.NostrTools.nip19) {
                            const decoded = window.NostrTools.nip19.decode(eventId);
                            hexId = decoded.type === 'note' ? decoded.data : decoded.data.id;
                        }
                    } catch (e) {
                        console.warn('NIP-19 decode failed, using as-is:', e);
                    }
                }
                
                console.log('ğŸ“„ Loading document:', hexId);
                
                const filter = { ids: [hexId], limit: 1 };
                let eventFound = false;
                
                const sub = window.appState.relay.subscribe([filter], {
                    onevent(event) {
                        eventFound = true;
                        window.appState.currentDocEvent = event;
                        window.appState.currentDocId = event.id;
                        
                        // Extract all metadata from tags
                        const title = event.tags.find(t => t[0] === 'title')?.[1] || 'Sans titre';
                        const version = event.tags.find(t => t[0] === 'version')?.[1] || '1';
                        const docType = event.tags.find(t => t[0] === 't' && ['commons', 'project', 'decision', 'garden', 'resource'].includes(t[1]))?.[1] || 'commons';
                        
                        // Update UI
                        document.getElementById('doc-title').value = title;
                        document.getElementById('version-badge').textContent = `v${version}`;
                        
                        // Update document type
                        window.appState.docType = docType;
                        document.querySelectorAll('.doc-type-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.type === docType);
                        });
                        const typeLabels = { commons: 'ğŸ¤ Commun', project: 'ğŸ¯ Projet', decision: 'ğŸ—³ï¸ DÃ©cision', garden: 'ğŸŒ± Jardin', resource: 'ğŸ“¦ Ressource' };
                        document.getElementById('info-type').textContent = typeLabels[docType] || typeLabels.commons;
                        
                        // Mark step 2 as in progress (editing)
                        document.getElementById('step-2').classList.add('completed');
                        document.getElementById('step-2').textContent = 'âœ“';
                        
                        // Load content into editor
                        setEditorContent(event.content);
                        
                        showNotification('Document chargÃ©!', 'success');
                        sub.close();
                    },
                    oneose() {
                        if (!eventFound) {
                            showNotification('Document non trouvÃ©', 'error');
                        }
                        sub.close();
                    }
                });
                
                // Timeout fallback
                setTimeout(() => {
                    if (!eventFound) {
                        sub.close();
                        showNotification('Timeout - document non trouvÃ©', 'error');
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Error loading document:', error);
                showNotification('Erreur de chargement: ' + error.message, 'error');
            }
        };

        window.loadDocumentById = function() {
            const eventId = document.getElementById('load-event-id').value.trim();
            if (eventId) {
                loadDocument(eventId);
                closeLoadModal();
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROPOSAL SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.proposeDocument = function() {
            if (!window.appState.isConnected) {
                showNotification('Veuillez vous connecter d\'abord', 'error');
                return;
            }
            
            const title = document.getElementById('doc-title').value.trim();
            if (!title) {
                showNotification('Veuillez donner un titre au document', 'error');
                return;
            }
            
            document.getElementById('propose-modal').classList.add('active');
        };

        window.submitProposal = async function() {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ PUBLISHING DOCUMENT (kind 30023)');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const title = document.getElementById('doc-title').value.trim();
            const summary = document.getElementById('change-summary').value.trim();
            const quorum = document.getElementById('quorum-select').value;
            const forkPolicy = document.getElementById('fork-policy').value;
            
            console.log('ğŸ“„ Document metadata:');
            console.log('   - Title:', title);
            console.log('   - Doc type:', window.appState.docType);
            console.log('   - Summary:', summary);
            console.log('   - Quorum:', quorum);
            console.log('   - Fork policy:', forkPolicy);
            
            if (!summary) {
                showNotification('Veuillez dÃ©crire vos modifications', 'error');
                return;
            }
            
            const content = window.appState.markdown;
            const lat = window.appState.umapLat;
            const lon = window.appState.umapLon;
            
            console.log('ğŸ“ Location:', lat, lon);
            console.log('ğŸ“ Content length:', content.length, 'chars');
            
            // Calculate content hash
            console.log('ğŸ” Calculating content hash...');
            const contentHash = await hashContent(content);
            console.log('   - Hash:', `${contentHash.substring(0, 16)}...`);
            
            // Build tags
            const tags = [
                ["d", `doc-${lat}-${lon}-${Date.now()}`],
                ["title", title],
                ["t", "collaborative"],
                ["t", "UPlanet"],
                ["t", window.appState.docType],
                ["g", `${lat},${lon}`],
                ["author", window.appState.userPubkey],
                ["version", "1"],
                ["quorum", quorum === 'all' ? 'unanimous' : quorum],
                ["governance", quorum === 'all' ? 'unanimous' : 'majority'],
                ["fork-policy", forkPolicy],
                ["content-hash", `sha256:${contentHash}`],
                ["change-summary", summary],
                ["published_at", String(Math.floor(Date.now() / 1000))]
            ];
            
            // Add UMAP pubkey reference if available (enables discovery by UMAP)
            if (window.appState.umapPubkey) {
                tags.push(["p", window.appState.umapPubkey, "", "umap"]);
                console.log('   + Added UMAP pubkey tag');
            }
            
            // If updating existing document
            if (window.appState.currentDocEvent) {
                const originalDTag = window.appState.currentDocEvent.tags.find(t => t[0] === 'd')?.[1];
                const originalVersion = parseInt(window.appState.currentDocEvent.tags.find(t => t[0] === 'version')?.[1] || '1');
                tags.push(["previous-version", window.appState.currentDocEvent.id]);
                
                // Update version tag
                const versionTagIndex = tags.findIndex(t => t[0] === 'version');
                tags[versionTagIndex] = ["version", String(originalVersion + 1)];
                console.log('   - Updating existing document (version', originalVersion + 1, ')');
            }
            
            console.log('ğŸ·ï¸ Tags:', tags.length);
            tags.forEach((tag, i) => {
                console.log(`   [${i+1}] ${tag[0]}: ${tag[1]?.substring(0, 40) || tag[1]}`);
            });
            
            const event = {
                kind: 30023,
                created_at: Math.floor(Date.now() / 1000),
                tags: tags,
                content: content
            };
            
            try {
                console.log('âœï¸ Signing kind 30023 event...');
                const signedEvent = await window.nostr.signEvent(event);
                console.log('âœ… Event signed');
                console.log('   - Event ID:', signedEvent.id);
                console.log('   - Signature:', `${signedEvent.sig.substring(0, 16)}...`);
                
                if (window.appState.relay) {
                    console.log('ğŸ“¡ Publishing to relay:', window.appState.relay.url || 'default');
                    await window.appState.relay.publish(signedEvent);
                    console.log('âœ… Kind 30023 document published successfully');
                } else {
                    console.error('âŒ No relay available');
                }
                
                window.appState.currentDocEvent = signedEvent;
                window.appState.currentDocId = signedEvent.id;
                
                // If crowdfund document, also publish structured kind 30904 event
                if (window.appState.docType === 'crowdfund') {
                    console.log('ğŸŒ³ Document type is "crowdfund" - will publish kind 30904 next...');
                    await publishCrowdfundEvent(signedEvent, title, lat, lon, content);
                } else {
                    console.log('âœ… Document published (not a crowdfund, skipping kind 30904)');
                }
                
                // Update UI
                document.getElementById('version-badge').textContent = 'v' + (tags.find(t => t[0] === 'version')?.[1] || '1');
                document.getElementById('step-3').classList.add('completed');
                document.getElementById('step-3').textContent = 'âœ“';
                
                closeProposeModal();
                showNotification('Document publiÃ© avec succÃ¨s!', 'success');
                
                // Show crowdfunding link if applicable
                if (window.appState.docType === 'crowdfund') {
                    setTimeout(() => {
                        showNotification('ğŸŒ³ Voir le projet sur <a href="crowdfunding.html" style="color: var(--accent-emerald)">Crowdfunding</a>', 'info');
                    }, 2000);
                }
                
                // Clear draft
                localStorage.removeItem(`umap-draft-${lat}-${lon}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ ERROR PUBLISHING DOCUMENT');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Event that failed:', JSON.stringify(event, null, 2));
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                showNotification('Erreur de publication: ' + error.message, 'error');
            }
        };
        
        // Publish structured kind 30904 crowdfunding event
        async function publishCrowdfundEvent(docEvent, title, lat, lon, markdownContent) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“¦ PUBLISHING KIND 30904 CROWDFUNDING EVENT');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“„ Input parameters:');
            console.log('   - Title:', title);
            console.log('   - Location:', lat, lon);
            console.log('   - Document event ID:', docEvent.id);
            console.log('   - Markdown length:', markdownContent.length, 'chars');
            
            // Extract owners from markdown table
            const owners = extractOwnersFromMarkdown(markdownContent);
            console.log('ğŸ‘¥ Extracted owners:', owners.length);
            if (owners.length > 0) {
                owners.forEach((o, i) => {
                    console.log(`   [${i+1}] ${o.email} - ${o.mode} - ${o.mode === 'commons' ? o.amount_zen + ' áºen' : o.amount_eur + 'â‚¬'}`);
                });
            }
            
            // Calculate totals
            const totals = calculateTotals(owners);
            console.log('ğŸ’° Calculated totals:');
            console.log('   - áºen convertible target:', totals.zen_convertible_target);
            console.log('   - Ä1 target:', totals.g1_target);
            console.log('   - Commons áºen:', totals.commons_zen);
            console.log('   - Cash â‚¬:', totals.cash_eur);
            
            // Project name (clean title)
            const projectName = title.replace(/^ğŸŒ³\s*/, '').replace(/\s*-\s*(ForÃªt Jardin|Crowdfunding)$/, '');
            const desc = `Crowdfunding: ${projectName}`;
            console.log('ğŸ“ Project name (cleaned):', projectName);
            
            // Try to create project via API to get Bien identity
            let projectId = `CF-${Date.now().toString(36).toUpperCase()}`;
            let bienIdentity = null;
            
            const apiUrl = window.appState.apiServer || `${window.location.protocol}//${window.location.hostname}:54321`;
            console.log('ğŸŒ API URL:', apiUrl);
            
            try {
                console.log('ğŸ“¡ Step 1/5: Creating project via API...');
                const createPayload = {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    name: projectName,
                    description: desc,
                    npub: window.appState.userNpub || ''
                };
                console.log('   Request payload:', JSON.stringify(createPayload, null, 2));
                
                const response = await fetch(`${apiUrl}/api/crowdfunding/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createPayload)
                });
                
                console.log('   Response status:', response.status, response.statusText);
                
                if (response.ok) {
                    const apiResult = await response.json();
                    console.log('   Response data:', JSON.stringify(apiResult, null, 2));
                    
                    if (apiResult.success && apiResult.project_id) {
                        projectId = apiResult.project_id;
                        bienIdentity = apiResult.bien_identity || apiResult.project?.bien_identity;
                        console.log('âœ… Step 1/5: Project created via API');
                        console.log('   - Project ID:', projectId);
                        console.log('   - Bien identity:', {
                            hex: bienIdentity?.hex ? `${bienIdentity.hex.substring(0, 16)}...` : 'MISSING',
                            g1pub: bienIdentity?.g1pub ? `${bienIdentity.g1pub.substring(0, 8)}...` : 'MISSING',
                            npub: bienIdentity?.npub ? `${bienIdentity.npub.substring(0, 20)}...` : 'MISSING'
                        });
                    } else {
                        console.warn('âš ï¸ API returned success=false or missing project_id');
                        console.warn('   Response:', apiResult);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('âŒ API call failed:', response.status, errorText);
                }
            } catch (e) {
                console.error('âŒ Step 1/5: API call exception:', e);
                console.error('   Error message:', e.message);
                console.error('   Stack:', e.stack);
                console.warn('âš ï¸ Using fallback local project ID:', projectId);
            }
            
            // Build structured data
            const crowdfundData = {
                id: projectId,
                name: projectName,
                location: {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lon)
                },
                status: owners.length > 0 ? 'crowdfunding' : 'draft',
                umapId: `UMAP_${parseFloat(lat).toFixed(2)}_${parseFloat(lon).toFixed(2)}`,
                umapPubkey: window.appState.umapPubkey,
                documentEventId: docEvent.id,
                owners: owners,
                totals: totals,
                campaigns: {
                    zen_convertible_campaign_active: totals.zen_convertible_target > 0,
                    g1_campaign_active: totals.g1_target > 0
                },
                contributions: [],
                opencollective: 'https://opencollective.com/uplanet-zero'
            };
            
            // Validate: bien_identity is REQUIRED
            console.log('ğŸ” Step 2/5: Validating bien_identity...');
            if (!bienIdentity) {
                console.error('âŒ Step 2/5: bien_identity is null/undefined');
                console.error('   This means the API /crowdfunding/create failed or did not return bien_identity');
                showNotification('âŒ Erreur: L\'identitÃ© du Bien est requise. Le projet doit Ãªtre crÃ©Ã© via l\'API.', 'error');
                return;
            }
            
            if (!bienIdentity.hex) {
                console.error('âŒ Step 2/5: bien_identity.hex is missing');
                console.error('   bien_identity object:', bienIdentity);
                showNotification('âŒ Erreur: bien_identity.hex manquant', 'error');
                return;
            }
            
            if (!bienIdentity.g1pub) {
                console.error('âŒ Step 2/5: bien_identity.g1pub is missing');
                console.error('   bien_identity object:', bienIdentity);
                showNotification('âŒ Erreur: bien_identity.g1pub manquant', 'error');
                return;
            }
            
            console.log('âœ… Step 2/5: bien_identity validated');
            console.log('   - hex:', `${bienIdentity.hex.substring(0, 16)}... (${bienIdentity.hex.length} chars)`);
            console.log('   - g1pub:', `${bienIdentity.g1pub.substring(0, 8)}... (${bienIdentity.g1pub.length} chars)`);
            console.log('   - npub:', bienIdentity.npub ? `${bienIdentity.npub.substring(0, 20)}...` : 'not provided');
            
            // Add bien_identity to data (REQUIRED)
            crowdfundData.bien_identity = bienIdentity;
            
            // Get IPFSNODEID from API (REQUIRED to prevent duplication)
            console.log('ğŸŒ Step 3/5: Getting IPFSNODEID...');
            let creatorNodeId = null;
            try {
                // Get IPFSNODEID from /api/myGPS endpoint
                if (window.appState?.userNpub) {
                    console.log('   - User npub available:', `${window.appState.userNpub.substring(0, 16)}...`);
                    const gpsUrl = `${apiUrl}/api/myGPS?npub=${window.appState.userNpub}`;
                    console.log('   - Requesting:', gpsUrl);
                    
                    const gpsResponse = await fetch(gpsUrl);
                    console.log('   - Response status:', gpsResponse.status, gpsResponse.statusText);
                    
                    if (gpsResponse.ok) {
                        const gpsData = await gpsResponse.json();
                        console.log('   - Response data:', gpsData);
                        creatorNodeId = gpsData.ipfsnodeid;
                        
                        if (creatorNodeId) {
                            console.log('âœ… Step 3/5: Got IPFSNODEID from /api/myGPS:', creatorNodeId);
                        } else {
                            console.warn('âš ï¸ Step 3/5: /api/myGPS response missing ipfsnodeid field');
                            console.warn('   Response keys:', Object.keys(gpsData));
                        }
                    } else {
                        const errorText = await gpsResponse.text();
                        console.warn('âš ï¸ Step 3/5: /api/myGPS failed:', gpsResponse.status, errorText);
                    }
                } else {
                    console.warn('âš ï¸ Step 3/5: No userNpub available for /api/myGPS request');
                }
                
                // Fallback: try to get from window state if available
                if (!creatorNodeId) {
                    creatorNodeId = window.appState?.ipfsNodeId || null;
                    if (creatorNodeId) {
                        console.log('âœ… Step 3/5: Got IPFSNODEID from window.appState:', creatorNodeId);
                    }
                }
            } catch (e) {
                console.error('âŒ Step 3/5: Exception getting IPFSNODEID:', e);
                console.error('   Error:', e.message);
                creatorNodeId = window.appState?.ipfsNodeId || null;
            }
            
            // Warn if IPFSNODEID is missing (not fatal, but recommended)
            if (!creatorNodeId) {
                console.warn('âš ï¸ Step 3/5: IPFSNODEID not available - project may be duplicated on other nodes');
            }
            
            // Add creator node ID to data
            if (creatorNodeId) {
                crowdfundData.creator_node_id = creatorNodeId;
            }
            
            // Build kind 30904 event with REQUIRED tags
            console.log('ğŸ—ï¸ Step 4/5: Building kind 30904 event...');
            const cfEvent = {
                kind: 30904,
                created_at: Math.floor(Date.now() / 1000),
                tags: [
                    ['d', projectId],  // REQUIRED: Unique identifier
                    ['title', title],  // REQUIRED: Campaign title
                    ['t', 'crowdfunding'],  // REQUIRED: Type marker
                    ['t', 'UPlanet'],
                    ['g', `${lat},${lon}`],  // REQUIRED: Geographic coordinates
                    ['project-id', projectId],  // REQUIRED: Project identifier
                    ['status', crowdfundData.status],  // REQUIRED: Campaign status
                    ['e', docEvent.id, '', 'document'],  // Reference to kind 30023
                    ['zen_target', String(totals.zen_convertible_target)],
                    ['g1_target', String(totals.g1_target)]
                ],
                content: JSON.stringify(crowdfundData)
            };
            
            console.log('   Base tags:', cfEvent.tags.length);
            cfEvent.tags.forEach((tag, i) => {
                console.log(`   [${i+1}] ${tag[0]}: ${tag[1]?.substring(0, 30) || tag[1]}${tag[2] ? ` (${tag[2]})` : ''}${tag[3] ? ` [${tag[3]}]` : ''}`);
            });
            
            // Add creator IPFSNODEID tag (REQUIRED to prevent duplication)
            if (creatorNodeId) {
                cfEvent.tags.push(['ipfsnodeid', creatorNodeId]);
                console.log('   + Added ipfsnodeid tag:', creatorNodeId);
            } else {
                console.warn('   âš ï¸ Missing ipfsnodeid tag (will be added if available)');
            }
            
            // Add UMAP pubkey if available
            if (window.appState.umapPubkey) {
                cfEvent.tags.push(['p', window.appState.umapPubkey, '', 'umap']);
                console.log('   + Added UMAP pubkey tag:', `${window.appState.umapPubkey.substring(0, 16)}...`);
            } else {
                console.log('   - No UMAP pubkey available');
            }
            
            // Add Bien identity tags (REQUIRED for payments)
            // The Bien's hex is the pubkey that can receive payments
            if (bienIdentity.hex) {
                // Tag p with bien marker - this is the Bien's NOSTR pubkey (REQUIRED)
                cfEvent.tags.push(['p', bienIdentity.hex, '', 'bien']);
                console.log('   + Added Bien hex tag (p):', `${bienIdentity.hex.substring(0, 16)}...`);
            } else {
                console.error('   âŒ Missing Bien hex for p tag!');
            }
            
            if (bienIdentity.g1pub) {
                // Tag i with g1pub - this is the Bien's Ä1 wallet (REQUIRED)
                cfEvent.tags.push(['i', `g1pub:${bienIdentity.g1pub}`]);
                console.log('   + Added Bien g1pub tag (i):', `g1pub:${bienIdentity.g1pub.substring(0, 8)}...`);
            } else {
                console.error('   âŒ Missing Bien g1pub for i tag!');
            }
            
            console.log('   Final tags count:', cfEvent.tags.length);
            console.log('   Content length:', cfEvent.content.length, 'chars');
            console.log('   Content preview:', cfEvent.content.substring(0, 200) + '...');
            
            try {
                console.log('âœï¸ Step 5/5: Signing and publishing event...');
                
                if (!window.nostr) {
                    console.error('âŒ Step 5/5: window.nostr not available');
                    showNotification('âŒ Extension Nostr non disponible', 'error');
                    return;
                }
                
                console.log('   - Signing event with NIP-07...');
                const signedCfEvent = await window.nostr.signEvent(cfEvent);
                console.log('âœ… Event signed successfully');
                console.log('   - Event ID:', signedCfEvent.id);
                console.log('   - Signature:', `${signedCfEvent.sig.substring(0, 16)}...`);
                
                if (window.appState.relay) {
                    console.log('   - Publishing to relay:', window.appState.relay.url || 'default');
                    await window.appState.relay.publish(signedCfEvent);
                    console.log('âœ… Step 5/5: Kind 30904 crowdfunding event published successfully');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('ğŸ‰ WORKFLOW COMPLETED SUCCESSFULLY');
                    console.log('   Project ID:', projectId);
                    console.log('   Event ID:', signedCfEvent.id);
                    console.log('   Bien hex:', `${bienIdentity.hex.substring(0, 16)}...`);
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    showNotification(`ğŸŒ³ Projet crowdfunding crÃ©Ã©: ${projectId}`, 'success');
                } else {
                    console.error('âŒ Step 5/5: No relay available');
                    console.error('   window.appState.relay:', window.appState.relay);
                    showNotification('âŒ Aucun relay disponible', 'error');
                }
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ WORKFLOW FAILED AT STEP 5/5');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Event that failed:', JSON.stringify(cfEvent, null, 2));
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                showNotification('âŒ Erreur de publication: ' + error.message, 'error');
            }
        }
        
        function extractOwnersFromMarkdown(content) {
            console.log('ğŸ” Extracting owners from markdown...');
            const owners = [];
            // Match table rows: | email | mode | amount | status |
            const tableRegex = /\|\s*([^\|]+@[^\|]+)\s*\|\s*(ğŸ¤|ğŸ’¶)[^\|]*\|[^\|]*(\d+)\s*(áºen|â‚¬)/gi;
            let match;
            let matchCount = 0;
            
            while ((match = tableRegex.exec(content)) !== null) {
                matchCount++;
                const mode = match[2] === 'ğŸ¤' ? 'commons' : 'cash';
                const amount = parseInt(match[3]);
                const owner = {
                    email: match[1].trim(),
                    mode: mode,
                    amount_zen: mode === 'commons' ? amount : 0,
                    amount_eur: mode === 'cash' ? amount : 0,
                    status: 'pending'
                };
                owners.push(owner);
                console.log(`   Match ${matchCount}: ${owner.email} - ${owner.mode} - ${amount} ${match[4]}`);
            }
            
            if (matchCount === 0) {
                console.log('   âš ï¸ No owners found in markdown (project will be in draft status)');
            } else {
                console.log(`   âœ… Extracted ${owners.length} owner(s)`);
            }
            
            return owners;
        }
        
        function calculateTotals(owners) {
            console.log('ğŸ§® Calculating totals from', owners.length, 'owner(s)...');
            
            const commons_zen = owners.filter(o => o.mode === 'commons').reduce((s, o) => s + o.amount_zen, 0);
            const cash_eur = owners.filter(o => o.mode === 'cash').reduce((s, o) => s + o.amount_eur, 0);
            const zen_convertible_target = owners.filter(o => o.mode === 'cash').reduce((s, o) => s + o.amount_eur, 0);
            
            const totals = {
                commons_zen: commons_zen,
                cash_eur: cash_eur,
                zen_convertible_target: zen_convertible_target,
                zen_convertible_collected: 0,
                g1_target: 100, // Default G1 target
                g1_collected: 0
            };
            
            console.log('   - Commons áºen:', commons_zen);
            console.log('   - Cash â‚¬:', cash_eur);
            console.log('   - áºen convertible target:', zen_convertible_target);
            console.log('   - Ä1 target (default):', totals.g1_target);
            
            return totals;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function hashContent(content) {
            const encoder = new TextEncoder();
            const data = encoder.encode(content);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function saveDraft() {
            const key = `umap-draft-${window.appState.umapLat}-${window.appState.umapLon}`;
            const draft = {
                title: document.getElementById('doc-title').value,
                content: window.appState.markdown,
                docType: window.appState.docType,
                timestamp: Date.now()
            };
            localStorage.setItem(key, JSON.stringify(draft));
        }

        function loadDraft() {
            const key = `umap-draft-${window.appState.umapLat}-${window.appState.umapLon}`;
            const draft = localStorage.getItem(key);
            
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    // Only load if less than 24h old
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        if (confirm('Un brouillon a Ã©tÃ© trouvÃ©. Voulez-vous le restaurer ?')) {
                            document.getElementById('doc-title').value = data.title || '';
                            window.appState.docType = data.docType || 'commons';
                            
                            // Update doc type button
                            document.querySelectorAll('.doc-type-btn').forEach(btn => {
                                btn.classList.toggle('active', btn.dataset.type === window.appState.docType);
                            });
                            
                            if (data.content) {
                                setEditorContent(data.content);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODAL FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.openLoadModal = function() {
            document.getElementById('load-modal').classList.add('active');
            if (window.appState.isConnected) {
                loadUMAPDocuments();
            }
        };

        window.closeLoadModal = function() {
            document.getElementById('load-modal').classList.remove('active');
        };

        window.closeProposeModal = function() {
            document.getElementById('propose-modal').classList.remove('active');
        };

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VOTING SYSTEM (Kind 7 Reactions)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Load pending proposals for current UMAP
        async function loadPendingProposals() {
            if (!window.appState.relay || !window.appState.isConnected) return;
            
            const container = document.getElementById('proposals-container');
            container.innerHTML = '<p style="color: var(--text-muted);">Chargement des propositions...</p>';
            
            try {
                const geoTag = `${window.appState.umapLat},${window.appState.umapLon}`;
                
                // Fetch draft proposals (kind 30024) or collaborative documents (kind 30023)
                const filter = {
                    kinds: [30023, 30024],
                    '#t': ['collaborative', 'UPlanet'],
                    '#g': [geoTag],
                    since: Math.floor(Date.now() / 1000) - (7 * 24 * 60 * 60), // Last 7 days
                    limit: 20
                };
                
                const events = [];
                
                const sub = window.appState.relay.subscribe([filter], {
                    onevent(event) {
                        events.push(event);
                    },
                    async oneose() {
                        // For each event, fetch its votes
                        for (const event of events) {
                            event.votes = await fetchVotesForDocument(event.id);
                        }
                        renderProposals(events, container);
                        sub.close();
                    }
                });
                
                setTimeout(() => {
                    if (container.innerHTML.includes('Chargement')) {
                        container.innerHTML = '<p style="color: var(--text-muted);">Aucune proposition en attente</p>';
                    }
                }, 8000);
                
            } catch (error) {
                console.error('Error loading proposals:', error);
                container.innerHTML = '<p style="color: var(--text-muted);">Erreur de chargement</p>';
            }
        }
        
        // Fetch votes (kind 7 reactions) for a document
        async function fetchVotesForDocument(eventId) {
            if (!window.appState.relay) return { approvals: 0, rejections: 0, forks: 0, voters: [] };
            
            return new Promise((resolve) => {
                const votes = { approvals: 0, rejections: 0, forks: 0, voters: [] };
                
                const filter = {
                    kinds: [7],
                    '#e': [eventId],
                    limit: 100
                };
                
                const sub = window.appState.relay.subscribe([filter], {
                    onevent(event) {
                        const content = event.content;
                        const voteTag = event.tags.find(t => t[0] === 'vote')?.[1];
                        
                        // Count by content or explicit vote tag
                        if (content === 'âœ…' || content === '+' || content === 'ğŸ‘' || voteTag === 'approve') {
                            votes.approvals++;
                        } else if (content === 'âŒ' || content === '-' || content === 'ğŸ‘' || voteTag === 'reject') {
                            votes.rejections++;
                        } else if (content === 'ğŸ”€' || voteTag === 'fork') {
                            votes.forks++;
                        }
                        
                        if (!votes.voters.includes(event.pubkey)) {
                            votes.voters.push(event.pubkey);
                        }
                    },
                    oneose() {
                        sub.close();
                        resolve(votes);
                    }
                });
                
                // Timeout fallback
                setTimeout(() => resolve(votes), 3000);
            });
        }
        
        // Render proposals with vote counts
        function renderProposals(events, container) {
            if (events.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">Aucune proposition en attente</p>';
                return;
            }
            
            container.innerHTML = '';
            
            // Sort by date (newest first)
            events.sort((a, b) => b.created_at - a.created_at);
            
            // Show max 5 proposals
            events.slice(0, 5).forEach(event => {
                const title = event.tags.find(t => t[0] === 'title')?.[1] || 'Sans titre';
                const summary = event.tags.find(t => t[0] === 'change-summary')?.[1] || 'Nouvelle proposition';
                const quorum = parseInt(event.tags.find(t => t[0] === 'quorum')?.[1] || '2');
                const authorPubkey = event.tags.find(t => t[0] === 'author')?.[1] || event.pubkey;
                const votes = event.votes || { approvals: 0, rejections: 0, forks: 0 };
                const timeAgo = formatTimeAgo(event.created_at);
                
                // Check if user already voted
                const userVoted = votes.voters?.includes(window.appState.userPubkey);
                
                const card = document.createElement('div');
                card.className = 'proposal-card' + (votes.approvals < quorum ? ' pending' : '');
                card.innerHTML = `
                    <div class="proposal-header">
                        <div class="proposal-author">
                            <img src="https://robohash.org/${authorPubkey}?set=set4&size=24x24" alt="">
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">${authorPubkey.substring(0, 8)}...</span>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${timeAgo}</span>
                    </div>
                    <div style="font-weight: 500; margin-bottom: 4px; color: var(--text-primary);">${escapeHtml(title)}</div>
                    <div class="proposal-summary">${escapeHtml(summary)}</div>
                    <div class="proposal-votes">
                        <button class="vote-btn approve" onclick="voteOnDocument('${event.id}', 'approve')" ${userVoted ? 'disabled' : ''} title="Approuver">
                            âœ… ${votes.approvals}
                        </button>
                        <button class="vote-btn reject" onclick="voteOnDocument('${event.id}', 'reject')" ${userVoted ? 'disabled' : ''} title="Rejeter">
                            âŒ ${votes.rejections}
                        </button>
                        <button class="vote-btn fork" onclick="voteOnDocument('${event.id}', 'fork')" ${userVoted ? 'disabled' : ''} title="Demander Fork">
                            ğŸ”€ ${votes.forks}
                        </button>
                    </div>
                    <div class="vote-count">
                        ${votes.approvals}/${quorum} validations â€¢ ${userVoted ? 'âœ“ Vous avez votÃ©' : 'En attente de votes'}
                    </div>
                `;
                
                // Add click to load document
                card.querySelector('.proposal-header').style.cursor = 'pointer';
                card.querySelector('.proposal-header').addEventListener('click', () => {
                    loadDocument(event.id);
                });
                
                container.appendChild(card);
            });
        }
        
        // Submit a vote (kind 7 reaction)
        window.voteOnDocument = async function(eventId, voteType) {
            if (!window.appState.isConnected) {
                showNotification('Veuillez vous connecter pour voter', 'error');
                return;
            }
            
            const voteEmojis = {
                'approve': 'âœ…',
                'reject': 'âŒ',
                'fork': 'ğŸ”€'
            };
            
            const event = {
                kind: 7,
                created_at: Math.floor(Date.now() / 1000),
                content: voteEmojis[voteType],
                tags: [
                    ["e", eventId],
                    ["vote", voteType],
                    ["t", "collaborative-vote"],
                    ["t", "UPlanet"]
                ]
            };
            
            try {
                const signedEvent = await window.nostr.signEvent(event);
                
                if (window.appState.relay) {
                    await window.appState.relay.publish(signedEvent);
                }
                
                showNotification(`Vote "${voteType}" enregistrÃ©!`, 'success');
                
                // Refresh proposals
                setTimeout(() => loadPendingProposals(), 1000);
                
            } catch (error) {
                console.error('Error voting:', error);
                showNotification('Erreur lors du vote: ' + error.message, 'error');
            }
        };
        
        // Helper: Format time ago
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor(Date.now() / 1000) - timestamp;
            
            if (seconds < 60) return 'Ã  l\'instant';
            if (seconds < 3600) return `il y a ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `il y a ${Math.floor(seconds / 3600)}h`;
            if (seconds < 604800) return `il y a ${Math.floor(seconds / 86400)}j`;
            return new Date(timestamp * 1000).toLocaleDateString('fr-FR');
        }
        
        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load proposals after connection
        const originalConnectNostr = window.connectNostr;
        window.connectNostr = async function() {
            await originalConnectNostr();
            if (window.appState.isConnected) {
                await loadPendingProposals();
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // IMAGE UPLOAD WITH NIP-42 AUTH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.handleImageUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if user is authenticated
            if (!window.appState.isAuthenticated) {
                showNotification('âš ï¸ Authentification NIP-42 requise pour uploader des images', 'error');
                showNotification('Cliquez sur ğŸ” dans le badge de connexion', 'info');
                return;
            }
            
            // Check if uDRIVE is available
            if (!window.appState.userProfile?.ipns_vault) {
                showNotification('uDRIVE non disponible - image convertie en base64', 'info');
                // Fallback to base64 embedding
                await insertImageAsBase64(file);
                return;
            }
            
            // Upload to uDRIVE
            try {
                showNotification('ğŸ“¤ Upload en cours...', 'info');
                
                const ipfsGw = window.appState.userProfile.ipfs_gw || 'https://ipfs.copylaradio.com';
                const uploadUrl = `${ipfsGw}/api/v0/add?pin=true`;
                
                const formData = new FormData();
                formData.append('file', file);
                
                // Add NIP-42 auth header if available
                const headers = {};
                if (window.appState.nip42Auth) {
                    headers['X-Nostr-Auth'] = JSON.stringify(window.appState.nip42Auth);
                }
                
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers,
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const imageUrl = `${ipfsGw}/ipfs/${result.Hash}`;
                    insertImageAtCursor(file.name, imageUrl);
                    showNotification('âœ… Image uploadÃ©e sur IPFS!', 'success');
                } else {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Erreur upload - fallback base64', 'info');
                await insertImageAsBase64(file);
            }
            
            // Reset input
            event.target.value = '';
        };
        
        // Insert image markdown at cursor position
        function insertImageAtCursor(altText, url) {
            const editor = document.getElementById('markdown-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            
            const insertion = `![${altText}](${url})`;
            editor.value = text.substring(0, start) + insertion + text.substring(end);
            editor.selectionStart = editor.selectionEnd = start + insertion.length;
            editor.focus();
            
            window.appState.markdown = editor.value;
            updatePreview();
            saveDraft();
        }
        
        // Fallback: Convert image to base64 and embed
        async function insertImageAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    insertImageAtCursor(file.name, base64);
                    showNotification('Image intÃ©grÃ©e (base64)', 'success');
                    resolve();
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOTIFICATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.showNotification = function(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            
            const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
            toast.innerHTML = `
                <span style="font-size: 1.2rem;">${icons[type]}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

    </script>
</body>
</html>
