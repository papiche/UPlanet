<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constellation - Simulateur Stratégique Coopératif</title>
    <link href="/ipfs/QmUPAAEcLVbmXBKcribNfhbpZ655BjbdCB2BsKz6tCGCfk/css2.css" rel="stylesheet">
    <script src="/ipfs/QmUPAAEcLVbmXBKcribNfhbpZ655BjbdCB2BsKz6tCGCfk/chart.js"></script>
    <script src="/ipfs/QmUvcdtTqYgv1aY7SasRb7J28rkCUCTEQqWRHmbgNBxh1H/chartjs-plugin-datalabels.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .sliders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .slider-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 3px solid #3498db;
            transition: all 0.3s ease;
        }

        .slider-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
            border-left-color: #2980b9;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slider-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            margin: 0;
        }

        .slider-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #3498db;
            min-width: 40px;
            text-align: right;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider-info {
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .financial-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #95a5a6;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .financial-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .financial-item.highlight {
            background: linear-gradient(135deg, #ecf0f1 0%, #ffffff 100%);
            border-left-color: #3498db;
            font-weight: 600;
        }

        .financial-item.revenue {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6 0%, #fafefe 100%);
        }

        .financial-item.cost {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fadbd8 0%, #fafefe 100%);
        }

        .financial-label, .legend-label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .financial-value {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .info-icon {
            width: 18px;
            height: 18px;
            background: #bdc3c7;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .tooltip .tooltiptext {
            visibility: hidden; width: 300px; background-color: #2c3e50; color: white;
            text-align: left; border-radius: 8px; padding: 15px; position: absolute;
            z-index: 1000; bottom: 125%; left: 50%; margin-left: -150px;
            opacity: 0; transition: opacity 0.3s; font-size: 14px; line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .wealth-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: center;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }
        
        .impact-statement {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white; padding: 25px; border-radius: 15px; text-align: center;
            font-size: 1.2rem; font-weight: 600; margin-top: 30px;
        }

        /* AMÉLIORATION : Onglets pour la projection */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* AMÉLIORATION : Section KPI */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .kpi-title { 
            font-weight: 600; 
            color: #7f8c8d; 
            margin-bottom: 8px; 
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-value { 
            font-size: 1.6rem; 
            font-weight: 700; 
            color: #2c3e50; 
            line-height: 1;
        }
        .kpi-card.positive .kpi-value { color: #27ae60; }
        .kpi-card.warning .kpi-value { color: #f39c12; }
        .kpi-card.negative .kpi-value { color: #e74c3c; }

        /* AMÉLIORATION : Conseils contextuels */
        .tips-container {
            margin-top: 20px;
        }
        .tip-card {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .tip-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .tip-success {
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
            border-left-color: #28a745;
        }
        .tip-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
            border-left-color: #ffc107;
        }
        .tip-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
            border-left-color: #17a2b8;
        }
        .tip-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .tip-content {
            flex: 1;
        }
        .tip-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .tip-message {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* AMÉLIORATION : Boutons de corrélation */
        .correlation-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
        }
        .correlation-btn:hover {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .correlation-btn small {
            display: block;
            margin-top: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 400;
        }

        /* AMÉLIORATION : Call to Action */
        .cta-section {
            text-align: center;
            padding: 40px;
            background-color: #f8f9fa;
            margin: 40px -40px -40px -40px; /* Pour toucher les bords */
        }
        .cta-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
        }

        @media (max-width: 768px) {
            .content { padding: 20px; }
            .section { margin-bottom: 30px; }
            .section h2 { font-size: 1.5rem; }
            .sliders-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .slider-container { padding: 12px; }
            .slider-label { font-size: 0.8rem; }
            .slider-value { font-size: 1rem; }
            .slider-info { font-size: 0.7rem; }
            .kpi-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .kpi-card { padding: 12px; }
            .kpi-title { font-size: 0.7rem; }
            .kpi-value { font-size: 1.3rem; }
            .financial-grid { grid-template-columns: 1fr; }
            .wealth-grid { grid-template-columns: 1fr; gap: 20px; }
            .chart-container { height: 250px; }
            .tabs { flex-wrap: wrap; }
            .tab-button { padding: 8px 15px; font-size: 0.9rem; }
        }

        @media (max-width: 480px) {
            .sliders-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: 1fr; }
        }

        /* AMÉLIORATION : Styles pour l'accordéon */
        .accordion {
            margin-bottom: 20px;
        }
        
        .accordion-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .accordion-header:hover {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .accordion-header.active {
            border-radius: 10px 10px 0 0;
        }
        
        .accordion-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            background: white;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .accordion-content.active {
            max-height: 5000px;
            padding: 30px;
        }
        
        .accordion-content .section {
            margin-bottom: 0;
        }
        
        .accordion-content .section:last-child {
            margin-bottom: 0;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏛️ Constellation</h1>
            <p class="subtitle">Simulateur économique pour votre constellation UPlanet ẐEN</p>
            <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="toggleAllAccordions(true)" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                    📖 Ouvrir toutes les sections
                </button>
                <button onclick="toggleAllAccordions(false)" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                    📚 Fermer toutes les sections
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Accordéon 1: Guide et Contexte -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">🌟 Comprendre le Simulateur Constellation</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content active">
                    <div class="section">
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f8f9fa 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">🎯 Qu'est-ce que Constellation ?</h3>
                    <p style="margin-bottom: 15px; line-height: 1.6;">
                        Ce simulateur vous permet de <strong>modéliser économiquement votre constellation UPlanet</strong> selon les principes de l'économie ẐEN. 
                        Il implémente fidèlement les règles décrites dans le document <code>ZEN.ECONOMY.readme.md</code> : 
                        collecte des loyers, provision fiscale, coûts de production, et répartition coopérative 3x1/3.
                    </p>
                    
                    <h3 style="color: #2c3e50; margin-bottom: 15px; margin-top: 20px;">🏗️ Le Modèle de Constellation</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 3px solid #3498db;">
                            <strong>🏠 Locataires (MULTIPASS) :</strong> Paiement de loyers hebdomadaires (1 Ẑ/semaine) pour services de base (uDRIVE 10GB)
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 3px solid #27ae60;">
                            <strong>💻 Développeurs :</strong> Équipe R&D financée par le fonds coopératif (salaire : 5600 Ẑ/mois)
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 3px solid #f39c12;">
                            <strong>👑 Propriétaires (ZEN Cards) :</strong> Achat de parts sociales annuel (50 Ẑ/an) + 128Go NextCloud illimité
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 3px solid #e74c3c;">
                            <strong>🖥️ Armateurs/Capitaines :</strong> Opérateurs de nœuds (rémunération : PAF + 2xPAF Ẑ/semaine par nœud)
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 3px solid #9c27b0;">
                            <strong>📢 Community Managers :</strong> Animation communautaire (salaire : 1620 Ẑ/mois)
                        </div>
                    </div>
                    
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">💡 Comment utiliser ce simulateur ?</h3>
                    <ol style="line-height: 1.8; margin-left: 20px;">
                        <li><strong>Ajustez les curseurs</strong> selon votre projet (nombre d'utilisateurs, équipe, infrastructure)</li>
                        <li><strong>Observez les KPIs</strong> : point mort, marge brute, emplois créés</li>
                        <li><strong>Analysez les flux financiers</strong> mensuels et annuels</li>
                        <li><strong>Visualisez la création de richesse</strong> selon la règle 3x1/3</li>
                        <li><strong>Évaluez l'impact écologique</strong> (acquisition de forêts-jardins)</li>
                    </ol>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 20px;">
                        <strong>💰 Exemple concret :</strong> Une constellation de 25 nœuds (1 Hub + 24 Satellites) avec 1000 propriétaires (ZEN Cards) et 4000 locataires (MULTIPASS) 
                        génère ~208k Ẑ/an de revenus récurrents + 50k Ẑ/an d'achats de parts sociales, soit ~69k Ẑ/an pour chaque fonds (R&D, Actifs, Trésorerie).
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; margin-top: 15px;">
                        <strong>💼 Rejoignez l'équipe :</strong> Des postes sont actuellement ouverts ! 
                        <a href="https://forum.monnaie-libre.fr/t/rejoignez-lequipe-uplanet-origin-co-creez-un-univers-numerique-libre-et-innovant-100-g1/32738" target="_blank" style="color: #27ae60; text-decoration: underline;">
                            Consultez les offres d'emploi sur le forum Monnaie Libre
                        </a> 
                        (développeurs, community managers, testeurs, artistes NFT...).
                    </div>
                    </div>
                </div>
            </div>

            <!-- Accordéon 2: Paramètres Économiques -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">💰 Paramètres Économiques</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="section">
                <div class="sliders-grid">
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                🏠 Location MULTIPASS (10Go)
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Tarif hebdomadaire MULTIPASS</strong><br/>
                                        • Services de base (stockage, identité NOSTR)<br/>
                                        • Valeur par défaut : 1 Ẑ/semaine<br/>
                                        • <strong>Contrainte technique :</strong> uDRIVE limité à 10GB<br/>
                                        • Ajustez selon votre stratégie tarifaire
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="prixMultipassValue">1.0</div>
                        </div>
                        <input type="range" id="prixMultipass" class="slider" min="0.5" max="3.0" step="0.1" value="1.0">
                        <div class="slider-info">0.5 - 3.0 Ẑ/semaine (uDRIVE 10GB max)</div>
                    </div>
                    
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                ⭐ Prix Achat 128 Go (paiement annuel) ZEN Card
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Prix des parts sociales (paiement annuel)</strong><br/>
                                        • Statut de Propriétaire/Sociétaire avec 128Go NextCloud<br/>
                                        • Valeur par défaut : 50 Ẑ (≈50€)<br/>
                                        • Droits de vote + participation aux bénéfices<br/>
                                        • <strong>Contrainte technique :</strong> NextCloud illimité
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="prixPartsSocialesValue">50</div>
                        </div>
                        <input type="range" id="prixPartsSociales" class="slider" min="20" max="100" step="5" value="50">
                        <div class="slider-info">20 - 100 Ẑ (paiement annuel)</div>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                📊 % MULTIPASS
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Proportion d'utilisateurs MULTIPASS</strong><br/>
                                        • Valeur par défaut : 80% MULTIPASS<br/>
                                        • Le reste sera en ZEN Cards<br/>
                                        • Ajustez selon votre cible clientèle
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="ratioMultipassValue">80</div>
                        </div>
                        <input type="range" id="ratioMultipass" class="slider" min="50" max="95" step="5" value="80">
                        <div class="slider-info">50% - 95% (le reste en ZEN Cards)</div>
                    </div>
                </div>
                    </div>
                </div>
            </div>

            <!-- Accordéon 3: Paramètres Opérationnels -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">📊 Pilotez votre Coopérative</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="section">
                <div class="sliders-grid">
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                🖥️ Capitaines
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Opérateurs de nœuds UPlanet (Stations)</strong><br/>
                                        • Rémunération : 3x PAF Ẑ/semaine par nœud<br/>
                                        • Détail : 1/3 Armateur + 2/3 Capitaine<br/>
                                        • Gèrent l'infrastructure technique<br/>
                                        • Types : Satellites (RPi) ou Hubs (PC Gamer)<br/>
                                        • <strong>Capacité :</strong> 250 MULTIPASS ou 24 ZEN Cards par station<br/>
                                        • Collectent les loyers des utilisateurs<br/>
                                        • Utilisez les boutons de corrélation pour dimensionner
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="nbCapitainesValue">25</div>
                        </div>
                        <input type="range" id="nbCapitaines" class="slider" min="1" max="25" step="1" value="25">
                        <div class="slider-info">1 - 25 nœuds par constellation (3x PAF Ẑ/semaine chacun)</div>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                ⚡ PAF (Participation Aux Frais)
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Participation Aux Frais hebdomadaire</strong><br/>
                                        • Coût de base pour chaque nœud (électricité, internet)<br/>
                                        • Valeur par défaut : 14 Ẑ/semaine<br/>
                                        • Rémunération Armateur = PAF Ẑ/semaine<br/>
                                        • Ajustez selon vos coûts réels d'infrastructure
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="pafValue">14</div>
                        </div>
                        <input type="range" id="paf" class="slider" min="5" max="25" step="1" value="14">
                        <div class="slider-info">5 - 25 Ẑ/semaine (3x PAF = rémunération Capitaine)</div>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                👥 Utilisateurs
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Utilisateurs totaux de votre constellation</strong><br/>
                                        • MULTIPASS : 1 Ẑ/semaine (loyers récurrents)<br/>
                                        • ZEN Cards : 50 Ẑ/an (achat parts sociales + 128Go)<br/>
                                        • Mix typique : 80% MULTIPASS, 20% ZEN Cards<br/>
                                        • <strong>Capacité par station :</strong> 250 MULTIPASS ou 24 ZEN Cards<br/>
                                        • Utilisez les boutons de corrélation automatique ci-dessous
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="nbAbonnesValue">5000</div>
                        </div>
                        <input type="range" id="nbAbonnes" class="slider" min="10" max="6000" step="10" value="5000">
                        <div class="slider-info">10 - 2000 utilisateurs (MULTIPASS + ZEN Cards)</div>
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                💻 Développeurs
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Équipe de développement R&D</strong><br/>
                                        • Financés par le fonds .RND (1/3 du surplus coopératif)<br/>
                                        • Développent l'infrastructure UPlanet<br/>
                                        • Salaire ajustable ci-dessous
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="nbDevsValue">2</div>
                        </div>
                        <input type="range" id="nbDevs" class="slider" min="0" max="10" step="1" value="2">
                        <div class="slider-info">0 - 10 développeurs</div>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                💰 Salaire Développeur
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Salaire mensuel par développeur</strong><br/>
                                        • Fourchette réelle : 3080-5600 Ẑ/mois<br/>
                                        • Paiement : toutes les 2 semaines<br/>
                                        • Ajustez selon l'expérience et les compétences
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="salaireDevValue">4340</div>
                        </div>
                        <input type="range" id="salaireDev" class="slider" min="3000" max="6000" step="100" value="4340">
                        <div class="slider-info">3000 - 6000 Ẑ/mois</div>
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                📢 Community Managers
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Équipe d'animation communautaire</strong><br/>
                                        • Financés par le fonds .RND<br/>
                                        • Animent les communautés locales<br/>
                                        • Accompagnent les nouveaux utilisateurs<br/>
                                        • Organisent événements et formations<br/>
                                        • Salaire ajustable ci-dessous
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="nbCommunityManagersValue">1</div>
                        </div>
                        <input type="range" id="nbCommunityManagers" class="slider" min="0" max="5" step="1" value="1">
                        <div class="slider-info">0 - 5 community managers</div>
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-header">
                            <div class="slider-label">
                                💰 Salaire Community Manager
                                <div class="tooltip">
                                    <div class="info-icon">?</div>
                                    <span class="tooltiptext">
                                        <strong>Salaire mensuel par Community Manager</strong><br/>
                                        • Fourchette réelle : 1100-1620 Ẑ/mois<br/>
                                        • Paiement : toutes les 2 semaines (550-810 Ẑ)<br/>
                                        • Ajustez selon l'expérience et la charge de travail
                                    </span>
                                </div>
                            </div>
                            <div class="slider-value" id="salaireCMValue">1360</div>
                        </div>
                        <input type="range" id="salaireCM" class="slider" min="1000" max="2000" step="50" value="1360">
                        <div class="slider-info">1000 - 2000 Ẑ/mois</div>
                    </div>
                </div>
                 <!-- AMÉLIORATION : Section KPI -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">POINT MORT (en utilisateurs)</div>
                        <div class="kpi-value" id="breakEven">N/A</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">MARGE BRUTE</div>
                        <div class="kpi-value" id="grossMargin">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">EMPLOIS LOCAUX CRÉÉS</div>
                        <div class="kpi-value" id="jobsCreated">3</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">PRIX MOYEN/ABONNÉ</div>
                        <div class="kpi-value" id="avgPrice">0 Ẑ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">COÛTS FIXES/4 SEMAINES</div>
                        <div class="kpi-value" id="fixedCosts">0 Ẑ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">TAUX UTILISATION</div>
                        <div class="kpi-value" id="utilizationRate">0%</div>
                    </div>
                </div>
                
                <!-- Indicateur de capacité constellation -->
                <div class="tips-container" id="capacity-info">
                    <!-- Les indicateurs de capacité seront générés dynamiquement par JavaScript -->
                </div>
                
                <!-- Boutons de corrélation automatique -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">🔗 Corrélation Automatique Stations ↔ Utilisateurs</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button onclick="autoCorrelateCapacity('mixed')" class="correlation-btn">
                            📊 Mix Optimal<br/>
                            <small>80% MULTIPASS + 20% ZEN Cards</small>
                        </button>
                        <button onclick="autoCorrelateCapacity('multipass')" class="correlation-btn">
                            🏠 Locataires Max<br/>
                            <small>250 MULTIPASS par station</small>
                        </button>
                        <button onclick="autoCorrelateCapacity('zencard')" class="correlation-btn">
                            👑 Propriétaires Max<br/>
                            <small>24 ZEN Cards par station</small>
                        </button>
                    </div>
                </div>
                
                <!-- Répartition des utilisateurs -->
                <div id="abonnes-breakdown">
                    <!-- La répartition sera générée dynamiquement par JavaScript -->
                </div>
                
                <!-- Validation des Contraintes de Tokenisation -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">🔍 Validation des Contraintes de Tokenisation</h3>
                    <div id="tokenization-validation">
                        <!-- La validation sera générée dynamiquement par JavaScript -->
                    </div>
                </div>
                
                <!-- Conseils contextuels -->
                <div class="tips-container" id="contextual-tips">
                    <!-- Les conseils seront générés dynamiquement par JavaScript -->
                </div>
                    </div>
                </div>
            </div>

            <!-- Accordéon 4: Tableau de Bord Financier -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">📊 Tableau de Bord Financier</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="section">
                        <div class="tabs">
                            <button class="tab-button active" onclick="openTab(event, 'monthly')">📅 Vue 4 Semaines</button>
                            <button class="tab-button" onclick="openTab(event, 'yearly')">📊 Projection 13 Cycles</button>
                        </div>

                <div id="monthly" class="tab-content active">
                     <h2>📅 Tableau de Bord Financier (4 semaines) (en Ẑen / €)</h2>
                     <div class="financial-grid" id="monthly-financials">
                        <!-- Le contenu sera généré par JS -->
                     </div>
                </div>

                <div id="yearly" class="tab-content">
                    <h2>💰 Projection sur 13 cycles</h2>
                    <p style="text-align:center; margin-bottom:20px; color:#7f8c8d;">Cette projection suppose des paramètres constants sur l'année (13 cycles de 4 semaines).</p>
                    <div class="financial-grid" id="yearly-financials">
                        <!-- Le contenu sera généré par JS -->
                    </div>
                </div>
                    </div>
                </div>
            </div>

            <!-- Accordéon 5: Création de Richesse -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">🌱 Création de Richesse Commune</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="section">
                <div class="wealth-grid">
                    <div class="chart-container">
                        <canvas id="wealthChart"></canvas>
                    </div>
                    <div class="legend" id="legend-container">
                        <!-- Le contenu sera généré par JS -->
                    </div>
                </div>
                <div class="impact-statement" id="impactStatement">
                    🌳 Impact Écologique ce cycle : Votre coopérative finance l'acquisition de 0 m² de forêt-jardin !
                </div>
                    </div>
                </div>
            </div>

            <!-- Accordéon 6: Exemples et Scénarios -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">🎯 Exemples Concrets et Scénarios d'Usage</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="section">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Scénario 1: Petit Satellite -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #2196f3;">
                        <h3 style="color: #1976d2; margin-bottom: 15px;">🛰️ Scénario "Satellite Local"</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>Configuration :</strong><br/>
                            • 100 utilisateurs (80 MULTIPASS + 20 ZEN Cards)<br/>
                            • 1 développeur<br/>
                            • 0 community manager<br/>
                            • 10 nœuds (Raspberry Pi)
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>Résultats attendus :</strong><br/>
                            • Point mort : ~150 utilisateurs<br/>
                            • Marge brute : ~60%<br/>
                            • Impact : Financement partiel d'1 poste R&D<br/>
                            • Écologie : ~50 m² de forêt/mois
                        </div>
                    </div>

                    <!-- Scénario 2: Constellation Moyenne -->
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #4caf50;">
                        <h3 style="color: #388e3c; margin-bottom: 15px;">🌟 Scénario "Constellation Régionale"</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>Configuration :</strong><br/>
                            • 500 utilisateurs (400 MULTIPASS + 100 ZEN Cards)<br/>
                            • 2 développeurs<br/>
                            • 1 community manager<br/>
                            • 25 nœuds (1 Hub + 24 Satellites)
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>Résultats attendus :</strong><br/>
                            • Point mort : ~180 utilisateurs<br/>
                            • Marge brute : ~85%<br/>
                            • Impact : Équipe R&D complète<br/>
                            • Écologie : ~400 m² de forêt/mois
                        </div>
                    </div>

                    <!-- Scénario 3: Grande Constellation -->
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%); padding: 20px; border-radius: 15px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #f57c00; margin-bottom: 15px;">🚀 Scénario "Méga-Constellation"</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>Configuration :</strong><br/>
                            • 1500 utilisateurs (1200 MULTIPASS + 300 ZEN Cards)<br/>
                            • 5 développeurs<br/>
                            • 3 community managers<br/>
                            • 100 nœuds (4 Hubs + 96 Satellites)
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>Résultats attendus :</strong><br/>
                            • Point mort : ~220 utilisateurs<br/>
                            • Marge brute : ~90%<br/>
                            • Impact : Écosystème R&D complet<br/>
                            • Écologie : ~1500 m² de forêt/mois
                        </div>
                    </div>
                </div>

                <!-- Guide d'utilisation pratique -->
                <div style="background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%); padding: 25px; border-radius: 15px; border-left: 4px solid #9c27b0;">
                    <h3 style="color: #7b1fa2; margin-bottom: 20px;">📋 Guide d'Utilisation Pratique</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div>
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">🎯 Pour Évaluer la Viabilité</h4>
                            <ul style="line-height: 1.6; margin-left: 20px;">
                                <li>Fixez votre nombre d'utilisateurs cible</li>
                                <li>Observez le point mort (seuil de rentabilité)</li>
                                <li>Vérifiez que la marge brute > 50%</li>
                                <li>Analysez l'impact écologique généré</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">💰 Pour Planifier les Investissements</h4>
                            <ul style="line-height: 1.6; margin-left: 20px;">
                                <li>Ajustez le nombre de développeurs selon vos besoins R&D</li>
                                <li>Dimensionnez l'infrastructure (nœuds) selon la charge</li>
                                <li>Évaluez les emplois locaux créés</li>
                                <li>Projetez sur 12 mois pour la planification</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">🌱 Pour Mesurer l'Impact</h4>
                            <ul style="line-height: 1.6; margin-left: 20px;">
                                <li>Visualisez la répartition 3x1/3 des bénéfices</li>
                                <li>Calculez l'acquisition de forêts-jardins</li>
                                <li>Évaluez la contribution au fonds R&D commun</li>
                                <li>Mesurez la création de valeur locale</li>
                            </ul>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
            
            <!-- Accordéon 7: Call to Action -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h2 style="margin: 0; color: white;">🚀 Rejoignez l'Équipe</h2>
                    <span class="accordion-icon">▼</span>
                </div>
                <div class="accordion-content">
                    <div class="cta-section">
                <h2>Prêt à construire votre souveraineté numérique ?</h2>
                <p style="margin-top:10px; margin-bottom:25px; color:#7f8c8d; max-width:600px; margin-left:auto; margin-right:auto;">
                    Ce simulateur démontre la viabilité d'un modèle économique plus juste, transparent et régénératif. 
                    Rejoignez la coopérative pour en faire une réalité.
                </p>
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <a href="https://github.com/papiche/Astroport.ONE" target="_blank" class="cta-button">Découvrir le projet sur GitHub</a>
                    <a href="https://forum.monnaie-libre.fr/t/rejoignez-lequipe-uplanet-origin-co-creez-un-univers-numerique-libre-et-innovant-100-g1/32738" target="_blank" class="cta-button" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">💼 Voir les offres d'emploi</a>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constantes fixes
        const C = {
            TAUX_TVA: 0.20,
            TAUX_IS: 0.25,
            REMUNERATION_CAPITAINE: 42, // 3x PAF (14 Ẑ Armateur + 28 Ẑ Capitaine = 42 Ẑ/semaine)
            PRIX_M2_FORET: 2,
            SEMAINES_PAR_CYCLE: 4, // 4 semaines par cycle (période de 4 semaines)
            CYCLES_PAR_AN: 13,     // 13 cycles par an (52 semaines ÷ 4 = 13)
            // Capacités par station
            LOCATAIRES_PAR_STATION: 250,  // MULTIPASS par station
            PROPRIETAIRES_PAR_STATION: 24, // ZEN Cards par station
        };
        
        // Fonction pour récupérer les valeurs dynamiques
        function getDynamicValues() {
            return {
                prixMultipass: parseFloat(document.getElementById('prixMultipass').value),
                prixPartsSociales: parseInt(document.getElementById('prixPartsSociales').value),
                ratioMultipass: parseInt(document.getElementById('ratioMultipass').value) / 100,
                ratioZenCard: (100 - parseInt(document.getElementById('ratioMultipass').value)) / 100,
                salaireDev: parseInt(document.getElementById('salaireDev').value),
                salaireCM: parseInt(document.getElementById('salaireCM').value),
                paf: parseInt(document.getElementById('paf').value)
            };
        }

        let wealthChart = null;
        
        // Fonctions Utilitaires
        const formatNumber = (num) => new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 0 }).format(num);
        const formatCurrency = (num) => `${formatNumber(num)} Ẑ`;
        
        // Calcul de la capacité théorique d'une constellation
        function calculateConstellationCapacity(nbCapitaines) {
            const values = getDynamicValues();
            const multipassCapacity = nbCapitaines * C.LOCATAIRES_PAR_STATION;
            const zencardCapacity = nbCapitaines * C.PROPRIETAIRES_PAR_STATION;
            const mixedCapacity = Math.floor(multipassCapacity * values.ratioMultipass + zencardCapacity * values.ratioZenCard);
            
            return {
                multipassOnly: multipassCapacity,
                zencardOnly: zencardCapacity,
                mixed: mixedCapacity,
                multipassInMix: Math.floor(mixedCapacity * values.ratioMultipass),
                zencardInMix: Math.floor(mixedCapacity * values.ratioZenCard)
            };
        }
        
        // Mise à jour des indicateurs de capacité
        function updateCapacityIndicators(nbCapitaines, nbAbonnes) {
            const capacity = calculateConstellationCapacity(nbCapitaines);
            const utilizationRate = (nbAbonnes / capacity.mixed * 100).toFixed(1);
            
            // Mise à jour de l'affichage de la capacité
            const capacityInfo = document.getElementById('capacity-info');
            if (capacityInfo) {
                let statusClass = 'info';
                let statusIcon = '📊';
                let statusText = 'Utilisation normale';
                
                if (utilizationRate > 100) {
                    statusClass = 'warning';
                    statusIcon = '⚠️';
                    statusText = 'Surcharge - Ajoutez des stations';
                } else if (utilizationRate > 80) {
                    statusClass = 'warning';
                    statusIcon = '📈';
                    statusText = 'Approche de la capacité max';
                } else if (utilizationRate < 20) {
                    statusClass = 'info';
                    statusIcon = '📉';
                    statusText = 'Sous-utilisation - Potentiel de croissance';
                } else {
                    statusClass = 'success';
                    statusIcon = '✅';
                    statusText = 'Utilisation optimale';
                }
                
                capacityInfo.innerHTML = `
                    <div class="capacity-card tip-${statusClass}">
                        <div class="tip-icon">${statusIcon}</div>
                        <div class="tip-content">
                            <div class="tip-title">Capacité Constellation : ${utilizationRate}%</div>
                            <div class="tip-message">
                                ${statusText}<br/>
                                <strong>Capacité max :</strong> ${formatNumber(capacity.mixed)} utilisateurs 
                                (${formatNumber(capacity.multipassInMix)} MULTIPASS + ${formatNumber(capacity.zencardInMix)} ZEN Cards)
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Mise à jour de l'affichage de la répartition des utilisateurs
        function updateAbonnesBreakdown(nbMultipass, nbZenCards, nbTotal) {
            const breakdownContainer = document.getElementById('abonnes-breakdown');
            if (breakdownContainer) {
                const values = getDynamicValues();
                const revenuMultipass = nbMultipass * values.prixMultipass * C.SEMAINES_PAR_CYCLE;
                const achatZenCards = nbZenCards * values.prixPartsSociales; // Paiement annuel unique
                const revenuTotal = revenuMultipass + achatZenCards;
                
                breakdownContainer.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">📊 Répartition des ${formatNumber(nbTotal)} Utilisateurs</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #3498db;">
                                <div style="font-weight: 600; color: #3498db;">🏠 MULTIPASS</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #2c3e50;">${formatNumber(nbMultipass)} utilisateurs</div>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">${formatCurrency(revenuMultipass)}/cycle</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #f39c12;">
                                <div style="font-weight: 600; color: #f39c12;">👑 ZEN CARDS</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #2c3e50;">${formatNumber(nbZenCards)} propriétaires</div>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">${formatCurrency(achatZenCards)}/an (achat)</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                            <strong>Total CA (HT) : ${formatCurrency(revenuTotal)}/cycle (loyers + achats)</strong>
                        </div>
                    </div>
                `;
            }
        }
        
        // Fonction de corrélation automatique
        function autoCorrelateCapacity(mode) {
            const nbCapitaines = parseInt(document.getElementById('nbCapitaines').value);
            const capacity = calculateConstellationCapacity(nbCapitaines);
            let targetAbonnes;
            
            switch(mode) {
                case 'mixed':
                    targetAbonnes = capacity.mixed;
                    break;
                case 'multipass':
                    targetAbonnes = capacity.multipassOnly;
                    break;
                case 'zencard':
                    targetAbonnes = capacity.zencardOnly;
                    break;
                default:
                    targetAbonnes = capacity.mixed;
            }
            
            // Mise à jour du curseur Utilisateurs
            const abonnesSlider = document.getElementById('nbAbonnes');
            abonnesSlider.value = Math.min(targetAbonnes, parseInt(abonnesSlider.max));
            
            // Mise à jour de l'affichage et recalcul
            updateSliderValues();
            calculateEconomy();
            
            // Feedback visuel
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '✅ Appliqué !';
            btn.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
            btn.style.color = 'white';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
                btn.style.color = '';
            }, 1500);
        }

        // Ajustement dynamique du curseur Utilisateurs selon le nombre de Capitaines
        function adjustAbonnesSlider(nbCapitaines) {
            const capacity = calculateConstellationCapacity(nbCapitaines);
            const abonnesSlider = document.getElementById('nbAbonnes');
            const currentValue = parseInt(abonnesSlider.value);
            
            // Définir le nouveau maximum (capacité mixte + 20% de marge)
            const newMax = Math.ceil(capacity.mixed * 1.2);
            abonnesSlider.max = newMax;
            
            // Si la valeur actuelle dépasse le nouveau max, l'ajuster
            if (currentValue > newMax) {
                abonnesSlider.value = newMax;
            }
            
            // Mettre à jour l'info du slider
            const sliderInfo = abonnesSlider.parentElement.querySelector('.slider-info');
            sliderInfo.textContent = `10 - ${formatNumber(newMax)} utilisateurs (capacité constellation)`;
        }

        // Mise à jour des valeurs des sliders
        function updateSliderValues() {
            const sliders = [
                'prixMultipass', 'prixPartsSociales', 'ratioMultipass',
                'nbCapitaines', 'paf', 'nbAbonnes', 'nbDevs', 'salaireDev', 'nbCommunityManagers', 'salaireCM'
            ];
            
            sliders.forEach(id => {
                const element = document.getElementById(`${id}Value`);
                const slider = document.getElementById(id);
                if (element && slider) {
                    let value = slider.value;
                    // Formatage spécial pour certains curseurs
                    if (id === 'ratioMultipass') {
                        value = value + '%';
                    } else if (id.includes('prix') && id !== 'prixPartsSociales') {
                        value = parseFloat(value).toFixed(1);
                    }
                    element.textContent = value;
                }
            });
        }
        
        // Génération du HTML pour les tableaux financiers
        function createFinancialHTML(period, data) {
            const isYearly = period === 'yearly';
            const multiplier = isYearly ? C.CYCLES_PAR_AN : 1;
            const container = document.getElementById(`${period}-financials`);
            
            container.innerHTML = `
                <!-- Section Revenus -->
                <div style="grid-column: 1 / -1; background: #e8f5e8; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <h4 style="color: #27ae60; margin: 0; font-size: 0.9rem;">💰 REVENUS</h4>
                </div>
                <div class="financial-item revenue">
                    <div class="financial-label">💳 CA Encaissé (TTC)</div>
                    <div class="financial-value positive">${formatCurrency(data.chiffreAffairesTTC * multiplier)}</div>
                </div>
                <div class="financial-item cost">
                    <div class="financial-label">🏛️ TVA provisionnée</div>
                    <div class="financial-value negative">-${formatCurrency(data.montantTVA * multiplier)}</div>
                </div>
                <div class="financial-item revenue">
                    <div class="financial-label">📈 CA Réel (HT)</div>
                    <div class="financial-value positive">${formatCurrency(data.chiffreAffairesHT * multiplier)}</div>
                </div>
                
                <!-- Section Coûts -->
                <div style="grid-column: 1 / -1; background: #fadbd8; padding: 10px; border-radius: 8px; margin: 15px 0 10px 0;">
                    <h4 style="color: #e74c3c; margin: 0; font-size: 0.9rem;">💸 COÛTS</h4>
                </div>
                <div class="financial-item cost">
                    <div class="financial-label">🖥️ Rémunération Capitaines</div>
                    <div class="financial-value negative">-${formatCurrency(data.coutsInfra * multiplier)}</div>
                </div>
                <div class="financial-item cost">
                    <div class="financial-label">🔬 Coûts R&D</div>
                    <div class="financial-value negative">-${formatCurrency(data.coutsRD * multiplier)}</div>
                </div>
                
                <!-- Section Résultats -->
                <div style="grid-column: 1 / -1; background: #d1ecf1; padding: 10px; border-radius: 8px; margin: 15px 0 10px 0;">
                    <h4 style="color: #0c5460; margin: 0; font-size: 0.9rem;">📊 RÉSULTATS</h4>
                </div>
                <div class="financial-item highlight">
                    <div class="financial-label">💡 Marge Brute</div>
                    <div class="financial-value ${data.margeBrute >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.margeBrute * multiplier)}</div>
                </div>
                <div class="financial-item highlight">
                    <div class="financial-label">📊 Résultat Avant Impôt</div>
                    <div class="financial-value ${data.resultatAvantImpot >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.resultatAvantImpot * multiplier)}</div>
                </div>
                <div class="financial-item cost">
                    <div class="financial-label">🏛️ Impôt Sociétés (25%)</div>
                    <div class="financial-value negative">-${formatCurrency(data.montantIS * multiplier)}</div>
                </div>
                <div class="financial-item highlight" style="background: linear-gradient(135deg, #d5f4e6 0%, #ffffff 100%); border-left-color: #27ae60; font-weight: 700;">
                    <div class="financial-label">✨ Résultat Net</div>
                    <div class="financial-value ${data.resultatNet >= 0 ? 'positive' : 'negative'}" style="font-size: 1.1rem;">${formatCurrency(data.resultatNet * multiplier)}</div>
                </div>
            `;
        }


        // Fonction principale de calcul
        function calculateEconomy() {
            const nbAbonnes = parseInt(document.getElementById('nbAbonnes').value);
            const nbDevs = parseInt(document.getElementById('nbDevs').value);
            const nbCM = parseInt(document.getElementById('nbCommunityManagers').value);
            const nbCapitaines = parseInt(document.getElementById('nbCapitaines').value);
            const values = getDynamicValues();
            
            // Ajuster le curseur Utilisateurs selon le nombre de Capitaines
            adjustAbonnesSlider(nbCapitaines);
            
            // Calcul de la répartition des utilisateurs
            const nbMultipass = Math.floor(nbAbonnes * values.ratioMultipass);
            const nbZenCards = nbAbonnes - nbMultipass;
            
            // Mise à jour de l'affichage de la répartition
            updateAbonnesBreakdown(nbMultipass, nbZenCards, nbAbonnes);
            
            // Calculs mensuels
            const coutsRD = (nbDevs * values.salaireDev) + (nbCM * values.salaireCM);
            const remunerationCapitaine = nbCapitaines * (values.paf * 3); // 3x PAF
            const coutsInfra = nbCapitaines * values.paf; // PAF pour l'infrastructure
            const coutsFixesHT = coutsRD + remunerationCapitaine;

            // Chiffre d'affaires avec prix dynamiques (conversion hebdomadaire -> cycle 4 semaines)
            // Seuls les revenus MULTIPASS sont comptés (loyers), les ZEN Cards sont des achats de parts sociales
            const chiffreAffairesHT = nbMultipass * values.prixMultipass * C.SEMAINES_PAR_CYCLE;
            const montantTVA = chiffreAffairesHT * C.TAUX_TVA;
            const chiffreAffairesTTC = chiffreAffairesHT + montantTVA;

            const margeBrute = chiffreAffairesHT - remunerationCapitaine;
            const resultatAvantImpot = margeBrute - coutsRD;
            const montantIS = (resultatAvantImpot > 0) ? resultatAvantImpot * C.TAUX_IS : 0;
            const resultatNet = resultatAvantImpot - montantIS;

            const monthlyData = {
                chiffreAffairesTTC, montantTVA, chiffreAffairesHT, coutsInfra: remunerationCapitaine, margeBrute,
                coutsRD, resultatAvantImpot, montantIS, resultatNet
            };

            // Mise à jour des affichages mensuels et annuels
            createFinancialHTML('monthly', monthlyData);
            createFinancialHTML('yearly', monthlyData);

            // Mise à jour des KPIs avec classes CSS dynamiques
            // Calcul du prix moyen pondéré par utilisateur
            // Calcul du prix moyen pondéré par abonné (seuls les MULTIPASS génèrent des revenus récurrents)
            const prixMoyenParAbonne = values.prixMultipass * C.SEMAINES_PAR_CYCLE; // conversion hebdo -> cycle 4 semaines
            const breakEven = Math.ceil(coutsFixesHT / prixMoyenParAbonne);
            const breakEvenElement = document.getElementById('breakEven');
            const breakEvenCard = breakEvenElement.closest('.kpi-card');
            breakEvenElement.textContent = formatNumber(breakEven);
            
            // Coloration du point mort selon la situation
            breakEvenCard.className = 'kpi-card';
            if (nbAbonnes >= breakEven) {
                breakEvenCard.classList.add('positive');
            } else if (nbAbonnes >= breakEven * 0.8) {
                breakEvenCard.classList.add('warning');
            } else {
                breakEvenCard.classList.add('negative');
            }
            
            const grossMargin = chiffreAffairesHT > 0 ? (margeBrute / chiffreAffairesHT) * 100 : 0;
            const grossMarginElement = document.getElementById('grossMargin');
            const grossMarginCard = grossMarginElement.closest('.kpi-card');
            grossMarginElement.textContent = `${formatNumber(grossMargin)}%`;
            
            // Coloration de la marge brute
            grossMarginCard.className = 'kpi-card';
            if (grossMargin >= 50) {
                grossMarginCard.classList.add('positive');
            } else if (grossMargin >= 20) {
                grossMarginCard.classList.add('warning');
            } else {
                grossMarginCard.classList.add('negative');
            }
            
            document.getElementById('jobsCreated').textContent = formatNumber(nbDevs + nbCM);
            
            // Mise à jour des KPIs supplémentaires
            document.getElementById('avgPrice').textContent = formatCurrency(prixMoyenParAbonne);
            document.getElementById('fixedCosts').textContent = formatCurrency(coutsFixesHT);
            
            // Calcul du taux d'utilisation de la constellation
            const capacity = calculateConstellationCapacity(nbCapitaines);
            const utilizationRate = (nbAbonnes / capacity.mixed * 100).toFixed(1);
            const utilizationElement = document.getElementById('utilizationRate');
            const utilizationCard = utilizationElement.closest('.kpi-card');
            utilizationElement.textContent = utilizationRate + '%';
            
            // Coloration du taux d'utilisation
            utilizationCard.className = 'kpi-card';
            if (utilizationRate > 100) {
                utilizationCard.classList.add('negative');
            } else if (utilizationRate > 80) {
                utilizationCard.classList.add('warning');
            } else if (utilizationRate < 20) {
                utilizationCard.classList.add('warning');
            } else {
                utilizationCard.classList.add('positive');
            }

        // Affichage des conseils contextuels
        showContextualTips(nbAbonnes, breakEven, grossMargin);
        
        // Mise à jour des indicateurs de capacité
        updateCapacityIndicators(nbCapitaines, nbAbonnes);

        // Validation des contraintes de tokenisation
        validateTokenizationConstraints(nbMultipass, nbZenCards, nbCapitaines);

        // Mise à jour de la section richesse
        updateWealthSection(resultatNet, monthlyData);
        }

        // Mise à jour de la section Richesse (graphique, légende, impact)
        function updateWealthSection(resultatNet, monthlyData) {
            const legendContainer = document.getElementById('legend-container');
            const impactStatement = document.getElementById('impactStatement');
            
            if (resultatNet > 0) {
                const part = resultatNet / 3;
                const m2Foret = part / C.PRIX_M2_FORET;
                
                legendContainer.innerHTML = `
                    <h3 style="margin-bottom: 20px;">Répartition 3x1/3</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ecf0f1;">
                        <div class="legend-label">
                            <div style="width:15px;height:15px;background:#3498db;border-radius:3px;margin-right:10px;"></div>
                            .TREASURY (Stabilité)
                        </div>
                        <div style="font-weight: 700; color: #27ae60;">${formatCurrency(part)}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #ecf0f1;">
                        <div class="legend-label">
                            <div style="width:15px;height:15px;background:#27ae60;border-radius:3px;margin-right:10px;"></div>
                            .ASSETS (Investissement)
                        </div>
                        <div style="font-weight: 700; color: #27ae60;">${formatCurrency(part)}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                        <div class="legend-label">
                            <div style="width:15px;height:15px;background:#f39c12;border-radius:3px;margin-right:10px;"></div>
                            Bonus / R&D
                        </div>
                        <div style="font-weight: 700; color: #27ae60;">${formatCurrency(part)}</div>
                    </div>
                `;
                impactStatement.textContent = `🌳 Impact Écologique ce cycle : Votre coopérative finance l'acquisition de ${formatNumber(m2Foret)} m² de forêt-jardin !`;
                updateChart([part, part, part], ['#3498db', '#27ae60', '#f39c12'], 'doughnut', resultatNet);
            } else {
                legendContainer.innerHTML = `<p style="text-align:center; color:#7f8c8d;">Le résultat net doit être positif pour créer de la richesse commune.</p>`;
                impactStatement.textContent = `🌱 Optimisez vos paramètres pour générer un impact positif !`;
                
                // Utiliser les données passées en paramètre au lieu d'essayer de lire le DOM
                const revenusHT = Math.abs(monthlyData.chiffreAffairesHT);
                const depensesHT = Math.abs(monthlyData.coutsInfra) + Math.abs(monthlyData.coutsRD);
                updateChart([revenusHT, depensesHT], ['#27ae60', '#e74c3c'], 'bar', resultatNet);
            }
        }
        
        // Mise à jour du graphique
        function updateChart(data, colors, type, resultatNet) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            const total = data.reduce((a, b) => a + b, 0);

            if (wealthChart) wealthChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                         callbacks: {
                            label: (context) => `${context.label}: ${formatCurrency(context.parsed)}`
                        }
                    },
                    // AMÉLIORATION : Texte au centre du doughnut
                    datalabels: {
                        formatter: () => '', // Cache les labels sur les segments
                    },
                }
            };
            
            let chartConfig;
            if (type === 'doughnut') {
                chartConfig = {
                    type: 'doughnut',
                    data: {
                        labels: ['.TREASURY', '.ASSETS', 'Bonus/R&D'],
                        datasets: [{ data, backgroundColor: colors, borderWidth: 0 }]
                    },
                    options: { ...chartOptions, cutout: '60%' },
                     plugins: [{ // Plugin pour écrire au centre
                        beforeDraw: function(chart) {
                            var width = chart.width, height = chart.height, ctx = chart.ctx;
                            ctx.restore();
                            var fontSize = (height / 160).toFixed(2);
                            ctx.font = "600 " + fontSize + "em Inter";
                            ctx.textBaseline = "middle";
                            
                            var text = formatCurrency(resultatNet);
                            var textX = Math.round((width - ctx.measureText(text).width) / 2);
                            var textY = height / 2;
                            
                            ctx.fillStyle = '#27ae60';
                            ctx.fillText(text, textX, textY - (fontSize * 8));

                            ctx.font = "400 " + (fontSize * 0.6) + "em Inter";
                            var subtext = "Résultat Net";
                            var subtextX = Math.round((width - ctx.measureText(subtext).width) / 2);
                             ctx.fillStyle = '#7f8c8d';
                            ctx.fillText(subtext, subtextX, textY + (fontSize * 8));
                            ctx.save();
                        }
                    }]
                };
            } else { // Bar chart for loss
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: ['Revenus (HT)', 'Dépenses (HT)'],
                        datasets: [{ data, backgroundColor: colors }]
                    },
                    options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
                };
            }
            wealthChart = new Chart(ctx, chartConfig);
        }

        // Gestion des onglets
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // Gestion de l'accordéon
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.accordion-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.classList.remove('active');
                icon.textContent = '▼';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                icon.textContent = '▲';
            }
        }

        // Fonction pour ouvrir/fermer tous les accordéons
        function toggleAllAccordions(openAll = true) {
            const accordions = document.querySelectorAll('.accordion');
            accordions.forEach(accordion => {
                const header = accordion.querySelector('.accordion-header');
                const content = accordion.querySelector('.accordion-content');
                const icon = accordion.querySelector('.accordion-icon');
                
                if (openAll) {
                    content.classList.add('active');
                    header.classList.add('active');
                    icon.textContent = '▲';
                } else {
                    content.classList.remove('active');
                    header.classList.remove('active');
                    icon.textContent = '▼';
                }
            });
        }

        // Fonction pour valider les contraintes de tokenisation
        function validateTokenizationConstraints(nbMultipass, nbZenCards, nbCapitaines) {
            const validationContainer = document.getElementById('tokenization-validation');
            if (!validationContainer) return;
            
            const capacity = calculateConstellationCapacity(nbCapitaines);
            const totalAbonnes = nbMultipass + nbZenCards;
            
            let validationResults = [];
            
            // Validation capacité MULTIPASS
            if (nbMultipass > capacity.multipassOnly) {
                validationResults.push({
                    type: 'error',
                    icon: '❌',
                    title: 'Dépassement capacité MULTIPASS',
                    message: `${formatNumber(nbMultipass)} MULTIPASS > ${formatNumber(capacity.multipassOnly)} max (${nbCapitaines} stations × 250)`
                });
            } else if (nbMultipass > capacity.multipassOnly * 0.8) {
                validationResults.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Capacité MULTIPASS proche du maximum',
                    message: `${formatNumber(nbMultipass)} MULTIPASS sur ${formatNumber(capacity.multipassOnly)} max (${Math.round(nbMultipass/capacity.multipassOnly*100)}%)`
                });
            } else {
                validationResults.push({
                    type: 'success',
                    icon: '✅',
                    title: 'Capacité MULTIPASS OK',
                    message: `${formatNumber(nbMultipass)} MULTIPASS sur ${formatNumber(capacity.multipassOnly)} max (${Math.round(nbMultipass/capacity.multipassOnly*100)}%)`
                });
            }
            
            // Validation capacité ZEN Cards
            if (nbZenCards > capacity.zencardOnly) {
                validationResults.push({
                    type: 'error',
                    icon: '❌',
                    title: 'Dépassement capacité ZEN Cards',
                    message: `${formatNumber(nbZenCards)} ZEN Cards > ${formatNumber(capacity.zencardOnly)} max (${nbCapitaines} stations × 24)`
                });
            } else if (nbZenCards > capacity.zencardOnly * 0.8) {
                validationResults.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Capacité ZEN Cards proche du maximum',
                    message: `${formatNumber(nbZenCards)} ZEN Cards sur ${formatNumber(capacity.zencardOnly)} max (${Math.round(nbZenCards/capacity.zencardOnly*100)}%)`
                });
            } else {
                validationResults.push({
                    type: 'success',
                    icon: '✅',
                    title: 'Capacité ZEN Cards OK',
                    message: `${formatNumber(nbZenCards)} ZEN Cards sur ${formatNumber(capacity.zencardOnly)} max (${Math.round(nbZenCards/capacity.zencardOnly*100)}%)`
                });
            }
            
            // Validation contraintes techniques
            const multipassStorageGB = nbMultipass * 0.1; // Estimation 100MB par MULTIPASS
            const zencardStorageGB = nbZenCards * 1.0; // Estimation 1GB par ZEN Card
            
            if (multipassStorageGB > 1000) { // 1TB limite technique
                validationResults.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Stockage uDRIVE élevé',
                    message: `Estimation: ${formatNumber(multipassStorageGB)} GB (limite technique: 1TB)`
                });
            }
            
            if (zencardStorageGB > 5000) { // 5TB limite technique
                validationResults.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Stockage NextCloud élevé',
                    message: `Estimation: ${formatNumber(zencardStorageGB)} GB (limite technique: 5TB)`
                });
            }
            
            // Affichage des résultats
            validationContainer.innerHTML = validationResults.map(result => `
                <div class="tip-card tip-${result.type}">
                    <div class="tip-icon">${result.icon}</div>
                    <div class="tip-content">
                        <div class="tip-title">${result.title}</div>
                        <div class="tip-message">${result.message}</div>
                    </div>
                </div>
            `).join('');
        }

        // Fonction pour afficher des conseils contextuels
        function showContextualTips(nbAbonnes, breakEven, grossMargin) {
            const tipsContainer = document.getElementById('contextual-tips');
            if (!tipsContainer) return;
            
            let tips = [];
            
            if (nbAbonnes < breakEven) {
                tips.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'Sous le seuil de rentabilité',
                    message: `Il vous faut ${breakEven - nbAbonnes} utilisateurs supplémentaires pour atteindre l'équilibre.`
                });
            } else if (nbAbonnes < breakEven * 1.5) {
                tips.push({
                    type: 'info',
                    icon: '💡',
                    title: 'Marge de sécurité faible',
                    message: 'Considérez augmenter votre base d\'utilisateurs pour plus de stabilité.'
                });
            } else {
                tips.push({
                    type: 'success',
                    icon: '✅',
                    title: 'Modèle viable !',
                    message: 'Votre constellation génère un surplus significatif pour la coopérative.'
                });
            }
            
            if (grossMargin > 80) {
                tips.push({
                    type: 'success',
                    icon: '🚀',
                    title: 'Excellente marge',
                    message: 'Votre modèle est très efficace. Considérez investir dans plus de R&D.'
                });
            }
            
            // Affichage des conseils
            tipsContainer.innerHTML = tips.map(tip => `
                <div class="tip-card tip-${tip.type}">
                    <div class="tip-icon">${tip.icon}</div>
                    <div class="tip-content">
                        <div class="tip-title">${tip.title}</div>
                        <div class="tip-message">${tip.message}</div>
                    </div>
                </div>
            `).join('');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            // Gestionnaires pour tous les curseurs économiques et opérationnels
            const allSliders = [
                'prixMultipass', 'prixPartsSociales', 'ratioMultipass',
                'nbCapitaines', 'paf', 'nbAbonnes', 'nbDevs', 'salaireDev', 'nbCommunityManagers', 'salaireCM'
            ];
            
            allSliders.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        updateSliderValues();
                        calculateEconomy();
                    });
                }
            });
            
            // Gestionnaire spécial pour le curseur Capitaines
            document.getElementById('nbCapitaines').addEventListener('input', () => {
                const nbCapitaines = parseInt(document.getElementById('nbCapitaines').value);
                
                // Ajuster immédiatement le curseur Utilisateurs
                adjustAbonnesSlider(nbCapitaines);
                
                // Mettre à jour les valeurs et recalculer
                updateSliderValues();
                calculateEconomy();
            });
            
            // Initialisation
            updateSliderValues();
            calculateEconomy();
        });
    </script>
</body>
</html>