<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coop.Suite - Simulateur Strat√©gique Coop√©ratif</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* ... (Le CSS reste majoritairement le m√™me, avec quelques ajouts) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .sliders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .slider-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #3498db;
        }

        .slider-label {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .slider {
            width: 100%;
        }

        .slider-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #3498db;
            text-align: center;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .financial-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #95a5a6;
            transition: all 0.3s ease;
        }
         .financial-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .financial-label, .legend-label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .financial-value {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .info-icon {
            width: 18px;
            height: 18px;
            background: #bdc3c7;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .tooltip .tooltiptext {
            visibility: hidden; width: 300px; background-color: #2c3e50; color: white;
            text-align: left; border-radius: 8px; padding: 15px; position: absolute;
            z-index: 1000; bottom: 125%; left: 50%; margin-left: -150px;
            opacity: 0; transition: opacity 0.3s; font-size: 14px; line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .wealth-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: center;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }
        
        .legend {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }
        
        .impact-statement {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white; padding: 25px; border-radius: 15px; text-align: center;
            font-size: 1.2rem; font-weight: 600; margin-top: 30px;
        }

        /* AM√âLIORATION : Onglets pour la projection */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* AM√âLIORATION : Section KPI */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .kpi-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .kpi-title { font-weight: 600; color: #7f8c8d; margin-bottom: 10px; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: #2c3e50; }

        /* AM√âLIORATION : Call to Action */
        .cta-section {
            text-align: center;
            padding: 40px;
            background-color: #f8f9fa;
            margin: 40px -40px -40px -40px; /* Pour toucher les bords */
        }
        .cta-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
        }

        @media (max-width: 768px) {
            .wealth-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Coop.Suite</h1>
            <p class="subtitle">Le simulateur strat√©gique pour votre alternative souveraine √† Google Workspace</p>
        </div>

        <div class="content">
            <!-- Section 1: Param√®tres -->
            <div class="section">
                <h2>üìä Pilotez votre Coop√©rative</h2>
                <div class="sliders-grid">
                    <!-- ... Les sliders restent les m√™mes ... -->
                    <div class="slider-container">
                        <div class="slider-label">üë• Abonn√©s</div>
                        <input type="range" id="nbAbonnes" class="slider" min="10" max="2000" step="10" value="300">
                        <div class="slider-value" id="nbAbonnesValue">300</div>
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">üíª D√©veloppeurs</div>
                        <input type="range" id="nbDevs" class="slider" min="1" max="10" step="1" value="2">
                        <div class="slider-value" id="nbDevsValue">2</div>
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">üì¢ Community Managers</div>
                        <input type="range" id="nbCommunityManagers" class="slider" min="0" max="5" step="1" value="1">
                        <div class="slider-value" id="nbCommunityManagersValue">1</div>
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">üñ•Ô∏è Capitaines</div>
                        <input type="range" id="nbCapitaines" class="slider" min="5" max="500" step="5" value="50">
                        <div class="slider-value" id="nbCapitainesValue">50</div>
                    </div>
                </div>
                 <!-- AM√âLIORATION : Section KPI -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">POINT MORT (en abonn√©s)</div>
                        <div class="kpi-value" id="breakEven">N/A</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">MARGE BRUTE</div>
                        <div class="kpi-value" id="grossMargin">0%</div>
                    </div>
                     <div class="kpi-card">
                        <div class="kpi-title">EMPLOIS LOCAUX CR√â√âS</div>
                        <div class="kpi-value" id="jobsCreated">3</div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Tableau de Bord Financier avec onglets -->
            <div class="section">
                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'monthly')">üìà Vue Mensuelle</button>
                    <button class="tab-button" onclick="openTab(event, 'yearly')">üìÖ Projection Annuelle</button>
                </div>

                <div id="monthly" class="tab-content active">
                     <h2>üí∞ Tableau de Bord Financier Mensuel (en ·∫êen / ‚Ç¨)</h2>
                     <div class="financial-grid" id="monthly-financials">
                        <!-- Le contenu sera g√©n√©r√© par JS -->
                     </div>
                </div>

                <div id="yearly" class="tab-content">
                    <h2>üí∞ Projection sur 12 mois</h2>
                    <p style="text-align:center; margin-bottom:20px; color:#7f8c8d;">Cette projection suppose des param√®tres constants sur l'ann√©e.</p>
                    <div class="financial-grid" id="yearly-financials">
                        <!-- Le contenu sera g√©n√©r√© par JS -->
                    </div>
                </div>
            </div>

            <!-- Section 3: Cr√©ation de Richesse -->
            <div class="section">
                <h2>üå± Votre Cr√©ation de Richesse Commune (Mensuelle)</h2>
                <div class="wealth-grid">
                    <div class="chart-container">
                        <canvas id="wealthChart"></canvas>
                    </div>
                    <div class="legend" id="legend-container">
                        <!-- Le contenu sera g√©n√©r√© par JS -->
                    </div>
                </div>
                <div class="impact-statement" id="impactStatement">
                    üå≥ Impact √âcologique ce mois-ci : Votre coop√©rative finance l'acquisition de 0 m¬≤ de for√™t-jardin !
                </div>
            </div>
            
            <!-- AM√âLIORATION : Call to Action -->
            <div class="cta-section">
                <h2>Pr√™t √† construire votre souverainet√© num√©rique ?</h2>
                <p style="margin-top:10px; margin-bottom:25px; color:#7f8c8d; max-width:600px; margin-left:auto; margin-right:auto;">
                    Ce simulateur d√©montre la viabilit√© d'un mod√®le √©conomique plus juste, transparent et r√©g√©n√©ratif. 
                    Rejoignez la coop√©rative pour en faire une r√©alit√©.
                </p>
                <a href="https://github.com/papiche/Astroport.ONE" target="_blank" class="cta-button">D√©couvrir le projet sur GitHub</a>
            </div>
        </div>
    </div>

    <script>
        // ... (Le JS sera plus complexe pour g√©rer les nouvelles fonctionnalit√©s) ...
        // Constantes
        const C = {
            ABONNEMENT_HT: 10,
            TAUX_TVA: 0.20,
            TAUX_IS: 0.25,
            REMUNERATION_CAPITAINE: 4.33,
            PRIX_M2_FORET: 2,
            SALAIRE_DEV: 5600,
            SALAIRE_CM: 1620
        };

        let wealthChart = null;
        
        // Fonctions Utilitaires
        const formatNumber = (num) => new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 0 }).format(num);
        const formatCurrency = (num) => `${formatNumber(num)} ·∫ê`;

        // Mise √† jour des valeurs des sliders
        function updateSliderValues() {
            ['nbAbonnes', 'nbDevs', 'nbCommunityManagers', 'nbCapitaines'].forEach(id => {
                document.getElementById(`${id}Value`).textContent = document.getElementById(id).value;
            });
        }
        
        // G√©n√©ration du HTML pour les tableaux financiers
        function createFinancialHTML(period, data) {
            const isYearly = period === 'yearly';
            const multiplier = isYearly ? 12 : 1;
            const container = document.getElementById(`${period}-financials`);
            
            // ... (Cette fonction est ajout√©e pour √©viter la duplication de code)
            container.innerHTML = `
                <div class="financial-item">
                    <div class="financial-label">üí≥ Chiffre d'Affaires Encaiss√© (TTC)</div>
                    <div class="financial-value positive">${formatCurrency(data.chiffreAffairesTTC * multiplier)}</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">üèõÔ∏è TVA provisionn√©e sur UPLANET.IMPOT</div>
                    <div class="financial-value negative">-${formatCurrency(data.montantTVA * multiplier)}</div>
                </div>
                <div style="grid-column: 1 / -1;"><hr></div>
                <div class="financial-item">
                    <div class="financial-label">üìà Chiffre d'Affaires R√©el (HT)</div>
                    <div class="financial-value positive">${formatCurrency(data.chiffreAffairesHT * multiplier)}</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">(-) üñ•Ô∏è Co√ªts d'Infrastructure</div>
                    <div class="financial-value negative">-${formatCurrency(data.coutsInfra * multiplier)}</div>
                </div>
                 <div class="financial-item">
                    <div class="financial-label">= üí° Marge Brute</div>
                    <div class="financial-value ${data.margeBrute >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.margeBrute * multiplier)}</div>
                </div>
                <div class="financial-item">
                    <div class="financial-label">(-) üî¨ Co√ªts de R&D</div>
                    <div class="financial-value negative">-${formatCurrency(data.coutsRD * multiplier)}</div>
                </div>
                 <div class="financial-item">
                    <div class="financial-label">= üìä R√©sultat Avant Imp√¥t</div>
                    <div class="financial-value ${data.resultatAvantImpot >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.resultatAvantImpot * multiplier)}</div>
                </div>
                 <div class="financial-item">
                    <div class="financial-label">(-) üèõÔ∏è Imp√¥t sur les Soci√©t√©s</div>
                    <div class="financial-value negative">-${formatCurrency(data.montantIS * multiplier)}</div>
                </div>
                <div class="financial-item" style="background-color: #ecf0f1; font-size: 1.1rem;">
                    <div class="financial-label">= ‚ú® R√©sultat Net</div>
                    <div class="financial-value ${data.resultatNet >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.resultatNet * multiplier)}</div>
                </div>
            `;
        }


        // Fonction principale de calcul
        function calculateEconomy() {
            const nbAbonnes = parseInt(document.getElementById('nbAbonnes').value);
            const nbDevs = parseInt(document.getElementById('nbDevs').value);
            const nbCM = parseInt(document.getElementById('nbCommunityManagers').value);
            const nbCapitaines = parseInt(document.getElementById('nbCapitaines').value);
            
            // Calculs mensuels
            const coutsRD = (nbDevs * C.SALAIRE_DEV) + (nbCM * C.SALAIRE_CM);
            const coutsInfra = nbCapitaines * C.REMUNERATION_CAPITAINE;
            const coutsFixesHT = coutsRD + coutsInfra;

            const chiffreAffairesHT = nbAbonnes * C.ABONNEMENT_HT;
            const montantTVA = chiffreAffairesHT * C.TAUX_TVA;
            const chiffreAffairesTTC = chiffreAffairesHT + montantTVA;

            const margeBrute = chiffreAffairesHT - coutsInfra;
            const resultatAvantImpot = margeBrute - coutsRD;
            const montantIS = (resultatAvantImpot > 0) ? resultatAvantImpot * C.TAUX_IS : 0;
            const resultatNet = resultatAvantImpot - montantIS;

            const monthlyData = {
                chiffreAffairesTTC, montantTVA, chiffreAffairesHT, coutsInfra, margeBrute,
                coutsRD, resultatAvantImpot, montantIS, resultatNet
            };

            // Mise √† jour des affichages mensuels et annuels
            createFinancialHTML('monthly', monthlyData);
            createFinancialHTML('yearly', monthlyData);

            // Mise √† jour des KPIs
            const breakEven = Math.ceil(coutsFixesHT / C.ABONNEMENT_HT);
            document.getElementById('breakEven').textContent = formatNumber(breakEven);
            const grossMargin = chiffreAffairesHT > 0 ? (margeBrute / chiffreAffairesHT) * 100 : 0;
            document.getElementById('grossMargin').textContent = `${formatNumber(grossMargin)}%`;
            document.getElementById('jobsCreated').textContent = formatNumber(nbDevs + nbCM);

            // Mise √† jour de la section richesse
            updateWealthSection(resultatNet);
        }

        // Mise √† jour de la section Richesse (graphique, l√©gende, impact)
        function updateWealthSection(resultatNet) {
            const legendContainer = document.getElementById('legend-container');
            const impactStatement = document.getElementById('impactStatement');
            
            if (resultatNet > 0) {
                const part = resultatNet / 3;
                const m2Foret = part / C.PRIX_M2_FORET;
                
                legendContainer.innerHTML = `
                    <h3 style="margin-bottom: 20px;">R√©partition 3x1/3</h3>
                    <div class="legend-item">
                        <div class="legend-label">
                            <div style="width:15px;height:15px;background:#3498db;"></div>
                            .TREASURY (Stabilit√©)
                        </div>
                        <div class="legend-value">${formatCurrency(part)}</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-label">
                            <div style="width:15px;height:15px;background:#27ae60;"></div>
                            .ASSETS (Investissement)
                        </div>
                        <div class="legend-value">${formatCurrency(part)}</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-label">
                            <div style="width:15px;height:15px;background:#f39c12;"></div>
                            Bonus / R&D
                        </div>
                        <div class="legend-value">${formatCurrency(part)}</div>
                    </div>
                `;
                impactStatement.textContent = `üå≥ Impact √âcologique ce mois-ci : Votre coop√©rative finance l'acquisition de ${formatNumber(m2Foret)} m¬≤ de for√™t-jardin !`;
                updateChart([part, part, part], ['#3498db', '#27ae60', '#f39c12'], 'doughnut', resultatNet);
            } else {
                legendContainer.innerHTML = `<p style="text-align:center; color:#7f8c8d;">Le r√©sultat net doit √™tre positif pour cr√©er de la richesse commune.</p>`;
                impactStatement.textContent = `üå± Optimisez vos param√®tres pour g√©n√©rer un impact positif !`;
                
                const dataForLoss = [
                    document.getElementById('chiffreAffairesHT').textContent.replace(/[^0-9]/g, ''),
                    document.getElementById('coutsInfra').textContent.replace(/[^0-9]/g, '') + document.getElementById('coutsRD').textContent.replace(/[^0-9]/g, '')
                ];
                updateChart([Math.abs(monthlyData.chiffreAffairesHT), Math.abs(monthlyData.coutsInfra) + Math.abs(monthlyData.coutsRD)], ['#27ae60', '#e74c3c'], 'bar', resultatNet);
            }
        }
        
        // Mise √† jour du graphique
        function updateChart(data, colors, type, resultatNet) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            const total = data.reduce((a, b) => a + b, 0);

            if (wealthChart) wealthChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                         callbacks: {
                            label: (context) => `${context.label}: ${formatCurrency(context.parsed)}`
                        }
                    },
                    // AM√âLIORATION : Texte au centre du doughnut
                    datalabels: {
                        formatter: () => '', // Cache les labels sur les segments
                    },
                }
            };
            
            let chartConfig;
            if (type === 'doughnut') {
                chartConfig = {
                    type: 'doughnut',
                    data: {
                        labels: ['.TREASURY', '.ASSETS', 'Bonus/R&D'],
                        datasets: [{ data, backgroundColor: colors, borderWidth: 0 }]
                    },
                    options: { ...chartOptions, cutout: '60%' },
                     plugins: [{ // Plugin pour √©crire au centre
                        beforeDraw: function(chart) {
                            var width = chart.width, height = chart.height, ctx = chart.ctx;
                            ctx.restore();
                            var fontSize = (height / 160).toFixed(2);
                            ctx.font = "600 " + fontSize + "em Inter";
                            ctx.textBaseline = "middle";
                            
                            var text = formatCurrency(resultatNet);
                            var textX = Math.round((width - ctx.measureText(text).width) / 2);
                            var textY = height / 2;
                            
                            ctx.fillStyle = '#27ae60';
                            ctx.fillText(text, textX, textY - (fontSize * 8));

                            ctx.font = "400 " + (fontSize * 0.6) + "em Inter";
                            var subtext = "R√©sultat Net";
                            var subtextX = Math.round((width - ctx.measureText(subtext).width) / 2);
                             ctx.fillStyle = '#7f8c8d';
                            ctx.fillText(subtext, subtextX, textY + (fontSize * 8));
                            ctx.save();
                        }
                    }]
                };
            } else { // Bar chart for loss
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: ['Revenus (HT)', 'D√©penses (HT)'],
                        datasets: [{ data, backgroundColor: colors }]
                    },
                    options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
                };
            }
            wealthChart = new Chart(ctx, chartConfig);
        }

        // Gestion des onglets
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            ['nbAbonnes', 'nbDevs', 'nbCommunityManagers', 'nbCapitaines'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    updateSliderValues();
                    calculateEconomy();
                });
            });
            updateSliderValues();
            calculateEconomy();
        });
    </script>
</body>
</html>