<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå UPlanet Constellation Command</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

        :root {
            --bg-void: #030508;
            --bg-deep: #0a0e14;
            --bg-panel: #0d1219;
            --bg-card: #111820;
            --bg-hover: #1a222d;
            --text-primary: #e8f4ff;
            --text-secondary: #6b8299;
            --text-dim: #3d5066;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-yellow: #ffd000;
            --accent-orange: #ff8800;
            --accent-red: #ff3366;
            --accent-purple: #9966ff;
            --accent-pink: #ff66aa;
            --border-glow: rgba(0, 212, 255, 0.3);
            --grid-line: rgba(0, 212, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(ellipse at 20% 30%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(153, 102, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 255, 136, 0.01) 0%, transparent 70%);
        }

        /* Grid overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Command Header */
        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--bg-panel) 0%, var(--bg-deep) 100%);
            border: 1px solid var(--border-glow);
            border-radius: 4px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .command-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--accent-cyan)); }
            50% { filter: drop-shadow(0 0 20px var(--accent-cyan)); }
        }

        .logo-text h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 3px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text .subtitle {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        .status-bar {
            display: flex;
            gap: 30px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: blink 2s ease-in-out infinite;
        }

        .status-dot.online { background: var(--accent-green); }
        .status-dot.warning { background: var(--accent-yellow); }
        .status-dot.offline { background: var(--accent-red); }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* View Mode Toggle */
        .view-toggle {
            display: flex;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border-glow);
        }

        .view-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .view-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
        }

        /* Main Content Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        /* Constellation Map View */
        .constellation-view {
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 4px;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-glow);
        }

        .map-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 2px;
            color: var(--accent-cyan);
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-btn {
            padding: 6px 12px;
            background: var(--bg-hover);
            border: 1px solid var(--border-glow);
            border-radius: 2px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-void);
        }

        .constellation-canvas {
            width: 100%;
            height: 450px;
            position: relative;
        }

        /* Station Node in Map */
        .station-node {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .station-node:hover {
            transform: scale(1.2);
            z-index: 20;
        }

        .station-core {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .station-core.healthy {
            background: radial-gradient(circle, rgba(0, 255, 136, 0.3), transparent);
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .station-core.warning,
        .station-core.growth_slowdown {
            background: radial-gradient(circle, rgba(255, 208, 0, 0.3), transparent);
            border-color: var(--accent-yellow);
            box-shadow: 0 0 20px rgba(255, 208, 0, 0.3);
        }

        .station-core.critical,
        .station-core.innovation_slowdown {
            background: radial-gradient(circle, rgba(255, 51, 102, 0.3), transparent);
            border-color: var(--accent-red);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.3);
            animation: critical-pulse 1s ease-in-out infinite;
        }

        .station-core.bankrupt {
            background: radial-gradient(circle, rgba(255, 51, 102, 0.5), transparent);
            border-color: var(--accent-red);
            animation: bankrupt-flash 0.5s ease-in-out infinite;
        }

        @keyframes critical-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 51, 102, 0.3); }
            50% { box-shadow: 0 0 40px rgba(255, 51, 102, 0.6); }
        }

        @keyframes bankrupt-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .station-node.selected .station-core {
            transform: scale(1.3);
            border-width: 3px;
        }

        .station-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: center;
        }

        .station-node:hover .station-label,
        .station-node.selected .station-label {
            color: var(--accent-cyan);
        }

        /* Connection Lines */
        .connection-line {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, var(--accent-cyan), transparent);
            opacity: 0.2;
            transform-origin: left center;
            pointer-events: none;
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Panel Card */
        .panel-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 4px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-glow);
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            letter-spacing: 2px;
            color: var(--accent-cyan);
        }

        .panel-content {
            padding: 15px;
        }

        /* Resource Bars (Game-style) */
        .resource-bar {
            margin-bottom: 15px;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .resource-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .resource-value {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .resource-track {
            height: 8px;
            background: var(--bg-void);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .resource-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
            position: relative;
        }

        .resource-fill.cash { background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple)); }
        .resource-fill.rnd { background: linear-gradient(90deg, var(--accent-yellow), var(--accent-orange)); }
        .resource-fill.assets { background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan)); }
        .resource-fill.impot { background: linear-gradient(90deg, var(--accent-pink), var(--accent-red)); }

        /* Station Details Panel */
        .station-details {
            display: none;
        }

        .station-details.active {
            display: block;
        }

        .station-hero {
            text-align: center;
            padding: 20px;
            background: linear-gradient(180deg, var(--bg-card), var(--bg-panel));
            border-bottom: 1px solid var(--border-glow);
        }

        .station-hero-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .station-hero-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .station-hero-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 2px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .station-hero-status.healthy { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .station-hero-status.warning, .station-hero-status.growth_slowdown { background: rgba(255, 208, 0, 0.2); color: var(--accent-yellow); }
        .station-hero-status.critical, .station-hero-status.innovation_slowdown { background: rgba(255, 51, 102, 0.2); color: var(--accent-red); }
        .station-hero-status.bankrupt { background: rgba(255, 51, 102, 0.4); color: var(--accent-red); }

        .station-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 2px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .stat-box:hover {
            border-color: var(--accent-cyan);
        }

        .stat-value {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--border-glow);
        }

        .nav-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 2px;
            color: var(--text-secondary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-void);
            border-color: var(--accent-cyan);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Swarm Overview (List View) */
        .swarm-list {
            display: none;
        }

        .swarm-list.active {
            display: block;
        }

        .station-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-glow);
            cursor: pointer;
            transition: all 0.2s;
        }

        .station-row:hover {
            background: var(--bg-hover);
        }

        .station-row.selected {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-cyan);
        }

        .station-row-header {
            background: var(--bg-card);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: var(--text-dim);
            letter-spacing: 1px;
            cursor: default;
        }

        .station-row-header:hover {
            background: var(--bg-card);
        }

        .station-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .station-mini-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .station-mini-status.healthy { background: var(--accent-green); }
        .station-mini-status.warning, .station-mini-status.growth_slowdown { background: var(--accent-yellow); }
        .station-mini-status.critical, .station-mini-status.innovation_slowdown { background: var(--accent-red); }
        .station-mini-status.bankrupt { background: var(--accent-red); animation: bankrupt-flash 0.5s infinite; }

        /* Aggregate Stats */
        .aggregate-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-glow);
            border-radius: 4px;
            margin-top: 20px;
        }

        .aggregate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1px;
            background: var(--border-glow);
        }

        .aggregate-item {
            background: var(--bg-panel);
            padding: 20px;
            text-align: center;
        }

        .aggregate-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .aggregate-value.cyan { color: var(--accent-cyan); }
        .aggregate-value.green { color: var(--accent-green); }
        .aggregate-value.yellow { color: var(--accent-yellow); }
        .aggregate-value.purple { color: var(--accent-purple); }

        .aggregate-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        /* Jump Animation */
        .jump-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-void);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }

        .jump-overlay.active {
            display: flex;
            animation: jump-sequence 1.5s ease-in-out;
        }

        @keyframes jump-sequence {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        .jump-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-cyan);
            letter-spacing: 5px;
            animation: jump-text-pulse 0.5s ease-in-out infinite;
        }

        @keyframes jump-text-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .jump-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .jump-line {
            position: absolute;
            width: 2px;
            height: 100px;
            background: linear-gradient(180deg, transparent, var(--accent-cyan), transparent);
            animation: jump-line-move 0.3s linear infinite;
        }

        @keyframes jump-line-move {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-void);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-ring {
            width: 80px;
            height: 80px;
            border: 3px solid var(--bg-card);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            letter-spacing: 3px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .side-panel {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .side-panel .panel-card {
                flex: 1;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .command-header {
                flex-direction: column;
                gap: 15px;
            }

            .status-bar {
                flex-wrap: wrap;
                justify-content: center;
            }

            .station-row {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .station-row-header {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-ring"></div>
        <div class="loading-text">CONNECTING TO CONSTELLATION</div>
    </div>

    <div id="jump-overlay" class="jump-overlay">
        <div class="jump-lines" id="jump-lines"></div>
        <div class="jump-text" id="jump-text">JUMPING TO STATION</div>
    </div>

    <div class="container" id="main-container" style="display: none;">
        <!-- Command Header -->
        <header class="command-header">
            <div class="logo-section">
                <div class="logo-icon">üåå</div>
                <div class="logo-text">
                    <h1>CONSTELLATION COMMAND</h1>
                    <div class="subtitle">N¬≤ ECONOMIC MONITORING SYSTEM</div>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot online" id="connection-status"></div>
                    <span id="relay-status">CONNECTED</span>
                </div>
                <div class="status-item">
                    <span>üì°</span>
                    <span id="relay-url">--</span>
                </div>
                <div class="status-item">
                    <span>üïê</span>
                    <span id="last-sync">--</span>
                </div>
            </div>

            <div class="view-toggle">
                <button class="view-btn active" id="btn-map" onclick="switchView('map')">
                    üó∫Ô∏è CONSTELLATION
                </button>
                <button class="view-btn" id="btn-list" onclick="switchView('list')">
                    üìã STATIONS
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Constellation Map -->
            <div class="constellation-view" id="map-view">
                <div class="map-header">
                    <div class="map-title">‚¨° SECTOR MAP</div>
                    <div class="map-controls">
                        <button class="map-btn" onclick="centerMap()">‚äô CENTER</button>
                        <button class="map-btn" onclick="refreshData()">‚Üª REFRESH</button>
                    </div>
                </div>
                <div class="constellation-canvas" id="constellation-canvas">
                    <!-- Station nodes rendered here -->
                </div>
            </div>

            <!-- List View (hidden by default) -->
            <div class="swarm-list" id="list-view">
                <div class="station-row station-row-header">
                    <div>STATION</div>
                    <div>STATUS</div>
                    <div>BILAN</div>
                    <div>CA/WEEK</div>
                    <div>USERS</div>
                    <div>RUNWAY</div>
                </div>
                <div id="stations-list">
                    <!-- Station rows rendered here -->
                </div>
            </div>

            <!-- Side Panel -->
            <div class="side-panel">
                <!-- Station Details (shown when station selected) -->
                <div class="panel-card station-details" id="station-details">
                    <div class="station-hero" id="station-hero">
                        <div class="station-hero-icon">üõ∞Ô∏è</div>
                        <div class="station-hero-name" id="detail-name">SELECT A STATION</div>
                        <div class="station-hero-status healthy" id="detail-status">
                            <span class="status-dot online"></span>
                            HEALTHY
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 15px; justify-content: center; font-size: 0.85rem;">
                            <div style="text-align: center;">
                                <div style="color: var(--accent-yellow); font-weight: 700;" id="detail-ca">-- ·∫ê</div>
                                <div style="color: var(--text-dim); font-size: 0.7rem;">CA/WEEK</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--accent-cyan); font-weight: 700;" id="detail-revenue-mp">-- ·∫ê</div>
                                <div style="color: var(--text-dim); font-size: 0.7rem;">MULTIPASS</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--accent-green); font-weight: 700;" id="detail-revenue-zc">-- ·∫ê</div>
                                <div style="color: var(--text-dim); font-size: 0.7rem;">ZENCARD</div>
                            </div>
                        </div>
                    </div>
                    <div class="station-stats" id="station-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="detail-bilan">--</div>
                            <div class="stat-label">BILAN ·∫ê</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="detail-runway">--</div>
                            <div class="stat-label">WEEKS RUNWAY</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="detail-multipass">--</div>
                            <div class="stat-label">MULTIPASS</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="detail-zencard">--</div>
                            <div class="stat-label">ZENCARD</div>
                        </div>
                        <div class="stat-box" title="Solar sync time - when station runs 20h12 cycle">
                            <div class="stat-value" id="detail-solar" style="color: var(--accent-cyan)">--:--</div>
                            <div class="stat-label">‚è∞ SOLAR SYNC</div>
                        </div>
                        <div class="stat-box" title="Station GPS coordinates">
                            <div class="stat-value" id="detail-geo" style="font-size: 0.9rem">--</div>
                            <div class="stat-label">üìç LOCATION</div>
                        </div>
                        <div class="stat-box" title="Weekly PAF cost (Part Armateur Forfaitaire)">
                            <div class="stat-value" id="detail-paf" style="color: var(--accent-orange)">--</div>
                            <div class="stat-label">üí∏ PAF/WEEK</div>
                        </div>
                        <div class="stat-box" title="MULTIPASS and ZENCARD weekly rates">
                            <div class="stat-value" id="detail-prices" style="font-size: 0.8rem; color: var(--accent-yellow)">--</div>
                            <div class="stat-label">üí∞ PRICES</div>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üí∞ CASH (Treasury)</span>
                                <span class="resource-value" id="detail-cash">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill cash" id="detail-cash-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üî¨ R&D</span>
                                <span class="resource-value" id="detail-rnd">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill rnd" id="detail-rnd-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üå≥ ASSETS</span>
                                <span class="resource-value" id="detail-assets">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill assets" id="detail-assets-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üìä IMPOT (TVA+IS)</span>
                                <span class="resource-value" id="detail-impot">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill impot" id="detail-impot-bar" style="width: 0%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.7rem; color: var(--text-dim);">
                                <span>TVA: <span id="detail-tva" style="color: var(--accent-pink)">--</span> ·∫ê</span>
                                <span>IS: <span id="detail-is" style="color: var(--accent-red)">--</span> ·∫ê</span>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">‚≠ê CAPITAL</span>
                                <span class="resource-value" id="detail-capital">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill" id="detail-capital-bar" style="width: 0%; background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));"></div>
                            </div>
                        </div>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" id="btn-prev" onclick="navigateStation(-1)">‚óÄ PREV</button>
                        <button class="nav-btn" id="btn-jump" onclick="jumpToStation()">üöÄ JUMP</button>
                        <button class="nav-btn" id="btn-next" onclick="navigateStation(1)">NEXT ‚ñ∂</button>
                    </div>
                </div>

                <!-- Swarm Resources -->
                <div class="panel-card">
                    <div class="panel-header">
                        <div class="panel-title">üíé SWARM RESOURCES</div>
                    </div>
                    <div class="panel-content">
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üí∞ Total CASH</span>
                                <span class="resource-value" id="total-cash">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill cash" id="total-cash-bar" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üî¨ Total R&D</span>
                                <span class="resource-value" id="total-rnd">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill rnd" id="total-rnd-bar" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üå≥ Total ASSETS</span>
                                <span class="resource-value" id="total-assets">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill assets" id="total-assets-bar" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">üìä Total IMPOT (TVA+IS)</span>
                                <span class="resource-value" id="total-impot">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill impot" id="total-impot-bar" style="width: 50%"></div>
                            </div>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-header">
                                <span class="resource-label">‚≠ê Total CAPITAL</span>
                                <span class="resource-value" id="total-capital">-- ·∫ê</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill" id="total-capital-bar" style="width: 50%; background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Links -->
        <div class="aggregate-panel" style="margin-bottom: 20px;">
            <div class="map-header">
                <div class="map-title">üîó NAVIGATION</div>
            </div>
            <div style="display: flex; gap: 15px; padding: 15px; flex-wrap: wrap; justify-content: center;">
                <a href="./index.html" class="nav-btn" style="text-decoration: none; flex: 1; max-width: 200px;">
                    üåç UPlanet Home
                </a>
                <a href="./economy.html" class="nav-btn" style="text-decoration: none; flex: 1; max-width: 200px;">
                    ‚ô•Ô∏è Station Dashboard
                </a>
                <a href="./economy.Constellation.html" class="nav-btn" style="text-decoration: none; flex: 1; max-width: 200px;">
                    üèõÔ∏è Simulateur Strat√©gique
                </a>
            </div>
        </div>

        <!-- Aggregate Stats -->
        <div class="aggregate-panel">
            <div class="map-header">
                <div class="map-title">üìä CONSTELLATION OVERVIEW</div>
            </div>
            <div class="aggregate-grid">
                <div class="aggregate-item">
                    <div class="aggregate-value cyan" id="agg-stations">--</div>
                    <div class="aggregate-label">STATIONS ONLINE</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value green" id="agg-health">--%</div>
                    <div class="aggregate-label">NETWORK HEALTH</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value purple" id="agg-users">--</div>
                    <div class="aggregate-label">TOTAL USERS</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value yellow" id="agg-revenue">-- ·∫ê</div>
                    <div class="aggregate-label">WEEKLY REVENUE</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value cyan" id="agg-capacity">--%</div>
                    <div class="aggregate-label">CAPACITY USED</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value green" id="agg-zencard">--</div>
                    <div class="aggregate-label">ZENCARD (üè†+üëë)</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value" id="agg-capital" style="color: var(--accent-pink)">-- ·∫ê</div>
                    <div class="aggregate-label">‚≠ê CAPITAL SOCIAL</div>
                </div>
                <div class="aggregate-item">
                    <div class="aggregate-value" id="agg-impot" style="color: var(--accent-red)">-- ·∫ê</div>
                    <div class="aggregate-label">üìä PROVISIONS FISCALES</div>
                </div>
            </div>
        </div>
    </div>
    <script src="nostr.bundle.js"></script>
    <script src="common.js"></script>
    <script>
        // Configuration
        const EVENT_KIND_STATION = 30850;
        let ws = null;
        let relay = null; // common.js relay object
        let stationsData = new Map();
        let selectedStationId = null;
        let stationOrder = [];

        // Detect relay URL - uses common.js DEFAULT_RELAYS if available
        function detectRelayUrl() {
            // Use common.js DEFAULT_RELAYS if available
            if (window.DEFAULT_RELAYS && window.DEFAULT_RELAYS.length > 0) {
                return window.DEFAULT_RELAYS[0];
            }
            if (typeof NostrState !== 'undefined' && NostrState.DEFAULT_RELAYS?.length > 0) {
                return NostrState.DEFAULT_RELAYS[0];
            }
            
            const hostname = window.location.hostname;
            if (hostname === "127.0.0.1" || hostname === "localhost") {
                return "ws://127.0.0.1:7777";
            } else if (hostname.startsWith("ipfs.") || hostname.startsWith("u.")) {
                const baseDomain = hostname.replace(/^(ipfs\.|u\.)/, '');
                return `wss://relay.${baseDomain}`;
            }
            return "wss://relay.copylaradio.com";
        }

        // Initialize
        window.addEventListener('load', async () => {
            console.log('üåå economy.Swarm.html loaded');
            console.log('   EVENT_KIND_STATION:', EVENT_KIND_STATION);
            
            // Wait for common.js to initialize
            await new Promise(r => setTimeout(r, 200));
            
            const relayUrl = new URLSearchParams(window.location.search).get('relay') || detectRelayUrl();
            console.log('üîó Connecting to relay:', relayUrl);
            document.getElementById('relay-url').textContent = relayUrl.replace(/^wss?:\/\//, '');
            
            // Try common.js relay first, then fallback to WebSocket
            await initializeRelay(relayUrl);
        });

        // Initialize relay connection - tries common.js first, then WebSocket
        async function initializeRelay(relayUrl) {
            // Option 1: Use common.js connectToRelay if available
            if (typeof connectToRelay === 'function' && connectToRelay !== initializeRelay) {
                try {
                    console.log('üì° Trying common.js connectToRelay...');
                    await connectToRelay();
                    
                    if (window.nostrRelay && typeof window.nostrRelay.sub === 'function') {
                        relay = window.nostrRelay;
                        console.log('‚úÖ Using common.js relay');
                        document.getElementById('connection-status').className = 'status-dot online';
                        document.getElementById('relay-status').textContent = 'CONNECTED';
                        subscribeWithCommonJS();
                        return;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è common.js connectToRelay failed:', e);
                }
            }
            
            // Option 2: Fallback to direct WebSocket
            console.log('üì° Using direct WebSocket connection...');
            connectWebSocket(relayUrl);
        }

        // Connect via WebSocket (fallback)
        function connectWebSocket(relayUrl) {
            ws = new WebSocket(relayUrl);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected to:', relayUrl);
                document.getElementById('connection-status').className = 'status-dot online';
                document.getElementById('relay-status').textContent = 'CONNECTED';
                subscribeWithWebSocket();
            };

            ws.onmessage = (event) => handleWebSocketMessage(JSON.parse(event.data));

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                document.getElementById('connection-status').className = 'status-dot offline';
                document.getElementById('relay-status').textContent = 'ERROR';
                hideLoading();
            };

            ws.onclose = (event) => {
                console.log('üîå WebSocket closed:', event.code, event.reason);
                document.getElementById('connection-status').className = 'status-dot warning';
                document.getElementById('relay-status').textContent = 'DISCONNECTED';
            };
        }

        // Subscribe using common.js relay
        function subscribeWithCommonJS() {
            const since = Math.floor(Date.now() / 1000) - (30 * 24 * 60 * 60);
            const filter = { kinds: [EVENT_KIND_STATION], since, limit: 500 };
            
            console.log('üì° Subscribing via common.js relay...');
            console.log('   filter:', JSON.stringify(filter));
            
            const sub = relay.sub([filter]);
            
            sub.on('event', (event) => {
                console.log('üì® EVENT received via common.js');
                processStationEvent(event);
            });
            
            sub.on('eose', () => {
                console.log('‚úÖ EOSE - End of stored events. Total stations:', stationsData.size);
                hideLoading();
                document.getElementById('main-container').style.display = 'block';
                updateUI();
            });
            
            setTimeout(() => {
                if (stationsData.size === 0) {
                    console.log('‚è∞ Timeout: No stations received after 5s');
                    hideLoading();
                    document.getElementById('main-container').style.display = 'block';
                }
            }, 5000);
        }

        // Subscribe via WebSocket (fallback)
        function subscribeWithWebSocket() {
            const since = Math.floor(Date.now() / 1000) - (30 * 24 * 60 * 60);
            const subId = 'constellation-' + Date.now();
            const filter = { kinds: [EVENT_KIND_STATION], since, limit: 500 };
            
            console.log('üì° Subscribing via WebSocket...');
            console.log('   subId:', subId);
            console.log('   filter:', JSON.stringify(filter));
            
            ws.send(JSON.stringify(['REQ', subId, filter]));
            
            setTimeout(() => {
                if (stationsData.size === 0) {
                    console.log('‚è∞ Timeout: No stations received after 5s');
                    hideLoading();
                    document.getElementById('main-container').style.display = 'block';
                }
            }, 5000);
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            const [type, ...data] = message;

            if (type === 'EVENT') {
                console.log('üì® EVENT received via WebSocket');
                processStationEvent(data[1]);
            } else if (type === 'EOSE') {
                console.log('‚úÖ EOSE - End of stored events. Total stations:', stationsData.size);
                hideLoading();
                document.getElementById('main-container').style.display = 'block';
                updateUI();
            } else if (type === 'NOTICE') {
                console.log('üì¢ NOTICE from relay:', data[0]);
            } else if (type === 'OK') {
                console.log('üëç OK response:', data);
            }
        }

        // Handle messages
        // Process station event
        function processStationEvent(event) {
            try {
                console.log('üõ∞Ô∏è Processing event kind:', event.kind, 'created_at:', new Date(event.created_at * 1000).toISOString());
                console.log('   pubkey:', event.pubkey?.substring(0, 16) + '...');
                
                const content = JSON.parse(event.content);
                const tags = event.tags;
                const stationId = getTagValue(tags, 'station');
                const stationName = getTagValue(tags, 'station:name');
                const week = getTagValue(tags, 'week');
                const healthStatus = getTagValue(tags, 'health:status');
                const bilan = getTagValue(tags, 'health:bilan');
                
                console.log('   station:', stationId, '| name:', stationName, '| week:', week);
                console.log('   health:', healthStatus, '| bilan:', bilan, '·∫ê');
                console.log('   tags count:', tags?.length, '| content keys:', Object.keys(content || {}).join(', '));
                
                const existing = stationsData.get(stationId);
                if (existing) {
                    console.log('   ‚Ü≥ Existing station, created_at comparison:', existing.created_at, 'vs', event.created_at);
                }
                
                if (!existing || event.created_at > existing.created_at) {
                    console.log('   ‚úÖ Adding/updating station:', stationId);
                    stationsData.set(stationId, {
                        stationId,
                        // Station display name (from relay domain or last 8 chars of station ID)
                        // IPFSNODEID always starts with "12D3KooW", so last 8 chars are more distinctive
                        stationName: getTagValue(tags, 'station:name') || (stationId ? '...' + stationId.slice(-8) : 'unknown'),
                        // Swarm ID = shared public key (NOT the secret UPLANETNAME!)
                        swarmId: getTagValue(tags, 'swarm_id') || 'default',
                        week: getTagValue(tags, 'week'),
                        healthStatus: getTagValue(tags, 'health:status') || 'healthy',
                        bilan: parseFloat(getTagValue(tags, 'health:bilan') || 0),
                        // Shared wallets (same for all stations in swarm)
                        cashBalance: parseFloat(getTagValue(tags, 'balance:cash') || 0),
                        rndBalance: parseFloat(getTagValue(tags, 'balance:rnd') || 0),
                        assetsBalance: parseFloat(getTagValue(tags, 'balance:assets') || 0),
                        impotBalance: parseFloat(getTagValue(tags, 'balance:impot') || 0),
                        capitalBalance: parseFloat(getTagValue(tags, 'balance:capital') || 0),
                        // Cost and pricing
                        costPaf: parseFloat(getTagValue(tags, 'cost:paf') || 0),
                        costCaptain: parseFloat(getTagValue(tags, 'cost:captain') || 0),
                        priceMultipass: parseFloat(getTagValue(tags, 'price:multipass') || 1),
                        priceZencard: parseFloat(getTagValue(tags, 'price:zencard') || 4),
                        // Provisions TVA/IS
                        provisionTva: parseFloat(getTagValue(tags, 'provision:tva') || 0),
                        provisionIs: parseFloat(getTagValue(tags, 'provision:is') || 0),
                        // Local station data (unique per station)
                        multipassUsed: parseInt(getTagValue(tags, 'capacity:multipass_used') || 0),
                        multipassTotal: parseInt(getTagValue(tags, 'capacity:multipass_total') || 250),
                        zencardTotal: parseInt(getTagValue(tags, 'capacity:zencard_total') || 0),
                        zencardRenters: parseInt(getTagValue(tags, 'capacity:zencard_renters') || 0),
                        zencardOwners: parseInt(getTagValue(tags, 'capacity:zencard_owners') || 0),
                        zencardCapacity: parseInt(getTagValue(tags, 'capacity:zencard_capacity') || 24),
                        weeksRunway: parseInt(getTagValue(tags, 'health:weeks_runway') || 0),
                        revenueTotal: parseFloat(getTagValue(tags, 'revenue:total') || 0),
                        revenueMultipass: parseFloat(getTagValue(tags, 'revenue:multipass') || 0),
                        revenueZencard: parseFloat(getTagValue(tags, 'revenue:zencard') || 0),
                        // Station location for solar time sync
                        stationLat: parseFloat(getTagValue(tags, 'geo:lat') || 0),
                        stationLon: parseFloat(getTagValue(tags, 'geo:lon') || 0),
                        solarOffset: getTagValue(tags, 'sync:solar_offset') || '--:--',
                        created_at: event.created_at,
                        content
                    });
                }
            } catch (e) {
                console.error('‚ùå Error processing event:', e);
                console.error('   Event content preview:', event?.content?.substring(0, 200));
                console.error('   Event tags:', event?.tags?.slice(0, 5));
            }
        }

        function getTagValue(tags, name) {
            return tags.find(t => t[0] === name)?.[1] || null;
        }

        // Update all UI elements
        function updateUI() {
            console.log('üîÑ updateUI() called');
            console.log('   Total stations in memory:', stationsData.size);
            
            stationOrder = Array.from(stationsData.keys());
            console.log('   Station order:', stationOrder);
            
            // Log station details
            stationsData.forEach((station, id) => {
                console.log(`   üìä ${station.stationName}: ${station.healthStatus} | bilan: ${station.bilan}·∫ê | MP: ${station.multipassUsed} | ZC: ${station.zencardTotal}`);
            });
            
            renderConstellationMap();
            renderStationsList();
            updateAggregates();
            updateSyncTime();
            
            if (stationOrder.length > 0 && !selectedStationId) {
                selectStation(stationOrder[0]);
            }
        }

        // Render constellation map
        function renderConstellationMap() {
            const canvas = document.getElementById('constellation-canvas');
            canvas.innerHTML = '';
            
            const stations = Array.from(stationsData.values());
            if (stations.length === 0) return;

            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.35;

            stations.forEach((station, index) => {
                const angle = (index / stations.length) * Math.PI * 2 - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius * (0.7 + Math.random() * 0.3);
                const y = centerY + Math.sin(angle) * radius * (0.7 + Math.random() * 0.3);

                const node = document.createElement('div');
                node.className = `station-node ${station.stationId === selectedStationId ? 'selected' : ''}`;
                node.style.left = `${x - 20}px`;
                node.style.top = `${y - 20}px`;
                node.onclick = () => selectStation(station.stationId);

                node.innerHTML = `
                    <div class="station-core ${station.healthStatus}">
                        ${getStatusEmoji(station.healthStatus)}
                    </div>
                    <div class="station-label">${station.stationName}</div>
                `;

                canvas.appendChild(node);

                // Draw connections to nearby stations
                if (index > 0) {
                    const prevAngle = ((index - 1) / stations.length) * Math.PI * 2 - Math.PI / 2;
                    const prevX = centerX + Math.cos(prevAngle) * radius;
                    const prevY = centerY + Math.sin(prevAngle) * radius;
                    
                    const line = document.createElement('div');
                    line.className = 'connection-line';
                    const length = Math.sqrt(Math.pow(x - prevX, 2) + Math.pow(y - prevY, 2));
                    const angle2 = Math.atan2(y - prevY, x - prevX);
                    line.style.width = `${length}px`;
                    line.style.left = `${prevX}px`;
                    line.style.top = `${prevY}px`;
                    line.style.transform = `rotate(${angle2}rad)`;
                    canvas.appendChild(line);
                }
            });
        }

        function getStatusEmoji(status) {
            switch (status) {
                case 'healthy': return 'üõ∞Ô∏è';
                case 'warning': 
                case 'growth_slowdown': return '‚ö†Ô∏è';
                case 'critical': 
                case 'innovation_slowdown': return 'üî¥';
                case 'bankrupt': return 'üíÄ';
                default: return 'üõ∞Ô∏è';
            }
        }
        
        // Normalize health status for CSS class mapping
        function normalizeHealthStatus(status) {
            switch (status) {
                case 'growth_slowdown': return 'warning';
                case 'innovation_slowdown': return 'critical';
                default: return status;
            }
        }

        // Render stations list
        function renderStationsList() {
            const container = document.getElementById('stations-list');
            container.innerHTML = '';

            const stations = Array.from(stationsData.values()).sort((a, b) => {
                // Sort by severity: most critical first
                const order = { 
                    'bankrupt': 0, 
                    'critical': 1, 'innovation_slowdown': 1,
                    'warning': 2, 'growth_slowdown': 2, 
                    'healthy': 3 
                };
                return (order[a.healthStatus] ?? 3) - (order[b.healthStatus] ?? 3);
            });

            stations.forEach(station => {
                const row = document.createElement('div');
                row.className = `station-row ${station.stationId === selectedStationId ? 'selected' : ''}`;
                row.onclick = () => selectStation(station.stationId);

                // Format solar offset display
                const solarDisplay = station.solarOffset || '--:--';
                const hasGeo = station.stationLat && station.stationLon && station.stationLat !== 0;

                row.innerHTML = `
                    <div class="station-name-cell">
                        <div class="station-mini-status ${station.healthStatus}"></div>
                        <span>${station.stationName}</span>
                    </div>
                    <div>${station.healthStatus.replace('_', ' ').toUpperCase()}</div>
                    <div style="color: ${station.bilan >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${station.bilan.toFixed(1)} ·∫ê</div>
                    <div style="color: var(--accent-yellow)">${station.revenueTotal.toFixed(0)} ·∫ê</div>
                    <div>MP:${station.multipassUsed} ZC:${station.zencardTotal}</div>
                    <div>${station.weeksRunway}w</div>
                `;

                container.appendChild(row);
            });
        }

        // Select a station
        function selectStation(stationId) {
            selectedStationId = stationId;
            const station = stationsData.get(stationId);
            if (!station) return;

            // Update details panel
            document.getElementById('station-details').classList.add('active');
            document.getElementById('detail-name').textContent = station.stationName;
            document.getElementById('detail-status').className = `station-hero-status ${station.healthStatus}`;
            const statusDotClass = station.healthStatus === 'healthy' ? 'online' : 
                                   (station.healthStatus === 'warning' || station.healthStatus === 'growth_slowdown') ? 'warning' : 'offline';
            const statusLabel = station.healthStatus.replace('_', ' ').toUpperCase();
            document.getElementById('detail-status').innerHTML = `<span class="status-dot ${statusDotClass}"></span>${statusLabel}`;
            
            document.getElementById('detail-bilan').textContent = station.bilan.toFixed(2);
            document.getElementById('detail-runway').textContent = station.weeksRunway;
            document.getElementById('detail-multipass').textContent = `${station.multipassUsed}/${station.multipassTotal}`;
            document.getElementById('detail-zencard').textContent = `${station.zencardRenters}üè†+${station.zencardOwners}üëë`;
            
            // Revenue breakdown
            document.getElementById('detail-ca').textContent = `${station.revenueTotal.toFixed(2)} ·∫ê`;
            document.getElementById('detail-revenue-mp').textContent = `${station.revenueMultipass.toFixed(2)} ·∫ê`;
            document.getElementById('detail-revenue-zc').textContent = `${station.revenueZencard.toFixed(2)} ·∫ê`;
            
            document.getElementById('detail-cash').textContent = `${station.cashBalance.toFixed(2)} ·∫ê`;
            document.getElementById('detail-rnd').textContent = `${station.rndBalance.toFixed(2)} ·∫ê`;
            document.getElementById('detail-assets').textContent = `${station.assetsBalance.toFixed(2)} ·∫ê`;
            document.getElementById('detail-impot').textContent = `${station.impotBalance.toFixed(2)} ·∫ê`;
            document.getElementById('detail-tva').textContent = station.provisionTva.toFixed(2);
            document.getElementById('detail-is').textContent = station.provisionIs.toFixed(2);
            document.getElementById('detail-capital').textContent = `${station.capitalBalance.toFixed(2)} ·∫ê`;
            
            // PAF and pricing
            document.getElementById('detail-paf').textContent = `${station.costPaf.toFixed(0)} ·∫ê`;
            document.getElementById('detail-prices').textContent = `MP:${station.priceMultipass}·∫ê ZC:${station.priceZencard}·∫ê`;
            
            // Solar sync and geo info
            document.getElementById('detail-solar').textContent = station.solarOffset || '--:--';
            const hasGeo = station.stationLat && station.stationLon && station.stationLat !== 0;
            document.getElementById('detail-geo').textContent = hasGeo 
                ? `${station.stationLat.toFixed(2)}¬∞, ${station.stationLon.toFixed(2)}¬∞`
                : 'N/A';
            
            // Calculate bar widths (relative to max in constellation)
            const maxCash = Math.max(...Array.from(stationsData.values()).map(s => s.cashBalance), 1);
            const maxRnd = Math.max(...Array.from(stationsData.values()).map(s => s.rndBalance), 1);
            const maxAssets = Math.max(...Array.from(stationsData.values()).map(s => s.assetsBalance), 1);
            const maxImpot = Math.max(...Array.from(stationsData.values()).map(s => s.impotBalance), 1);
            const maxCapital = Math.max(...Array.from(stationsData.values()).map(s => s.capitalBalance), 1);
            
            document.getElementById('detail-cash-bar').style.width = `${(station.cashBalance / maxCash) * 100}%`;
            document.getElementById('detail-rnd-bar').style.width = `${(station.rndBalance / maxRnd) * 100}%`;
            document.getElementById('detail-assets-bar').style.width = `${(station.assetsBalance / maxAssets) * 100}%`;
            document.getElementById('detail-impot-bar').style.width = `${(station.impotBalance / maxImpot) * 100}%`;
            document.getElementById('detail-capital-bar').style.width = `${(station.capitalBalance / maxCapital) * 100}%`;

            // Update nav buttons
            const idx = stationOrder.indexOf(stationId);
            document.getElementById('btn-prev').disabled = idx <= 0;
            document.getElementById('btn-next').disabled = idx >= stationOrder.length - 1;

            // Update visual selection
            renderConstellationMap();
            renderStationsList();
        }

        // Navigate between stations
        function navigateStation(direction) {
            const idx = stationOrder.indexOf(selectedStationId);
            const newIdx = idx + direction;
            if (newIdx >= 0 && newIdx < stationOrder.length) {
                playJumpAnimation(stationsData.get(stationOrder[newIdx]).stationName);
                setTimeout(() => selectStation(stationOrder[newIdx]), 800);
            }
        }

        // Jump animation
        function playJumpAnimation(targetName) {
            const overlay = document.getElementById('jump-overlay');
            const jumpText = document.getElementById('jump-text');
            const linesContainer = document.getElementById('jump-lines');
            
            jumpText.textContent = `JUMPING TO ${targetName.toUpperCase()}`;
            linesContainer.innerHTML = '';
            
            // Create jump lines
            for (let i = 0; i < 30; i++) {
                const line = document.createElement('div');
                line.className = 'jump-line';
                line.style.left = `${Math.random() * 100}%`;
                line.style.animationDelay = `${Math.random() * 0.3}s`;
                linesContainer.appendChild(line);
            }
            
            overlay.classList.add('active');
            setTimeout(() => overlay.classList.remove('active'), 1500);
        }

        // Jump to station (placeholder for future API integration)
        function jumpToStation() {
            if (selectedStationId) {
                const station = stationsData.get(selectedStationId);
                playJumpAnimation(station.stationName);
                // In future: could redirect to station's local dashboard
                console.log('üöÄ Jump to station:', station);
            }
        }

        // Update aggregates
        // NOTE: CASH, RnD, ASSETS are SHARED wallets (same for all stations in a swarm)
        // They should NOT be summed - we take the value from ONE station per swarm
        // LOCAL values (users, revenue) ARE summed across all stations
        function updateAggregates() {
            const stations = Array.from(stationsData.values());
            if (stations.length === 0) return;

            // Group stations by swarm_id to handle shared wallets correctly
            const swarmMap = new Map();
            stations.forEach(s => {
                const swarmId = s.swarmId || s.uplanetname || 'default';
                if (!swarmMap.has(swarmId)) {
                    swarmMap.set(swarmId, []);
                }
                swarmMap.get(swarmId).push(s);
            });

            // SHARED wallets: take from most recent station per swarm (not sum!)
            let totalCash = 0, totalRnd = 0, totalAssets = 0, totalImpot = 0, totalCapital = 0;
            swarmMap.forEach((swarmStations, swarmId) => {
                // Get most recent report for this swarm
                const latestStation = swarmStations.reduce((latest, s) => 
                    s.created_at > latest.created_at ? s : latest
                );
                // Add shared wallet values ONCE per swarm
                totalCash += latestStation.cashBalance;
                totalRnd += latestStation.rndBalance;
                totalAssets += latestStation.assetsBalance;
                totalImpot += latestStation.impotBalance;
                totalCapital += latestStation.capitalBalance;
            });

            // LOCAL values: sum across ALL stations
            let totalRevenue = 0;
            let totalMultipass = 0, totalMultipassCap = 0;
            let totalZencardRenters = 0, totalZencardOwners = 0;
            let healthyCount = 0;

            stations.forEach(s => {
                totalRevenue += s.revenueTotal;
                totalMultipass += s.multipassUsed;
                totalMultipassCap += s.multipassTotal;
                totalZencardRenters += s.zencardRenters;
                totalZencardOwners += s.zencardOwners;
                if (s.healthStatus === 'healthy') healthyCount++;
            });

            const healthPercent = Math.round((healthyCount / stations.length) * 100);
            const capacityPercent = totalMultipassCap > 0 ? Math.round((totalMultipass / totalMultipassCap) * 100) : 0;

            document.getElementById('agg-stations').textContent = stations.length;
            document.getElementById('agg-health').textContent = `${healthPercent}%`;
            document.getElementById('agg-users').textContent = totalMultipass + totalZencardRenters + totalZencardOwners;
            document.getElementById('agg-revenue').textContent = `${totalRevenue.toFixed(2)} ·∫ê`;
            document.getElementById('agg-capacity').textContent = `${capacityPercent}%`;
            document.getElementById('agg-zencard').textContent = `${totalZencardRenters}üè†+${totalZencardOwners}üëë`;
            document.getElementById('agg-capital').textContent = `${totalCapital.toFixed(2)} ·∫ê`;
            document.getElementById('agg-impot').textContent = `${totalImpot.toFixed(2)} ·∫ê`;

            // Display SHARED wallet values (correctly not summed across stations)
            document.getElementById('total-cash').textContent = `${totalCash.toFixed(2)} ·∫ê`;
            document.getElementById('total-rnd').textContent = `${totalRnd.toFixed(2)} ·∫ê`;
            document.getElementById('total-assets').textContent = `${totalAssets.toFixed(2)} ·∫ê`;
            document.getElementById('total-impot').textContent = `${totalImpot.toFixed(2)} ·∫ê`;
            document.getElementById('total-capital').textContent = `${totalCapital.toFixed(2)} ·∫ê`;
        }

        function updateSyncTime() {
            document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
        }

        // View switching
        function switchView(view) {
            document.getElementById('btn-map').classList.toggle('active', view === 'map');
            document.getElementById('btn-list').classList.toggle('active', view === 'list');
            document.getElementById('map-view').style.display = view === 'map' ? 'block' : 'none';
            document.getElementById('list-view').classList.toggle('active', view === 'list');
        }

        function centerMap() {
            renderConstellationMap();
        }

        function refreshData() {
            stationsData.clear();
            subscribeToEvents();
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    </script>
</body>
</html>
