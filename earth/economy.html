<!DOCTYPE html>
<html>
<head>
    <title>UPlanet Economy Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
            background: #181c24;
            height: 100vh;
            overflow: hidden;
        }

        .economic-dashboard {
            background: #232733;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow-y: auto;
            font-family: 'Arial', sans-serif;
            box-sizing: border-box;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Style de la barre de défilement */
        .economic-dashboard::-webkit-scrollbar {
            width: 6px;
        }

        .economic-dashboard::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .economic-dashboard::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        .economic-dashboard::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .status-section {
            margin-bottom: 18px;
            padding: 18px 16px;
            background: #232733;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: 1.5px solid #232733;
        }

        .metric-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 6px;
            margin-top: 6px;
        }

        .metric-box {
            padding: 6px;
            border-radius: 6px;
        }

        .metric-box .metric-title {
            font-size: 0.9em;
            margin-bottom: 4px;
            padding-bottom: 4px;
        }

        .metric-box .metric-value {
            font-size: 1.1em;
        }

        .metric-box .metric-subtitle {
            font-size: 0.75em;
            margin-top: 2px;
        }

        .metric-box .price {
            font-size: 1.1em;
            margin-top: 6px;
        }

        .metric-box .buy-button {
            padding: 4px 8px;
            margin-top: 4px;
            font-size: 0.85em;
            border-radius: 4px;
        }

        .metric-box.zen-card {
            border-color: #2ecc71;
            background: linear-gradient(145deg, #232733, #1e2a22);
        }

        .metric-box.zen-card:hover {
            background: linear-gradient(145deg, #1e2a22, #232733);
        }

        .metric-box.multipass {
            border-color: #3498db;
            background: linear-gradient(145deg, #232733, #1e2533);
        }

        .metric-box.multipass:hover {
            background: linear-gradient(145deg, #1e2533, #232733);
        }

        .metric-box .metric-title {
            color: #b8c6e0;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #232733;
        }

        .metric-box .metric-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #eaf6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .metric-box .metric-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .metric-box .buy-button {
            display: inline-block;
            background: #3498db;
            color: #fff !important;
            padding: 6px 14px;
            border-radius: 6px;
            text-decoration: none;
            margin-left: 8px;
            font-weight: bold;
            font-size: 0.95em;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52,152,219,0.10);
        }

        .metric-box.zen-card .buy-button {
            background: #2ecc71;
        }

        .metric-box .buy-button:hover {
            background: #217dbb;
            color: #fff !important;
            text-decoration: none;
            transform: translateY(-1px) scale(1.04);
            box-shadow: 0 4px 16px rgba(52,152,219,0.18);
        }

        .simulator-section {
            margin-top: 8px;
            padding: 12px;
            background: #232733;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        .simulation-results {
            margin-top: 8px;
            padding: 12px;
        }

        .simulator-controls {
            display: flex;
            flex-direction: row;
            gap: 24px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .simulator-input {
            max-width: 220px;
            min-width: 180px;
            background: linear-gradient(145deg, #232733, #1e222d);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 8px 12px 8px;
            gap: 6px;
        }

        .simulator-input label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1em;
            font-weight: 600;
            color: #eaf6ff;
            margin-bottom: 0;
        }

        .simulator-input .simu-picto {
            font-size: 1.2em;
        }

        .simulator-input .simu-header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .simulator-input .buy-button {
            margin: 0;
            padding: 4px 10px;
            font-size: 0.95em;
            background: #3498db;
            color: #fff !important;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .simulator-input .buy-button:hover {
            background: #217dbb;
        }

        .simulator-input .price-tag {
            font-size: 0.9em;
            color: #b8c6e0;
            margin-bottom: 2px;
        }

        .simulator-input .input-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 2px;
        }

        .simulator-input input[type=number] {
            width: 60px;
            min-width: 0;
            padding: 2px 4px;
            font-size: 1.1em;
            border-radius: 4px;
            border: 1px solid #232733;
            text-align: center;
            background: #181c24;
            color: #eaf6ff;
            font-weight: 700;
            height: 28px;
        }

        .simulator-input input[type=number]::-webkit-inner-spin-button, 
        .simulator-input input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .simulator-input input[type=number] {
            -moz-appearance: textfield;
        }

        .simulator-input .number-control {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            color: #b8c6e0;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .simulator-input .number-control:hover {
            background: #3498db;
            color: #fff;
        }

        .simulator-input .max-value {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .progress-container {
            background: #232733;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #232733;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71);
            transition: width 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform-origin: left;
        }

        .progress-bar-fill.negative {
            background: #e74c3c;
            transform: scaleX(-1);
        }

        .progress-value.negative {
            color: #e74c3c;
        }

        .progress-value.positive {
            color: #2ecc71;
        }

        /* Styles pour la répartition des bénéfices UPlanet */
        .uplanet-distribution {
            margin-top: 12px;
            padding: 8px;
        }

        .uplanet-distribution.active {
            opacity: 1;
            background: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .uplanet-distribution.animate-in {
            animation: uplanet-appear 1s ease-out;
        }

        @keyframes uplanet-appear {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            50% {
                transform: translateY(-10px);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .distribution-bars {
            margin-top: 15px;
        }

        .distribution-item {
            margin: 12px 0;
        }

        .distribution-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .distribution-percentage {
            font-weight: bold;
            color: #3498db;
        }

        .distribution-value {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .distribution-bar {
            height: 8px;
            background: #232733;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .distribution-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            transition: all 0.5s ease-in-out;
            transform-origin: left;
            will-change: transform;
        }

        .distribution-fill.cash {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .distribution-fill.infra {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        .distribution-fill.rd {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .metric-details {
            font-size: 0.9em;
            color: #b8c6e0;
            margin-top: 5px;
        }

        .metric-details div {
            margin: 2px 0;
        }

        .thresholds {
            margin-top: 15px;
        }

        .threshold {
            margin: 10px 0;
            padding: 10px;
            background: #232733;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .threshold.active {
            background: #232733;
            border-left: 4px solid #3498db;
        }

        .threshold-label {
            font-weight: bold;
            color: #b8c6e0;
            margin-bottom: 5px;
        }

        .threshold-value {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .threshold-progress {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .threshold-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.5s ease-in-out;
        }

        .benefit-card {
            background: #232733;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .benefit-card h4 {
            color: #3498db;
            margin: 0 0 8px 0;
            font-size: 1.1em;
        }

        .benefit-card ul {
            list-style: none;
            padding: 0;
            margin: 0 0 12px 0;
        }

        .benefit-card li {
            padding: 4px 0;
            color: #b8c6e0;
            position: relative;
            padding-left: 18px;
            font-size: 0.9em;
        }

        .benefit-card li:before {
            content: "✓";
            color: #2ecc71;
            position: absolute;
            left: 0;
        }

        .subscribe-button {
            padding: 12px;
            font-size: 1em;
        }

        .info-table {
            margin: 8px 0;
            font-size: 0.9em;
            background: #232733;
            color: #b8c6e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .table-header {
            padding: 8px;
        }

        .table-label {
            padding: 6px;
        }

        .info-table td {
            padding: 6px;
        }

        .compact-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .compact-list li {
            margin: 2px 0;
            padding-left: 15px;
            position: relative;
        }

        .compact-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #3498db;
        }

        .positive {
            color: #2ecc71;
        }

        .negative {
            color: #e74c3c;
        }

        /* Styles pour les graphiques en camembert */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }

        .metric-chart {
            background: #232733;
            padding: 6px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            text-align: center;
        }

        .chart-title {
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .chart-value {
            font-size: 1em;
            margin: 2px 0;
        }

        .chart-details {
            font-size: 0.7em;
            margin-top: 2px;
        }

        .pie-chart {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #181c24;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: 2px solid #232733;
            position: relative;
            margin: 0 auto;
        }

        .pie-chart::before {
            width: 65%;
            height: 65%;
            top: 17.5%;
            left: 17.5%;
        }

        .pie-chart.negative {
            background: #181c24;
        }

        .pie-chart.captain {
            background: #181c24;
        }

        .pie-chart.uplanet {
            background: #181c24;
        }

        .chart-legend {
            gap: 8px;
            margin-top: 6px;
            font-size: 0.75em;
        }

        .legend-item {
            gap: 4px;
        }

        .legend-color {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .economic-dashboard {
                padding: 10px;
                max-width: 100%;
            }

            .metric-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .metric-box {
                padding: 8px;
            }

            .metric-box .metric-title {
                font-size: 0.8em;
                margin-bottom: 4px;
                padding-bottom: 4px;
            }

            .metric-box .metric-value {
                font-size: 1.1em;
            }

            .metric-box .metric-subtitle {
                font-size: 0.7em;
            }

            .simulator-controls {
                flex-direction: row;
                gap: 8px;
            }

            .simulator-input {
                min-width: 0;
                padding: 8px 6px;
                border-radius: 8px;
            }

            .simulator-input label {
                font-size: 0.9em;
            }

            .simulator-input input[type=number] {
                width: 50px;
                font-size: 0.9em;
                height: 24px;
            }

            .simulator-input .number-control {
                width: 24px;
                height: 24px;
                font-size: 0.9em;
            }

            .simulator-input .max-value {
                font-size: 0.75em;
            }

            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .metric-chart {
                padding: 4px;
            }

            .chart-title {
                font-size: 0.7em;
            }

            .chart-value {
                font-size: 0.9em;
            }

            .chart-details {
                font-size: 0.65em;
            }

            .pie-chart {
                width: 40px;
                height: 40px;
            }

            .uplanet-distribution h3 {
                font-size: 1em;
            }
        }

        @media (min-width: 768px) {
            .simulator-controls {
                flex-direction: row;
                justify-content: center;
                gap: 16px;
            }

            .simulator-input {
                min-width: 240px;
            }
        }

        h1, h2, h3, h4, h5, h6 {
            color: #eaf6ff !important;
        }
        label, .chart-title, .metric-title, .legend-item, .legend-color, .metric-subtitle, .max-value, .price-tag, .threshold-label, .threshold-value, .distribution-label, .distribution-percentage, .distribution-value, .table-header, .table-label {
            color: #b8c6e0 !important;
        }
        .chart-details, .metric-details, .compact-list li, .simulation-results, .info-table, .benefit-card li {
            color: #b8c6e0 !important;
        }
        
        /* Amélioration de la lisibilité des liens et du texte */
        a {
            color: #3498db !important;
            text-decoration: none;
        }
        
        a:hover {
            color: #5dade2 !important;
            text-decoration: underline;
        }
        
        a:visited {
            color: #85c1e9 !important;
        }
        
        /* Amélioration du contraste pour le texte UPlanet */
        .uplanet-info {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: 600;
        }
        
        .uplanet-balance {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            font-weight: bold;
        }

        /* Legal Wallets Styles */
        .legal-wallets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .legal-wallet-card {
            background: linear-gradient(145deg, #232733, #1e2a22);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .legal-wallet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-color: rgba(52,152,219,0.3);
        }

        .legal-wallet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--wallet-color, #3498db);
        }

        .legal-wallet-card.treasury::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .legal-wallet-card.rnd::before {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .legal-wallet-card.assets::before {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        .legal-wallet-card.impot::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .legal-wallet-card.g1::before {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .legal-wallet-card.society::before {
            background: linear-gradient(90deg, #34495e, #2c3e50);
        }

        .legal-wallet-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .legal-wallet-icon {
            font-size: 1.2em;
        }

        .legal-wallet-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #eaf6ff;
        }

        .legal-wallet-balance {
            font-size: 1.3em;
            font-weight: bold;
            color: #eaf6ff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            margin-bottom: 4px;
            min-height: 2em;
            display: flex;
            align-items: center;
        }

        .legal-wallet-balance .loading {
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .legal-wallet-description {
            font-size: 0.75em;
            color: #b8c6e0;
            line-height: 1.3;
        }

        .legal-wallet-pubkey {
            font-size: 0.7em;
            color: #7f8c8d;
            font-family: monospace;
            margin-top: 4px;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .legal-wallets-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .legal-wallet-card {
                padding: 8px;
            }

            .legal-wallet-balance {
                font-size: 1.1em;
            }

            .legal-wallet-name {
                font-size: 0.8em;
            }

            .legal-wallet-description {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="economic-dashboard">
        <!-- Le contenu de l'encart ECONOMY sera chargé dynamiquement ici -->
    </div>

    <script>
        // Fonction pour transformer l'URL en URL de l'API
        function getAPIUrl() {
            const currentUrl = new URL(window.location.href);
            let apiUrl = new URL(currentUrl.origin);

            // Transformation de 'ipfs.domain.tld' en `u.domain.tld`
            if (currentUrl.hostname.startsWith('ipfs.')) {
                apiUrl.hostname = apiUrl.hostname.replace('ipfs.', 'u.');
            }

            // Changer le port en 54321 si le port actuel est 8080
            if (currentUrl.port === '8080' || currentUrl.port !== '') {
                apiUrl.port = '54321';
            }

            return apiUrl.toString();
        }

        // Fonction pour charger les données UPlanet (two-step approach)
        async function loadUPlanetData(myURL) {
            try {
                // Step 1: Get IPFSNODEID from Ustats API
                const apiUrl = myURL || getAPIUrl();
                console.log('Step 1: Fetching Ustats data from:', apiUrl);
                const ustatsResponse = await fetch(apiUrl);
                const ustatsData = await ustatsResponse.json();
                console.log('Ustats data loaded successfully:', ustatsData);

                // Extract IPFSNODEID from Ustats
                const ipfsNodeId = ustatsData.IPFSNODEID;
                if (!ipfsNodeId) {
                    console.error('No IPFSNODEID found in Ustats data');
                    return ustatsData; // Return Ustats data anyway
                }

                // Step 2: Get mynode data from /ipns/IPFSNODEID/12345.json
                // Construct the IPFS gateway URL for the mynode data
                const baseUrl = new URL(apiUrl);
                const ipfsGatewayUrl = `${baseUrl.protocol}//${baseUrl.hostname.replace('u.', 'ipfs.')}${baseUrl.port ? ':' + (baseUrl.port === '54321' ? '8080' : baseUrl.port) : ''}`;
                const mynodeDataUrl = `${ipfsGatewayUrl}/ipns/${ipfsNodeId}/12345.json`;
                console.log('Step 2: Fetching mynode data from:', mynodeDataUrl);
                
                try {
                    const mynodeResponse = await fetch(mynodeDataUrl);
                    const mynodeData = await mynodeResponse.json();
                    console.log('Wallet data loaded successfully:', mynodeData);

                    // Merge Ustats data with mynode data (mynode data takes precedence for overlapping keys)
                    const mergedData = { ...ustatsData, ...mynodeData };
                    // Store the original API URL for balance checking
                    mergedData._originalApiUrl = apiUrl;
                    console.log('Merged data:', mergedData);
                    return mergedData;
                } catch (mynodeError) {
                    console.warn('Failed to fetch mynode data, using Ustats data only:', mynodeError);
                    // Store the original API URL even in fallback case
                    ustatsData._originalApiUrl = apiUrl;
                    return ustatsData; // Fallback to Ustats data only
                }

            } catch (error) {
                console.error('Error loading UPlanet data:', error);
                return null;
            }
        }

        // Fonction pour récupérer le solde d'un portefeuille
        async function fetchWalletBalance(g1pub, apiBaseUrl) {
            try {
                if (!g1pub || g1pub === 'N/A') {
                    return { balance: '0.00', zen: '0.00' };
                }

                const balanceUrl = `${apiBaseUrl}/check_balance?g1pub=${g1pub}`;
                console.log('Fetching balance from:', balanceUrl);
                
                const response = await fetch(balanceUrl);
                const data = await response.json();
                
                if (data && data.balance) {
                    const g1Balance = parseFloat(data.balance);
                    // Convert Ğ1 to ẐEN (1 Ğ1 = 10 ẐEN, but we need to subtract 1 first)
                    const zenBalance = (g1Balance - 1) * 10;
                    
                    return {
                        balance: g1Balance.toFixed(2),
                        zen: Math.max(0, zenBalance).toFixed(2) // Ensure non-negative
                    };
                } else {
                    console.warn('Invalid balance response for', g1pub, data);
                    return { balance: '0.00', zen: '0.00' };
                }
            } catch (error) {
                console.error('Error fetching balance for', g1pub, error);
                return { balance: '0.00', zen: '0.00' };
            }
        }

        // Fonction pour créer la section des portefeuilles légaux
        async function createLegalWalletsSection(data, originalApiUrl) {
            const legalWalletsGrid = document.getElementById('legal-wallets-grid');
            
            // Define the legal wallets with their properties
            const legalWallets = [
                {
                    key: 'UPLANETNAME_G1',
                    name: 'Réserve & Stabilité',
                    icon: '🏛️',
                    description: 'Émet et "brûle" les Ẑen lors des conversions avec l\'Euro',
                    className: 'g1'
                },
                {
                    key: 'UPLANETNAME_SOCIETY',
                    name: 'Capital Social',
                    icon: '⭐',
                    description: 'Gère les apports des sociétaires et l\'émission des parts',
                    className: 'society'
                },
                {
                    key: 'UPLANETNAME_TREASURY',
                    name: 'Trésorerie (1/3)',
                    icon: '💰',
                    description: 'Réserves impartageables pour la liquidité',
                    className: 'treasury'
                },
                {
                    key: 'UPLANETNAME_RND',
                    name: 'R&D (1/3)',
                    icon: '🔬',
                    description: 'Financement du G1FabLab et de l\'innovation',
                    className: 'rnd'
                },
                {
                    key: 'UPLANETNAME_ASSETS',
                    name: 'Actifs Réels (1/3)',
                    icon: '🌳',
                    description: 'Acquisition des forêts-jardins et biens communs',
                    className: 'assets'
                },
                {
                    key: 'UPLANETNAME_IMPOT',
                    name: 'Provision Fiscale',
                    icon: '📊',
                    description: 'Isole la TVA et l\'IS pour garantir la conformité',
                    className: 'impot'
                }
            ];

            // Use the original API URL for balance checking (uSPOT API)
            const apiBaseUrl = originalApiUrl || getAPIUrl();

            // Create initial HTML with loading states
            let walletsHTML = '';
            
            legalWallets.forEach(wallet => {
                const pubkey = data[wallet.key] || 'N/A';
                const shortPubkey = pubkey !== 'N/A' ? `${pubkey.substring(0, 8)}...${pubkey.substring(pubkey.length - 4)}` : 'N/A';
                
                walletsHTML += `
                    <div class="legal-wallet-card ${wallet.className}" id="wallet-${wallet.key}">
                        <div class="legal-wallet-header">
                            <span class="legal-wallet-icon">${wallet.icon}</span>
                            <span class="legal-wallet-name">${wallet.name}</span>
                        </div>
                        <div class="legal-wallet-balance" id="balance-${wallet.key}">
                            <span class="loading" style="color: #7f8c8d; font-size: 0.9em;">⏳ Chargement...</span>
                        </div>
                        <div class="legal-wallet-description">${wallet.description}</div>
                        <div class="legal-wallet-pubkey" title="${pubkey}">${shortPubkey}</div>
                    </div>
                `;
            });

            legalWalletsGrid.innerHTML = walletsHTML;

            // Fetch balances for each wallet in the background
            legalWallets.forEach(async (wallet) => {
                const pubkey = data[wallet.key];
                const balanceElement = document.getElementById(`balance-${wallet.key}`);
                
                if (pubkey && pubkey !== 'N/A') {
                    try {
                        const balanceData = await fetchWalletBalance(pubkey, apiBaseUrl);
                        
                        // Update the balance display
                        balanceElement.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <div style="font-size: 1.3em; font-weight: bold;">${balanceData.zen} Ẑ</div>
                                <div style="font-size: 0.8em; color: #7f8c8d;">${balanceData.balance} Ğ1</div>
                            </div>
                        `;
                    } catch (error) {
                        console.error(`Error loading balance for ${wallet.key}:`, error);
                        balanceElement.innerHTML = `
                            <div style="color: #e74c3c; font-size: 0.9em;">❌ Erreur</div>
                        `;
                    }
                } else {
                    balanceElement.innerHTML = `
                        <div style="color: #7f8c8d; font-size: 0.9em;">N/A</div>
                    `;
                }
            });
        }

        // Fonction pour créer le dashboard économique
        function createEconomicDashboard(data) {
            const dashboard = document.querySelector('.economic-dashboard');
            
            // Get values from JSON data
            const maxPlayers = 24;
            const maxNostr = 250;
            const currentPlayers = data.PLAYERs ? data.PLAYERs.length : 0;
            const currentNostr = data.NOSTR ? data.NOSTR.length : 0;
            const availablePlayers = maxPlayers - currentPlayers;
            const availableNostr = maxNostr - currentNostr;

            // Get values from JSON data
            const zcard = parseInt(data.ZCARD) || 15;
            const ncard = parseInt(data.NCARD) || 4;
            const paf = parseInt(data.PAF) || 100;
            const zen = parseInt(data.ZEN) || 0;
            const bilan = parseInt(data.BILAN) || 0;

            // Count NOSTR accounts with more than ZCARD amount
            const nostrAboveZcard = data.NOSTR ? data.NOSTR.filter(nostr => parseInt(nostr.ZEN) > zcard).length : 0;
            
            // Count PLAYERs with more than ZCARD amount
            const playersAboveZcard = data.PLAYERs ? data.PLAYERs.filter(player => parseInt(player.ZEN) > zcard).length : 0;

            // Get IPFS Node ID
            const IPFSNODEID = data.IPFSNODEID ? data.IPFSNODEID : 'N/A';

            // Get first 8 characters of UPLANET public key
            const planetPub = data.UPLANETG1PUB ? data.UPLANETG1PUB.substring(0, 8) : 'N/A';

            dashboard.innerHTML = `
                <!-- UPlanet Status -->
                <div class="status-section" style="
                    background: ${bilan < 0 ? 
                        'linear-gradient(145deg, #232733, #2a1e1e)' : 
                        bilan < paf ? 
                            'linear-gradient(145deg, #232733, #2a251e)' : 
                            bilan < (3 * paf) ? 
                                'linear-gradient(145deg, #232733, #1e252a)' : 
                                'linear-gradient(145deg, #232733, #1e2a22)'
                    };
                    border-left: 4px solid ${bilan < 0 ? 
                        '#e74c3c' : 
                        bilan < paf ? 
                            '#f39c12' : 
                            bilan < (3 * paf) ? 
                                '#3498db' : 
                                '#2ecc71'
                    };
                    transition: all 0.3s ease;
                    padding: 12px;
                    margin-top: 12px;
                ">
                    <div class="metric" style="display: flex; flex-direction: column; gap: 6px;">
                        <div class="metric-title" style="
                            font-size: 1em;
                            color: #eaf6ff;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                            <span style="font-size: 1.2em;">🌍</span>
                            <a href="/ipns/${IPFSNODEID}" target="_blank" style="color: #42a5f5 !important; text-shadow: 0 1px 2px rgba(0,0,0,0.8); font-weight: 600;">${IPFSNODEID}</a>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div class="metric-value uplanet-balance" id="uplanet-balance" style="
                                font-size: 1.6em;
                                font-weight: bold;
                                color: ${bilan < 0 ? 
                                    '#ff6b6b' : 
                                    bilan < paf ? 
                                    '#ffa726' : 
                                    bilan < (3 * paf) ? 
                                        '#42a5f5' : 
                                        '#66bb6a'
                                };
                                text-shadow: 0 2px 4px rgba(0,0,0,0.9);
                            ">${bilan.toFixed(2)} Ẑ</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 1.2em;">🌐</span>
                                <span class="uplanet-info">UPlanet${planetPub}</span>
                                <span class="uplanet-info">${zen.toFixed(2)} Ẑ</span>
                            </div>
                        </div>
                        <div class="metric-subtitle" style="
                            font-size: 0.9em;
                            color: ${bilan < 0 ? 
                                '#ff6b6b' : 
                                bilan < paf ? 
                                    '#ffa726' : 
                                    bilan < (3 * paf) ? 
                                        '#42a5f5' : 
                                        '#66bb6a'
                            };
                            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                            <span style="font-size: 1.1em;">
                                ${bilan < 0 ? 
                                    '⚠️' : 
                                    bilan < paf ? 
                                        '🔄' : 
                                        bilan < (3 * paf) ? 
                                            '✅' : 
                                            '🌟'
                                }
                            </span>
                            ${bilan < 0 ? 
                                'Déficit' : 
                                bilan < paf ? 
                                    'Manque part du Capitaine' : 
                                    bilan < (3 * paf) ? 
                                        'PAF couvert' : 
                                        'PAF et Capitaine couverts'
                            }
                        </div>
                    </div>
                </div>

                <!-- Simulator Section -->
                <div class="simulator-section">
                    <div class="simulator-controls">
                        <div class="simulator-input multipass">
                            <div class="simu-header">
                                <a class="buy-button" href="https://opencollective.com/uplanet-zero/contribute" target="_blank"><span class="simu-picto">🔑</span> MULTIPASS</a>
                                <span class="price-tag">${ncard} Ẑ/semaine</span>
                            </div>
                            <div class="input-row">
                                <input type="number" id="new-nostr" min="0" max="${availableNostr}" value="${nostrAboveZcard}">
                            </div>
                            <div class="max-value">${availableNostr}/${maxNostr} dispo</div>
                        </div>
                        
                        <div class="simulator-separator"><span class="sep-dot"></span></div>

                        <div class="simulator-input zen-card">
                            <div class="simu-header">
                                <a class="buy-button" href="https://opencollective.com/uplanet-zero/contribute" target="_blank"><span class="simu-picto">💳</span> ZEN Card</a>
                                <span class="price-tag">${zcard} Ẑ/semaine</span>
                            </div>
                            <div class="input-row">
                                <input type="number" id="new-zen" min="0" max="${availablePlayers}" value="${playersAboveZcard}">
                            </div>
                            <div class="max-value">${availablePlayers}/${maxPlayers} dispo</div>
                        </div>
                    </div>
                    <div class="simulation-results" id="simulation-results">
                        <!-- Results will be displayed here -->
                    </div>
                </div>

                <!-- Legal Wallets Section -->
                <div class="status-section" style="
                    background: linear-gradient(145deg, #232733, #1e252a);
                    border-left: 4px solid #3498db;
                    transition: all 0.3s ease;
                    padding: 12px;
                    margin-top: 12px;
                ">
                    <div class="metric" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="metric-title" style="
                            font-size: 1.1em;
                            color: #eaf6ff;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                            <span style="font-size: 1.2em;">⚖️</span>
                            <span>Portefeuilles Coopératifs</span>
                        </div>
                        <div class="legal-wallets-grid" id="legal-wallets-grid">
                            <!-- Legal wallets will be populated here -->
                        </div>
                    </div>
                </div>
            `;

            // Create the legal wallets section (async - will load balances in background)
            createLegalWalletsSection(data, data._originalApiUrl);

            // Add event listeners for dynamic simulation
            const newNostrInput = document.getElementById('new-nostr');
            const newZenInput = document.getElementById('new-zen');

            function updateSimulation() {
                const newNostr = parseInt(newNostrInput.value) || nostrAboveZcard;
                const newZen = parseInt(newZenInput.value) || playersAboveZcard;
                
                // Calculate weekly revenue (NCARD and ZCARD are per week)
                const weeklyNostrRevenue = newNostr * ncard;
                const weeklyZenRevenue = newZen * zcard;
                const totalWeeklyRevenue = weeklyNostrRevenue + weeklyZenRevenue;
                
                // Calculate monthly revenue (4 weeks = 28 days)
                const totalNewRevenue = totalWeeklyRevenue * 4;
                
                // Calculate new monthly profit
                const newMonthlyProfit = totalNewRevenue - paf;
                
                // Calculate thresholds
                const nodeThreshold = paf; // Node gets paid first (PAF)
                const captainThreshold = 2 * paf; // Captain starts getting paid after 1x PAF
                const uplanetThreshold = 3 * paf; // UPlanet gets what's above 3x PAF
                
                // Calculate who gets paid
                const nodePayment = Math.min(totalNewRevenue, nodeThreshold); // PAF is paid first
                const captainPayment = totalNewRevenue > nodeThreshold ? 
                    Math.min(totalNewRevenue - nodeThreshold, uplanetThreshold - nodeThreshold) : 0; // Captain gets everything between 1x PAF and 3x PAF
                const uplanetPayment = totalNewRevenue > uplanetThreshold ? 
                    totalNewRevenue - uplanetThreshold : 0; // UPlanet gets what's above 3x PAF

                // Calculate UPlanet distribution if threshold is reached
                let uplanetDistribution = null;
                if (totalNewRevenue >= uplanetThreshold) {
                    const totalUPlanetProfit = uplanetPayment;
                    uplanetDistribution = {
                        cash: totalUPlanetProfit * 0.34, // 34% pour la trésorerie
                        infra: totalUPlanetProfit * 0.33, // 33% pour l'infrastructure
                        rd: totalUPlanetProfit * 0.33 // 33% pour la R&D
                    };
                }

                // Create the base HTML
                let html = `
                    <div class="metrics-grid">
                        <div class="metric-chart">
                            <div class="chart-title">♥️BOX</div>
                            <div class="pie-chart" style="background: conic-gradient(
                                ${totalNewRevenue > 0 ? 
                                    `hsl(${Math.min(120, (totalNewRevenue / paf) * 120)}, 70%, 45%)` : 
                                    '#e74c3c'
                                } 0% ${totalNewRevenue > 0 ? Math.min(100, (totalNewRevenue / paf) * 100) : 0}%,
                                #e0e0e0 ${totalNewRevenue > 0 ? Math.min(100, (totalNewRevenue / paf) * 100) : 0}% 100%
                            )"></div>
                            <div class="chart-value">${nodePayment.toFixed(2)} Ẑ</div>
                            <div class="chart-details">
                                <div>PAF: ${paf.toFixed(2)} Ẑ</div>
                                <div>Revenus: ${totalNewRevenue.toFixed(2)} Ẑ</div>
                                <div style="font-size: 0.8em; color: #7f8c8d;">(${totalWeeklyRevenue.toFixed(2)} Ẑ/semaine)</div>
                            </div>
                        </div>

                        <div class="metric-chart">
                            <div class="chart-title">Capitaine</div>
                            <div class="pie-chart" style="background: conic-gradient(
                                ${captainPayment > 0 ? 
                                    `hsl(${Math.min(120, (captainPayment / (uplanetThreshold - nodeThreshold)) * 120)}, 70%, 45%)` : 
                                    '#e74c3c'
                                } 0% ${(captainPayment / (uplanetThreshold - nodeThreshold) * 100)}%,
                                #e0e0e0 ${(captainPayment / (uplanetThreshold - nodeThreshold) * 100)}% 100%
                            )"></div>
                            <div class="chart-value">${captainPayment.toFixed(2)} Ẑ</div>
                            <div class="chart-details">
                                <div>Plage: ${nodeThreshold.toFixed(2)} → ${uplanetThreshold.toFixed(2)} Ẑ</div>
                                <div>Progression: ${((captainPayment / (uplanetThreshold - nodeThreshold)) * 100).toFixed(1)}%</div>
                            </div>
                        </div>

                        <div class="metric-chart">
                            <div class="chart-title">UPlanet</div>
                            <div class="pie-chart" style="background: conic-gradient(
                                ${totalNewRevenue > uplanetThreshold ? 
                                    `hsl(${Math.min(120, ((totalNewRevenue - uplanetThreshold) / (uplanetThreshold)) * 120)}, 70%, 45%)` : 
                                    '#e74c3c'
                                } 0% ${totalNewRevenue > uplanetThreshold ? ((totalNewRevenue - uplanetThreshold) / totalNewRevenue * 100) : 0}%,
                                #e0e0e0 ${totalNewRevenue > uplanetThreshold ? ((totalNewRevenue - uplanetThreshold) / totalNewRevenue * 100) : 0}% 100%
                            )"></div>
                            <div class="chart-value">${uplanetPayment.toFixed(2)} Ẑ</div>
                            <div class="chart-details">
                                <div>Seuil: ${uplanetThreshold.toFixed(2)} Ẑ</div>
                                <div>Revenus: ${totalNewRevenue.toFixed(2)} Ẑ</div>
                            </div>
                        </div>
                    </div>`;

                // Always show UPlanet distribution section
                const totalUPlanetProfit = uplanetPayment;
                const cashAmount = totalUPlanetProfit * 0.34;
                const infraAmount = totalUPlanetProfit * 0.33;
                const rdAmount = totalUPlanetProfit * 0.33;

                html += `
                <div class="uplanet-distribution ${totalUPlanetProfit > 0 ? 'active' : ''}" style="background:#232733;">
                    <h3 style="color:#eaf6ff; text-shadow:0 2px 8px #181c24; letter-spacing:1px;">Distribution "3 x 1/3"</h3>
                    <div class="metric-container">
                        <div class="metric-box" style="background: linear-gradient(145deg, #232733, #1e2a22); border-color: #3498db; color: #eaf6ff;">
                            <div class="metric-title">Trésorerie</div>
                            <div class="metric-value">${cashAmount.toFixed(2)} Ẑ</div>
                            <div class="metric-subtitle">34%</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(145deg, #232733, #1e2a22); border-color: #2ecc71; color: #eaf6ff;">
                            <div class="metric-title">Infrastructure</div>
                            <div class="metric-value">${infraAmount.toFixed(2)} Ẑ</div>
                            <div class="metric-subtitle">33%</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(145deg, #232733, #23271a); border-color: #f1c40f; color: #eaf6ff;">
                            <div class="metric-title">R&D</div>
                            <div class="metric-value">${rdAmount.toFixed(2)} Ẑ</div>
                            <div class="metric-subtitle">33%</div>
                        </div>
                    </div>
                </div>`;

                // Update the content
                const resultsDiv = document.getElementById('simulation-results');
                resultsDiv.innerHTML = html;

                // Add animation class if UPlanet profits just started
                if (totalUPlanetProfit > 0) {
                    const uplanetSection = resultsDiv.querySelector('.uplanet-distribution');
                    uplanetSection.classList.add('animate-in');
                    setTimeout(() => {
                        uplanetSection.classList.remove('animate-in');
                    }, 1000);
                }

                // Force a reflow to ensure animations work
                void resultsDiv.offsetWidth;
            }

            // Add input event listeners for dynamic updates
            newNostrInput.addEventListener('input', updateSimulation);
            newZenInput.addEventListener('input', updateSimulation);

            // Initial simulation
            updateSimulation();

            // Add number controls
            function addNumberControls(input) {
                const container = input.parentElement;
                const controls = document.createElement('div');
                controls.className = 'controls';
                controls.style.display = 'flex';
                controls.style.alignItems = 'center';
                controls.style.gap = '6px';
                
                const minusButton = document.createElement('button');
                minusButton.className = 'number-control';
                minusButton.innerHTML = '−';
                minusButton.onclick = () => {
                    const currentValue = parseInt(input.value) || 0;
                    if (currentValue > 0) {
                        input.value = currentValue - 1;
                        input.dispatchEvent(new Event('input'));
                    }
                };

                const plusButton = document.createElement('button');
                plusButton.className = 'number-control';
                plusButton.innerHTML = '+';
                plusButton.onclick = () => {
                    const currentValue = parseInt(input.value) || 0;
                    const max = parseInt(input.max);
                    if (currentValue < max) {
                        input.value = currentValue + 1;
                        input.dispatchEvent(new Event('input'));
                    }
                };

                // Insérer le bouton moins avant l'input
                container.insertBefore(minusButton, input);
                // Insérer le bouton plus après l'input
                container.insertBefore(plusButton, input.nextSibling);
            }

            // Add controls to inputs
            addNumberControls(newNostrInput);
            addNumberControls(newZenInput);

            // Après avoir inséré le HTML du dashboard, relie les boutons -/+ à l'input correspondant
            // (à placer à la fin de createEconomicDashboard)
            setTimeout(() => {
                document.querySelectorAll('.simulator-input').forEach(simInput => {
                    const minus = simInput.querySelector('.input-row .number-control:first-child');
                    const plus = simInput.querySelector('.input-row .number-control:last-child');
                    const input = simInput.querySelector('.input-row input[type=number]');
                    if (minus && plus && input) {
                        minus.onclick = () => {
                            let v = parseInt(input.value) || 0;
                            if (v > parseInt(input.min)) {
                                input.value = v - 1;
                                input.dispatchEvent(new Event('input'));
                            }
                        };
                        plus.onclick = () => {
                            let v = parseInt(input.value) || 0;
                            if (v < parseInt(input.max)) {
                                input.value = v + 1;
                                input.dispatchEvent(new Event('input'));
                            }
                        };
                    }
                });
            }, 0);
        }

        // Charger les données au chargement de la page
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const uPlanetAPI_URL = urlParams.get('api_url') || '';
            
            // Utiliser l'URL de l'API par défaut si aucun paramètre n'est fourni
            loadUPlanetData(uPlanetAPI_URL).then(data => {
                if (data) {
                    createEconomicDashboard(data);
                    
                    // Force initial update after dashboard creation
                    const newNostrInput = document.getElementById('new-nostr');
                    const newZenInput = document.getElementById('new-zen');
                    
                    if (newNostrInput && newZenInput) {
                        // Trigger input events to update simulation
                        newNostrInput.dispatchEvent(new Event('input'));
                        newZenInput.dispatchEvent(new Event('input'));
                    }
                }
            });
        });

    </script>
</body>
</html> 