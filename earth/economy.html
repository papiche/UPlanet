<!DOCTYPE html>
<html>
<head>
    <title>♥️BOX : ẐEN Economic Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
            background: #181c24;
            height: 100vh;
            overflow: hidden;
        }

        .economic-dashboard {
            background: #232733;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow-y: auto;
            font-family: 'Arial', sans-serif;
            box-sizing: border-box;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Style de la barre de défilement */
        .economic-dashboard::-webkit-scrollbar {
            width: 6px;
        }

        .economic-dashboard::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .economic-dashboard::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        .economic-dashboard::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .status-section {
            margin-bottom: 18px;
            padding: 18px 16px;
            background: #232733;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: 1.5px solid #232733;
        }

        .metric-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 6px;
            margin-top: 6px;
        }

        .metric-box {
            padding: 6px;
            border-radius: 6px;
        }

        .metric-box .metric-title {
            font-size: 0.9em;
            margin-bottom: 4px;
            padding-bottom: 4px;
        }

        .metric-box .metric-value {
            font-size: 1.1em;
        }

        .metric-box .metric-subtitle {
            font-size: 0.75em;
            margin-top: 2px;
        }

        .metric-box .price {
            font-size: 1.1em;
            margin-top: 6px;
        }

        .metric-box .buy-button {
            padding: 4px 8px;
            margin-top: 4px;
            font-size: 0.85em;
            border-radius: 4px;
        }

        .metric-box.zen-card {
            border-color: #2ecc71;
            background: linear-gradient(145deg, #232733, #1e2a22);
        }

        .metric-box.zen-card:hover {
            background: linear-gradient(145deg, #1e2a22, #232733);
        }

        .metric-box.multipass {
            border-color: #3498db;
            background: linear-gradient(145deg, #232733, #1e2533);
        }

        .metric-box.multipass:hover {
            background: linear-gradient(145deg, #1e2533, #232733);
        }

        .metric-box .metric-title {
            color: #b8c6e0;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #232733;
        }

        .metric-box .metric-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #eaf6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .metric-box .metric-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .metric-box .buy-button {
            display: inline-block;
            background: #3498db;
            color: #fff !important;
            padding: 6px 14px;
            border-radius: 6px;
            text-decoration: none;
            margin-left: 8px;
            font-weight: bold;
            font-size: 0.95em;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52,152,219,0.10);
        }

        .metric-box.zen-card .buy-button {
            background: #2ecc71;
        }

        .metric-box .buy-button:hover {
            background: #217dbb;
            color: #fff !important;
            text-decoration: none;
            transform: translateY(-1px) scale(1.04);
            box-shadow: 0 4px 16px rgba(52,152,219,0.18);
        }

        .simulator-section {
            margin-top: 8px;
            padding: 12px;
            background: #232733;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        .simulation-results {
            margin-top: 8px;
            padding: 12px;
        }

        .simulator-controls {
            display: flex;
            flex-direction: row;
            gap: 24px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .simulator-input {
            max-width: 220px;
            min-width: 180px;
            background: linear-gradient(145deg, #232733, #1e222d);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 8px 12px 8px;
            gap: 6px;
        }

        .simulator-input label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1em;
            font-weight: 600;
            color: #eaf6ff;
            margin-bottom: 0;
        }

        .simulator-input .simu-picto {
            font-size: 1.2em;
        }

        .simulator-input .simu-header {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .simulator-input .buy-button {
            margin: 0;
            padding: 4px 10px;
            font-size: 0.95em;
            background: #3498db;
            color: #fff !important;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .simulator-input .buy-button:hover {
            background: #217dbb;
        }

        .simulator-input .price-tag {
            font-size: 0.9em;
            color: #b8c6e0;
            margin-bottom: 2px;
        }

        .simulator-input .input-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 2px;
        }

        .simulator-input input[type=number] {
            width: 60px;
            min-width: 0;
            padding: 2px 4px;
            font-size: 1.1em;
            border-radius: 4px;
            border: 1px solid #232733;
            text-align: center;
            background: #181c24;
            color: #eaf6ff;
            font-weight: 700;
            height: 28px;
        }

        .simulator-input input[type=number]::-webkit-inner-spin-button, 
        .simulator-input input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .simulator-input input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .simulator-input .number-control {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            color: #b8c6e0;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .simulator-input .number-control:hover {
            background: #3498db;
            color: #fff;
        }

        .simulator-input .max-value {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .progress-container {
            background: #232733;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #232733;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71);
            transition: width 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform-origin: left;
        }

        .progress-bar-fill.negative {
            background: #e74c3c;
            transform: scaleX(-1);
        }

        .progress-value.negative {
            color: #e74c3c;
        }

        .progress-value.positive {
            color: #2ecc71;
        }

        /* Styles pour la répartition des bénéfices UPlanet */
        .uplanet-distribution {
            margin-top: 12px;
            padding: 8px;
        }

        .uplanet-distribution.active {
            opacity: 1;
            background: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .uplanet-distribution.animate-in {
            animation: uplanet-appear 1s ease-out;
        }

        @keyframes uplanet-appear {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            50% {
                transform: translateY(-10px);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .distribution-bars {
            margin-top: 15px;
        }

        .distribution-item {
            margin: 12px 0;
        }

        .distribution-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .distribution-percentage {
            font-weight: bold;
            color: #3498db;
        }

        .distribution-value {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .distribution-bar {
            height: 8px;
            background: #232733;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .distribution-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            transition: all 0.5s ease-in-out;
            transform-origin: left;
            will-change: transform;
        }

        .distribution-fill.cash {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .distribution-fill.infra {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        .distribution-fill.rd {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .metric-details {
            font-size: 0.9em;
            color: #b8c6e0;
            margin-top: 5px;
        }

        .metric-details div {
            margin: 2px 0;
        }

        .thresholds {
            margin-top: 15px;
        }

        .threshold {
            margin: 10px 0;
            padding: 10px;
            background: #232733;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .threshold.active {
            background: #232733;
            border-left: 4px solid #3498db;
        }

        .threshold-label {
            font-weight: bold;
            color: #b8c6e0;
            margin-bottom: 5px;
        }

        .threshold-value {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .threshold-progress {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .threshold-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.5s ease-in-out;
        }

        .benefit-card {
            background: #232733;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .benefit-card h4 {
            color: #3498db;
            margin: 0 0 8px 0;
            font-size: 1.1em;
        }

        .benefit-card ul {
            list-style: none;
            padding: 0;
            margin: 0 0 12px 0;
        }

        .benefit-card li {
            padding: 4px 0;
            color: #b8c6e0;
            position: relative;
            padding-left: 18px;
            font-size: 0.9em;
        }

        .benefit-card li:before {
            content: "✓";
            color: #2ecc71;
            position: absolute;
            left: 0;
        }

        .subscribe-button {
            padding: 12px;
            font-size: 1em;
        }

        .info-table {
            margin: 8px 0;
            font-size: 0.9em;
            background: #232733;
            color: #b8c6e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .table-header {
            padding: 8px;
        }

        .table-label {
            padding: 6px;
        }

        .info-table td {
            padding: 6px;
        }

        .compact-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .compact-list li {
            margin: 2px 0;
            padding-left: 15px;
            position: relative;
        }

        .compact-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #3498db;
        }

        .positive {
            color: #2ecc71;
        }

        .negative {
            color: #e74c3c;
        }

        /* Styles pour les graphiques en camembert */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin: 8px 0;
        }

        .metric-chart {
            background: #232733;
            padding: 6px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            text-align: center;
        }

        .chart-title {
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .chart-value {
            font-size: 1em;
            margin: 2px 0;
        }

        .chart-details {
            font-size: 0.7em;
            margin-top: 2px;
        }

        .pie-chart {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #181c24;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: 2px solid #232733;
            position: relative;
            margin: 0 auto;
        }

        .pie-chart::before {
            width: 65%;
            height: 65%;
            top: 17.5%;
            left: 17.5%;
        }

        .pie-chart.negative {
            background: #181c24;
        }

        .pie-chart.captain {
            background: #181c24;
        }

        .pie-chart.uplanet {
            background: #181c24;
        }

        .chart-legend {
            gap: 8px;
            margin-top: 6px;
            font-size: 0.75em;
        }

        .legend-item {
            gap: 4px;
        }

        .legend-color {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .economic-dashboard {
                padding: 10px;
                max-width: 100%;
            }

            .metric-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .metric-box {
                padding: 8px;
            }

            .metric-box .metric-title {
                font-size: 0.8em;
                margin-bottom: 4px;
                padding-bottom: 4px;
            }

            .metric-box .metric-value {
                font-size: 1.1em;
            }

            .metric-box .metric-subtitle {
                font-size: 0.7em;
            }

            .simulator-controls {
                flex-direction: row;
                gap: 8px;
            }

            .simulator-input {
                min-width: 0;
                padding: 8px 6px;
                border-radius: 8px;
            }

            .simulator-input label {
                font-size: 0.9em;
            }

            .simulator-input input[type=number] {
                width: 50px;
                font-size: 0.9em;
                height: 24px;
            }

            .simulator-input .number-control {
                width: 24px;
                height: 24px;
                font-size: 0.9em;
            }

            .simulator-input .max-value {
                font-size: 0.75em;
            }

            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .metric-chart {
                padding: 4px;
            }

            .chart-title {
                font-size: 0.7em;
            }

            .chart-value {
                font-size: 0.9em;
            }

            .chart-details {
                font-size: 0.65em;
            }

            .pie-chart {
                width: 40px;
                height: 40px;
            }

            .uplanet-distribution h3 {
                font-size: 1em;
            }
        }

        @media (min-width: 768px) {
            .simulator-controls {
                flex-direction: row;
                justify-content: center;
                gap: 16px;
            }

            .simulator-input {
                min-width: 240px;
            }
        }

        h1, h2, h3, h4, h5, h6 {
            color: #eaf6ff !important;
        }
        label, .chart-title, .metric-title, .legend-item, .legend-color, .metric-subtitle, .max-value, .price-tag, .threshold-label, .threshold-value, .distribution-label, .distribution-percentage, .distribution-value, .table-header, .table-label {
            color: #b8c6e0 !important;
        }
        .chart-details, .metric-details, .compact-list li, .simulation-results, .info-table, .benefit-card li {
            color: #b8c6e0 !important;
        }
        
        /* Amélioration de la lisibilité des liens et du texte */
        a {
            color: #3498db !important;
            text-decoration: none;
        }
        
        a:hover {
            color: #5dade2 !important;
            text-decoration: underline;
        }
        
        a:visited {
            color: #85c1e9 !important;
        }
        
        /* Amélioration du contraste pour le texte UPlanet */
        .uplanet-info {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: 600;
        }
        
        .uplanet-balance {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            font-weight: bold;
        }

        /* Legal Wallets Styles */
        .legal-wallets-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 8px;
        }

        .legal-wallets-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .legal-wallets-row.two-cols {
            grid-template-columns: repeat(2, 1fr);
        }

        .legal-wallets-row.three-cols {
            grid-template-columns: repeat(3, 1fr);
        }

        .legal-wallets-row.one-col {
            grid-template-columns: 1fr;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .wallet-separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            margin: 8px 0;
        }

        .legal-wallet-card {
            background: linear-gradient(145deg, #232733, #1e2a22);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .legal-wallet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border-color: rgba(52,152,219,0.3);
        }

        .legal-wallet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--wallet-color, #3498db);
        }

        .legal-wallet-card.treasury::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .legal-wallet-card.rnd::before {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .legal-wallet-card.assets::before {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        .legal-wallet-card.impot::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .legal-wallet-card.g1::before {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .legal-wallet-card.society::before {
            background: linear-gradient(90deg, #34495e, #2c3e50);
        }

        .legal-wallet-card.ca::before {
            background: linear-gradient(90deg, #16a085, #1abc9c);
        }

        .legal-wallet-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .legal-wallet-icon {
            font-size: 1.2em;
        }

        .legal-wallet-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #eaf6ff;
        }

        .legal-wallet-balance {
            font-size: 1.3em;
            font-weight: bold;
            color: #eaf6ff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            margin-bottom: 4px;
            min-height: 2em;
            display: flex;
            align-items: center;
        }

        .legal-wallet-balance .loading {
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .legal-wallet-description {
            font-size: 0.75em;
            color: #b8c6e0;
            line-height: 1.3;
        }

        .legal-wallet-pubkey {
            font-size: 0.7em;
            color: #7f8c8d;
            font-family: monospace;
            margin-top: 4px;
            word-break: break-all;
        }

        .copyable-pubkey {
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .copyable-pubkey:hover {
            color: #3498db;
            background: rgba(52,152,219,0.1);
            transform: scale(1.02);
        }

        .copyable-pubkey:active {
            transform: scale(0.98);
        }

        @media (max-width: 768px) {
            .legal-wallets-grid {
                gap: 12px;
            }

            .legal-wallets-row {
                gap: 6px;
            }

            .legal-wallets-row.two-cols,
            .legal-wallets-row.three-cols {
                grid-template-columns: repeat(2, 1fr);
            }

            .legal-wallets-row.one-col {
                grid-template-columns: 1fr;
                max-width: 100%;
            }

            .legal-wallet-card {
                padding: 8px;
            }

            .legal-wallet-balance {
                font-size: 1.1em;
            }

            .legal-wallet-name {
                font-size: 0.8em;
            }

            .legal-wallet-description {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="economic-dashboard">
        <!-- Le contenu de l'encart ECONOMY sera chargé dynamiquement ici -->
    </div>

    <script>
        // Fonction pour copier dans le presse-papier avec feedback visuel
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                // Feedback visuel de succès
                const originalContent = element.innerHTML;
                const originalColor = element.style.color;
                
                element.innerHTML = '✅ Copié !';
                element.style.color = '#2ecc71';
                
                setTimeout(() => {
                    element.innerHTML = originalContent;
                    element.style.color = originalColor;
                }, 1500);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                // Feedback visuel d'erreur
                const originalContent = element.innerHTML;
                element.innerHTML = '❌ Erreur';
                element.style.color = '#e74c3c';
                
                setTimeout(() => {
                    element.innerHTML = originalContent;
                }, 1500);
            });
        }

        // Fonction pour transformer l'URL en URL de l'API
        function getAPIUrl() {
            const currentUrl = new URL(window.location.href);
            let apiUrl = new URL(currentUrl.origin);

            // Transformation de 'ipfs.domain.tld' en `u.domain.tld`
            if (currentUrl.hostname.startsWith('ipfs.')) {
                apiUrl.hostname = apiUrl.hostname.replace('ipfs.', 'u.');
            }

            // Changer le port en 54321 si le port actuel est 8080
            if (currentUrl.port === '8080' || currentUrl.port !== '') {
                apiUrl.port = '54321';
            }

            // Return clean URL without trailing slash
            return apiUrl.toString().replace(/\/+$/, '');
        }

        // Fonction pour charger les données UPlanet (progressive loading)
        async function loadUPlanetData(myURL, onUstatsLoaded = null, onMynodeLoaded = null) {
            try {
                // Step 1: Get IPFSNODEID from Ustats API (fast)
                const apiUrl = myURL || getAPIUrl();
                console.log('Step 1: Fetching Ustats data from:', apiUrl);
                const ustatsResponse = await fetch(apiUrl);
                const ustatsData = await ustatsResponse.json();
                console.log('Ustats data loaded successfully:', ustatsData);

                // Store the original API URL for balance checking
                ustatsData._originalApiUrl = apiUrl;

                // Call callback with Ustats data immediately (for quick display)
                if (onUstatsLoaded) {
                    onUstatsLoaded(ustatsData);
                }

                // Extract IPFSNODEID from Ustats
                const ipfsNodeId = ustatsData.IPFSNODEID;
                if (!ipfsNodeId) {
                    console.error('No IPFSNODEID found in Ustats data');
                    return ustatsData; // Return Ustats data anyway
                }

                // Step 2: Get mynode data from /ipns/IPFSNODEID/12345.json (slow)
                // Construct the IPFS gateway URL for the mynode data
                const baseUrl = new URL(apiUrl);
                const ipfsGatewayUrl = `${baseUrl.protocol}//${baseUrl.hostname.replace('u.', 'ipfs.')}${baseUrl.port ? ':' + (baseUrl.port === '54321' ? '8080' : baseUrl.port) : ''}`;
                const mynodeDataUrl = `${ipfsGatewayUrl}/ipns/${ipfsNodeId}/12345.json`;
                console.log('Step 2: Fetching mynode data from:', mynodeDataUrl);
                
                try {
                    const mynodeResponse = await fetch(mynodeDataUrl);
                    const mynodeData = await mynodeResponse.json();
                    console.log('Wallet data loaded successfully:', mynodeData);

                    // Merge Ustats data with mynode data (mynode data takes precedence for overlapping keys)
                    const mergedData = { ...ustatsData, ...mynodeData };
                    // Store the original API URL for balance checking
                    mergedData._originalApiUrl = apiUrl;
                    console.log('Merged data:', mergedData);

                    // Call callback with merged data (for complete display)
                    if (onMynodeLoaded) {
                        onMynodeLoaded(mergedData);
                    }

                    return mergedData;
                } catch (mynodeError) {
                    console.warn('Failed to fetch mynode data, using Ustats data only:', mynodeError);
                    return ustatsData; // Fallback to Ustats data only
                }

            } catch (error) {
                console.error('Error loading UPlanet data:', error);
                return null;
            }
        }

        // Fonction pour récupérer le solde d'un portefeuille
        async function fetchWalletBalance(g1pub, apiBaseUrl) {
            try {
                if (!g1pub || g1pub === 'N/A') {
                    return { balance: '0.00', zen: '0.00' };
                }

                // Ensure proper URL construction without double slashes
                const cleanApiBaseUrl = apiBaseUrl.replace(/\/+$/, ''); // Remove trailing slashes
                const balanceUrl = `${cleanApiBaseUrl}/check_balance?g1pub=${g1pub}`;
                console.log('Fetching balance from:', balanceUrl);
                
                const response = await fetch(balanceUrl);
                const data = await response.json();
                
                if (data && data.balance) {
                    const g1Balance = parseFloat(data.balance);
                    // Convert Ğ1 to ẐEN (1 Ğ1 = 10 ẐEN, but we need to subtract 1 first)
                    const zenBalance = (g1Balance - 1) * 10;
                    
                    return {
                        balance: g1Balance.toFixed(2),
                        zen: Math.max(0, zenBalance).toFixed(2) // Ensure non-negative
                    };
                } else {
                    console.warn('Invalid balance response for', g1pub, data);
                    return { balance: '0.00', zen: '0.00' };
                }
            } catch (error) {
                console.error('Error fetching balance for', g1pub, error);
                return { balance: '0.00', zen: '0.00' };
            }
        }

        // Fonction pour créer la section des portefeuilles légaux
        async function createLegalWalletsSection(data, originalApiUrl) {
            const legalWalletsGrid = document.getElementById('legal-wallets-grid');
            
            // Define the legal wallets with their properties (G1 Reserve is displayed separately)
            // Organized in groups for visual layout
            const walletGroups = [
                {
                    name: 'revenue_social',
                    columns: 'two-cols',
                    wallets: [
                        {
                            key: 'UPLANETG1PUB',
                            name: 'Chiffre d\'Affaires',
                            icon: '📡',
                            description: 'Hub de distribution des services - Historique des revenus',
                            className: 'ca',
                            isRevenue: true  // Special flag to display CA from incoming transactions
                        },
                        {
                            key: 'UPLANETNAME_SOCIETY',
                            name: 'Capital Social',
                            icon: '⭐',
                            description: 'Gère les apports des sociétaires et l\'émission des parts',
                            className: 'society'
                        }
                    ]
                },
                {
                    name: 'cooperative_distribution',
                    columns: 'three-cols',
                    wallets: [
                        {
                            key: 'UPLANETNAME_TREASURY',
                            name: 'Trésorerie (1/3)',
                            icon: '💰',
                            description: 'Réserves impartageables pour la liquidité',
                            className: 'treasury'
                        },
                        {
                            key: 'UPLANETNAME_RND',
                            name: 'R&D (1/3)',
                            icon: '🔬',
                            description: 'Financement du G1FabLab et de l\'innovation',
                            className: 'rnd'
                        },
                        {
                            key: 'UPLANETNAME_ASSETS',
                            name: 'Actifs Réels (1/3)',
                            icon: '🌳',
                            description: 'Acquisition des forêts-jardins et biens communs',
                            className: 'assets'
                        }
                    ]
                }
            ];

            // Use the original API URL for balance checking (uSPOT API)
            const apiBaseUrl = originalApiUrl || getAPIUrl();

            // Create initial HTML with loading states organized in groups
            let walletsHTML = '';
            
            walletGroups.forEach((group, groupIndex) => {
                // Add separator before each group (except the first one)
                if (groupIndex > 0) {
                    walletsHTML += '<div class="wallet-separator"></div>';
                }
                
                // Start a new row with the appropriate column layout
                walletsHTML += `<div class="legal-wallets-row ${group.columns}">`;
                
                group.wallets.forEach(wallet => {
                    const pubkey = data[wallet.key] || 'N/A';
                    const shortPubkey = pubkey !== 'N/A' ? `${pubkey.substring(0, 8)}...${pubkey.substring(pubkey.length - 4)}` : 'N/A';
                    
                    walletsHTML += `
                        <div class="legal-wallet-card ${wallet.className}" id="wallet-${wallet.key}">
                            <div class="legal-wallet-header">
                                <span class="legal-wallet-icon">${wallet.icon}</span>
                                <span class="legal-wallet-name">${wallet.name}</span>
                            </div>
                            <div class="legal-wallet-balance" id="balance-${wallet.key}">
                                <span class="loading" style="color: #7f8c8d; font-size: 0.9em;">⏳ Chargement...</span>
                            </div>
                            <div class="legal-wallet-description">${wallet.description}</div>
                            <div class="legal-wallet-pubkey" title="${pubkey}">${shortPubkey}</div>
                        </div>
                    `;
                });
                
                // Close the row
                walletsHTML += '</div>';
            });

            legalWalletsGrid.innerHTML = walletsHTML;

            // Add Tax Provision section with same style as G1 Reserve
            const taxProvisionHTML = `
                <div class="wallet-separator"></div>
                <div class="status-section" style="
                    background: linear-gradient(145deg, #232733, #2a1e1e);
                    border-left: 4px solid #e74c3c;
                    transition: all 0.3s ease;
                    padding: 8px 12px;
                    margin-top: 0;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
                ">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
                                <span style="font-size: 1.2em;">📊</span>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <span style="font-size: 0.85em; color: #b8c6e0; font-weight: 600;">Solde Provision Fiscale</span>
                                    <span style="font-size: 0.65em; color: #7f8c8d; line-height: 1.2;">TVA et IS provisionnés - Solde disponible</span>
                                </div>
                            </div>
                            <div id="tax-provision-balance" style="display: flex; align-items: baseline; gap: 6px;">
                                <span style="color: #7f8c8d; font-size: 0.8em;">⏳ Chargement...</span>
                            </div>
                        </div>
                        <div style="padding-left: 28px;">
                            <a id="tax-provision-link" href="#" style="
                                display: inline-block;
                                font-size: 0.75em;
                                color: #e74c3c;
                                text-decoration: none;
                                padding: 4px 8px;
                                background: rgba(231,76,60,0.1);
                                border-radius: 4px;
                                transition: all 0.3s;
                            " onmouseover="this.style.background='rgba(231,76,60,0.2)'" onmouseout="this.style.background='rgba(231,76,60,0.1)'">
                                📜 Historique Complet des Provisions
                            </a>
                        </div>
                    </div>
                </div>
            `;
            legalWalletsGrid.insertAdjacentHTML('beforeend', taxProvisionHTML);

            // Fetch G1 Reserve balance separately (displayed above cooperative wallets)
            const g1ReservePubkey = data['UPLANETNAME_G1'];
            const g1ReserveBalanceElement = document.getElementById('g1-reserve-balance');
            const g1ReservePubkeyElement = document.getElementById('g1-reserve-pubkey');
            
            if (g1ReservePubkey && g1ReservePubkey !== 'N/A') {
                // Display public key (shortened format)
                const shortPubkey = `${g1ReservePubkey.substring(0, 8)}...${g1ReservePubkey.substring(g1ReservePubkey.length - 4)}`;
                g1ReservePubkeyElement.innerHTML = `
                    <span class="copyable-pubkey" title="📋 Cliquer pour copier: ${g1ReservePubkey}">${shortPubkey}</span>
                `;
                
                // Add click event to copy to clipboard
                const copyableElement = g1ReservePubkeyElement.querySelector('.copyable-pubkey');
                if (copyableElement) {
                    copyableElement.addEventListener('click', (e) => {
                        copyToClipboard(g1ReservePubkey, e.target);
                    });
                }
                
                try {
                    const balanceData = await fetchWalletBalance(g1ReservePubkey, apiBaseUrl);
                    
                    // Display with Ğ1 large and Ẑ small
                    g1ReserveBalanceElement.innerHTML = `
                        <div style="display: flex; align-items: baseline; gap: 8px;">
                            <span style="font-size: 1.5em; font-weight: bold; color: #9b59b6;">${balanceData.balance} Ğ1</span>
                            <span style="font-size: 0.85em; color: #7f8c8d;">(${balanceData.zen} Ẑ)</span>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading G1 Reserve balance:', error);
                    g1ReserveBalanceElement.innerHTML = `
                        <span style="color: #e74c3c; font-size: 0.9em;">❌ Erreur</span>
                    `;
                }
            } else {
                g1ReserveBalanceElement.innerHTML = `
                    <span style="color: #7f8c8d; font-size: 0.9em;">N/A</span>
                `;
                g1ReservePubkeyElement.innerHTML = `
                    <span style="color: #7f8c8d;">N/A</span>
                `;
            }

            // Fetch Tax Provision balance separately
            const taxProvisionPubkey = data['UPLANETNAME_IMPOT'];
            const taxProvisionBalanceElement = document.getElementById('tax-provision-balance');
            const taxProvisionLinkElement = document.getElementById('tax-provision-link');
            
            if (taxProvisionPubkey && taxProvisionPubkey !== 'N/A') {
                try {
                    // Get current balance
                    const balanceData = await fetchWalletBalance(taxProvisionPubkey, apiBaseUrl);
                    const currentBalance = parseFloat(balanceData.zen);
                    
                    // Get total provisions from check_impots API
                    const cleanApiBaseUrl = apiBaseUrl.replace(/\/+$/, '');
                    const impostsUrl = `${cleanApiBaseUrl}/check_impots`;
                    
                    try {
                        const impostsResponse = await fetch(impostsUrl);
                        const impostsData = await impostsResponse.json();
                        
                        if (impostsData && impostsData.total_provisions_zen !== undefined) {
                            const totalProvisioned = parseFloat(impostsData.total_provisions_zen);
                            const used = totalProvisioned - currentBalance;
                            
                            // Display both current balance and total provisioned with difference
                            taxProvisionBalanceElement.innerHTML = `
                                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                                    <div style="display: flex; align-items: baseline; gap: 6px;">
                                        <span style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${currentBalance.toFixed(2)} Ẑ</span>
                                        <span style="font-size: 0.75em; color: #7f8c8d;">disponible</span>
                                    </div>
                                    ${used > 0 ? `
                                    <div style="font-size: 0.7em; color: #b8c6e0;">
                                        ${totalProvisioned.toFixed(2)} Ẑ provisionné • ${used.toFixed(2)} Ẑ utilisé
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        } else {
                            // Fallback: only display current balance
                            taxProvisionBalanceElement.innerHTML = `
                                <span style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${currentBalance.toFixed(2)} Ẑ</span>
                            `;
                        }
                    } catch (impostsError) {
                        console.warn('Failed to fetch provisions history, showing balance only:', impostsError);
                        // Fallback: only display current balance
                        taxProvisionBalanceElement.innerHTML = `
                            <span style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${currentBalance.toFixed(2)} Ẑ</span>
                        `;
                    }
                    
                    // Update link to point to check_impots with HTML output
                    if (taxProvisionLinkElement) {
                        const cleanApiBaseUrl = apiBaseUrl.replace(/\/+$/, '');
                        taxProvisionLinkElement.href = `${cleanApiBaseUrl}/check_impots?html=1`;
                        taxProvisionLinkElement.target = '_blank';
                    }
                } catch (error) {
                    console.error('Error loading Tax Provision balance:', error);
                    taxProvisionBalanceElement.innerHTML = `
                        <span style="color: #e74c3c; font-size: 0.9em;">❌ Erreur</span>
                    `;
                }
            } else {
                taxProvisionBalanceElement.innerHTML = `
                    <span style="color: #7f8c8d; font-size: 0.9em;">N/A</span>
                `;
            }

            // Fetch balances for each wallet in the background
            // Flatten all wallets from all groups
            const allWallets = walletGroups.flatMap(group => group.wallets);
            
            allWallets.forEach(async (wallet) => {
                const pubkey = data[wallet.key];
                const balanceElement = document.getElementById(`balance-${wallet.key}`);
                
                if (pubkey && pubkey !== 'N/A') {
                    try {
                        // Special handling for CA wallet (UPLANETG1PUB) - show revenue history
                        if (wallet.key === 'UPLANETG1PUB' && wallet.isRevenue) {
                            // Fetch revenue data to display total CA
                            const cleanApiBaseUrl = apiBaseUrl.replace(/\/+$/, '');
                            const revenueUrl = `${cleanApiBaseUrl}/check_revenue`;
                            console.log('Fetching revenue data from:', revenueUrl);
                            
                            try {
                                const revenueResponse = await fetch(revenueUrl);
                                const revenueData = await revenueResponse.json();
                                
                                if (revenueData && revenueData.total_revenue_zen !== undefined) {
                                    // Display total revenue with button to view history
                                    balanceElement.innerHTML = `
                                        <div style="display: flex; flex-direction: column; gap: 4px;">
                                            <div style="font-size: 1.3em; font-weight: bold;">${revenueData.total_revenue_zen.toFixed(2)} Ẑ</div>
                                            <div style="font-size: 0.7em; color: #7f8c8d;">${revenueData.total_transactions} ventes RENTAL</div>
                                            <a href="${cleanApiBaseUrl}/check_revenue?html=1" target="_blank" style="
                                                display: inline-block;
                                                margin-top: 4px;
                                                padding: 4px 8px;
                                                background: #16a085;
                                                color: white !important;
                                                text-decoration: none;
                                                border-radius: 4px;
                                                font-size: 0.75em;
                                                text-align: center;
                                                transition: background 0.3s;
                                            " onmouseover="this.style.background='#138d75'" onmouseout="this.style.background='#16a085'">
                                                💼 Historique CA
                                            </a>
                                        </div>
                                    `;
                                } else {
                                    throw new Error('Invalid revenue data');
                                }
                            } catch (error) {
                                console.warn('Failed to fetch revenue data, showing balance only:', error);
                                // Fallback: just display current balance
                                const balanceData = await fetchWalletBalance(pubkey, apiBaseUrl);
                                balanceElement.innerHTML = `
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="font-size: 1.3em; font-weight: bold;">${balanceData.zen} Ẑ</div>
                                        <div style="font-size: 0.8em; color: #7f8c8d;">${balanceData.balance} Ğ1</div>
                                        <div style="font-size: 0.7em; color: #16a085; margin-top: 2px;">
                                            💼 Hub de distribution actif
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        // Special handling for SOCIETY wallet - show total outgoing transfers
                        else if (wallet.key === 'UPLANETNAME_SOCIETY') {
                            // Fetch society history (no g1pub parameter needed - read from environment)
                            const cleanApiBaseUrl = apiBaseUrl.replace(/\/+$/, '');
                            const societyUrl = `${cleanApiBaseUrl}/check_society`;
                            console.log('Fetching society history from:', societyUrl);
                            
                            const response = await fetch(societyUrl);
                            const societyData = await response.json();
                            
                            if (societyData && societyData.total_outgoing_zen !== undefined) {
                                // Display total outgoing transfers with button to view history
                                balanceElement.innerHTML = `
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="font-size: 1.3em; font-weight: bold;">${societyData.total_outgoing_zen.toFixed(2)} Ẑ</div>
                                        <div style="font-size: 0.7em; color: #7f8c8d;">${societyData.total_transfers} parts distribuées</div>
                                        <a href="${cleanApiBaseUrl}/check_society?html=1" target="_blank" style="
                                            display: inline-block;
                                            margin-top: 4px;
                                            padding: 4px 8px;
                                            background: #3498db;
                                            color: white !important;
                                            text-decoration: none;
                                            border-radius: 4px;
                                            font-size: 0.75em;
                                            text-align: center;
                                            transition: background 0.3s;
                                        " onmouseover="this.style.background='#217dbb'" onmouseout="this.style.background='#3498db'">
                                            📜 Historique
                                        </a>
                                    </div>
                                `;
                            } else {
                                balanceElement.innerHTML = `
                                    <div style="color: #7f8c8d; font-size: 0.9em;">0.00 Ẑ</div>
                                `;
                            }
                        } else {
                            // Normal balance display for other wallets
                            const balanceData = await fetchWalletBalance(pubkey, apiBaseUrl);
                            
                            // Update the balance display
                            balanceElement.innerHTML = `
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <div style="font-size: 1.3em; font-weight: bold;">${balanceData.zen} Ẑ</div>
                                    <div style="font-size: 0.8em; color: #7f8c8d;">${balanceData.balance} Ğ1</div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error(`Error loading data for ${wallet.key}:`, error);
                        balanceElement.innerHTML = `
                            <div style="color: #e74c3c; font-size: 0.9em;">❌ Erreur</div>
                        `;
                    }
                } else {
                    balanceElement.innerHTML = `
                        <div style="color: #7f8c8d; font-size: 0.9em;">N/A</div>
                    `;
                }
            });
        }

        // Fonction pour créer le dashboard économique
        function createEconomicDashboard(data, isPartialData = false) {
            const dashboard = document.querySelector('.economic-dashboard');
            
            // Get values from JSON data with loading states
            // Use real capacities from API if available, otherwise fallback to defaults
            const maxPlayers = data.capacities?.zencard_slots || 24;
            const maxNostr = data.capacities?.nostr_slots || 250;
            const currentPlayers = data.PLAYERs ? data.PLAYERs.length : 0;
            const currentNostr = data.NOSTR ? data.NOSTR.length : 0;
            const availablePlayers = maxPlayers - currentPlayers;
            const availableNostr = maxNostr - currentNostr;

            // Get values from JSON data
            const zcard = parseInt(data.ZCARD) || 15;
            const ncard = parseInt(data.NCARD) || 4;
            const paf = parseInt(data.PAF) || 100;
            const zen = parseInt(data.ZEN) || 0;
            const bilan = parseInt(data.BILAN) || 0;

            // Count NOSTR accounts with more than ZCARD amount
            const nostrAboveZcard = data.NOSTR ? data.NOSTR.filter(nostr => parseInt(nostr.ZEN) > zcard).length : 0;
            
            // Count PLAYERs with more than ZCARD amount
            const playersAboveZcard = data.PLAYERs ? data.PLAYERs.filter(player => parseInt(player.ZEN) > zcard).length : 0;

            // Get IPFS Node ID
            const IPFSNODEID = data.IPFSNODEID ? data.IPFSNODEID : (isPartialData ? '⏳ Chargement...' : 'N/A');

            // Get first 8 characters of UPLANET public key
            const planetPub = data.UPLANETG1PUB ? data.UPLANETG1PUB.substring(0, 8) : (isPartialData ? '⏳' : 'N/A');

            dashboard.innerHTML = `
                <!-- UPlanet Status -->

                <!-- G1 Reserve Section -->
                <div class="status-section" style="
                    background: linear-gradient(145deg, #232733, #2a2233);
                    border-left: 4px solid #9b59b6;
                    transition: all 0.3s ease;
                    padding: 8px 12px;
                    margin-top: 12px;
                ">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
                                <span style="font-size: 1.2em;">🏛️</span>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <span style="font-size: 0.85em; color: #b8c6e0; font-weight: 600;">Réserve Ğ1</span>
                                    <span style="font-size: 0.65em; color: #7f8c8d; line-height: 1.2;">Portefeuille source qui alimente UPlanet</span>
                                </div>
                            </div>
                            <div id="g1-reserve-balance" style="display: flex; align-items: baseline; gap: 6px;">
                                <span style="color: #7f8c8d; font-size: 0.8em;">⏳ Chargement...</span>
                            </div>
                        </div>
                        <div id="g1-reserve-pubkey" style="font-size: 0.7em; color: #7f8c8d; font-family: monospace; word-break: break-all; padding-left: 28px;">
                            <!-- Public key will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Legal Wallets Section -->
                <div class="status-section" style="
                    background: linear-gradient(145deg, #232733, #1e252a);
                    border-left: 4px solid #3498db;
                    transition: all 0.3s ease;
                    padding: 12px;
                    margin-top: 8px;
                ">
                    <div class="metric" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="metric-title" style="
                            font-size: 1.1em;
                            color: #eaf6ff;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                            <span style="font-size: 1.2em;">⚖️</span>
                            <span>Portefeuilles Coopératifs</span>
                        </div>
                        <div class="legal-wallets-grid" id="legal-wallets-grid">
                            <!-- Legal wallets will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Simulator Section -->
                <div class="simulator-section">
                    <div class="simulator-controls">
                        <div class="simulator-input multipass">
                            <div class="simu-header">
                                <a class="buy-button" href="https://opencollective.com/uplanet-zero/contribute" target="_blank"><span class="simu-picto">🔑</span> MULTIPASS</a>
                                <span class="price-tag">${ncard} Ẑ/semaine</span>
                            </div>
                            <div class="input-row">
                                <input type="number" id="new-nostr" min="0" max="${availableNostr}" value="${nostrAboveZcard}">
                            </div>
                            <div class="max-value">${availableNostr}/${maxNostr} dispo</div>
                        </div>
                        
                        <div class="simulator-separator"><span class="sep-dot"></span></div>

                        <div class="simulator-input zen-card">
                            <div class="simu-header">
                                <a class="buy-button" href="https://opencollective.com/uplanet-zero/contribute" target="_blank"><span class="simu-picto">💳</span> ZEN Card</a>
                                <span class="price-tag">${zcard} Ẑ/semaine</span>
                            </div>
                            <div class="input-row">
                                <input type="number" id="new-zen" min="0" max="${availablePlayers}" value="${playersAboveZcard}">
                            </div>
                            <div class="max-value">${availablePlayers}/${maxPlayers} dispo${maxPlayers === 0 ? ' ⚠️' : ''}</div>
                            ${maxPlayers === 0 ? `<div style="font-size: 0.7em; color: #e74c3c; margin-top: 2px;">Slots ZEN Card désactivés</div>` : ''}
                        </div>
                    </div>
                    <div class="simulation-results" id="simulation-results">
                        <!-- Results will be displayed here -->
                    </div>
                    <!-- Tax Configuration Section -->
                    <div style="margin-top: 16px; padding: 12px; background: rgba(52,152,219,0.1); border-radius: 8px; border-left: 3px solid #3498db;">
                        <div style="font-size: 0.9em; color: #3498db; font-weight: 600; margin-bottom: 8px;">⚖️ Configuration Fiscale</div>
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <label style="font-size: 0.8em; color: #b8c6e0;">Structure:</label>
                                <select id="legal-structure" style="padding: 2px 4px; font-size: 0.8em; border-radius: 4px; border: 1px solid #232733; background: #181c24; color: #eaf6ff;">
                                    <option value="association">Association Loi 1901</option>
                                    <option value="scic" selected>SCIC SAS ⭐ (Recommandé UPlanet)</option>
                                    <option value="gie">GIE (Groupement d'Intérêt Économique)</option>
                                    <option value="sas">SAS (Société par Actions Simplifiée)</option>
                                    <option value="sarl">SARL (Société à Responsabilité Limitée)</option>
                                    <option value="auto-entrepreneur">Auto-entrepreneur / Micro-entreprise</option>
                                    <option value="sci">SCI (Société Civile Immobilière)</option>
                                    <option value="federation">Fédération Commerciale</option>
                                    <option value="startup">Startup (SAS + levée de fonds)</option>
                                    <option value="cooperative">Coopérative (SCOP)</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <label style="font-size: 0.8em; color: #b8c6e0;">TVA Locations:</label>
                                <input type="number" id="vat-rate" min="0" max="30" step="0.1" value="0.0" style="width: 50px; padding: 2px 4px; font-size: 0.8em; border-radius: 4px; border: 1px solid #232733; background: #181c24; color: #eaf6ff; text-align: center;">
                                <span style="font-size: 0.8em; color: #b8c6e0;">%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <label style="font-size: 0.8em; color: #b8c6e0;">IS Bénéfices:</label>
                                <input type="number" id="corporate-tax-rate" min="0" max="50" step="0.1" value="0.0" style="width: 50px; padding: 2px 4px; font-size: 0.8em; border-radius: 4px; border: 1px solid #232733; background: #181c24; color: #eaf6ff; text-align: center;">
                                <span style="font-size: 0.8em; color: #b8c6e0;">%</span>
                            </div>
                        </div>
                        <div id="tax-info" style="margin-top: 8px; font-size: 0.75em; color: #7f8c8d; line-height: 1.3;">
                            <!-- Tax information will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Usage-based Advice Section -->
                <div class="status-section" style="
                    background: linear-gradient(145deg, #232733, #1e2a1e);
                    border-left: 4px solid #2ecc71;
                    transition: all 0.3s ease;
                    padding: 12px;
                    margin-top: 12px;
                ">
                    <div class="metric" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="metric-title" style="
                            font-size: 1.1em;
                            color: #eaf6ff;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                            <span style="font-size: 1.2em;">💡</span>
                            <span>Conseils selon votre Usage du ẐEN</span>
                        </div>
                        <div id="usage-advice" style="color: #b8c6e0; line-height: 1.4;">
                            <!-- Usage advice will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Constellation Simulator Link Section -->
                <div class="status-section" style="
                    background: linear-gradient(145deg, #232733, #1e2533);
                    border-left: 4px solid #3498db;
                    transition: all 0.3s ease;
                    padding: 20px;
                    margin-top: 12px;
                    text-align: center;
                ">
                    <div class="metric" style="display: flex; flex-direction: column; gap: 12px; align-items: center;">
                        <div class="metric-title" style="
                            font-size: 1.2em;
                            color: #eaf6ff;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                            <span style="font-size: 1.3em;">🏛️</span>
                            <span>Simulateur Stratégique Constellation</span>
                        </div>
                        <div style="color: #b8c6e0; line-height: 1.5; margin-bottom: 15px; max-width: 600px;">
                            Explorez la viabilité économique d'une coopérative numérique alternative. 
                            Modélisez différents scénarios de croissance et visualisez leur impact économique.
                        </div>
                        <a href="./economy.Constellation.html" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                            color: white;
                            padding: 12px 25px;
                            border-radius: 25px;
                            text-decoration: none;
                            font-weight: 600;
                            font-size: 1.1em;
                            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.4)';" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.3)';">
                            🚀 Lancer le Simulateur Constellation
                        </a>
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 8px;">
                            Modélisation interactive • Projection financière • Impact écologique
                        </div>
                    </div>
                </div>

                                <div class="status-section" style="
                    background: ${bilan < 0 ? 
                        'linear-gradient(145deg, #232733, #2a1e1e)' : 
                        bilan < paf ? 
                            'linear-gradient(145deg, #232733, #2a251e)' : 
                            bilan < (3 * paf) ? 
                                'linear-gradient(145deg, #232733, #1e252a)' : 
                                'linear-gradient(145deg, #232733, #1e2a22)'
                    };
                    border-left: 4px solid ${bilan < 0 ? 
                        '#e74c3c' : 
                        bilan < paf ? 
                            '#f39c12' : 
                            bilan < (3 * paf) ? 
                                '#3498db' : 
                                '#2ecc71'
                    };
                    transition: all 0.3s ease;
                    padding: 12px;
                    margin-top: 12px;
                ">
                    <div class="metric" style="display: flex; flex-direction: column; gap: 6px;">
                        <div class="metric-title" style="
                            font-size: 1em;
                            color: #eaf6ff;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                            <span style="font-size: 1.2em;">🌍</span>
                            <a href="/ipns/${IPFSNODEID}" target="_blank" style="color: #42a5f5 !important; text-shadow: 0 1px 2px rgba(0,0,0,0.8); font-weight: 600;">${IPFSNODEID}</a>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div class="metric-value uplanet-balance" id="uplanet-balance" style="
                                    font-size: 1.6em;
                                    font-weight: bold;
                                    color: ${bilan < 0 ? 
                                        '#ff6b6b' : 
                                        bilan < paf ? 
                                        '#ffa726' : 
                                        bilan < (3 * paf) ? 
                                            '#42a5f5' : 
                                            '#66bb6a'
                                    };
                                    text-shadow: 0 2px 4px rgba(0,0,0,0.9);
                                ">${bilan.toFixed(2)} Ẑ</div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 1.2em;">🌐</span>
                                    <span class="uplanet-info">UPlanet${planetPub}</span>
                                    <span class="uplanet-info">${zen.toFixed(2)} Ẑ</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.85em; color: #b8c6e0;">
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    💰 PAF: <strong style="color: #3498db;">${paf} Ẑ/sem</strong>
                                </span>
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    🔑 MULTIPASS: <strong style="color: #3498db;">${ncard} Ẑ/sem</strong>
                                </span>
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    💳 ZEN Card: <strong style="color: #2ecc71;">${zcard} Ẑ/sem</strong>
                                </span>
                            </div>
                        </div>
                        <div class="metric-subtitle" style="
                            font-size: 0.9em;
                            color: ${bilan < 0 ? 
                                '#ff6b6b' : 
                                bilan < paf ? 
                                    '#ffa726' : 
                                    bilan < (3 * paf) ? 
                                        '#42a5f5' : 
                                        '#66bb6a'
                            };
                            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                            <span style="font-size: 1.1em;">
                                ${bilan < 0 ? 
                                    '⚠️' : 
                                    bilan < paf ? 
                                        '🔄' : 
                                        bilan < (3 * paf) ? 
                                            '✅' : 
                                            '🌟'
                                }
                            </span>
                            ${bilan < 0 ? 
                                'Déficit' : 
                                bilan < paf ? 
                                    'Manque part du Capitaine' : 
                                    bilan < (3 * paf) ? 
                                        'PAF couvert' : 
                                        'PAF et Capitaine couverts'
                            }
                        </div>
                    </div>
                </div>
            `;

            // Create the legal wallets section (async - will load balances in background)
            // Only create if we have wallet data (not in partial loading state)
            if (!isPartialData || (data.UPLANETNAME_G1 || data.UPLANETNAME_TREASURY)) {
            createLegalWalletsSection(data, data._originalApiUrl);
            } else {
                // Show loading state for legal wallets
                const legalWalletsGrid = document.getElementById('legal-wallets-grid');
                if (legalWalletsGrid) {
                    legalWalletsGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #7f8c8d;">
                            <div style="font-size: 1.2em; margin-bottom: 8px;">⏳</div>
                            <div>Chargement des portefeuilles coopératifs...</div>
                            <div style="font-size: 0.8em; margin-top: 4px; opacity: 0.7;">Récupération des données IPNS en cours</div>
                        </div>
                    `;
                }
            }

            // Add event listeners for dynamic simulation
            const newNostrInput = document.getElementById('new-nostr');
            const newZenInput = document.getElementById('new-zen');

            function updateSimulation() {
                const newNostr = parseInt(newNostrInput.value) || nostrAboveZcard;
                const newZen = parseInt(newZenInput.value) || playersAboveZcard;
                
                // Get tax rates from selectors
                const vatRate = parseFloat(document.getElementById('vat-rate')?.value || 20.0) / 100;
                const corporateTaxRate = parseFloat(document.getElementById('corporate-tax-rate')?.value || 25.0) / 100;
                
                // Calculate weekly revenue (NCARD and ZCARD are per week)
                const weeklyNostrRevenue = newNostr * ncard;
                const weeklyZenRevenue = newZen * zcard;
                const totalWeeklyRevenue = weeklyNostrRevenue + weeklyZenRevenue;
                
                // Calculate VAT on rental income (TVA sur locations)
                const weeklyVAT = totalWeeklyRevenue * vatRate;
                
                // Calculate weekly costs (PAF is weekly)
                const weeklyPAF = paf; // PAF is weekly cost for NODE
                const weeklyCaptainCost = 2 * paf; // Captain gets 2x PAF weekly (target)
                
                // Calculate weekly thresholds based on ZEN.ECONOMY.sh and ZEN.COOPERATIVE.3x1-3.sh
                const nodeThreshold = weeklyPAF; // Node gets weekly PAF first
                const captainThreshold = weeklyPAF + weeklyCaptainCost; // Captain gets 2x PAF after node PAF (total 3x PAF)
                const uplanetThreshold = captainThreshold; // UPlanet distribution starts after Captain gets his 2x PAF
                
                // Calculate who gets paid (weekly amounts) - following ZEN.ECONOMY.sh logic
                const nodePayment = Math.min(totalWeeklyRevenue, nodeThreshold); // Weekly PAF is paid first to NODE
                const captainPayment = totalWeeklyRevenue > nodeThreshold ? 
                    Math.min(totalWeeklyRevenue - nodeThreshold, weeklyCaptainCost) : 0; // Captain gets 2x PAF after node PAF
                const uplanetPayment = totalWeeklyRevenue > uplanetThreshold ? 
                    totalWeeklyRevenue - uplanetThreshold : 0; // UPlanet gets surplus above 3x PAF (1x for node + 2x for captain)

                // Calculate UPlanet distribution if threshold is reached
                let uplanetDistribution = null;
                if (totalWeeklyRevenue >= uplanetThreshold) {
                    const totalUPlanetProfit = uplanetPayment;
                    uplanetDistribution = {
                        cash: totalUPlanetProfit * 0.34, // 34% pour la trésorerie
                        infra: totalUPlanetProfit * 0.33, // 33% pour l'infrastructure
                        rd: totalUPlanetProfit * 0.33 // 33% pour la R&D
                    };
                }

                // Create the base HTML
                let html = `
                    <div class="metrics-grid">
                        <div class="metric-chart">
                            <div class="chart-title">♥️BOX</div>
                            <div class="pie-chart" style="background: conic-gradient(
                                ${totalWeeklyRevenue > 0 ? 
                                    `hsl(${Math.min(120, (totalWeeklyRevenue / weeklyPAF) * 120)}, 70%, 45%)` : 
                                    '#e74c3c'
                                } 0% ${totalWeeklyRevenue > 0 ? Math.min(100, (totalWeeklyRevenue / weeklyPAF) * 100) : 0}%,
                                #e0e0e0 ${totalWeeklyRevenue > 0 ? Math.min(100, (totalWeeklyRevenue / weeklyPAF) * 100) : 0}% 100%
                            )"></div>
                            <div class="chart-value">${nodePayment.toFixed(2)} Ẑ</div>
                            <div class="chart-details">
                                <div>PAF hebdo: ${weeklyPAF.toFixed(2)} Ẑ</div>
                                <div>Revenus HT: ${totalWeeklyRevenue.toFixed(2)} Ẑ</div>
                                ${weeklyVAT > 0 ? `<div style="color: #e74c3c;">TVA (${(vatRate * 100).toFixed(1)}%): ${weeklyVAT.toFixed(2)} Ẑ</div>` : ''}
                                <div style="font-size: 0.8em; color: #7f8c8d;">Couverture: ${totalWeeklyRevenue > 0 ? (totalWeeklyRevenue / weeklyPAF * 100).toFixed(0) : 0}%</div>
                            </div>
                        </div>

                        <div class="metric-chart">
                            <div class="chart-title">Capitaine</div>
                            <div class="pie-chart" style="background: conic-gradient(
                                ${captainPayment > 0 ? 
                                    `hsl(${Math.min(120, (captainPayment / weeklyCaptainCost) * 120)}, 70%, 45%)` : 
                                    '#e74c3c'
                                } 0% ${captainPayment > 0 ? Math.min(100, (captainPayment / weeklyCaptainCost) * 100) : 0}%,
                                #e0e0e0 ${captainPayment > 0 ? Math.min(100, (captainPayment / weeklyCaptainCost) * 100) : 0}% 100%
                            )"></div>
                            <div class="chart-value">${captainPayment.toFixed(2)} Ẑ</div>
                            <div class="chart-details">
                                <div>Cible hebdo: ${weeklyCaptainCost.toFixed(2)} Ẑ (2x PAF)</div>
                                <div>Seuil: ${nodeThreshold.toFixed(2)} Ẑ (après NODE)</div>
                                ${weeklyVAT > 0 ? `<div style="color: #7f8c8d; font-size: 0.75em;">TVA déjà provisionnée</div>` : ''}
                                <div style="font-size: 0.8em; color: #7f8c8d;">Couverture: ${captainPayment > 0 ? (captainPayment / weeklyCaptainCost * 100).toFixed(0) : 0}%</div>
                            </div>
                        </div>

                        <div class="metric-chart">
                            <div class="chart-title">UPlanet</div>
                            <div class="pie-chart" style="background: conic-gradient(
                                ${uplanetPayment > 0 ? 
                                    `hsl(${Math.min(120, (uplanetPayment / (totalWeeklyRevenue > 0 ? totalWeeklyRevenue * 0.3 : 1)) * 120)}, 70%, 45%)` : 
                                    '#e74c3c'
                                } 0% ${uplanetPayment > 0 && totalWeeklyRevenue > 0 ? Math.min(100, (uplanetPayment / totalWeeklyRevenue * 100)) : 0}%,
                                #e0e0e0 ${uplanetPayment > 0 && totalWeeklyRevenue > 0 ? Math.min(100, (uplanetPayment / totalWeeklyRevenue * 100)) : 0}% 100%
                            )"></div>
                            <div class="chart-value">${uplanetPayment.toFixed(2)} Ẑ</div>
                            <div class="chart-details">
                                <div>Seuil: ${uplanetThreshold.toFixed(2)} Ẑ (3x PAF)</div>
                                <div>Surplus brut: ${uplanetPayment.toFixed(2)} Ẑ</div>
                                ${uplanetPayment > 0 && corporateTaxRate > 0 ? `<div style="color: #e74c3c; font-size: 0.75em;">IS (${(corporateTaxRate * 100).toFixed(1)}%): ${(uplanetPayment * corporateTaxRate).toFixed(2)} Ẑ</div>` : ''}
                                <div style="font-size: 0.8em; color: #7f8c8d;">Part surplus: ${uplanetPayment > 0 && totalWeeklyRevenue > 0 ? (uplanetPayment / totalWeeklyRevenue * 100).toFixed(0) : 0}%</div>
                            </div>
                        </div>
                    </div>`;

                // UPlanet distribution section - following ZEN.COOPERATIVE.3x1-3.sh logic
                const totalUPlanetProfit = uplanetPayment;
                
                // Tax provisions (TVA + IS)
                const corporateTaxProvision = totalUPlanetProfit * corporateTaxRate; // IS on surplus
                const totalTaxProvision = weeklyVAT + corporateTaxProvision; // TVA + IS
                const netSurplus = totalUPlanetProfit - corporateTaxProvision; // Only subtract IS from surplus (VAT is on revenue)
                
                // 3x1/3 allocation on net surplus (after tax provision)
                const cashAmount = netSurplus * 0.3333; // Treasury (1/3)
                const rdAmount = netSurplus * 0.3333;   // R&D (1/3)
                const assetsAmount = netSurplus * 0.3334; // Assets (1/3)

                // Get legal structure for display
                const legalStructure = document.getElementById('legal-structure')?.value || 'association';
                const structureTitles = {
                    'association': 'Association Loi 1901',
                    'scic': 'SCIC SAS',
                    'gie': 'GIE',
                    'sas': 'SAS',
                    'sarl': 'SARL',
                    'auto-entrepreneur': 'Auto-entrepreneur',
                    'sci': 'SCI',
                    'federation': 'Fédération Commerciale',
                    'startup': 'Startup',
                    'cooperative': 'SCOP'
                };
                const structureTitle = structureTitles[legalStructure] || 'Association Loi 1901';

                html += `
                <div class="uplanet-distribution ${totalWeeklyRevenue > 0 ? 'active' : ''}" style="background:#232733;">
                    <h3 style="color:#eaf6ff; text-shadow:0 2px 8px #181c24; letter-spacing:1px;">Distribution ${structureTitle}</h3>
                    ${totalWeeklyRevenue > 0 ? `
                    <div style="margin-bottom: 12px; padding: 8px; background: rgba(231,76,60,0.1); border-radius: 6px; border-left: 3px solid #e74c3c;">
                        <div style="font-size: 0.9em; color: #e74c3c; font-weight: 600;">📊 Provisions Fiscales Totales</div>
                        <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                            <span style="font-size: 0.8em; color: #b8c6e0;">TVA Locations (${(vatRate * 100).toFixed(1)}%):</span>
                            <span style="font-size: 0.9em; color: #eaf6ff; font-weight: bold;">${weeklyVAT.toFixed(2)} Ẑ</span>
                        </div>
                        ${totalUPlanetProfit > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                            <span style="font-size: 0.8em; color: #b8c6e0;">IS Bénéfices (${(corporateTaxRate * 100).toFixed(1)}%):</span>
                            <span style="font-size: 0.9em; color: #eaf6ff; font-weight: bold;">${corporateTaxProvision.toFixed(2)} Ẑ</span>
                        </div>` : ''}
                        <div style="border-top: 1px solid rgba(231,76,60,0.3); margin: 6px 0; padding-top: 6px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.9em; color: #e74c3c; font-weight: 600;">Total Provisions:</span>
                                <span style="font-size: 1.1em; color: #eaf6ff; font-weight: bold;">${totalTaxProvision.toFixed(2)} Ẑ</span>
                            </div>
                        </div>
                        ${totalUPlanetProfit > 0 ? `<div style="font-size: 0.8em; color: #b8c6e0; margin-top: 4px;">Surplus net après IS: ${netSurplus.toFixed(2)} Ẑ</div>` : ''}
                    </div>` : ''}
                    <div class="metric-container">
                        <div class="metric-box" style="background: linear-gradient(145deg, #232733, #1e2a22); border-color: #3498db; color: #eaf6ff;">
                            <div class="metric-title">Trésorerie</div>
                            <div class="metric-value">${cashAmount.toFixed(2)} Ẑ</div>
                            <div class="metric-subtitle">1/3 du net</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(145deg, #232733, #23271a); border-color: #f1c40f; color: #eaf6ff;">
                            <div class="metric-title">R&D</div>
                            <div class="metric-value">${rdAmount.toFixed(2)} Ẑ</div>
                            <div class="metric-subtitle">1/3 du net</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(145deg, #232733, #1e2a22); border-color: #2ecc71; color: #eaf6ff;">
                            <div class="metric-title">Actifs Réels</div>
                            <div class="metric-value">${assetsAmount.toFixed(2)} Ẑ</div>
                            <div class="metric-subtitle">1/3 du net</div>
                        </div>
                    </div>
                </div>`;

                // Update the content
                const resultsDiv = document.getElementById('simulation-results');
                resultsDiv.innerHTML = html;

                // Add animation class if UPlanet profits just started
                if (totalUPlanetProfit > 0) {
                    const uplanetSection = resultsDiv.querySelector('.uplanet-distribution');
                    uplanetSection.classList.add('animate-in');
                    setTimeout(() => {
                        uplanetSection.classList.remove('animate-in');
                    }, 1000);
                }

                // Force a reflow to ensure animations work
                void resultsDiv.offsetWidth;
            }

            // Add input event listeners for dynamic updates
            newNostrInput.addEventListener('input', updateSimulation);
            newZenInput.addEventListener('input', updateSimulation);
            
            // Add event listeners for tax rate changes
            setTimeout(() => {
                const vatRateInput = document.getElementById('vat-rate');
                const corporateTaxRateInput = document.getElementById('corporate-tax-rate');
                const legalStructureSelect = document.getElementById('legal-structure');
                const taxInfoDiv = document.getElementById('tax-info');
                
                // Function to update tax rates based on legal structure
                function updateTaxRatesForStructure() {
                    const structure = legalStructureSelect.value;
                    
                    if (structure === 'association') {
                        // Association Loi 1901 - Generally tax exempt
                        vatRateInput.value = '0.0';
                        corporateTaxRateInput.value = '0.0';
                        taxInfoDiv.innerHTML = `
                            <strong>Association Loi 1901 :</strong><br>
                            • TVA : Exonérée si activité non lucrative (monnaie locale ẐEN)<br>
                            • IS : Exonérée si gestion désintéressée<br>
                            • Exception : 20% TVA + 24% IS si activité commerciale > 72k€
                        `;
                    } else if (structure === 'scic') {
                        // SCIC SAS - Standard commercial rates
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '25.0';
                        taxInfoDiv.innerHTML = `
                            <strong>SCIC SAS :</strong><br>
                            • TVA : 20% sur prestations de location d'infrastructure<br>
                            • IS : 15% (≤42.5k€) ou 25% (>42.5k€) sur bénéfices<br>
                            • Répartition coopérative : 3x1/3 après provisions fiscales
                        `;
                    } else if (structure === 'gie') {
                        // GIE - Tax transparency
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '0.0';
                        taxInfoDiv.innerHTML = `
                            <strong>GIE (Groupement d'Intérêt Économique) ⭐ RECOMMANDÉ :</strong><br>
                            • TVA : 20% sur prestations aux membres<br>
                            • IS : 0% (transparence fiscale - imposé chez les membres)<br>
                            • Bénéfices : Répartis selon quote-parts des membres<br>
                            • Idéal pour fédération de commerçants (modèle Intermarché)
                        `;
                    } else if (structure === 'sas') {
                        // SAS - Standard commercial rates
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '25.0';
                        taxInfoDiv.innerHTML = `
                            <strong>SAS (Société par Actions Simplifiée) :</strong><br>
                            • TVA : 20% sur toutes prestations<br>
                            • IS : 15% (≤42.5k€) ou 25% (>42.5k€) sur bénéfices<br>
                            • Gouvernance : Flexible, statuts sur mesure<br>
                            • Responsabilité : Limitée au capital social
                        `;
                    } else if (structure === 'sarl') {
                        // SARL - Traditional commercial structure
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '25.0';
                        taxInfoDiv.innerHTML = `
                            <strong>SARL (Société à Responsabilité Limitée) :</strong><br>
                            • TVA : 20% sur toutes prestations<br>
                            • IS : 15% (≤42.5k€) ou 25% (>42.5k€) sur bénéfices<br>
                            • Gouvernance : Gérance + assemblée des associés<br>
                            • Capital minimum : 1€, responsabilité limitée aux apports
                        `;
                    } else if (structure === 'auto-entrepreneur') {
                        // Auto-entrepreneur - Simplified regime
                        vatRateInput.value = '0.0';
                        corporateTaxRateInput.value = '22.0';
                        taxInfoDiv.innerHTML = `
                            <strong>Auto-entrepreneur / Micro-entreprise :</strong><br>
                            • TVA : Exonérée si CA < 36.8k€ (services) ou 91.9k€ (vente)<br>
                            • Cotisations sociales : 22% du CA (prestations de services)<br>
                            • Simplicité : Déclaration mensuelle/trimestrielle<br>
                            • Limité : Plafonds de CA, pas d'investisseurs
                        `;
                    } else if (structure === 'sci') {
                        // SCI - Real estate focused
                        vatRateInput.value = '0.0';
                        corporateTaxRateInput.value = '0.0';
                        taxInfoDiv.innerHTML = `
                            <strong>SCI (Société Civile Immobilière) :</strong><br>
                            • TVA : Généralement exonérée (activité civile)<br>
                            • IS : Transparence fiscale (IR des associés)<br>
                            • Usage : Gestion immobilière, pas adapté pour ẐEN commercial<br>
                            • Note : Structure inadaptée pour monnaie numérique
                        `;
                    } else if (structure === 'startup') {
                        // Startup - SAS optimized for fundraising
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '25.0';
                        taxInfoDiv.innerHTML = `
                            <strong>Startup (SAS + levée de fonds) :</strong><br>
                            • TVA : 20% sur prestations numériques<br>
                            • IS : 15% (≤42.5k€) ou 25% (>42.5k€) + CIR possible<br>
                            • Avantages : BSPCE, JEI, levées de fonds facilitées<br>
                            • Idéal : Croissance rapide, innovation technologique ẐEN
                        `;
                    } else if (structure === 'cooperative') {
                        // SCOP - Worker cooperative
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '25.0';
                        taxInfoDiv.innerHTML = `
                            <strong>Coopérative (SCOP) :</strong><br>
                            • TVA : 20% sur prestations<br>
                            • IS : 25% mais réserves obligatoires (45% bénéfices)<br>
                            • Gouvernance : 1 salarié = 1 voix, gestion démocratique<br>
                            • Avantages : Participation salariés, exonérations fiscales
                        `;
                    } else if (structure === 'federation') {
                        // Commercial Federation - Mixed model
                        vatRateInput.value = '20.0';
                        corporateTaxRateInput.value = '15.0';
                        taxInfoDiv.innerHTML = `
                            <strong>Fédération Commerciale (modèle "points fidélité") :</strong><br>
                            • TVA : 20% sur prestations de gestion ẐEN<br>
                            • IS : 15% (taux préférentiel fédération)<br>
                            • Statut : GIE ou SAS selon gouvernance souhaitée<br>
                            • Revenus : Commission sur transactions + cotisations membres
                        `;
                    }
                    
                    updateSimulation();
                    updateUsageAdvice();
                }

                // Function to update usage advice based on legal structure
                function updateUsageAdvice() {
                    const structure = legalStructureSelect.value;
                    const usageAdviceDiv = document.getElementById('usage-advice');
                    
                    if (!usageAdviceDiv) return;
                    
                    const adviceContent = {
                        'association': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : Monnaie Locale Citoyenne</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Cas d'usage recommandés :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Monnaie locale territoriale</li>
                                        <li>Réseau d'échange local (SEL)</li>
                                        <li>Communauté éco-responsable</li>
                                        <li>Projet d'économie sociale</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>⚠️ Limites à considérer :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Pas de distribution de bénéfices</li>
                                        <li>Gestion bénévole obligatoire</li>
                                        <li>Risque fiscal si activité commerciale</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        'gie': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : Fédération de Commerçants</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Cas d'usage recommandés :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Points fidélité inter-enseignes</li>
                                        <li>Réseau de restaurateurs</li>
                                        <li>Centre commercial virtuel</li>
                                        <li>Mutualisation des coûts IT</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>💰 Modèle économique :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Cotisation mensuelle : 50-200€</li>
                                        <li>Commission : 0.5-2% par transaction</li>
                                        <li>Services premium payants</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        'sas': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : Entreprise Innovante</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Cas d'usage recommandés :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Plateforme ẐEN B2B</li>
                                        <li>Services financiers numériques</li>
                                        <li>Marketplace avec ẐEN</li>
                                        <li>Croissance rapide prévue</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>🚀 Avantages :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Gouvernance flexible</li>
                                        <li>Entrée d'investisseurs facilitée</li>
                                        <li>Responsabilité limitée</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        'sarl': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : PME Traditionnelle</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Cas d'usage recommandés :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Commerce intégrant le ẐEN</li>
                                        <li>Prestataire de services ẐEN</li>
                                        <li>Activité stable et locale</li>
                                        <li>Associés familiaux/amis</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>📊 Caractéristiques :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Gouvernance encadrée par la loi</li>
                                        <li>Cession de parts réglementée</li>
                                        <li>Stabilité juridique</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        'auto-entrepreneur': `
                            <h4 style="color: #f39c12; margin: 0 0 8px 0;">🎯 Idéal pour : Démarrage ẐEN Individuel</h4>
                            
                            <div style="margin-bottom: 12px; padding: 8px; background: rgba(52,152,219,0.1); border-radius: 4px; border-left: 3px solid #3498db;">
                                <strong>🌟 Usages ẐEN en Micro-Entreprise :</strong><br>
                                • <strong>Capitaine débutant</strong> : Maintenance nœud RPi5 (rémunération 2xPAF)<br>
                                • <strong>Créateur de contenu</strong> : Monétisation likes/partages en ẐEN<br>
                                • <strong>Services ẐEN</strong> : Formations, consulting, développement<br>
                                • <strong>Pont de liquidité</strong> : Conversion ẐEN → EUR occasionnelle
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Avantages ẐEN :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li><strong>Simplicité fiscale :</strong> Déclaration uniquement sur EUR reçus</li>
                                        <li><strong>Pas de TVA :</strong> Si < 36 800€ CA (franchise)</li>
                                        <li><strong>Cotisations :</strong> 21.2% uniquement sur EUR encaissés</li>
                                        <li><strong>Démarrage rapide :</strong> Création gratuite en ligne</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>⚠️ Limites importantes :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li><strong>CA limité :</strong> 77 700€ services (BNC)</li>
                                        <li><strong>Pas d'associés :</strong> Activité strictement individuelle</li>
                                        <li><strong>Pas de frais :</strong> Abattement forfaitaire 34% seulement</li>
                                        <li><strong>Évolution :</strong> Passage SAS/SARL si croissance</li>
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: rgba(46,204,113,0.1); border-radius: 4px; border-left: 3px solid #2ecc71;">
                                <strong>💡 Stratégie ẐEN recommandée :</strong><br>
                                • <strong>Phase 1 :</strong> Accumuler ẐEN via services/contenu<br>
                                • <strong>Phase 2 :</strong> Convertir partiellement selon besoins EUR<br>
                                • <strong>Phase 3 :</strong> Réinvestir ẐEN en parts sociales coopérative<br>
                                • <strong>Évolution :</strong> Devenir sociétaire puis Capitaine/Armateur
                            </div>
                        `,
                        'sci': `
                            <h4 style="color: #e74c3c; margin: 0 0 8px 0;">❌ Non Recommandé pour ẐEN</h4>
                            <div style="background: rgba(231,76,60,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid #e74c3c;">
                                <strong>La SCI est inadaptée pour une monnaie numérique :</strong>
                                <ul style="margin: 8px 0; padding-left: 16px;">
                                    <li>Objet social limité à l'immobilier</li>
                                    <li>Activité commerciale interdite</li>
                                    <li>Pas de prestations de services</li>
                                    <li>Réglementation stricte</li>
                                </ul>
                                <strong>Alternative :</strong> Choisissez SAS ou SARL pour activités ẐEN.
                            </div>
                        `,
                        'startup': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : Innovation ẐEN Disruptive</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Cas d'usage recommandés :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>DeFi avec ẐEN</li>
                                        <li>Plateforme d'échange ẐEN</li>
                                        <li>Innovation blockchain</li>
                                        <li>Croissance exponentielle visée</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>🚀 Avantages startup :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>BSPCE pour équipes</li>
                                        <li>Statut JEI possible</li>
                                        <li>CIR/CII pour R&D</li>
                                        <li>Levées de fonds facilitées</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        'cooperative': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : Économie Collaborative</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Cas d'usage recommandés :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Plateforme coopérative ẐEN</li>
                                        <li>Services mutualisés</li>
                                        <li>Économie sociale et solidaire</li>
                                        <li>Participation salariés</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>🤝 Spécificités SCOP :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li>Salariés = associés majoritaires</li>
                                        <li>Participation aux bénéfices</li>
                                        <li>Réserves impartageables</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        'scic': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 ⭐ PARFAIT pour : Écosystème ẐEN Coopératif</h4>
                            
                            <div style="margin-bottom: 12px; padding: 8px; background: rgba(52,152,219,0.1); border-radius: 4px; border-left: 3px solid #3498db;">
                                <strong>🌟 Usages ẐEN optimaux en SCIC :</strong><br>
                                • <strong>Infrastructure décentralisée</strong> : PC GAMER + 24 Satellites RPi5<br>
                                • <strong>Monnaie territoriale</strong> : Circulation locale avec pont EUR<br>
                                • <strong>Économie contributive</strong> : Récompenses création de contenu<br>
                                • <strong>Coopérative de services</strong> : Cloud, IPFS, NOSTR, NextCloud
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Modèle économique UPlanet :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li><strong>Location :</strong> 10Go MULTIPASS (1Ẑ/sem), 128Go ZEN Card (+ 4Ẑ/sem)</li>
                                        <li><strong>Parts sociales :</strong> 50Ẑ → Exemption loyer + vote</li>
                                        <li><strong>Rémunération :</strong> PAF Armateur + 2xPAF Capitaine</li>
                                        <li><strong>Surplus :</strong> Répartition 3x1/3 automatique</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>🏛️ Multi-sociétariat légal :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li><strong>Locataires :</strong> Clients → Sociétaires (parcours naturel)</li>
                                        <li><strong>Capitaines :</strong> Opérateurs techniques rémunérés</li>
                                        <li><strong>Armateurs :</strong> Apporteurs matériel (capital)</li>
                                        <li><strong>Collectivités :</strong> Partenaires institutionnels</li>
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: rgba(46,204,113,0.1); border-radius: 4px; border-left: 3px solid #2ecc71;">
                                <strong>💡 Avantages juridiques ẐEN :</strong><br>
                                • <strong>Monnaie interne</strong> : Légale en SCIC (pas de régulation bancaire)<br>
                                • <strong>Pont de liquidité</strong> : Conversion ẐEN → EUR légale<br>
                                • <strong>Fiscalité simple</strong> : Fait générateur = conversion EUR<br>
                                • <strong>Agrément ESS</strong> : Reconnaissance utilité sociale possible
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: rgba(230,126,34,0.1); border-radius: 4px; border-left: 3px solid #e67e22;">
                                <strong>⚠️ Contraintes SCIC à respecter :</strong><br>
                                • <strong>Capital minimum</strong> : 18 500€ (ou 37 000€ si forme SAS)<br>
                                • <strong>Lucrativité limitée</strong> : Pas de distribution libre des bénéfices<br>
                                • <strong>Agrément préfectoral</strong> : Dossier d'utilité sociale obligatoire<br>
                                • <strong>Reporting annuel</strong> : Bilan social et impact territorial
                            </div>
                        `,
                        'federation': `
                            <h4 style="color: #2ecc71; margin: 0 0 8px 0;">🎯 Idéal pour : Réseau Commercial ẐEN (Modèle "Intermarché Points")</h4>
                            
                            <div style="margin-bottom: 12px; padding: 8px; background: rgba(52,152,219,0.1); border-radius: 4px; border-left: 3px solid #3498db;">
                                <strong>🌟 Usages ẐEN en Fédération Commerciale :</strong><br>
                                • <strong>Carte fidélité inter-enseignes</strong> : 1€ d'achat = 1 ẐEN (10% cashback, précision 10cts)<br>
                                • <strong>Cashback mutualisé</strong> : Dépenser ẐEN chez tous partenaires<br>
                                • <strong>Marketing collaboratif</strong> : Campagnes communes financées en ẐEN<br>
                                • <strong>Trésorerie partagée</strong> : Fonds de roulement collectif
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                <div>
                                    <strong>✅ Modèle économique ẐEN :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li><strong>Émission :</strong> 10€ achat = 1 ẐEN (10% cashback)</li>
                                        <li><strong>Utilisation :</strong> 1 ẐEN = 1€ de réduction</li>
                                        <li><strong>Cotisation :</strong> 0.5% CA pour alimenter fonds ẐEN</li>
                                        <li><strong>Gouvernance :</strong> 1 commerce = 1 voix (égalitaire)</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>🏪 Secteurs optimaux :</strong>
                                    <ul style="margin: 4px 0; padding-left: 16px;">
                                        <li><strong>Restauration :</strong> Bars, restaurants, traiteurs</li>
                                        <li><strong>Commerce :</strong> Épiceries, boulangeries, pharmacies</li>
                                        <li><strong>Services :</strong> Coiffeurs, garages, pressing</li>
                                        <li><strong>Artisanat :</strong> Menuisiers, électriciens, plombiers</li>
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: rgba(46,204,113,0.1); border-radius: 4px; border-left: 3px solid #2ecc71;">
                                <strong>💡 Avantages ẐEN Fédération :</strong><br>
                                • <strong>Fidélisation croisée</strong> : Clients partagés entre commerces<br>
                                • <strong>Trésorerie optimisée</strong> : Délai de conversion ẐEN → EUR<br>
                                • <strong>Marketing mutualisé</strong> : Coûts publicitaires partagés<br>
                                • <strong>Données clients</strong> : Analytics comportementaux anonymisés
                            </div>

                            <div style="margin-top: 8px; padding: 8px; background: rgba(230,126,34,0.1); border-radius: 4px; border-left: 3px solid #e67e22;">
                                <strong>⚠️ Points d'attention juridiques :</strong><br>
                                • <strong>Statut GIE recommandé</strong> : Transparence fiscale + mutualisation<br>
                                • <strong>Règles RGPD</strong> : Consentement clients pour données partagées<br>
                                • <strong>Comptabilité séparée</strong> : ẐEN ≠ monnaie légale (jeton interne)<br>
                                • <strong>Conversion EUR</strong> : Déclaration fiscale individuelle par commerce
                            </div>
                        `
                    };
                    
                    usageAdviceDiv.innerHTML = adviceContent[structure] || adviceContent['association'];
                }
                
                if (vatRateInput) {
                    vatRateInput.addEventListener('input', updateSimulation);
                }
                if (corporateTaxRateInput) {
                    corporateTaxRateInput.addEventListener('input', updateSimulation);
                }
                if (legalStructureSelect) {
                    legalStructureSelect.addEventListener('change', updateTaxRatesForStructure);
                    // Initialize with default values
                    updateTaxRatesForStructure();
                    // Initialize usage advice
                    setTimeout(() => updateUsageAdvice(), 200);
                }
            }, 100);

            // Initial simulation
            updateSimulation();

            // Add number controls
            function addNumberControls(input, syncWithInput = null) {
                const container = input.parentElement;
                const controls = document.createElement('div');
                controls.className = 'controls';
                controls.style.display = 'flex';
                controls.style.alignItems = 'center';
                controls.style.gap = '6px';
                
                const minusButton = document.createElement('button');
                minusButton.className = 'number-control';
                minusButton.innerHTML = '−';
                minusButton.onclick = () => {
                    const currentValue = parseInt(input.value) || 0;
                    if (currentValue > 0) {
                        input.value = currentValue - 1;
                        input.dispatchEvent(new Event('input'));
                        
                        // Synchroniser avec l'autre input si spécifié
                        if (syncWithInput) {
                            const syncValue = parseInt(syncWithInput.value) || 0;
                            if (syncValue > 0) {
                                syncWithInput.value = syncValue - 1;
                                syncWithInput.dispatchEvent(new Event('input'));
                            }
                        }
                    }
                };

                const plusButton = document.createElement('button');
                plusButton.className = 'number-control';
                plusButton.innerHTML = '+';
                plusButton.onclick = () => {
                    const currentValue = parseInt(input.value) || 0;
                    const max = parseInt(input.max);
                    if (currentValue < max) {
                        input.value = currentValue + 1;
                        input.dispatchEvent(new Event('input'));
                        
                        // Synchroniser avec l'autre input si spécifié
                        if (syncWithInput) {
                            const syncValue = parseInt(syncWithInput.value) || 0;
                            const syncMax = parseInt(syncWithInput.max);
                            if (syncValue < syncMax) {
                                syncWithInput.value = syncValue + 1;
                                syncWithInput.dispatchEvent(new Event('input'));
                            }
                        }
                    }
                };

                // Insérer le bouton moins avant l'input
                container.insertBefore(minusButton, input);
                // Insérer le bouton plus après l'input
                container.insertBefore(plusButton, input.nextSibling);
            }

            // Add controls to inputs - ZEN Card syncs with MULTIPASS
            addNumberControls(newNostrInput);
            addNumberControls(newZenInput, newNostrInput); // ZEN Card synchronise avec MULTIPASS

            // Après avoir inséré le HTML du dashboard, relie les boutons -/+ à l'input correspondant
            // (à placer à la fin de createEconomicDashboard)
            setTimeout(() => {
                document.querySelectorAll('.simulator-input').forEach(simInput => {
                    const minus = simInput.querySelector('.input-row .number-control:first-child');
                    const plus = simInput.querySelector('.input-row .number-control:last-child');
                    const input = simInput.querySelector('.input-row input[type=number]');
                    if (minus && plus && input) {
                        const isZenCard = input.id === 'new-zen';
                        
                        minus.onclick = () => {
                            let v = parseInt(input.value) || 0;
                            if (v > parseInt(input.min)) {
                                input.value = v - 1;
                                input.dispatchEvent(new Event('input'));
                                
                                // Si c'est ZEN Card, synchroniser avec MULTIPASS
                                if (isZenCard) {
                                    const nostrInput = document.getElementById('new-nostr');
                                    if (nostrInput) {
                                        const nostrValue = parseInt(nostrInput.value) || 0;
                                        if (nostrValue > parseInt(nostrInput.min)) {
                                            nostrInput.value = nostrValue - 1;
                                            nostrInput.dispatchEvent(new Event('input'));
                                        }
                                    }
                                }
                            }
                        };
                        plus.onclick = () => {
                            let v = parseInt(input.value) || 0;
                            if (v < parseInt(input.max)) {
                                input.value = v + 1;
                                input.dispatchEvent(new Event('input'));
                                
                                // Si c'est ZEN Card, synchroniser avec MULTIPASS
                                if (isZenCard) {
                                    const nostrInput = document.getElementById('new-nostr');
                                    if (nostrInput) {
                                        const nostrValue = parseInt(nostrInput.value) || 0;
                                        if (nostrValue < parseInt(nostrInput.max)) {
                                            nostrInput.value = nostrValue + 1;
                                            nostrInput.dispatchEvent(new Event('input'));
                                        }
                                    }
                                }
                            }
                        };
                    }
                });
            }, 0);
        }

        // Fonction pour mettre à jour le dashboard avec les données complètes
        function updateDashboardWithCompleteData(data) {
            // Update IPFS Node ID link
            const ipfsNodeId = data.IPFSNODEID;
            if (ipfsNodeId && ipfsNodeId !== 'N/A') {
                const ipfsLink = document.querySelector('a[href*="/ipns/"]');
                if (ipfsLink) {
                    ipfsLink.href = `/ipns/${ipfsNodeId}`;
                    ipfsLink.textContent = ipfsNodeId;
                }
            }

            // Update UPlanet info
            const planetPub = data.UPLANETG1PUB ? data.UPLANETG1PUB.substring(0, 8) : 'N/A';
            const uplanetInfoElements = document.querySelectorAll('.uplanet-info');
            if (uplanetInfoElements.length >= 2) {
                uplanetInfoElements[0].textContent = `UPlanet${planetPub}`;
            }

            // Update legal wallets section with complete data
            createLegalWalletsSection(data, data._originalApiUrl);

            console.log('Dashboard updated with complete IPNS data');
        }

        // Charger les données au chargement de la page
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const UPlanetAPI_URL = urlParams.get('api_url') || '';
            
            // Progressive loading: show page immediately with Ustats data, then update with IPNS data
            loadUPlanetData(
                UPlanetAPI_URL,
                // Callback for Ustats data (fast) - show page immediately
                (ustatsData) => {
                    console.log('Creating dashboard with Ustats data (fast loading)');
                    createEconomicDashboard(ustatsData, true); // true = partial data
                    
                    // Force initial update after dashboard creation
                    const newNostrInput = document.getElementById('new-nostr');
                    const newZenInput = document.getElementById('new-zen');
                    
                    if (newNostrInput && newZenInput) {
                        // Trigger input events to update simulation
                        newNostrInput.dispatchEvent(new Event('input'));
                        newZenInput.dispatchEvent(new Event('input'));
                    }
                },
                // Callback for complete data (slow) - update with IPNS data
                (completeData) => {
                    console.log('Updating dashboard with complete IPNS data');
                    updateDashboardWithCompleteData(completeData);
                }
            );
        });

    </script>
</body>
</html> 