<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UPlanet ‚Äî ORIGIN & ·∫êEN</title>
  <meta name="description" content="UPlanet ORIGIN (bac √† sable) & ·∫êEN (services coop√©ratifs) ‚Äî D√©couvrez un cloud souverain, poss√©dez vos donn√©es et rejoignez une √©conomie d√©centralis√©e." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåç</text></svg>">

  <style>
    /* ... (CSS reste inchang√©, il est correct) ... */
    :root{ --bg: #f8fbf9; --card-bg: #ffffff; --accent: #059669; --muted: #64748b; --text: #0f1724; --text-light: #ffffff; --gradient-bg: linear-gradient(180deg, var(--bg), #ffffff); --gradient-accent: linear-gradient(135deg, var(--accent), #10b981); --border-color: rgba(6,95,70,0.06); --glass: rgba(255, 255, 255, 0.7); --radius: 18px; --shadow: 0 6px 20px rgba(8,15,23,0.06); --maxw: 1100px; --font-base: 18px; }
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { margin: 0; font-size: var(--font-base); font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--gradient-bg); color: var(--text); transition: background 0.5s ease, color 0.5s ease; }
    a { color:var(--accent); text-decoration:none; }
    .container { max-width:var(--maxw); margin:0 auto; padding:0 20px; }
    header { position: sticky; top: 0; z-index: 1000; padding: 12px 0; background: var(--glass); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-bottom: 1px solid var(--border-color); }
    .header-content { display:flex; align-items:center; justify-content:space-between; max-width:var(--maxw); margin:0 auto; padding:0 20px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width:56px; height:56px; border-radius:12px; background:var(--gradient-accent); display:flex; align-items:center; justify-content:center; color:var(--text-light); font-weight:700; font-size:24px; }
    nav { display:flex; gap:16px; align-items:center; }
    nav a { font-size: 16px; color:var(--text); opacity:0.9; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:12px 20px; border-radius:999px; border:none; cursor:pointer; font-weight:600; font-size: 16px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-primary { background:var(--accent); color:var(--text-light); }
    .btn-ghost { background:transparent; border:1px solid var(--accent); color:var(--accent); }
    main { padding-top: 24px; }
    section { padding:48px 0; }
    h1 { font-size: 44px; line-height: 1.1; margin:0; }
    h2 { margin:0 0 24px 0; font-size: 32px; }
    h3 { margin:0 0 10px 0; font-size: 22px; }
    p, li { line-height: 1.6; }
    .subtitle { color:var(--muted); margin-top:16px; font-size: 20px; }
    .muted { color:var(--muted); }
    .hero { display:grid; grid-template-columns:1fr 460px; gap:32px; align-items:center; }
    .card { background:var(--card-bg); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow); border:1px solid var(--border-color); }
    .features { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px,1fr)); gap:20px; }
    .two-col { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .cta { background: var(--gradient-bg); padding:24px; border-radius:var(--radius); border:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between; gap:24px; flex-wrap:wrap; }
    .info-buttons { margin-top:24px; display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; }
    .info-buttons a { display: block; padding: 20px; border-radius: 14px; background: var(--card-bg); color: var(--text); font-weight: 600; text-align: center; border: 1px solid var(--border-color); }
    .info-buttons a:hover { color: var(--accent); border-color: var(--accent); }
    .mermaid { text-align: center; background: var(--card-bg); padding: 16px; border-radius: 12px; margin-top:16px;}
    footer { border-top:1px solid var(--border-color); padding:32px 0; margin-top:32px; }
    .footer-grid { display:grid; grid-template-columns:2fr 1fr 1fr; gap:24px; }
    .form input,.form textarea { width:100%; padding:12px; border-radius:8px; border:1px solid rgba(15,23,36,0.08); background:var(--card-bg); color:var(--text); }
    .form button {width: 100%;}
    .user-profile { font-size: 14px; color: var(--muted); padding-bottom: 8px;}
    @media(max-width:920px){ .hero { grid-template-columns:1fr; } }
    @media(max-width:768px){ h1 { font-size: 36px; } h2 { font-size: 28px; } .footer-grid, .two-col { grid-template-columns:1fr; } }
     /* Mobile-specific adjustments for header navigation and buttons */
     @media(max-width:600px){
       header { padding: 8px 0; }
       .header-content { flex-wrap: wrap; gap: 8px; }
       .logo { width: 44px; height: 44px; font-size: 20px; }
       nav { width: 100%; display: flex; gap: 8px; flex-wrap: wrap; }
       /* Keep section links visible on the first row */
       nav a { order: 1; flex: 1 1 calc(33.33% - 8px); text-align: center; font-size: 14px; padding: 8px 0; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
       /* Make buttons compact and place them on the second row */
       .btn { padding: 10px 14px; font-size: 14px; }
       #loginBtn, nav .btn-primary { order: 2; flex: 1 1 calc(50% - 6px); min-width: 140px; }
       /* Prevent long dynamic text from overflowing */
       #loginBtn { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
     }
  </style>

  <!-- Ajout de la librairie nostr.bundle.js -->
  <script src="/ipfs/QmXEmaPRUaGcvhuyeG99mHHNyP43nn8GtNeuDok8jdpG4a/nostr.bundle.js"></script>

</head>
<body>
  <header>
    <div class="header-content">
      <a href="#" class="brand">
        <div class="logo">·∫ê</div>
        <div>
          <div style="font-weight:700">UPlanet</div>
          <div style="font-size:14px;color:var(--muted)">L'Internet de Confiance</div>
        </div>
      </a>
      <nav role="navigation">
        <a href="#services">Services</a>
        <a href="#economie">√âconomie</a>
        <a href="#pacte">Notre Pacte</a>
        <a href="#rejoindre">Rejoindre</a>
        <button class="btn btn-ghost" id="loginBtn">Connexion Nostr</button>
        <button class="btn btn-primary" onclick="openCreateAccountPage()">Cr√©er son MULTIPASS</button>
      </nav>
    </div>
  </header>

  <div class="container">
    <main>
      <section class="hero">
        <div>
          <h1 class="title">Reprenez le contr√¥le d'Internet. <span style="color:var(--accent)">Brique par brique.</span></h1>
          <p class="subtitle"><strong>UPlanet n'est pas un autre cloud.</strong> C'est un r√©seau d'humains de confiance qui partagent des ressources pour construire un Internet s√ªr, pratique et co-poss√©d√©. Chaque service que vous utilisez finance l'infrastructure commune et la transforme en <b>biens r√©els : des for√™ts et des terres fertiles.</b></p>

          <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="scrollToId('rejoindre')">Devenir Co-B√¢tisseur</button>
            <button class="btn" onclick="scrollToId('services')" style="border:1px solid var(--border-color);background:var(--card-bg); color:var(--text)">D√©couvrir les Services</button>
          </div>
        </div>

        <aside class="card">
          <h3 style="margin:0 0 16px 0">Votre Station Personnelle</h3>
          <img src="/ipfs/QmNW6J3tgCwiAr3Bmw8UoNY6ZjXXWk1dNWRvxyPBAEgNTH/CopyLaRadioPCRPi.jpg" alt="Visualisation d'une station Astroport personnelle et int√©gr√©e" style="width:100%;border-radius:12px;"/>
          <p class="muted" style="margin-top:16px;font-size:16px">Votre <strong>Astroport.ONE</strong> est un n≈ìud de cet Internet souverain. Il est h√©berg√© par vous ou un membre de confiance de votre r√©seau, pas par une multinationale.</p>
        </aside>
      </section>

      <section id="services">
        <h2>Des Outils pour un Internet de Confiance</h2>
        <div class="features">
          <article class="feature">
            <h3>MULTIPASS : Votre Identit√© Souveraine</h3>
            <p class="muted">Bien plus qu'un compte, c'est votre cl√© d'entr√©e infalsifiable dans la toile de confiance. Il vous donne acc√®s √† un espace de stockage initial et √† notre IA locale.</p>
          </article>

          <article class="feature">
            <h3>ZEN Card : Votre Espace Num√©rique Priv√©</h3>
            <p class="muted">Un cloud NextCloud complet (128 Go et plus) pour vos fichiers, contacts et calendriers. H√©berg√© par un membre de confiance, pas sur un serveur anonyme √† l'autre bout du monde.</p>
          </article>

          <article class="feature">
            <h3>Une IA qui Respecte votre Vie Priv√©e</h3>
            <p class="muted">Notre IA #BRO tourne sur les machines de la coop√©rative. Vos donn√©es sont trait√©es localement pour vous aider, jamais pour vous profiler. Le service est partag√© √©quitablement entre les membres.</p>
          </article>

          <article class="feature">
            <h3>Ancrage G√©ographique (Geo Key)</h3>
            <p class="muted">En liant votre identit√© num√©rique √† un lieu physique, nous cr√©ons des services de proximit√© et un r√©seau r√©silient qui ne d√©pend plus des grands axes centralis√©s.</p>
          </article>

          <article class="feature">
            <h3>Gouvernance & √âvolution</h3>
            <p class="muted">En tant que soci√©taire, vous votez sur l'√©volution des logiciels libres qui composent notre √©cosyst√®me. Votre voix fa√ßonne l'avenir de l'outil que vous co-poss√©dez.</p>
          </article>

          <article class="feature">
            <h3>Astroport.ONE : Votre Tour de Contr√¥le</h3>
            <p class="muted">Le logiciel open source qui anime votre n≈ìud. Il transforme une simple machine en une porte d'acc√®s s√©curis√©e √† l'Internet de confiance.</p>
          </article>
        </div>
      </section>

      <section id="rejoindre">
        <h2>De l'Utilisateur au Co-B√¢tisseur</h2>
        <div class="two-col">
            <article class="card">
                <h3><strong>L'Explorateur (Locataire)</strong></h3>
                <p class="muted">D√©couvrez le r√©seau et ses services √† votre rythme, sans engagement. Vous utilisez les ressources partag√©es en payant un "droit de passage" symbolique.</p>
                <ul>
                    <li>Acc√®s imm√©diat √† votre MULTIPASS</li>
                    <li>Payez uniquement ce que vous utilisez</li>
                    <li>Id√©al pour tester la puissance du r√©seau</li>
                </ul>
                <button class="btn btn-ghost" style="margin-top:16px" onclick="mockSignup()">Commencer l'Exploration</button>
            </article>
            <article class="card" style="border: 2px solid var(--accent)">
                <h3><strong>Le B√¢tisseur (Soci√©taire)</strong></h3>
                <p class="muted">Passez du statut de consommateur √† celui de co-propri√©taire. En achetant une part sociale, vous investissez dans l'infrastructure et son avenir.</p>
                <ul>
                    <li><strong>Plus de "loyer"</strong> pour vos services de base</li>
                    <li>Droit de vote sur les d√©cisions de la coop√©rative</li>
                    <li>Part de propri√©t√© sur les <b>biens r√©els (serveurs, for√™ts...)</b></li>
                </ul>
                <button class="btn btn-primary" style="margin-top:16px" onclick="window.open('https://opencollective.com/uplanet-zero/contribute/achat-128-go-sur-nanopi5-86611', '_blank')">Devenir B√¢tisseur</button>
            </article>
        </div>
      </section>

      <section id="economie">
        <h2>Une √âconomie Transparente, au Service du Commun</h2>
        <div class="two-col">
          <article>
            <h3>Notre Pacte : La R√®gle des Tiers</h3>
            <p class="muted">Chaque euro qui entre dans notre coop√©rative est une graine que nous plantons pour l'avenir. Le protocole ·∫êEN la r√©partit automatiquement et de mani√®re transparente sur trois piliers essentiels.</p>
            <div class="mermaid">
              pie
                title R√©partition de chaque Euro
                "Stabilit√© & Liquidit√©" : 33.3
                "Innovation (R&D)" : 33.3
                "Biens Communs R√©els" : 33.3
            </div>
          </article>
          <article>
            <h3>Votre Impact Direct</h3>
            <p class="muted">Votre choix d'implication change tout. En tant que B√¢tisseur, vous ne faites pas que financer un service : vous construisez un patrimoine commun, num√©rique et physique.</p>
             <div class="mermaid">
              graph TD
                  A[Vous] -->|Explore| B(Explorateur);
                  A -->|Construit| C(B√¢tisseur);

                  B --> D[Utilise les services];
                  
                  C --> E[Co-Poss√®de les services];
                  C --> F[Gouverne l'√©volution];
                  C --> G[Poss√®de une part des actifs];
                  G --> H[üå≥ For√™ts & Terres];

                  style C fill:#059669,stroke:#fff,color:#fff
                  style H fill:#10b981,stroke:#fff,color:#fff
            </div>
          </article>
        </div>
        <div style="text-align:center; margin-top:32px;">
            <a href="https://ipfs.copylaradio.com/ipns/copylaradio.com/economy.html" target="_blank" class="btn btn-ghost">Calculateur √âconomique embarqu√© sur chaque Astroport</a>
        </div>
      </section>
      
      <section id="pacte">
        <div class="container">
          <h2>üìú Notre Contrat Social : Code, Loi et Confiance</h2>
          <p class="subtitle">Nous b√¢tissons sur des fondations solides et v√©rifiables par tous. La confiance n'est pas une promesse marketing, c'est le r√©sultat de notre architecture.</p>
          
          <div class="features">
            <div class="card">
              <h3>üèõÔ∏è Une Gouvernance Humaine</h3>
              <p>Notre structure l√©gale est une <strong>SCIC (Soci√©t√© Coop√©rative)</strong>. Les d√©cisions critiques sont prises d√©mocratiquement : <strong>1 membre = 1 voix</strong>. Pas d'actionnaires distants, juste des co-b√¢tisseurs.</p>
            </div>
            
            <div class="card">
              <h3>‚öñÔ∏è Une Transparence Radicale</h3>
              <p>Le protocole ·∫êEN fonctionne comme un <strong>livre de comptes public et infalsifiable</strong>. Les imp√¥ts et taxes (TVA, IS) sont provisionn√©s automatiquement. Tout est clair, pour tout le monde, tout le temps.</p>
            </div>
            
            <div class="card">
              <h3>üîê Des R√®gles du Jeu √âquitables</h3>
              <p>Les r√®gles de la coop√©rative sont inscrites dans le <strong>code open source</strong>. L'application du pacte d'associ√©s et de la r√®gle des tiers n'est pas sujette √† l'erreur humaine : elle est automatis√©e.</p>
            </div>
          </div>
          
          <div class="two-col" style="margin-top: 32px;">
            <div class="card">
              <h3>üìã Nos Codes Fondateurs</h3>
              <div class="info-buttons">
                <a href="https://github.com/papiche/Astroport.ONE/blob/master/LEGAL.md" target="_blank">üìú Constitution de l'√âcosyst√®me</a>
                <a href="https://github.com/papiche/Astroport.ONE/blob/master/BOOKS/Le%20Livre%20Blanc%20Astroport.ONE%20_%20De%20la%20Souverainet%C3%A9%20Num%C3%A9rique%20%C3%A0%20la%20R%C3%A9g%C3%A9n%C3%A9ration%20%C3%89cologique.md" target="_blank">üìñ Livre Blanc Technique</a>
              </div>
            </div>
            
            <div class="card">
              <h3>üå± Notre Mission √âcologique</h3>
              <p>La finalit√© de notre √©conomie n'est pas le profit, mais la cr√©ation de communs. Le tiers allou√© aux "Biens Communs" est utilis√© pour acqu√©rir et r√©g√©n√©rer des terres, cr√©ant un patrimoine physique pour tous les soci√©taires.</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <footer id="contact">
    <div class="container footer-grid">
      <div>
        <div style="font-weight:700">UPlanet ‚Ä¢ CopyLaRadio</div>
        <div style="margin-top:10px;color:var(--muted)">B√¢tissons ensemble l'Internet des humains. Gouvernance partag√©e, infrastructure poss√©d√©e, impact r√©el.</div>
        <div style="margin-top:12px;color:var(--muted);font-size:14px">¬© "UPlanet" ‚Äî une initiative du ƒû1FabLab</div>
      </div>
      <div>
        <div style="font-weight:700;margin-bottom:8px">Ressources</div>
        <ul style="color:var(--muted);font-size:16px;line-height:1.8;list-style:none;padding:0">
          <li><a href="/ipfs/QmbohSecUq3XcBkFgDxCSC3ZycY8hASy5pMSesLbqjqrSa/Lib%C3%A9rez-vous_du_Cloud_Formation_UPlanet.pdf" target="_blank">Guide ¬´ Lib√©rez-vous du Cloud ¬ª</a></li>
          <li><a href="https://github.com/papiche/Astroport.ONE" target="_blank">Code Source (Astroport.ONE)</a></li>
          <li><a href="https://forum.monnaie-libre.fr/" target="_blank">Forum de la Communaut√©</a></li>
        </ul>
      </div>
      <div id="contact-form-container">
        <div style="font-weight:700;margin-bottom:8px">Contact</div>
        <form id="contactForm" class="form" onsubmit="return false;">
          <div id="logged-out-view">
              <p class="muted" style="font-size:15px; margin-top:0;">√âchangeons directement sur le r√©seau que nous construisons. Connectez-vous via Nostr.</p>
              <button class="btn btn-primary" style="width:100%" onclick="handleLogin()">Se connecter avec Nostr</button>
          </div>
          <div id="logged-in-view" style="display:none;">
            <div class="user-profile">Connect√© en tant que : <span id="user-profile-id"></span></div>
            <textarea id="message" placeholder="Votre message √† l'√©quipe UPlanet..." rows="4" style="margin-top:8px" required></textarea>
            <div style="margin-top:8px"><button class="btn btn-primary" id="sendMessageBtn" type="submit">Envoyer le message</button></div>
          </div>
        </form>
      </div>
    </div>
  </footer>

  <script src="/ipfs/QmPiVdioLq3DhEqbrTRwfUFZGQ9LDoVQH69pQZP5hEQjib/mermaid.min.js"></script>
  <script>
    // Global variables for Nostr and uSPOT
    let DEFAULT_RELAYS = [ // This will be dynamically set
        'wss://relay.copylaradio.com',
        'ws://127.0.0.1:7777',
        'wss://relay.damus.io',
        'wss://nos.lol'
    ];
    let nostrRelay = null;
    let isNostrConnected = false;
    let upassportUrl = '';
    let userPrivateKey = null; // Will be used if no extension is found

    // D√©tection de l'API uSPOT et des relais par d√©faut
    function detectUSPOTAPI() {
        const currentURL = new URL(window.location.href);
        const hostname = currentURL.hostname;
        const port = currentURL.port;
        const protocol = currentURL.protocol.split(":")[0];

        let determinedUpassportUrl = '';
        let determinedRelay = '';

        if (hostname === "127.0.0.1" && port === "8080") {
            determinedUpassportUrl = `http://127.0.0.1:54321`;
            determinedRelay = `ws://127.0.0.1:7777`;
        } else if (hostname.startsWith("ipfs.")) {
            const baseDomain = hostname.substring("ipfs.".length);
            determinedUpassportUrl = `${protocol}://u.${baseDomain}`;
            determinedRelay = `wss://relay.${baseDomain}`;
        } else {
            // Fallback for other environments or if detection fails
            determinedUpassportUrl = `https://u.copylaradio.com`;
            determinedRelay = `wss://relay.copylaradio.com`; // Uplanet ORIGIN public relay
        }

        upassportUrl = determinedUpassportUrl;
        DEFAULT_RELAYS = [determinedRelay, 'wss://relay.damus.io', 'wss://nos.lol'];

        console.log(`API uSPOT d√©tect√©e: ${upassportUrl}`);
        console.log(`Relay par d√©faut: ${DEFAULT_RELAYS[0]}`);
        console.log(`Gateway IPFS: ${hostname}:${port}`);
    }

    // --- Initialisation de la page et des th√®mes ---
    (function applyDynamicTheme() {
        const hour = new Date().getHours();
        const root = document.documentElement;
        let theme = {
            bg: '#f8fbf9', cardBg: '#ffffff', accent: '#059669', muted: '#64748b', text: '#0f1724', textLight: '#ffffff',
            gradientBg: 'linear-gradient(180deg, #f8fbf9, #ffffff)',
            gradientAccent: 'linear-gradient(135deg, #059669, #10b981)',
            borderColor: 'rgba(6,95,70,0.06)', glass: 'rgba(255, 255, 255, 0.7)'
        };
        if (hour >= 5 && hour < 11) {
            theme = { bg: '#fffbeb', cardBg: '#ffffff', accent: '#f59e0b', muted: '#6b7280', text: '#1f2937', textLight: '#ffffff', gradientBg: 'linear-gradient(180deg, #fffbeb, #fefce8)', gradientAccent: 'linear-gradient(135deg, #f59e0b, #fbbf24)', borderColor: 'rgba(217,119,6,0.08)', glass: 'rgba(255, 251, 235, 0.7)' };
        } else if (hour >= 17 && hour < 21) {
            theme = { bg: '#fdf2f8', cardBg: '#ffffff', accent: '#db2777', muted: '#64748b', text: '#1e293b', textLight: '#ffffff', gradientBg: 'linear-gradient(180deg, #fdf2f8, #faf5ff)', gradientAccent: 'linear-gradient(135deg, #db2777, #f472b6)', borderColor: 'rgba(190,24,93,0.08)', glass: 'rgba(253, 242, 248, 0.7)' };
        } else if (hour >= 21 || hour < 5) {
            theme = { bg: '#111827', cardBg: '#1f2937', accent: '#34d399', muted: '#9ca3af', text: '#f9fafb', textLight: '#111827', gradientBg: 'linear-gradient(180deg, #111827, #0f1724)', gradientAccent: 'linear-gradient(135deg, #10b981, #34d399)', borderColor: 'rgba(52,211,153,0.15)', glass: 'rgba(17, 24, 39, 0.7)' };
        }
        for (const [key, value] of Object.entries(theme)) {
            const cssVar = `--${key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`)}`;
            root.style.setProperty(cssVar, value);
        }
    })();

    mermaid.initialize({ startOnLoad: true, theme: 'base', themeVariables: {
        'primaryColor': getComputedStyle(document.documentElement).getPropertyValue('--card-bg'),
        'primaryTextColor': getComputedStyle(document.documentElement).getPropertyValue('--text'),
        'primaryBorderColor': getComputedStyle(document.documentElement).getPropertyValue('--accent'),
        'lineColor': getComputedStyle(document.documentElement).getPropertyValue('--muted'),
        'textColor': getComputedStyle(document.documentElement).getPropertyValue('--text'),
    }});

    function scrollToId(id){ document.getElementById(id)?.scrollIntoView(); }
    function mockSignup(){ window.open('https://opencollective.com/uplanet-zero#category-CONTRIBUTE', '_blank'); }
    function openCreateAccountPage() {
        if (upassportUrl) {
            window.open(`${upassportUrl}/g1`, '_blank');
        } else {
            alert("uSPOT API URL not detected. Please try again later.");
            console.error("uSPOT API URL is not set. Cannot open create account page.");
        }
    }

    // --- Logique Nostr (Utilise nostr.bundle.js) ---

    const CAPTAIN_PUBKEY_HEX = "60c1133d148ae0d2c4b42506fb4abacac903032680b178010c942bd538643f78";
    const CAPTAIN_NPROFILE = "nprofile1qqsxpsgn852g4cxjcj6z2phmf2av4jgrqvngpvtcqyxfg2748pjr77qprdmhxue69uhhyetvv9ujucm0wpukcctjv9jxjmewvdhk6uus763";

    let userPubkey = null; // Stocke la cl√© publique de l'utilisateur connect√©

    const loginBtn = document.getElementById('loginBtn');
    const contactForm = document.getElementById('contactForm');
    const loggedOutView = document.getElementById('logged-out-view');
    const loggedInView = document.getElementById('logged-in-view');
    const userProfileId = document.getElementById('user-profile-id');
    const messageTextarea = document.getElementById('message');
    const sendMessageBtn = document.getElementById('sendMessageBtn');

    /**
     * G√®re la connexion de l'utilisateur via la librairie Nostr.
     */
    async function handleLogin() {
        if (typeof window.nostr === 'undefined' || typeof window.nostr.getPublicKey !== 'function') {
            alert("L'extension Nostr avec la clef de votre MULTIPASS est requise pour la connexion.");
            return;
        }
        try {
            console.log("Attempting to get public key from Nostr extension...");
            const pubkey = await window.nostr.getPublicKey();
            if (pubkey) {
                userPubkey = pubkey;
                updateUIForLogin(pubkey);
                console.log("Connecting to Nostr relay after successful public key retrieval...");
                await connectToRelay(); // Connect to relay after successful login
            } else {
                alert("Impossible de r√©cup√©rer la cl√© publique. Autorisez l'acc√®s dans votre extension Nostr.");
            }
        } catch (error) {
            alert("La connexion a √©chou√©. Veuillez autoriser l'acc√®s dans votre extension Nostr.");
            console.error("Erreur de connexion Nostr:", error);
        }
    }

    /**
     * Met √† jour l'interface utilisateur apr√®s une connexion r√©ussie.
     * @param {string} pubkey - La cl√© publique hexad√©cimale de l'utilisateur.
     */
    function updateUIForLogin(pubkey) {
        loginBtn.textContent = `Connect√© : ${pubkey.substring(0, 6)}...${pubkey.substring(pubkey.length - 4)}`;
        loginBtn.classList.remove('btn-ghost');
        loginBtn.onclick = null;

        loggedOutView.style.display = 'none';
        loggedInView.style.display = 'block';
        userProfileId.textContent = `${pubkey.substring(0, 8)}...`;
    }

    /**
     * G√®re l'envoi du message via le formulaire en utilisant la librairie.
     */
    async function handleSendMessage(event) {
        event.preventDefault();
        if (!userPubkey) {
            alert("Erreur : vous n\'√™tes pas connect√©.");
            return;
        }

        const messageContent = messageTextarea.value.trim();
        if (!messageContent) {
            alert("Veuillez √©crire un message.");
            return;
        }

        sendMessageBtn.disabled = true;
        sendMessageBtn.textContent = "Envoi...";

        try {
            // Create a base event
            const eventTemplate = {
                kind: 1, // Generic text note
                created_at: Math.floor(Date.now() / 1000),
                tags: [["p", CAPTAIN_PUBKEY_HEX]], // Tag the captain's pubkey
                content: messageContent
            };

            // Add the 'reply' tag if this were a reply, or other specific tags as needed.
            // For a direct message, it might be kind 4 and encrypted.
            // For now, assuming a public note tagging the captain.

            let signedEvent;
            if (window.nostr && typeof window.nostr.signEvent === 'function') {
                signedEvent = await window.nostr.signEvent(eventTemplate);
            } else if (userPrivateKey) {
                // Fallback for private key signing (if implemented for this project)
                signedEvent = NostrTools.finishEvent(eventTemplate, userPrivateKey);
            } else {
                throw new Error("No Nostr extension found or private key available for signing.");
            }

            if (!nostrRelay || !isNostrConnected) {
                throw new Error("Relay not connected. Please try connecting again.");
            }

            console.log("Publishing event to relay:", signedEvent);
            const publishPromise = nostrRelay.publish(signedEvent);

            // Add a timeout for the publish operation
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Publish timeout')), 5000);
            });

            await Promise.race([publishPromise, timeoutPromise]);

            console.log("√âv√©nement publi√© : ", signedEvent);

            alert("Message envoy√© avec succ√®s !");
            messageTextarea.value = '';

        } catch (error) {
            alert(`Erreur lors de l'envoi du message: ${error.message}.`);
            console.error("Erreur d'envoi Nostr:", error);
        } finally {
            sendMessageBtn.disabled = false;
            sendMessageBtn.textContent = "Envoyer le message";
        }
    }

    async function connectToRelay() {
        const NOSTRws = DEFAULT_RELAYS[0]; // Use the dynamically determined default relay
        const userPublicKey = userPubkey; // Use the globally set userPubkey
        const userPrivateKey = null; // We don't have userPrivateKey in this context yet

        if (!NOSTRws) {
            console.error("NOSTRws is not defined. Cannot connect to relay.");
            updateConnectionStatus(false);
            return;
        }

        console.log('Connecting to relay:', NOSTRws);

        try {
            nostrRelay = NostrTools.relayInit(NOSTRws);

            nostrRelay.on('connect', () => {
                console.log('‚úÖ Connected to NOSTR relay:', NOSTRws);
                isNostrConnected = true;
                updateConnectionStatus(true);
            });

            nostrRelay.on('error', (error) => {
                console.error('‚ùå Relay connection error:', error);
                isNostrConnected = false;
                updateConnectionStatus(false);
            });

            nostrRelay.on('auth', async (challenge) => {
                console.log('üîê Received AUTH challenge:', challenge);
                try {
                    const authEvent = {
                        kind: 22242,
                        created_at: Math.floor(Date.now() / 1000),
                        tags: [
                            ['relay', NOSTRws],
                            ['challenge', challenge]
                        ],
                        content: '',
                        pubkey: userPublicKey
                    };

                    let signedAuthEvent;
                    if (window.nostr) {
                        signedAuthEvent = await window.nostr.signEvent(authEvent);
                    } else if (userPrivateKey) {
                        signedAuthEvent = NostrTools.finishEvent(authEvent, userPrivateKey);
                    } else {
                        console.error('No signing method available for NIP-42 auth');
                        return;
                    }

                    console.log('‚úçÔ∏è Responding to AUTH challenge with NIP-42 event:', signedAuthEvent);
                    await nostrRelay.publish(signedAuthEvent);

                } catch (authError) {
                    console.error('‚ùå Error processing NIP-42 auth:', authError);
                }
            });

            console.log('Attempting relay connection...');
            await nostrRelay.connect();

            console.log('‚úÖ Connected to NOSTR relay:', NOSTRws);
            isNostrConnected = true;

            if (nostrRelay.status === 1) { // OPEN
                console.log('‚úÖ Relay status: CONNECTED');
            } else {
                console.log('‚ö†Ô∏è Relay status:', nostrRelay.status);
            }
        } catch (error) {
            console.error('Failed to connect to relay:', error);
            isNostrConnected = false;
            throw error;
        }
    }

    function tryDirectWebSocketSend(event) {
        console.warn('Direct WebSocket send not implemented. Event:', event);
        if (nostrRelay && nostrRelay.ws && nostrRelay.ws.readyState === WebSocket.OPEN) {
            nostrRelay.ws.send(JSON.stringify(["EVENT", event]));
            console.log('Attempted direct WebSocket send.');
        } else {
            console.error('Direct WebSocket send failed: Relay not connected or WebSocket not open.');
        }
    }

    function updateConnectionStatus(isConnected) {
        console.log(`Relay connection status: ${isConnected ? 'Connected' : 'Disconnected'}`);
    }

    // Ajoute les √©couteurs d'√©v√©nements au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
        // Initial check for Nostr extension
        loginBtn.disabled = true;
        loginBtn.textContent = "Checking Nostr Extension...";

        setTimeout(() => {
            if (typeof window.nostr === 'undefined' || typeof window.nostr.getPublicKey !== 'function') {
                loginBtn.disabled = true;
                loginBtn.textContent = "Nostr Extension Required";
            } else {
                loginBtn.disabled = false;
                loginBtn.textContent = "Connexion"; // Restore original text
            }
        }, 500); // Delay the check by 500ms

        loginBtn.addEventListener('click', handleLogin);
        contactForm.addEventListener('submit', handleSendMessage);
        detectUSPOTAPI(); // Call detectUSPOTAPI on load
    });
  </script>
</body>
</html>
