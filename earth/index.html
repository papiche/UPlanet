<!DOCTYPE html>
<html>
  <head>
    <title>UPlanet - Public Goods For A Better Tomorrow - 0.01° x 0.01° -  </title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ring.ico">
    <link rel="stylesheet" href="jquery-ui.min.css">

    <script type="text/javascript" src="requestanimationframe.polyfill.js"></script>

    <script type="text/javascript" src="jquery-1.7.2.min.js"></script>

    <script type="text/javascript" src="jquery-ui.0.min.js"></script>
    <script type="text/javascript" src="sphere-hacked.js"></script>


    <script type="text/javascript" src="jquery.earth-3d.js"></script>

    <script type="text/javascript" src="world.js"></script>

    <script type="text/javascript" src="demo.js"></script>

    <script src="astro.js"></script>


    <script type="text/javascript">

// Extract the hostname (e.g., "https://ipfs.domain.tld" or "http://ipfs.localhost:8080")
var currentURL = new URL(window.location.href);
var hostname = currentURL.hostname;
var port = currentURL.port;
var protocol = currentURL.protocol.split(":")[0];
// Check and replace the port if it's 8080
if (port === "8080") {
    port = "1234";
}
var zHost = hostname.replace("ipfs", "astroport");
var station = protocol + "://" + zHost + (port ? (":" + port) : "");
console.log(station)

if (port === "1234") {
    port = "54321";
}

var uHost = hostname.replace("ipfs", "u");
var upassport = protocol + "://" + uHost + (port ? (":" + port) : "");
console.log(upassport)

// Define UPlanet API URL
var uPlanetAPI_URL = upassport + "/";

    function go2UPassport(route) {
        const currentUrl = new URL(window.location.href);
        let newUrl = new URL(currentUrl.origin);

        // Transformation de 'ipfs.domain.tld' en `u.domain.tld`
        if (currentUrl.hostname.startsWith('ipfs.')) {
            newUrl.hostname = newUrl.hostname.replace('ipfs.', 'u.');
        }

        // Changer le port en 54321 si le port actuel est 8080
        if (currentUrl.port === '8080' || currentUrl.port !== '') {
            newUrl.port = '54321';
        }

        window.parent.location.href = newUrl.toString() + route;
    }


    examples['simple_mars'] = function() {
    $('#sphere').earth3d({
        texture: 'maps/sector0_miz.jpg', // texture used on sphere
        dragElement: $('#locations') // where do we catch the mouse drag
    });
    };
    </script>

   <style>
    body {
      padding: 0;
      margin: 0;
      font-family: sans-serif;
    }

    .slidecontainer {
      width: 80%;
      margin: 0 auto;
      text-align: center;
    }

    .gif-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .gif-container img {
      margin: 10px;
      max-width: 200px;
    }

    .slider {
      width: 100%;
      text-align: center;
    }

    .slider #prev {
      float: left;
      font-size: 40px;
    }

    .slider #next {
      float: right;
      font-size: 40px;
    }

#glow-shadows.earth {
    background: url(maps/earth-glow-shadows.png);
}

#glow-shadows.mars {
    background: url(maps/mars-glow-shadows.png);
}

.flight {
    position: absolute;
    width: 24px;
    height: 25px;
    left: 10px;
    top: 10px;
    background: url(maps/plain.png);
    background-size: 100% 100%;
    margin-left: -12px;
    margin-top: -12.5px;
    cursor: pointer;
}

.button {
    background-color: #3498db;
    color: #fff;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
}
#console {
    visibility: hidden;
    background: rgba(0, 0, 0, 0.9); /* Adjust the background color and opacity as needed */
    color: white;
    width: 100%;
    height: 80%;
    position: absolute;
    bottom: 50px;
    left: 0;
    box-sizing: border-box;
}
#addressForm {
    text-align: center;
    margin-top: 20px;
}

#address {
    width: 300px;
    padding: 10px;
    font-size: 16px;
    border: 2px solid #3498db;
    border-radius: 10px;
    outline: none;
    transition: all 0.3s ease-in-out;
}

#address:focus {
    border-color: #2ecc71;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
}

button {
    background-color: #2ecc71;
    color: white;
    font-size: 16px;
    padding: 10px 15px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s ease-in-out;
}

button:hover {
    background-color: #27ae60;
}

/* Economic Dashboard Styles */
.economic-dashboard {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255, 255, 255, 0.95);
  padding: 15px;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  max-width: 250px;
  font-family: 'Arial', sans-serif;
  transition: transform 0.3s ease-in-out;
  transform: translateX(0);
}

.economic-dashboard.hidden {
  transform: translateX(calc(100% + 20px));
}

.dashboard-toggle {
  position: fixed;
  top: 80px;
  right: 20px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 20px;
  cursor: pointer;
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s ease;
}

.dashboard-toggle:hover {
  background: #2980b9;
}

.dashboard-title {
  font-size: 1em;
  font-weight: bold;
  color: #2c3e50;
  margin-bottom: 10px;
  text-align: center;
  border-bottom: 2px solid #3498db;
  padding-bottom: 5px;
}

.metric {
  margin: 5px 0;
  padding: 8px;
  border-radius: 8px;
  background: #f8f9fa;
}

.metric-title {
  font-weight: bold;
  color: #34495e;
  margin-bottom: 2px;
  font-size: 0.9em;
}

.metric-value {
  font-size: 1em;
  color: #2c3e50;
}

.metric.positive {
  border-left: 4px solid #2ecc71;
}

.metric.negative {
  border-left: 4px solid #e74c3c;
}

.spots-container {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}

.spot-box {
  flex: 1;
  margin: 0 3px;
  padding: 8px;
  text-align: center;
  background: #f8f9fa;
  border-radius: 8px;
}

.spot-title {
  font-size: 0.8em;
  color: #7f8c8d;
}

.spot-value {
  font-size: 1.1em;
  font-weight: bold;
  color: #2c3e50;
}

.buy-link {
  display: block;
  text-align: center;
  margin-top: 10px;
  padding: 8px;
  background: #3498db;
  color: white;
  text-decoration: none;
  border-radius: 8px;
  transition: background 0.3s ease;
  font-size: 0.9em;
}

.buy-link:hover {
  background: #2980b9;
}
  </style>

    <link rel="stylesheet" href="earth.css">

  </head>

  <body>
    <h1>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="go2UPassport('');">/</button> __ UPlanet __ <button onclick="go2UPassport('scan');">SCAN</button></h1>

¯\_༼qO͡〰op༽_/¯

        <div id="countdown"></div>

    <div id="container">

        <br><br>
          <div id="sphere"></div>
          <div id="glow-shadows" class="earth"></div>
          <div id="flights"></div>
          <div id="locations"></div>
     </div>
<!--
        <div class="choose_example">
          Planet : <select id="example">
            <option value="simple_mars">New</option>
            <option value="locations" selected >Earth</option>
          </select>
        </div>
-->
    <button style="position: fixed; top: 5px; left: 5px;" onclick="document.getElementById('console').style.visibility = (document.getElementById('console').style.visibility === 'visible' ? 'hidden' : 'visible');">c[○┬●]כ</button>

    <form style="position: fixed; bottom: 10px; width: 100%; display: flex; justify-content: center;" id="addressForm">
    <div style="text-align: center;">
        <label for="address"></label>
        <h3><input type="text" id="address" size=26 required>
        <button type="button" title="FIND ME" onclick="getCoordinates()">⌂ ?</button>
        </h3>

        <h2>
            <a target="visio" href="/ipfs/QmRq6LusiEG49BA3nsUTQvBmQxUQnY3tjqNM4M66rbBEt7/?room=UPLANET&effects&record">"VISIO ROOM"</a>
        </h2>
        <p id="result"> - <a href="mailto:support@qo-op.com">contact</a> - <a target="goodies" href="https://astroport.myspreadshop.fr/"> goodies </a> - <a target="sponsor" href="https://opencollective.com/monnaie-libre"> sponsor </a> - </p>
    </div>
    </form>


        <!--
        <div class="code">
          <a href="#" onclick="$('#example_code').show(); $(this).hide().siblings('a').show(); return false;">Show code</a>
          <a href="#" style="display: none;" onclick="$('#example_code').hide(); $(this).hide().siblings('a').show(); return false;">Hide code</a>
          <textarea id="example_code" onclick="this.focus();this.select();"></textarea>
        </div>
-->

<div id="console"> <a href="https://pad.p2p.legal/p/UPlanet_HELP" target="aframe">
    <img width=20 src="/ipfs/QmY1BbaSHLj5vmtB6QmFenqma6qajkky3QRBJEMWaZnA49" ></a>
      ____ <a href="https://zen.g1sms.fr" target="aframe">UPlanet(*) Ẑen</a>
        ____ <button onclick="document.getElementById('console').style.visibility = 'hidden';"> X </button>
    <iframe name="aframe" id="aframe" src="nostr_console.html" width="100%" height="100%"></iframe>
</div>

<script>
// Function to extract URL parameters
function getUrlParameter(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  const results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}
const defaultIPNS = '';
const defaultIPFS = '';
const defaultPUB = '';

const myIPFS = getUrlParameter('ipfs') || defaultIPFS;
const myPUBKEY = getUrlParameter('g1pub') || defaultPUB;
const sectorIPNS = getUrlParameter('ipns') || defaultIPNS;
console.log('myIPFS: /ipfs/', myIPFS);
console.log('myPUBKEY: /g1pub/', myPUBKEY);
console.log('sectorIPNS: /ipns/', sectorIPNS);

if (sectorIPNS !== '' ) {
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'button-container'
    buttonContainer.style.position = 'absolute';
    buttonContainer.style.bottom = '0px';
    buttonContainer.style.left = '0px';
    buttonContainer.style.width = '200px';
    buttonContainer.style.height = '150px';
    buttonContainer.style.zIndex = '1001';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.flexDirection = 'column';
    buttonContainer.style.alignItems = 'center';
    buttonContainer.style.justifyContent = 'center';

    const button = document.createElement('button');
    button.innerText = 'EXPLORE';
    button.className = 'button';

    // Add an event listener to the button
    button.addEventListener('click', function() {
        window.open( '/ipns/'+ sectorIPNS, "AstroTab");
    });

    // Append the button to the button container
    buttonContainer.appendChild(button);
    document.body.appendChild(buttonContainer);
}

function getCoordinates() {
    const addressInput = document.getElementById('address');
    const address = addressInput.value.trim(); // Trim to remove leading/trailing spaces

    if (address === '') {
        // If address is empty, proceed to retrieve geolocation
        getLocation();
    } else {
        // Replace spaces with '+' for the URL
        const formattedAddress = address.replace(/ /g, '+');

        // Make a request to the Nominatim API
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${formattedAddress}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const latitude = (parseFloat(data[0].lat) - 0.025).toFixed(2);
                    const longitude = (parseFloat(data[0].lon) - 0.025).toFixed(2);
                    window.location.replace(`map_render.html?southWestLat=${latitude}&southWestLon=${longitude}&deg=0.1`);
                } else {
                    document.getElementById('result').innerText = 'Coordinates not found. Click on surrounding dots to zoom in.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result').innerText = 'An error occurred while fetching coordinates.';
            });
    }
}

// Add event listener for the "Enter" key
document.getElementById('address').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        getCoordinates();
    }
});

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const latitude = (position.coords.latitude - 0.025).toFixed(1);
            const longitude = (position.coords.longitude - 0.025).toFixed(1);
            window.location.replace(`map_render.html?southWestLat=${latitude}&southWestLon=${longitude}&deg=0.1`);
        }, function(error) {
            console.error('Error getting geolocation:', error);
            document.getElementById('result').innerText = 'Geolocation not available. Enter an address to proceed.';
        });
    } else {
        document.getElementById('result').innerText = 'Geolocation is not supported by this browser. Enter an address to proceed.';
    }
}

// Add this after the existing script section
async function loadUPlanetData(myURL) {
  try {
    console.log('Fetching UPlanet data from:', myURL);
    const response = await fetch(myURL);
    const data = await response.json();
    console.log('UPlanet data loaded successfully:', data);
    return data;
  } catch (error) {
    console.error('Error loading UPlanet data:', error);
    return null;
  }
}

function createEconomicDashboard(data) {
  // Create toggle button
  const toggleButton = document.createElement('button');
  toggleButton.className = 'dashboard-toggle';
  toggleButton.innerHTML = '💰';
  toggleButton.title = 'Toggle Economic Dashboard';
  document.body.appendChild(toggleButton);

  const dashboard = document.createElement('div');
  dashboard.className = 'economic-dashboard';
  
  // Get values from JSON data
  const maxPlayers = 24;
  const maxNostr = 250;
  const currentPlayers = data.PLAYERs ? data.PLAYERs.length : 0;
  const currentNostr = data.NOSTR ? data.NOSTR.length : 0;
  const availablePlayers = maxPlayers - currentPlayers;
  const availableNostr = maxNostr - currentNostr;

  // Get values from JSON data
  const zcard = parseInt(data.ZCARD) || 15;
  const ncard = parseInt(data.NCARD) || 4;
  const paf = parseInt(data.PAF) || 100;
  const zen = parseInt(data.ZEN) || 0;
  const bilan = parseInt(data.BILAN) || 0;

  // Calculate revenue and profit
  const totalRevenue = zcard + ncard;
  const monthlyProfit = totalRevenue - paf;

  // Calculate shares
  let captainShare, playerShare, playerReturn, nostrReturn;

  if (monthlyProfit > 0) {
    // If profit is positive
    if (totalRevenue >= (2 * paf)) {
      // Captain gets profit when revenue is 2x PAF
      captainShare = monthlyProfit;
      playerShare = 0;
    } else {
      // No profit distribution until 2x PAF is reached
      captainShare = 0;
      playerShare = 0;
    }
  } else {
    // If loss
    captainShare = 0; // Captain doesn't take loss
    playerShare = 0;  // No distribution in case of loss
  }

  // Calculate returns (only for PLAYERs)
  playerReturn = currentPlayers > 0 ? playerShare / currentPlayers : 0;
  nostrReturn = 0; // NOSTR accounts don't get profit distribution

  // Get first 8 characters of UPLANET public key
  const planetPub = data.UPLANETG1PUB ? data.UPLANETG1PUB.substring(0, 8) : 'N/A';

  // Set toggle button color based on balance
  toggleButton.style.backgroundColor = bilan >= 0 ? '#2ecc71' : '#e74c3c';

  dashboard.innerHTML = `
    <div class="dashboard-title">♥️BOX ECO</div>

    <div class="metric">
      <div class="metric-title">UPLANET ${planetPub}</div>
    </div>

    <div class="metric paf-metric">
      <div class="metric-title">PAF / 28 jours</div>
      <div class="metric-value">${paf.toFixed(2)} Ẑ</div>
    </div>
    
    <div class="metric ${bilan >= 0 ? 'positive' : 'negative'}">
      <div class="metric-title">Solde</div>
      <div class="metric-value">${bilan.toFixed(2)} Ẑ</div>
    </div>

    <div class="metric">
      <div class="metric-title">Revenu Mensuel</div>
      <div class="metric-value">${totalRevenue.toFixed(2)} Ẑ</div>
      <div class="metric-subtitle">(ZCARD: ${zcard.toFixed(2)} + NCARD: ${ncard.toFixed(2)})</div>
    </div>

    <div class="metric">
      <div class="metric-title">Gains Capitaine ♥️</div>
      <div class="metric-value">${captainShare.toFixed(2)} Ẑ</div>
      <div class="metric-subtitle">(Profit when revenue ≥ ${(2 * paf).toFixed(2)}Ẑ)</div>
    </div>

    <div class="metric">
      <div class="metric-title">Gains / PLAYER ✨</div>
      <div class="metric-value">${playerReturn.toFixed(2)} Ẑ</div>
      <div class="metric-subtitle">per PLAYER (${currentPlayers} active)</div>
    </div>

    <div class="spots-container">
      <div class="spot-box">
        <div class="spot-title">NextCloud + IA</div>
        <div class="spot-value">${availablePlayers}/${maxPlayers}</div>
      </div>
      <div class="spot-box">
        <div class="spot-title">NOSTR + IA</div>
        <div class="spot-value">${availableNostr}/${maxNostr}</div>
      </div>
    </div>

    <a href="https://zen.g1sms.fr" target="_blank" class="buy-link">
      Prenez votre place
    </a>
  `;

  // Add custom styles for PAF metric
  const style = document.createElement('style');
  style.textContent = `
    .paf-metric {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .paf-metric .metric-title {
      color: #2c3e50;
      font-weight: bold;
    }
    .paf-metric .metric-value {
      color: #3498db;
      font-size: 1.2em;
      font-weight: bold;
    }
  `;
  document.head.appendChild(style);

  document.body.appendChild(dashboard);

  // Add toggle functionality
  toggleButton.addEventListener('click', () => {
    dashboard.classList.toggle('hidden');
    toggleButton.innerHTML = dashboard.classList.contains('hidden') ? '💰' : '📊';
  });
}

// Load and display economic data
loadUPlanetData(uPlanetAPI_URL).then(data => {
  if (data) {
    createEconomicDashboard(data);
  }
});
</script>

</body></html>
