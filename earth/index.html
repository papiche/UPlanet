<!DOCTYPE html>
<html>
  <head>
    <title>UPlanet - Public Goods For A Better Tomorrow - 0.01° x 0.01° -  </title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ring.ico">
    <link rel="stylesheet" href="jquery-ui.min.css">

    <script type="text/javascript" src="requestanimationframe.polyfill.js"></script>

    <script type="text/javascript" src="jquery-1.7.2.min.js"></script>

    <script type="text/javascript" src="jquery-ui.0.min.js"></script>
    <script type="text/javascript" src="sphere-hacked.js"></script>


    <script type="text/javascript" src="jquery.earth-3d.js"></script>

    <script type="text/javascript" src="world.js"></script>

    <script type="text/javascript" src="demo.js"></script>

    <script src="astro.js"></script>


    <script type="text/javascript">

// Extract the hostname (e.g., "https://ipfs.domain.tld" or "http://ipfs.localhost:8080")
var currentURL = new URL(window.location.href);
var hostname = currentURL.hostname;
var port = currentURL.port;
var protocol = currentURL.protocol.split(":")[0];
// Check and replace the port if it's 8080
if (port === "8080") {
    port = "1234";
}
var zHost = hostname.replace("ipfs", "astroport");
var station = protocol + "://" + zHost + (port ? (":" + port) : "");
console.log(station)

if (port === "1234") {
    port = "54321";
}

var uHost = hostname.replace("ipfs", "u");
var upassport = protocol + "://" + uHost + (port ? (":" + port) : "");
console.log(upassport)

// Define UPlanet API URL
var uPlanetAPI_URL = upassport + "/";

    function go2UPassport(route) {
        const currentUrl = new URL(window.location.href);
        let newUrl = new URL(currentUrl.origin);

        // Transformation de 'ipfs.domain.tld' en `u.domain.tld`
        if (currentUrl.hostname.startsWith('ipfs.')) {
            newUrl.hostname = newUrl.hostname.replace('ipfs.', 'u.');
        }

        // Changer le port en 54321 si le port actuel est 8080
        if (currentUrl.port === '8080' || currentUrl.port !== '') {
            newUrl.port = '54321';
        }

        window.parent.location.href = newUrl.toString() + route;
    }


    examples['simple_mars'] = function() {
    $('#sphere').earth3d({
        texture: 'maps/sector0_miz.jpg', // texture used on sphere
        dragElement: $('#locations') // where do we catch the mouse drag
    });
    };
    </script>

   <style>
    body {
      padding: 0;
      margin: 0;
      font-family: sans-serif;
    }

    .slidecontainer {
      width: 80%;
      margin: 0 auto;
      text-align: center;
    }

    .gif-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .gif-container img {
      margin: 10px;
      max-width: 200px;
    }

    .slider {
      width: 100%;
      text-align: center;
    }

    .slider #prev {
      float: left;
      font-size: 40px;
    }

    .slider #next {
      float: right;
      font-size: 40px;
    }

#glow-shadows.earth {
    background: url(maps/earth-glow-shadows.png);
}

#glow-shadows.mars {
    background: url(maps/mars-glow-shadows.png);
}

.flight {
    position: absolute;
    width: 24px;
    height: 25px;
    left: 10px;
    top: 10px;
    background: url(maps/plain.png);
    background-size: 100% 100%;
    margin-left: -12px;
    margin-top: -12.5px;
    cursor: pointer;
}

.button {
    background-color: #3498db;
    color: #fff;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
}
#console {
    visibility: hidden;
    background: rgba(0, 0, 0, 0.9); /* Adjust the background color and opacity as needed */
    color: white;
    width: 100%;
    height: 80%;
    position: absolute;
    bottom: 50px;
    left: 0;
    box-sizing: border-box;
}
#addressForm {
    text-align: center;
    margin-top: 20px;
}

#address {
    width: 300px;
    padding: 10px;
    font-size: 16px;
    border: 2px solid #3498db;
    border-radius: 10px;
    outline: none;
    transition: all 0.3s ease-in-out;
}

#address:focus {
    border-color: #2ecc71;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
}

button {
    background-color: #2ecc71;
    color: white;
    font-size: 16px;
    padding: 10px 15px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s ease-in-out;
}

button:hover {
    background-color: #27ae60;
}

/* Economic Dashboard Styles */
.economic-dashboard {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255, 255, 255, 0.95);
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  max-width: 600px;
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  font-family: 'Arial', sans-serif;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* Style de la barre de défilement */
.economic-dashboard::-webkit-scrollbar {
  width: 8px;
}

.economic-dashboard::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.economic-dashboard::-webkit-scrollbar-thumb {
  background: #3498db;
  border-radius: 4px;
}

.economic-dashboard::-webkit-scrollbar-thumb:hover {
  background: #2980b9;
}

/* Ajustement des sections pour une meilleure lisibilité */
.status-section {
  margin-bottom: 15px;
  padding: 12px;
}

.simulator-section {
  margin-top: 15px;
  padding: 15px;
}

.simulation-results {
  margin-top: 10px;
  padding: 15px;
}

.progress-container {
  margin: 10px 0;
  padding: 12px;
}

.simulation-note {
  margin: 10px 0;
  padding: 12px;
}

.subscription-cta {
  margin-top: 15px;
  padding: 12px;
}

/* Ajustement des espacements pour une meilleure densité d'information */
.metric-details div {
  margin: 1px 0;
}

.simulation-note p {
  margin: 3px 0;
}

.subscription-cta p {
  margin: 3px 0;
}

.economic-dashboard.hidden {
  transform: translateX(120%);
  opacity: 0;
}

.status-section {
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
}

.status-section .metric {
  flex: 1;
  min-width: 200px;
}

.progress-bar {
  width: 100%;
  height: 20px;
  background: #e0e0e0;
  border-radius: 10px;
  margin: 10px 0;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71);
  transition: width 0.5s ease-in-out;
}

.simulator-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 20px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 10px;
}

.simulator-input {
  flex: 1;
  min-width: 200px;
  position: relative;
}

.simulator-input label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
  color: #2c3e50;
}

.simulator-input input {
  width: 100%;
  padding: 12px;
  border: 2px solid #3498db;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  -webkit-appearance: none;
  margin: 0;
}

.simulator-input input:focus {
  border-color: #2ecc71;
  box-shadow: 0 0 8px rgba(46, 204, 113, 0.3);
  outline: none;
}

/* Style pour les boutons + et - sur mobile */
.simulator-input input[type="number"]::-webkit-inner-spin-button,
.simulator-input input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.simulator-input input[type="number"] {
  -moz-appearance: textfield;
}

/* Ajout de boutons + et - personnalisés */
.number-controls {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.number-control {
  width: 24px;
  height: 24px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s ease;
}

.number-control:hover {
  background: #2980b9;
}

/* Media queries pour le responsive */
@media (max-width: 768px) {
  .simulator-controls {
    flex-direction: column;
    gap: 20px;
  }

  .simulator-input {
    min-width: 100%;
  }

  .simulator-input input {
    font-size: 18px;
    padding: 15px;
  }

  .number-controls {
    right: 15px;
  }

  .number-control {
    width: 30px;
    height: 30px;
    font-size: 20px;
  }
}

@media (max-width: 480px) {
  .simulator-section {
    padding: 10px;
  }

  .simulator-controls {
    padding: 15px;
  }

  .simulator-input label {
    font-size: 14px;
  }

  .simulator-input input {
    padding: 12px;
    font-size: 16px;
  }
}

.metric-title {
  font-weight: bold;
  color: #34495e;
  margin-bottom: 2px;
  font-size: 0.9em;
}

.metric-value {
  font-size: 1.2em;
  color: #2c3e50;
  font-weight: bold;
}

.metric-subtitle {
  font-size: 0.8em;
  color: #7f8c8d;
}

.positive {
  color: #2ecc71;
}

.negative {
  color: #e74c3c;
}

.subscription-benefits {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
}

.subscription-benefits h3 {
  color: #2c3e50;
  margin-bottom: 15px;
  text-align: center;
}

.benefit-card {
  background: white;
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: relative;
  z-index: 1;
}

.benefit-card h4 {
  color: #3498db;
  margin: 0 0 10px 0;
  font-size: 1.2em;
}

.benefit-card ul {
  list-style: none;
  padding: 0;
  margin: 0 0 15px 0;
}

.benefit-card li {
  padding: 5px 0;
  color: #2c3e50;
  position: relative;
  padding-left: 20px;
}

.benefit-card li:before {
  content: "✓";
  color: #2ecc71;
  position: absolute;
  left: 0;
}

.subscribe-button {
  display: block;
  text-align: center;
  background: #3498db;
  color: white;
  text-decoration: none;
  padding: 15px;
  border-radius: 8px;
  transition: all 0.3s ease;
  margin-top: 15px;
  font-weight: bold;
  font-size: 1.1em;
  border: none;
  cursor: pointer;
  width: 100%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.subscribe-button:hover {
  background: #2980b9;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.subscribe-button:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Style spécifique pour le bouton ZEN Card */
.benefit-card:last-child .subscribe-button {
  background: #2ecc71;
  font-size: 1.2em;
  padding: 18px;
}

.benefit-card:last-child .subscribe-button:hover {
  background: #27ae60;
}

/* Ajustements pour mobile */
@media (max-width: 768px) {
  .benefit-card {
    margin: 15px 0;
    padding: 20px;
  }

  .subscribe-button {
    padding: 18px;
    font-size: 1.2em;
  }

  .benefit-card:last-child .subscribe-button {
    padding: 20px;
    font-size: 1.3em;
  }
}

.simulation-results {
  background: white;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
  border: 1px solid #e0e0e0;
}

.simulation-results h4 {
  color: #2c3e50;
  margin: 0 0 10px 0;
}

.simulation-results p {
  margin: 5px 0;
  color: #34495e;
}

.simulation-results .highlight {
  color: #2ecc71;
  font-weight: bold;
}

.dashboard-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #3498db;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1001;
  transition: all 0.3s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.dashboard-toggle:hover {
  transform: scale(1.1);
  background: #2980b9;
}

.thresholds {
  margin-top: 15px;
}

.threshold {
  margin: 10px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.threshold.active {
  background: #e8f4fc;
  border-left: 4px solid #3498db;
}

.threshold-label {
  font-weight: bold;
  color: #2c3e50;
  margin-bottom: 5px;
}

.threshold-value {
  color: #3498db;
  font-weight: bold;
  margin-bottom: 5px;
}

.threshold-progress {
  height: 6px;
  background: #e0e0e0;
  border-radius: 3px;
  overflow: hidden;
}

.threshold-bar {
  height: 100%;
  background: linear-gradient(90deg, #3498db, #2ecc71);
  transition: width 0.5s ease-in-out;
}

.simulation-note ul {
  margin: 5px 0;
  padding-left: 20px;
}

.simulation-note li {
  margin: 3px 0;
  color: #2c3e50;
}

.uplanet-distribution {
  background: #f8f9fa;
  border-left: 4px solid #2ecc71;
}

.distribution-bars {
  margin-top: 15px;
}

.distribution-item {
  margin: 10px 0;
}

.distribution-label {
  font-weight: bold;
  color: #2c3e50;
  margin-bottom: 5px;
}

.distribution-value {
  color: #27ae60;
  font-weight: bold;
  margin-bottom: 5px;
}

.distribution-bar {
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
}

.distribution-fill {
  height: 100%;
  background: linear-gradient(90deg, #27ae60, #2ecc71);
  transition: width 0.5s ease-in-out;
}

.info-table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.table-header {
  background: #3498db;
  color: white;
  padding: 10px;
  font-weight: bold;
  text-align: center;
}

.table-label {
  background: #f8f9fa;
  padding: 8px;
  font-weight: bold;
  width: 30%;
  vertical-align: top;
  border-right: 1px solid #e0e0e0;
}

.info-table td {
  padding: 8px;
  border-bottom: 1px solid #e0e0e0;
}

.compact-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.compact-list li {
  margin: 2px 0;
  padding-left: 15px;
  position: relative;
}

.compact-list li:before {
  content: "•";
  position: absolute;
  left: 0;
  color: #3498db;
}

.benefit-card {
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
}

.subscribe-button {
  display: block;
  text-align: center;
  background: #3498db;
  color: white;
  text-decoration: none;
  padding: 12px;
  border-radius: 5px;
  transition: background 0.3s ease;
  margin-top: 10px;
  font-weight: bold;
}

.subscribe-button:hover {
  background: #2980b9;
  transform: translateY(-2px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.buy-link {
  display: block;
  text-align: center;
  background: #2ecc71;
  color: white;
  text-decoration: none;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  font-size: 1.3em;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  position: relative;
  z-index: 2;
}

.buy-link:hover {
  background: #27ae60;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.buy-link a {
  color: white;
  text-decoration: none;
}

.buy-link a:hover {
  text-decoration: underline;
}

/* Ajustements pour mobile */
@media (max-width: 768px) {
  .buy-link {
    padding: 25px;
    font-size: 1.4em;
    margin: 25px 0;
  }
}

@media (max-width: 480px) {
  .buy-link {
    padding: 20px;
    font-size: 1.3em;
    margin: 20px 0;
  }
}

.metric-container {
  display: flex;
  gap: 15px;
  margin-top: 10px;
}

.metric-box {
  flex: 1;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-align: center;
  transition: transform 0.3s ease;
  border: 2px solid #f0f0f0;
}

.metric-box:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.metric-box .metric-title {
  color: #2c3e50;
  font-weight: bold;
  font-size: 1.1em;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 2px solid #f0f0f0;
}

.metric-box .metric-value {
  font-size: 1.4em;
  font-weight: bold;
  color: #3498db;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.metric-box .metric-value::before {
  content: "•";
  color: #2ecc71;
  font-size: 1.2em;
}

.metric-box .metric-value::after {
  content: "slots";
  font-size: 0.5em;
  color: #7f8c8d;
  font-weight: normal;
  margin-left: 5px;
}

/* Style spécifique pour chaque type de carte */
.metric-box.zen-card {
  border-color: #2ecc71;
}

.metric-box.zen-card .metric-title {
  color: #27ae60;
}

.metric-box.multipass {
  border-color: #3498db;
}

.metric-box.multipass .metric-title {
  color: #2980b9;
}

/* Ajustements pour mobile */
@media (max-width: 768px) {
  .metric-container {
    flex-direction: column;
    gap: 10px;
  }

  .metric-box {
    padding: 20px;
  }

  .metric-box .metric-title {
    font-size: 1.2em;
  }

  .metric-box .metric-value {
    font-size: 1.6em;
  }
}
  </style>

    <link rel="stylesheet" href="earth.css">

  </head>

  <body>
    <h1>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="go2UPassport('');">/</button> __ UPlanet __ <button onclick="go2UPassport('scan');">SCAN</button></h1>

¯\_༼qO͡〰op༽_/¯

        <div id="countdown"></div>

    <div id="container">

        <br><br>
          <div id="sphere"></div>
          <div id="glow-shadows" class="earth"></div>
          <div id="flights"></div>
          <div id="locations"></div>
     </div>
<!--
        <div class="choose_example">
          Planet : <select id="example">
            <option value="simple_mars">New</option>
            <option value="locations" selected >Earth</option>
          </select>
        </div>
-->
    <button style="position: fixed; top: 5px; left: 5px;" onclick="document.getElementById('console').style.visibility = (document.getElementById('console').style.visibility === 'visible' ? 'hidden' : 'visible');">c[○┬●]כ</button>

    <form style="position: fixed; bottom: 10px; width: 100%; display: flex; justify-content: center;" id="addressForm">
    <div style="text-align: center;">
        <label for="address"></label>
        <h3><input type="text" id="address" size=26 required>
        <button type="button" title="FIND ME" onclick="getCoordinates()">⌂ ?</button>
        </h3>

        <h2>
            <a target="visio" href="/ipfs/QmRq6LusiEG49BA3nsUTQvBmQxUQnY3tjqNM4M66rbBEt7/?room=UPLANET&effects&record">"VISIO ROOM"</a>
        </h2>
        <p id="result"> - <a href="mailto:support@qo-op.com">contact</a> - <a target="goodies" href="https://astroport.myspreadshop.fr/"> goodies </a> - <a target="sponsor" href="https://opencollective.com/monnaie-libre"> sponsor </a> - </p>
    </div>
    </form>


        <!--
        <div class="code">
          <a href="#" onclick="$('#example_code').show(); $(this).hide().siblings('a').show(); return false;">Show code</a>
          <a href="#" style="display: none;" onclick="$('#example_code').hide(); $(this).hide().siblings('a').show(); return false;">Hide code</a>
          <textarea id="example_code" onclick="this.focus();this.select();"></textarea>
        </div>
-->

<div id="console"> <a href="nostr_console.html" target="aframe">
    <img width=20 src="/ipfs/QmY1BbaSHLj5vmtB6QmFenqma6qajkky3QRBJEMWaZnA49" ></a>
      ____ <a href="https://zen.g1sms.fr" target="aframe">Club Ẑen</a>
        ____ <button onclick="document.getElementById('console').style.visibility = 'hidden';"> X </button>
    <iframe name="aframe" id="aframe" src="https://pad.p2p.legal/p/UPlanet_HELP" width="100%" height="100%"></iframe>
</div>

<script>
// Function to extract URL parameters
function getUrlParameter(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  const results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}
const defaultIPNS = '';
const defaultIPFS = '';
const defaultPUB = '';

const myIPFS = getUrlParameter('ipfs') || defaultIPFS;
const myPUBKEY = getUrlParameter('g1pub') || defaultPUB;
const sectorIPNS = getUrlParameter('ipns') || defaultIPNS;
console.log('myIPFS: /ipfs/', myIPFS);
console.log('myPUBKEY: /g1pub/', myPUBKEY);
console.log('sectorIPNS: /ipns/', sectorIPNS);

if (sectorIPNS !== '' ) {
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'button-container'
    buttonContainer.style.position = 'absolute';
    buttonContainer.style.bottom = '0px';
    buttonContainer.style.left = '0px';
    buttonContainer.style.width = '200px';
    buttonContainer.style.height = '150px';
    buttonContainer.style.zIndex = '1001';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.flexDirection = 'column';
    buttonContainer.style.alignItems = 'center';
    buttonContainer.style.justifyContent = 'center';

    const button = document.createElement('button');
    button.innerText = 'EXPLORE';
    button.className = 'button';

    // Add an event listener to the button
    button.addEventListener('click', function() {
        window.open( '/ipns/'+ sectorIPNS, "AstroTab");
    });

    // Append the button to the button container
    buttonContainer.appendChild(button);
    document.body.appendChild(buttonContainer);
}

function getCoordinates() {
    const addressInput = document.getElementById('address');
    const address = addressInput.value.trim(); // Trim to remove leading/trailing spaces

    if (address === '') {
        // If address is empty, proceed to retrieve geolocation
        getLocation();
    } else {
        // Replace spaces with '+' for the URL
        const formattedAddress = address.replace(/ /g, '+');

        // Make a request to the Nominatim API
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${formattedAddress}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const latitude = (parseFloat(data[0].lat) - 0.025).toFixed(2);
                    const longitude = (parseFloat(data[0].lon) - 0.025).toFixed(2);
                    window.location.replace(`map_render.html?southWestLat=${latitude}&southWestLon=${longitude}&deg=0.1`);
                } else {
                    document.getElementById('result').innerText = 'Coordinates not found. Click on surrounding dots to zoom in.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result').innerText = 'An error occurred while fetching coordinates.';
            });
    }
}

// Add event listener for the "Enter" key
document.getElementById('address').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        getCoordinates();
    }
});

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const latitude = (position.coords.latitude - 0.025).toFixed(1);
            const longitude = (position.coords.longitude - 0.025).toFixed(1);
            window.location.replace(`map_render.html?southWestLat=${latitude}&southWestLon=${longitude}&deg=0.1`);
        }, function(error) {
            console.error('Error getting geolocation:', error);
            document.getElementById('result').innerText = 'Geolocation not available. Enter an address to proceed.';
        });
    } else {
        document.getElementById('result').innerText = 'Geolocation is not supported by this browser. Enter an address to proceed.';
    }
}

// Add this after the existing script section
async function loadUPlanetData(myURL) {
  try {
    console.log('Fetching UPlanet data from:', myURL);
    const response = await fetch(myURL);
    const data = await response.json();
    console.log('UPlanet data loaded successfully:', data);
    return data;
  } catch (error) {
    console.error('Error loading UPlanet data:', error);
    return null;
  }
}

function createEconomicDashboard(data) {
  // Create toggle button
  const toggleButton = document.createElement('button');
  toggleButton.className = 'dashboard-toggle';
  toggleButton.innerHTML = '📊';
  toggleButton.title = 'Toggle ♥️BOX Dashboard';
  document.body.appendChild(toggleButton);

  const dashboard = document.createElement('div');
  dashboard.className = 'economic-dashboard';
  
  // Get values from JSON data
  const maxPlayers = 24;
  const maxNostr = 250;
  const currentPlayers = data.PLAYERs ? data.PLAYERs.length : 0;
  const currentNostr = data.NOSTR ? data.NOSTR.length : 0;
  const availablePlayers = maxPlayers - currentPlayers;
  const availableNostr = maxNostr - currentNostr;

  // Get values from JSON data
  const zcard = parseInt(data.ZCARD) || 15;
  const ncard = parseInt(data.NCARD) || 4;
  const paf = parseInt(data.PAF) || 100;
  const zen = parseInt(data.ZEN) || 0;
  const bilan = parseInt(data.BILAN) || 0;

  // Count NOSTR accounts with more than ZCARD amount
  const nostrAboveZcard = data.NOSTR ? data.NOSTR.filter(nostr => parseInt(nostr.ZEN) > zcard).length : 0;
  
  // Count PLAYERs with more than ZCARD amount
  const playersAboveZcard = data.PLAYERs ? data.PLAYERs.filter(player => parseInt(player.ZEN) > zcard).length : 0;

  // Calculate revenue and profit
  const totalRevenue = zcard + ncard;
  const monthlyProfit = totalRevenue - paf;

  // Calculate shares
  let captainShare, playerShare, playerReturn, nostrReturn;

  if (monthlyProfit > 0) {
    // If profit is positive
    if (totalRevenue >= (2 * paf)) {
      // Captain gets profit when revenue is 2x PAF
      captainShare = monthlyProfit;
      playerShare = 0;
    } else {
      // No profit distribution until 2x PAF is reached
      captainShare = 0;
      playerShare = 0;
    }
  } else {
    // If loss
    captainShare = 0; // Captain doesn't take loss
    playerShare = 0;  // No distribution in case of loss
  }

  // Calculate returns (only for PLAYERs)
  playerReturn = currentPlayers > 0 ? playerShare / currentPlayers : 0;
  nostrReturn = 0; // NOSTR accounts don't get profit distribution

  // Get IPFS Node ID
  const IPFSNODEID = data.IPFSNODEID ? data.IPFSNODEID : 'N/A';

  // Get first 8 characters of UPLANET public key
  const planetPub = data.UPLANETG1PUB ? data.UPLANETG1PUB.substring(0, 8) : 'N/A';

  // Set toggle button color based on balance
  toggleButton.style.backgroundColor = bilan >= 0 ? '#2ecc71' : '#e74c3c';

  dashboard.innerHTML = `
    <div class="dashboard-title">♥️BOX UPlanet${planetPub} : ${zen.toFixed(2)} Ẑ</div>

    <!-- Node Status -->
    <div class="status-section">
      <h3>Health Status</h3>
    <div class="metric">
        <div class="metric-title">${IPFSNODEID}</div>
        <div class="metric-value" id="uplanet-balance">${bilan.toFixed(2)} Ẑ</div>
    </div>
    </div>
    
    <!-- Capacity Status -->
    <div class="status-section">
      <h3>Capacity Status</h3>
      <div class="metric-container">
        <div class="metric-box zen-card">
          <div class="metric-title">ZEN Card</div>
          <div class="metric-value">${availablePlayers}/${maxPlayers}</div>
    </div>
        <div class="metric-box multipass">
          <div class="metric-title">MULTIPASS</div>
          <div class="metric-value">${availableNostr}/${maxNostr}</div>
        </div>
      </div>
    </div>

    <!-- Simulator Section -->
    <div class="simulator-section">
      <h3>Economic Simulator</h3>
      <div class="simulation-results" id="simulation-results">
        <!-- Results will be displayed here -->
      </div>
      <div class="simulator-controls">
        <div class="simulator-input">
          <label>MULTIPASSs (${ncard} Ẑen):</label>
          <input type="number" id="new-nostr" min="0" max="${availableNostr}" value="0">
        </div>
        <div class="simulator-input">
          <label>ZEN Cards + (${zcard} Ẑen):</label>
          <input type="number" id="new-zen" min="0" max="${availablePlayers}" value="0">
        </div>
      </div>
    </div>

    <div class="subscription-cta">
      <p><strong>Prêt à rejoindre <a href="https://copylaradio.com" target="_blank">CopyLaRadio / UPlanet Ẑen</a>?</strong></p>
      <p>Choisissez votre type de carte ci-dessous pour rejoindre la coopérative!</p>
    </div>

    <div class="subscription-benefits">
      <div class="benefit-card">
        <h4>MULTIPASS (${ncard} Ẑen)</h4>
        <ul>
          <li>Access to NOSTR network</li>
          <li>Basic IA features</li>
          <li>Community access</li>
          <li>Activation in 24h</li>
        </ul>
        <a href="https://opencollective.com/uplanet-zero/contribute/majordome-ia-78848/checkout?interval=month&amount=4&contributeAs=me" target="_blank" class="subscribe-button">Get MULTIPASS</a>
      </div>
      <div class="benefit-card">
        <h4>ZEN Card + 128 Go (${zcard} Ẑen)</h4>
        <ul>
          <li>All NOSTR features</li>
          <li>Full IA capabilities</li>
          <li>NextCloud storage</li>
          <li>Priority support</li>
        </ul>
        <a href="https://opencollective.com/uplanet-zero/contribute/locataire-128go-71401/checkout?interval=month&amount=19&contributeAs=me" 
           target="_blank" 
           class="subscribe-button"
           style="display: block !important; visibility: visible !important;">
          Get ZEN Card
        </a>
      </div>
    </div>

    <div class="simulation-note">
      <table class="info-table">
        <tr>
          <td colspan="2" class="table-header">Informations importantes</td>
        </tr>
        <tr>
          <td class="table-label">Activation</td>
          <td>Les nouveaux comptes prennent 24 heures pour s'activer</td>
        </tr>
        <tr>
          <td class="table-label">Paliers de bénéfices</td>
          <td>
            <ul class="compact-list">
              <li>Node : Premier palier (${paf} Ẑ)</li>
              <li>Captain : Deuxième palier (${2*paf} Ẑ)</li>
              <li>UPlanet : Troisième palier (${3*paf} Ẑ)</li>
            </ul>
          </td>
        </tr>
        <tr>
          <td class="table-label">Répartition UPlanet</td>
          <td>
            <ul class="compact-list">
              <li>34% pour la trésorerie</li>
              <li>33% pour l'infrastructure</li>
              <li>33% pour la R&D</li>
            </ul>
          </td>
        </tr>
      </table>
    </div>
    <a href="https://opencollective.com/uplanet-zero" target="_blank" class="buy-link" style="display: block !important; visibility: visible !important;">
      UPlanet Ẑen[0]
    </a>
  `;

  // Add custom styles for PAF metric
  const style = document.createElement('style');
  style.textContent = `
    .paf-metric {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .paf-metric .metric-title {
      color: #2c3e50;
      font-weight: bold;
    }
    .paf-metric .metric-value {
      color: #3498db;
      font-size: 1.2em;
      font-weight: bold;
    }
  `;
  document.head.appendChild(style);

  document.body.appendChild(dashboard);

  // Add toggle functionality
  toggleButton.addEventListener('click', () => {
    dashboard.classList.toggle('hidden');
    toggleButton.innerHTML = dashboard.classList.contains('hidden') ? '♥️' : '📊';
  });

  // Initial state
  dashboard.classList.add('hidden');
  toggleButton.innerHTML = '♥️';

  // Add event listeners for dynamic simulation
  const newNostrInput = document.getElementById('new-nostr');
  const newZenInput = document.getElementById('new-zen');

  // Set initial values based on accounts above ZCARD threshold
  if (newNostrInput) {
    newNostrInput.value = nostrAboveZcard;
  }
  if (newZenInput) {
    newZenInput.value = playersAboveZcard;
  }

  function updateSimulation() {
    const newNostr = parseInt(newNostrInput.value) || 0;
    const newZen = parseInt(newZenInput.value) || 0;
    
    // Calculate new revenue (after 28 days)
    const newNostrRevenue = newNostr * ncard;
    const newZenRevenue = newZen * zcard;
    const totalNewRevenue = newNostrRevenue + newZenRevenue;
    
    // Calculate new monthly profit
    const newMonthlyProfit = totalNewRevenue - paf;
    
    // Calculate thresholds
    const nodeThreshold = paf; // Node gets paid first
    const captainThreshold = 2 * paf; // Captain gets profit after 2x PAF
    const uplanetThreshold = 3 * paf; // UPlanet gets profit after 3x PAF
    
    // Calculate progress percentages
    const revenueProgress = Math.min((totalNewRevenue / uplanetThreshold) * 100, 100);
    const profitProgress = Math.min((newMonthlyProfit / paf) * 100, 100);
    
    // Calculate who gets paid
    const nodePayment = Math.min(totalNewRevenue, nodeThreshold);
    const captainPayment = totalNewRevenue > captainThreshold ? Math.min(totalNewRevenue - captainThreshold, paf) : 0;
    const uplanetPayment = totalNewRevenue > uplanetThreshold ? totalNewRevenue - uplanetThreshold : 0;
    
    // Calculate UPlanet distribution if threshold is reached
    let uplanetDistribution = null;
    if (totalNewRevenue >= uplanetThreshold) {
        const totalUPlanetProfit = uplanetPayment;
        uplanetDistribution = {
            cash: totalUPlanetProfit * 0.34, // 34% pour la trésorerie
            infra: totalUPlanetProfit * 0.33, // 33% pour l'infrastructure
            rd: totalUPlanetProfit * 0.33 // 33% pour la R&D
        };
    }

    // Update results with progress bars
    const resultsDiv = document.getElementById('simulation-results');
    resultsDiv.innerHTML = `   
      <div class="progress-container">
        <div class="progress-label">
          <span>Revenus menstruels (28 jours)</span>
          <span class="progress-value">${totalNewRevenue.toFixed(2)} Ẑ</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill" style="width: ${revenueProgress}%"></div>
        </div>
        <div class="metric-details">
          <div>MULTIPASSs: ${newNostr} × ${ncard} Ẑ = ${newNostrRevenue} Ẑ</div>
          <div>ZEN Cards: ${newZen} × ${zcard} Ẑ = ${newZenRevenue} Ẑ</div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-label">
          <span>Profit menstruel</span>
          <span class="progress-value ${newMonthlyProfit >= 0 ? 'positive' : 'negative'}">${newMonthlyProfit.toFixed(2)} Ẑ</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill" style="width: ${profitProgress}%"></div>
        </div>
        <div class="metric-details">
          <div>Revenus: ${totalNewRevenue.toFixed(2)} Ẑ</div>
          <div>PAF: -${paf.toFixed(2)} Ẑ</div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-label">
          <span>Répartition des bénéfices</span>
        </div>
        <div class="thresholds">
          <div class="threshold ${totalNewRevenue >= nodeThreshold ? 'active' : ''}">
            <div class="threshold-label">Node (${nodeThreshold} Ẑ)</div>
            <div class="threshold-value">${nodePayment.toFixed(2)} Ẑ</div>
            <div class="threshold-progress">
              <div class="threshold-bar" style="width: ${Math.min((totalNewRevenue/nodeThreshold) * 100, 100)}%"></div>
            </div>
          </div>
          
          <div class="threshold ${totalNewRevenue >= captainThreshold ? 'active' : ''}">
            <div class="threshold-label">Captain (${captainThreshold} Ẑ)</div>
            <div class="threshold-value">${captainPayment.toFixed(2)} Ẑ</div>
            <div class="threshold-progress">
              <div class="threshold-bar" style="width: ${totalNewRevenue >= captainThreshold ? Math.min(((totalNewRevenue-captainThreshold)/paf) * 100, 100) : 0}%"></div>
            </div>
          </div>
          
          <div class="threshold ${totalNewRevenue >= uplanetThreshold ? 'active' : ''}">
            <div class="threshold-label">UPlanet (${uplanetThreshold} Ẑ)</div>
            <div class="threshold-value">${uplanetPayment.toFixed(2)} Ẑ</div>
            <div class="threshold-progress">
              <div class="threshold-bar" style="width: ${totalNewRevenue >= uplanetThreshold ? Math.min(((totalNewRevenue-uplanetThreshold)/paf) * 100, 100) : 0}%"></div>
            </div>
          </div>
        </div>
      </div>

      ${uplanetDistribution ? `
      <div class="progress-container uplanet-distribution">
        <div class="progress-label">
          <span>Répartition des bénéfices UPlanet</span>
          <span class="progress-value">${uplanetPayment.toFixed(2)} Ẑ</span>
        </div>
        <div class="distribution-bars">
          <div class="distribution-item">
            <div class="distribution-label">Trésorerie (34%)</div>
            <div class="distribution-value">${uplanetDistribution.cash.toFixed(1)} Ẑ</div>
            <div class="distribution-bar">
              <div class="distribution-fill" style="width: 34%"></div>
            </div>
          </div>
          <div class="distribution-item">
            <div class="distribution-label">Infrastructure (33%)</div>
            <div class="distribution-value">${uplanetDistribution.infra.toFixed(1)} Ẑ</div>
            <div class="distribution-bar">
              <div class="distribution-fill" style="width: 33%"></div>
            </div>
          </div>
          <div class="distribution-item">
            <div class="distribution-label">R&D (33%)</div>
            <div class="distribution-value">${uplanetDistribution.rd.toFixed(1)} Ẑ</div>
            <div class="distribution-bar">
              <div class="distribution-fill" style="width: 33%"></div>
            </div>
          </div>
        </div>
      </div>
      ` : ''}
    `;
  }

  // Add input event listeners for dynamic updates
  newNostrInput.addEventListener('input', updateSimulation);
  newZenInput.addEventListener('input', updateSimulation);

  // Initial simulation
  updateSimulation();

  // Ajouter les contrôles de nombre après la création des inputs
  function addNumberControls(input) {
    const controls = document.createElement('div');
    controls.className = 'number-controls';
    
    const plusButton = document.createElement('button');
    plusButton.className = 'number-control';
    plusButton.innerHTML = '+';
    plusButton.onclick = () => {
      const currentValue = parseInt(input.value) || 0;
      const max = parseInt(input.max);
      if (currentValue < max) {
        input.value = currentValue + 1;
        input.dispatchEvent(new Event('input'));
      }
    };

    const minusButton = document.createElement('button');
    minusButton.className = 'number-control';
    minusButton.innerHTML = '−';
    minusButton.onclick = () => {
      const currentValue = parseInt(input.value) || 0;
      if (currentValue > 0) {
        input.value = currentValue - 1;
        input.dispatchEvent(new Event('input'));
      }
    };

    controls.appendChild(plusButton);
    controls.appendChild(minusButton);
    input.parentNode.appendChild(controls);
  }

  addNumberControls(newNostrInput);
  addNumberControls(newZenInput);
}

// Load and display economic data
loadUPlanetData(uPlanetAPI_URL).then(data => {
  if (data) {
    createEconomicDashboard(data);
  }
});

// Update balances periodically
function updateBalances() {
  fetch(uPlanetAPI_URL)
    .then(response => response.json())
    .then(data => {
      const balanceElement = document.getElementById('uplanet-balance');
      if (balanceElement) {
        balanceElement.textContent = `${Number(data.BILAN || 0).toFixed(2)} Ẑ`;
      }
    })
    .catch(error => console.error('Error updating balances:', error));
}

// Update balances every 30 seconds
setInterval(updateBalances, 30000);

// Add new styles
const style = document.createElement('style');
style.textContent = `
  .metric-details {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
    padding-left: 10px;
  }

  .metric-details div {
    margin: 2px 0;
  }

  .positive {
    color: #2ecc71;
  }

  .negative {
    color: #e74c3c;
  }

  .simulation-note {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #3498db;
  }

  .simulation-note p {
    margin: 5px 0;
    color: #2c3e50;
  }

  .subscription-cta {
    text-align: center;
    margin-top: 20px;
    padding: 15px;
    background: #f1f9ff;
    border-radius: 8px;
  }

  .subscription-cta p {
    margin: 5px 0;
    color: #2c3e50;
  }

  .progress-container {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .thresholds {
    margin-top: 15px;
  }

  .threshold {
    margin: 10px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .threshold.active {
    background: #e8f4fc;
    border-left: 4px solid #3498db;
  }

  .threshold-label {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
  }

  .threshold-value {
    color: #3498db;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .threshold-progress {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
  }

  .threshold-bar {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2ecc71);
    transition: width 0.5s ease-in-out;
  }

  .simulation-note ul {
    margin: 5px 0;
    padding-left: 20px;
  }

  .simulation-note li {
    margin: 3px 0;
    color: #2c3e50;
  }

  .uplanet-distribution {
    background: #f8f9fa;
    border-left: 4px solid #2ecc71;
  }

  .distribution-bars {
    margin-top: 15px;
  }

  .distribution-item {
    margin: 10px 0;
  }

  .distribution-label {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
  }

  .distribution-value {
    color: #27ae60;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .distribution-bar {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
  }

  .distribution-fill {
    height: 100%;
    background: linear-gradient(90deg, #27ae60, #2ecc71);
    transition: width 0.5s ease-in-out;
  }

  .info-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
  }

  .table-header {
    background: #3498db;
    color: white;
    padding: 10px;
    font-weight: bold;
    text-align: center;
  }

  .table-label {
    background: #f8f9fa;
    padding: 8px;
    font-weight: bold;
    width: 30%;
    vertical-align: top;
    border-right: 1px solid #e0e0e0;
  }

  .info-table td {
    padding: 8px;
    border-bottom: 1px solid #e0e0e0;
  }

  .compact-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .compact-list li {
    margin: 2px 0;
    padding-left: 15px;
    position: relative;
  }

  .compact-list li:before {
    content: "•";
    position: absolute;
    left: 0;
    color: #3498db;
  }

  .benefit-card {
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
  }

  .subscribe-button {
    display: block;
    text-align: center;
    background: #3498db;
    color: white;
    text-decoration: none;
    padding: 12px;
    border-radius: 5px;
    transition: background 0.3s ease;
    margin-top: 10px;
    font-weight: bold;
  }

  .subscribe-button:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
`;
document.head.appendChild(style);
</script>

</body></html>
