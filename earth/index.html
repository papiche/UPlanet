<!DOCTYPE html>
<html>
<head>
<title>UPlanet - Public Goods For A Better Tomorrow - 0.01¬∞ x 0.01¬∞</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="description" content="UPlanet - Decentralized Internet Infrastructure and Social Network Protocol">
<meta name="keywords" content="UPlanet, decentralized, internet, social network, blockchain, ƒû1">
<meta name="author" content="UPlanet Team">
<meta name="robots" content="index, follow">
<link rel="icon" type="image/x-icon" href="favicon.ring.ico">
<link rel="preconnect" href="https://nominatim.openstreetmap.org">
<link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">
<link rel="stylesheet" href="jquery-ui.min.css">
<link rel="stylesheet" href="earth.css">
<link rel="stylesheet" href="optimized-styles.css">

<!-- Optimized script loading - jQuery first, then dependencies -->
<script type="text/javascript" src="requestanimationframe.polyfill.js"></script>
<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="jquery-ui.0.min.js"></script>
<script type="text/javascript" src="sphere-hacked.js"></script>
<script type="text/javascript" src="jquery.earth-3d.js"></script>
<script type="text/javascript" src="world.js"></script>
<script type="text/javascript" src="demo.js"></script>
<script src="astro.js"></script>


<script type="text/javascript">

// Optimized URL utilities with caching
const URL_CACHE = new Map();

function getCurrentUrlInfo() {
    const cacheKey = window.location.href;
    if (URL_CACHE.has(cacheKey)) {
        return URL_CACHE.get(cacheKey);
    }
    
    const currentURL = new URL(window.location.href);
    const info = {
        hostname: currentURL.hostname,
        port: currentURL.port,
        protocol: currentURL.protocol.split(":")[0],
        origin: currentURL.origin
    };
    
    URL_CACHE.set(cacheKey, info);
    return info;
}

function getStationUrl() {
    const urlInfo = getCurrentUrlInfo();
    let port = urlInfo.port;
    
    // Check and replace the port if it's 8080
    if (port === "8080") {
        port = "1234";
    }
    
    const zHost = urlInfo.hostname.replace("ipfs", "astroport");
    return `${urlInfo.protocol}://${zHost}${port ? `:${port}` : ""}`;
}

function getUSPOTUrl(route = '') {
    const urlInfo = getCurrentUrlInfo();
    let newUrl = new URL(urlInfo.origin);

    // Transformation de 'ipfs.domain.tld' en `u.domain.tld`
    if (urlInfo.hostname.startsWith('ipfs.')) {
        newUrl.hostname = urlInfo.hostname.replace('ipfs.', 'u.');
    }

    // Changer le port en 54321 si n√©cessaire
    if (urlInfo.port === '8080' || urlInfo.port !== '') {
        newUrl.port = '54321';
    }

    return newUrl.toString() + route;
}

var station = getStationUrl();
console.log('Station URL:', station);

var upassport = getUSPOTUrl('');
console.log('uSPOT URL:', upassport);

// Debug URL construction
console.log('Current location:', window.location.href);
console.log('URL info:', getCurrentUrlInfo());

function go2UPassport(route, target = '_parent') {
    // Reuse optimized URL generation
    const finalUrl = getUSPOTUrl(route);

    // Optimized target handling with early returns
    switch (target) {
        case '_blank':
            window.open(finalUrl, '_blank');
            return;
            
        case 'console':
            const consoleFrame = document.querySelector('#aframe');
            if (consoleFrame) {
                consoleFrame.src = finalUrl;
            } else {
                window.parent.location.href = finalUrl;
            }
            return;
            
        default:
            window.parent.location.href = finalUrl;
    }
}

// Initialize examples object if not defined
if (typeof examples === 'undefined') {
    window.examples = {};
}

examples['simple_mars'] = function() {
    $('#sphere').earth3d({
        texture: 'maps/sector0_miz.jpg', // texture used on sphere
        dragElement: $('#locations') // where do we catch the mouse drag
    });
};

// Optimized function with caching and error handling
const G1PUB_CACHE = new Map();
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

function generateColorFromHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const hue = Math.abs(hash % 360);
    return `hsl(${hue}, 70%, 50%)`;
}

function createDisplayElement() {
    const displayElement = document.createElement('div');
    displayElement.id = 'g1pub-display';
    Object.assign(displayElement.style, {
        fontSize: '24px',
        fontWeight: 'bold',
        textAlign: 'center',
        textShadow: '2px 2px 4px rgba(0,0,0,0.5)'
    });
    return displayElement;
}

function updateAsciiArt(color) {
    const asciiArt = document.getElementById('ascii-art');
    if (!asciiArt) return;
    
    // Create wrapper link if it doesn't exist
    if (!asciiArt.parentElement.matches('a')) {
        const link = document.createElement('a');
        link.href = 'https://coracle.copylaradio.com';
        link.target = '_blank';
        asciiArt.parentNode.insertBefore(link, asciiArt);
        link.appendChild(asciiArt);
    }
    
    Object.assign(asciiArt.style, {
        color: color,
        fontSize: '24px',
        fontWeight: 'bold',
        textShadow: '2px 2px 4px rgba(0,0,0,0.5)',
        opacity: '1'
    });
}

async function fetchAndDisplayUPLANETG1PUB() {
    const cacheKey = upassport;
    const cached = G1PUB_CACHE.get(cacheKey);
    
    // Return cached data if still valid
    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
        displayG1PUBData(cached.data);
        return;
    }
    
    try {
        console.log('Fetching from uSPOT URL:', upassport);
        
        const response = await fetch(upassport, {
            headers: { 
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            cache: 'default',
            mode: 'cors'
        });
        
        console.log('uSPOT Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('uSPOT Data received:', data);
        
        // Cache the result
        G1PUB_CACHE.set(cacheKey, {
            data: data,
            timestamp: Date.now()
        });
        
        displayG1PUBData(data);
        
    } catch (error) {
        console.error('Error fetching UPLANETG1PUB:', error);
        console.log('Falling back to default styling');
        
        // Fallback to default styling with ORIGIN
        const fallbackData = {
            UPLANETG1PUB: 'AwdjhpJN' // Default to ORIGIN
        };
        displayG1PUBData(fallbackData);
    }
}

function displayG1PUBData(data) {
    const g1pub = data.UPLANETG1PUB.substring(0, 8);
    const color = generateColorFromHash(data.UPLANETG1PUB);
    
    // Create or update display element
    let displayElement = document.getElementById('g1pub-display');
    if (!displayElement) {
        displayElement = createDisplayElement();
        document.getElementById('g1pub-container').appendChild(displayElement);
    }
    
    displayElement.textContent = g1pub === 'AwdjhpJN' ? 'ORIGIN' : `·∫êEN[${g1pub}]`;
    displayElement.style.color = color;
    
    updateAsciiArt(color);
}

// Safe initialization function
function initializeUPlanet() {
    console.log('Initializing UPlanet...');
    
    // Wait for jQuery to be available
    if (typeof $ === 'undefined') {
        console.log('jQuery not ready, retrying...');
        setTimeout(initializeUPlanet, 100);
        return;
    }
    
    // Initialize the earth3d when DOM is ready
    $(document).ready(function() {
        console.log('DOM ready, initializing earth3d...');
        
        // Wait a bit more for all scripts to load
        setTimeout(function() {
            // Check if sphere element exists
            const sphereElement = document.getElementById('sphere');
            if (!sphereElement) {
                console.error('Sphere element not found!');
                return;
            }
            
            // Initialize examples if needed
            if (typeof examples !== 'undefined' && examples['simple_mars']) {
                console.log('Initializing earth3d...');
                try {
                    examples['simple_mars']();
                    console.log('earth3d initialized successfully');
                } catch (error) {
                    console.error('Error initializing earth3d:', error);
                }
            } else {
                console.error('examples or simple_mars function not available');
            }
            
            // Fetch and display G1PUB data
            fetchAndDisplayUPLANETG1PUB();
        }, 500); // Wait 500ms for all scripts to load
    });
}

// Start initialization
initializeUPlanet();
</script>

<!-- CSS moved to optimized-styles.css for better performance -->
</head>

<body>
    <br>
    <h1>
        <button class="flyover-trigger" onclick="go2UPassport('g1', 'parent');" onmouseenter="showFlyover('g1-registration')" onmouseleave="hideFlyover()" title="Registration">‚ú®</button>
         _ UPlanet _ 
        <button onclick="go2UPassport('scan');" title="üõÇ MULTIPASS Scanner">üõÇ</button>
    </h1>

    <div id="ascii-art" title="Global Chat System - powered by Astroport.ONE ‚ô•Ô∏èBOX" style="opacity: 0; transition: opacity 0.5s ease;">¬Ø\_‡ººqOÕ°„Ä∞op‡ºΩ_/¬Ø</div>

    <div id="g1pub-container" style="width: 100%; text-align: center; margin: 10px 0; z-index: 100;"></div>

        <div id="countdown"></div>

    <div id="container">
    <br><br>
          <div id="sphere"></div>
          <div id="glow-shadows" class="earth"></div>
          <div id="flights"></div>
          <div id="locations"></div>

    </div>
    <button style="position: fixed; top: 5px; left: 5px; padding: 10px 15px; border-radius: 12px; font-size: 16px; min-width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;" class="flyover-trigger" onclick="toggleConsole(); closeFlyover();" onmouseenter="showFlyover('console-toggle')" onmouseleave="hideFlyover()" title="Toggle console">ÿ©_ÿ©</button>
    <button style="position: fixed; top: 5px; right: 5px; z-index: 1002; padding: 10px 15px; border-radius: 12px; font-size: 16px; min-width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;" class="flyover-trigger" onclick="go2UPassport('nostr')" onmouseenter="showFlyover('geo-message')" onmouseleave="hideFlyover()" title="üåêÔ∏è UPlanet Geo Message üåê">üí¨</button>
    <button style="position: fixed; top: 60px; right: 5px; z-index: 1002; padding: 10px 15px; border-radius: 12px; font-size: 16px; min-width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;" onclick="window.open('plantnet.html', '_blank')" title="üåø PlantNet Flora Explorer">üåø</button>
    <button style="position: fixed; top: 110px; right: 5px; z-index: 1002; padding: 10px 15px; border-radius: 12px; font-size: 16px; min-width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;" onclick="go2UPassport('youtube?html=1', '_blank')" title="üì∫ Nostr Tube">‚ñ∂Ô∏è</button>
    <button style="position: fixed; top: 160px; right: 5px; z-index: 1002; padding: 10px 15px; border-radius: 12px; font-size: 16px; min-width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;" onclick="go2UPassport('oracle?html=1', '_blank')" title="üîÆ Syst√®me de Permis">üîÆ</button>
    
    <form style="position: fixed; bottom: 10px; width: 100%; display: flex; justify-content: center;" id="addressForm">
    <div style="text-align: center;">
        <label for="address"></label>
        <h3><input type="text" id="address" size=26 required placeholder="O√π √™tes vous ? Where are you located...">
        <button type="button" title="FIND ME" onclick="getCoordinates()">‚åÇ ?</button>
        </h3>

        <h2>
            <a target="visio" href="/ipns/vdo.copylaradio.com/?room=UPLANET&effects&record">VISIO by "vdo.ninja"</a>
        </h2>
        <p id="result">
            <a target="entrance" href="entrance.html" title="CopyLaRadio = Web3 Internet Self Hosting ·∫êEN Cooperative"> CopyLaRadio </a>
            - <a target="code" href="https://github.com/papiche/Astroport.ONE" title="and build Astroport.ONE source code">[code (Astroport.ONE)]</a>
            - <a target="goodies" href="https://astroport.myspreadshop.fr/" title="You can get Tee Shirt & more"> goodies </a> 
            - <a target="sponsor" href="https://g1sms.fr" title="G1FabLab makes the Open Source code selections"> ƒû1FabLab </a>
            - <a href="mailto:support@qo-op.com" title="Contact Support">contact</a>
            </p>
    </div>
    </form>
    
<div id="console"> 
     <button class="flyover-trigger" onclick="document.getElementById('aframe').style.backgroundColor='#f0f0f0';go2UPassport('g1', 'parent');" onmouseenter="showFlyover('g1-registration')" onmouseleave="hideFlyover()" title="ƒû1 registration">‚ú®</button>
      _ <button class="flyover-trigger" onclick="document.getElementById('aframe').src='nostr_console.html';" onmouseenter="showFlyover('nostr-console')" onmouseleave="hideFlyover()" title="Nostr Relay Console">üì°</button>
      _ <button class="flyover-trigger" onclick="document.getElementById('aframe').src='economy.html';" onmouseenter="showFlyover('economic-level')" onmouseleave="hideFlyover()" title="‚ô•Ô∏èBOX Economic Level">‚ô•Ô∏è</button>
      _ <button class="flyover-trigger" onclick="document.getElementById('aframe').src='https://zen.g1sms.fr';" onmouseenter="showFlyover('zen-club')" onmouseleave="hideFlyover()" title="UPlanet ·∫êen[0]">‚òØÔ∏è</button>
      _ <button onclick="document.getElementById('aframe').src='https://pad.p2p.legal/s/UPlanet_Enter_Help';" title="Help">üõà</button>  
       <button onclick="toggleFullWindow()" title="Toggle fullscreen">‚õ∂</button>
       <button onclick="document.getElementById('console').style.visibility = 'hidden';" title="Close console">‚úñ</button>
    <iframe name="aframe" id="aframe" src="https://pad.p2p.legal/s/Astroport.ONE.FR" width="100%" height="100%"></iframe>
</div>

<!-- Flyover Modal -->
<div id="flyover-modal">
    <div id="flyover-content">
        <span id="flyover-close">&times;</span>
        <img id="flyover-image" src="/ipfs/QmUCShpeuJ1QXyjBTBKZtw9WJDKRULgptpNAoH3ihM2SzG/UPlanet_nav0_explain.png" alt="UPlanet Navigation Explanation" draggable="false">
    </div>
</div>

<!-- Bang App Modal -->
<div id="bang-app-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px); z-index: 99999; overflow: hidden;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9)); padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="/ipfs/QmagEQC8KJUsjuDXbcuWHxmA8vwRF9y9d6LGtc3iSEqZE2/uplanet.png" 
                     style="width: 24px; height: 24px; border-radius: 50%;" alt="UPlanet">
                <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">UPlanet ORIGIN - a ·∫êen experiment </h3>
            </div>
            <button onclick="closeBangApp()" 
                    style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='scale(1.1) rotate(90deg)';"
                    onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='none';"
                    title="Close Bang App">
                &times;
            </button>
        </div>
        
        <!-- Modal Content -->
        <div style="flex: 1; position: relative;">
            <iframe id="bang-app-iframe" 
                    src="" 
                    style="width: 100%; height: 100%; border: none; background: white;"
                    title="UPlanet ORIGIN to ·∫êen experiment">
            </iframe>
        </div>
    </div>
</div>

<script>
// Function to extract URL parameters
function getUrlParameter(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  const results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}
const defaultIPNS = '';
const defaultIPFS = '';
const defaultPUB = '';

const myIPFS = getUrlParameter('ipfs') || defaultIPFS;
const myPUBKEY = getUrlParameter('g1pub') || defaultPUB;
const sectorIPNS = getUrlParameter('ipns') || defaultIPNS;
console.log('myIPFS: /ipfs/', myIPFS);
console.log('myPUBKEY: /g1pub/', myPUBKEY);
console.log('sectorIPNS: /ipns/', sectorIPNS);

if (sectorIPNS !== '' ) {
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'button-container'
    buttonContainer.style.position = 'absolute';
    buttonContainer.style.bottom = '0px';
    buttonContainer.style.left = '0px';
    buttonContainer.style.width = '200px';
    buttonContainer.style.height = '150px';
    buttonContainer.style.zIndex = '1001';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.flexDirection = 'column';
    buttonContainer.style.alignItems = 'center';
    buttonContainer.style.justifyContent = 'center';

    const button = document.createElement('button');
    button.innerText = 'EXPLORE';
    button.className = 'button';

    // Add an event listener to the button
    button.addEventListener('click', function() {
        window.open( '/ipns/'+ sectorIPNS, "AstroTab");
    });

    // Append the button to the button container
    buttonContainer.appendChild(button);
    document.body.appendChild(buttonContainer);
}

// Optimized geolocation with caching and better error handling
const GEO_CACHE = new Map();
const GEO_CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

function getCoordinates() {
    const addressInput = document.getElementById('address');
    const address = addressInput.value.trim();

    if (address === '') {
        getLocation();
        return;
    }

    // Check cache first
    const cacheKey = address.toLowerCase();
    const cached = GEO_CACHE.get(cacheKey);
    if (cached && Date.now() - cached.timestamp < GEO_CACHE_DURATION) {
        navigateToCoordinates(cached.lat, cached.lon);
        return;
    }

    // Optimized API call with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    const formattedAddress = encodeURIComponent(address);
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${formattedAddress}&limit=1`, {
        signal: controller.signal,
        headers: {
            'User-Agent': 'UPlanet/1.0'
        }
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.length > 0) {
            const lat = parseFloat(data[0].lat) - 0.025;
            const lon = parseFloat(data[0].lon) - 0.025;
            
            // Cache the result
            GEO_CACHE.set(cacheKey, {
                lat: lat,
                lon: lon,
                timestamp: Date.now()
            });
            
            navigateToCoordinates(lat, lon);
        } else {
            showError('Coordinates not found. Click on surrounding dots to zoom in.');
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Geocoding error:', error);
        showError(error.name === 'AbortError' ? 'Request timeout. Please try again.' : 'An error occurred while fetching coordinates.');
    });
}

function navigateToCoordinates(lat, lon) {
    const latitude = lat.toFixed(2);
    const longitude = lon.toFixed(2);
    window.location.replace(`map_render.html?southWestLat=${latitude}&southWestLon=${longitude}&deg=0.1`);
}

function showError(message) {
    const resultElement = document.getElementById('result');
    if (resultElement) {
        resultElement.innerText = message;
    }
}

// Optimized event listener with debouncing
let addressInputDebounce;
document.getElementById('address').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        clearTimeout(addressInputDebounce);
        addressInputDebounce = setTimeout(getCoordinates, 100);
    }
});

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const latitude = (position.coords.latitude - 0.025).toFixed(1);
            const longitude = (position.coords.longitude - 0.025).toFixed(1);
            window.location.replace(`map_render.html?southWestLat=${latitude}&southWestLon=${longitude}&deg=0.1`);
        }, function(error) {
            console.error('Error getting geolocation:', error);
            document.getElementById('result').innerText = 'Geolocation not available. Enter an address to proceed.';
        });
    } else {
        document.getElementById('result').innerText = 'Geolocation is not supported by this browser. Enter an address to proceed.';
    }
}

function toggleFullWindow() {
    const console = document.getElementById('console');
    if (console.style.position !== 'fixed') {
        // Save original position and size
        console.dataset.originalPosition = console.style.position;
        console.dataset.originalTop = console.style.top;
        console.dataset.originalLeft = console.style.left;
        console.dataset.originalWidth = console.style.width;
        console.dataset.originalHeight = console.style.height;
        console.dataset.originalBottom = console.style.bottom;
        
        // Set to full window
        console.style.position = 'fixed';
        console.style.top = '0';
        console.style.left = '0';
        console.style.width = '100%';
        console.style.height = '100%';
        console.style.bottom = '0';
    } else {
        // Restore original position and size
        console.style.position = console.dataset.originalPosition || '';
        console.style.top = console.dataset.originalTop || '';
        console.style.left = console.dataset.originalLeft || '';
        console.style.width = console.dataset.originalWidth || '';
        console.style.height = console.dataset.originalHeight || '';
        console.style.bottom = console.dataset.originalBottom || '';
    }
}

// Flyover functionality
let flyoverTimeout;
let isZoomed = false;
let scale = 1;
let isDragging = false;
let startX, startY, translateX = 0, translateY = 0;
let currentFloatingButton = null;
let currentTriggerButton = null;

// Image mappings for different buttons
const flyoverImages = {
    'g1-registration': '/ipfs/QmXEE5Qv6gKX2EUEuz5TGB2HcgfXYrYjhv1cRGEMC3ASTN/UPlanet_g1new_nav.png',
    'nostr-console': '/ipfs/Qmei7n7VMunNwv3tUbhet1dbMWR8W34J4GUUmV6qzxWGr4/UPlanet_stream_nav.png',
    'economic-level': '/ipfs/QmXqT3gjTkccKBuEJGjJcAptCbpmjpc1GEDhshQcbZLcRg/UPlanet_eco_nav.png',
    'zen-club': '/ipfs/QmeUqKdaLAEvegJSfFn5hBf61B3TqiRShCegvmjr7EKxDc/UPlanet_clubzen_nav.png',
    'geo-message': '/ipfs/QmVZ4oxg8CG2qvNWNTJnWFNzBUBj6bqkUxzDSLjCLupQbD/UPlanet_geomessage_nav.png',
    'console-toggle': '/ipfs/QmUCShpeuJ1QXyjBTBKZtw9WJDKRULgptpNAoH3ihM2SzG/UPlanet_nav0_explain.png'
};

// Console toggle function
function toggleConsole() {
    const console = document.getElementById('console');
    console.style.visibility = (console.style.visibility === 'visible' ? 'hidden' : 'visible');
}

function createFloatingActionButton(triggerButton, imageKey) {
    // Remove existing floating button
    removeFloatingButton();
    
    // Clone the original button
    const floatingButton = triggerButton.cloneNode(true);
    floatingButton.classList.add('floating-action-button');
    floatingButton.classList.remove('flyover-trigger');
    
    // Remove flyover events from clone
    floatingButton.removeAttribute('onmouseenter');
    floatingButton.removeAttribute('onmouseleave');
    
    // Position the floating button over the image
    const modal = document.getElementById('flyover-modal');
    const image = document.getElementById('flyover-image');
    
    // Calculate position relative to the image
    setTimeout(() => {
        const imageRect = image.getBoundingClientRect();
        const modalRect = modal.getBoundingClientRect();
        
        // Responsive positioning based on screen size
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // Center bottom on mobile
            floatingButton.style.position = 'fixed';
            floatingButton.style.left = '50%';
            floatingButton.style.transform = 'translateX(-50%)';
            floatingButton.style.bottom = '80px';
            floatingButton.style.fontSize = '20px';
            floatingButton.style.padding = '12px 20px';
        } else {
            // Bottom-right corner of image on desktop
            floatingButton.style.position = 'fixed';
            floatingButton.style.left = (imageRect.right - 120) + 'px';
            floatingButton.style.top = (imageRect.bottom - 70) + 'px';
            floatingButton.style.transform = 'none';
        }
        
        floatingButton.style.zIndex = '10100';
        
        // Add glow effect based on image key
        const glowColors = {
            'g1-registration': 'rgba(241, 196, 15, 0.6)',
            'nostr-console': 'rgba(155, 89, 182, 0.6)', 
            'economic-level': 'rgba(231, 76, 60, 0.6)',
            'zen-club': 'rgba(52, 152, 219, 0.6)',
            'geo-message': 'rgba(46, 204, 113, 0.6)',
            'console-toggle': 'rgba(142, 68, 173, 0.6)'
        };
        
        // Enhanced gradients and colors
        const gradients = {
            'g1-registration': 'linear-gradient(135deg, #f1c40f, #f39c12)',
            'nostr-console': 'linear-gradient(135deg, #9b59b6, #8e44ad)', 
            'economic-level': 'linear-gradient(135deg, #e74c3c, #c0392b)',
            'zen-club': 'linear-gradient(135deg, #3498db, #2980b9)',
            'geo-message': 'linear-gradient(135deg, #2ecc71, #27ae60)',
            'console-toggle': 'linear-gradient(135deg, #8e44ad, #9b59b6)'
        };
        
        floatingButton.style.background = gradients[imageKey] || 'linear-gradient(135deg, #667eea, #764ba2)';
        floatingButton.style.boxShadow = `0 20px 40px ${glowColors[imageKey] || 'rgba(102, 126, 234, 0.6)'}`;
        
        // Enhanced animation sequence
        floatingButton.style.animation = 'floatIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), pulse 3s infinite 1.2s';
        
        // Add interactive hover effects
        floatingButton.addEventListener('mouseenter', () => {
            floatingButton.style.animation = 'pulse 0.8s infinite';
            if (isMobile) {
                floatingButton.style.transform = 'translateX(-50%) scale(1.05)';
            } else {
                floatingButton.style.transform = 'scale(1.05) translateY(-3px)';
            }
        });
        
        floatingButton.addEventListener('mouseleave', () => {
            floatingButton.style.animation = 'floatIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), pulse 3s infinite 1.2s';
            if (isMobile) {
                floatingButton.style.transform = 'translateX(-50%)';
            } else {
                floatingButton.style.transform = 'none';
            }
        });
        
        // Add click feedback animation
        floatingButton.addEventListener('click', () => {
            if (isMobile) {
                floatingButton.style.transform = 'translateX(-50%) scale(0.95)';
            } else {
                floatingButton.style.transform = 'scale(0.95)';
            }
            setTimeout(() => {
                if (isMobile) {
                    floatingButton.style.transform = 'translateX(-50%)';
                } else {
                    floatingButton.style.transform = 'none';
                }
            }, 150);
        });
        
    }, 150);
    
    // Add click handler that closes flyover after action
    const originalOnClick = floatingButton.getAttribute('onclick');
    floatingButton.setAttribute('onclick', `${originalOnClick}; setTimeout(closeFlyover, 300);`);
    
    // Add to modal
    modal.appendChild(floatingButton);
    currentFloatingButton = floatingButton;
    
    return floatingButton;
}

function removeFloatingButton() {
    if (currentFloatingButton) {
        currentFloatingButton.remove();
        currentFloatingButton = null;
    }
}

function showFlyover(imageKey = 'console-toggle') {
    clearTimeout(flyoverTimeout);
    
    // Store reference to trigger button
    currentTriggerButton = event.target;
    
    flyoverTimeout = setTimeout(() => {
        // Only show if console is not visible for console-toggle, or always for other buttons
        const console = document.getElementById('console');
        if (imageKey !== 'console-toggle' || console.style.visibility !== 'visible') {
            const modal = document.getElementById('flyover-modal');
            const image = document.getElementById('flyover-image');
            
            // Set the appropriate image
            image.src = flyoverImages[imageKey] || flyoverImages['console-toggle'];
            image.alt = `UPlanet ${imageKey} Navigation Explanation`;
            
            // Mark current trigger as active and hide conflicting buttons
            markActiveTrigger(currentTriggerButton);
            hideConflictingButtons();
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Create floating action button after modal is visible
            setTimeout(() => {
                createFloatingActionButton(currentTriggerButton, imageKey);
            }, 200);
        }
    }, 1000); // Add delay for more control
}

function markActiveTrigger(trigger) {
    // Remove previous active states
    document.querySelectorAll('.flyover-trigger-active').forEach(btn => {
        btn.classList.remove('flyover-trigger-active');
    });
    
    // Mark current trigger as active
    if (trigger) {
        trigger.classList.add('flyover-trigger-active');
    }
}

function hideConflictingButtons() {
    // Hide buttons that might interfere with flyover reading
    const interfering = document.querySelectorAll('h1 button, button[onclick*="nostr"], button[title*="Scanner"]');
    interfering.forEach(btn => {
        if (!btn.classList.contains('flyover-trigger-active')) {
            btn.classList.add('flyover-hidden');
            btn.dataset.hiddenForFlyover = 'true';
        }
    });
}

function showConflictingButtons() {
    // Restore hidden buttons
    const hidden = document.querySelectorAll('[data-hidden-for-flyover="true"]');
    hidden.forEach(btn => {
        btn.classList.remove('flyover-hidden');
        btn.removeAttribute('data-hidden-for-flyover');
    });
    
    // Remove all active trigger states
    document.querySelectorAll('.flyover-trigger-active').forEach(btn => {
        btn.classList.remove('flyover-trigger-active');
    });
}

function hideFlyover() {
    clearTimeout(flyoverTimeout);
    // Auto-hide after a short delay if not interacting with modal
    setTimeout(() => {
        const modal = document.getElementById('flyover-modal');
        if (modal.style.display === 'block' && !modal.matches(':hover')) {
            closeFlyover();
        }
    }, 300);
}

function closeFlyover() {
    clearTimeout(flyoverTimeout);
    removeFloatingButton(); // Remove floating button first
    showConflictingButtons(); // Restore hidden buttons
    document.getElementById('flyover-modal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
    resetImage();
    currentTriggerButton = null;
}

function resetImage() {
    const image = document.getElementById('flyover-image');
    image.classList.remove('zoomed');
    image.style.transform = 'scale(1) translate(0, 0)';
    scale = 1;
    translateX = 0;
    translateY = 0;
    isZoomed = false;
}

function toggleZoom(event) {
    const image = document.getElementById('flyover-image');
    
    if (!isZoomed) {
        // Zoom in
        scale = 2;
        image.classList.add('zoomed');
        
        // Calculate zoom position - center at 2/3 width and mid-height
        const rect = image.getBoundingClientRect();
        const x = rect.width * (2/3);  // Position at 2/3 of image width
        const y = rect.height / 2;     // Position at mid-height
        
        translateX = (rect.width / 2 - x) * (scale - 1);
        translateY = (rect.height / 2 - y) * (scale - 1);
        
        image.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
        isZoomed = true;
    } else {
        // Zoom out
        resetImage();
    }
}

// Mouse events for desktop
document.getElementById('flyover-image').addEventListener('click', toggleZoom);

document.getElementById('flyover-image').addEventListener('mousedown', function(e) {
    if (isZoomed) {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        e.preventDefault();
    }
});

document.addEventListener('mousemove', function(e) {
    if (isDragging && isZoomed) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        document.getElementById('flyover-image').style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
    }
});

document.addEventListener('mouseup', function(e) {
    if (isDragging) {
        isDragging = false;
        // Prevent any unwanted zoom reset
        e.preventDefault();
        e.stopPropagation();
    }
});

// Touch events for mobile
let lastTouchTime = 0;

document.getElementById('flyover-image').addEventListener('touchstart', function(e) {
    const currentTime = new Date().getTime();
    const timeDiff = currentTime - lastTouchTime;
    
    if (timeDiff < 300 && timeDiff > 0) {
        // Double tap detected
        toggleZoom(e);
        e.preventDefault();
    } else if (isZoomed && e.touches.length === 1) {
        // Single touch for dragging
        isDragging = true;
        startX = e.touches[0].clientX - translateX;
        startY = e.touches[0].clientY - translateY;
        e.preventDefault();
    }
    
    lastTouchTime = currentTime;
});

document.addEventListener('touchmove', function(e) {
    if (isDragging && isZoomed) {
        translateX = e.touches[0].clientX - startX;
        translateY = e.touches[0].clientY - startY;
        document.getElementById('flyover-image').style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
        e.preventDefault();
    }
});

document.addEventListener('touchend', function(e) {
    if (isDragging) {
        isDragging = false;
        // Prevent any unwanted zoom reset
        e.preventDefault();
        e.stopPropagation();
    }
});

// Pinch to zoom for mobile
let initialDistance = 0;
let initialScale = 1;

document.getElementById('flyover-image').addEventListener('touchstart', function(e) {
    if (e.touches.length === 2) {
        initialDistance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        initialScale = scale;
        e.preventDefault();
    }
});

document.addEventListener('touchmove', function(e) {
    if (e.touches.length === 2) {
        const currentDistance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        
        scale = Math.min(Math.max(0.5, initialScale * (currentDistance / initialDistance)), 4);
        
        if (scale > 1) {
            document.getElementById('flyover-image').classList.add('zoomed');
            isZoomed = true;
        } else {
            document.getElementById('flyover-image').classList.remove('zoomed');
            isZoomed = false;
        }
        
        document.getElementById('flyover-image').style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
        e.preventDefault();
    }
});

// Close modal events
document.getElementById('flyover-close').addEventListener('click', closeFlyover);
document.getElementById('flyover-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFlyover();
    }
});

// ESC key to close
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('flyover-modal').style.display === 'block') {
        closeFlyover();
    }
});

// Prevent context menu on long press
document.getElementById('flyover-image').addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
</script>

<!-- Software Recommendations Section -->
<div id="software-recommendations" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(20, 20, 40, 0.9)); backdrop-filter: blur(15px); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 15px 20px; z-index: 1050; transform: translateY(100%); transition: transform 0.4s ease;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 10px;">

        
        <!-- Guide Link -->
        <div style="text-align: center; margin-top: 15px;">
            <a href="https://pad.p2p.legal/s/UPlanet_Enter_Help" target="_blank" 
               style="color: #3498db; text-decoration: none; font-size: 11px; opacity: 0.8; transition: opacity 0.3s ease;"
               onmouseover="this.style.opacity='1';"
               onmouseout="this.style.opacity='0.8';">
                <h5>üìö UPlanet Guide & Documentation</h5>
            </a>
        </div>

        <!-- UPlanet App Section -->
        <div style="margin-bottom: 15px;">
            <br>
            <h5 style="color: #ffffff; margin: 0 0 8px 0; font-size: 14px; font-weight: 600; text-align: center;">üöÄ A brief Network History</h5>
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button onclick="openBangApp()" 
                   style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border: none; border-radius: 20px; font-size: 13px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); min-width: 160px; justify-content: center; cursor: pointer;"
                   onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.5)';"
                   onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';"
                   title="UPlanet ORIGIN - Une Exp√©rience ·∫êEN Interactive">
                    <img src="/ipfs/QmagEQC8KJUsjuDXbcuWHxmA8vwRF9y9d6LGtc3iSEqZE2/uplanet.png" 
                         style="width: 40px; height: 40px; border-radius: 10%;" alt="UPlanet">
                    <span>from Web0 to Web3</span>
                </button>
            </div>
        </div>

        <!-- Essential Tools Section -->
        <div style="text-align: center; margin-bottom: 20px;">
            <h4 style="color: #ffffff; margin: 0 0 5px 0; font-size: 18px; font-weight: bold;">üîß Essential Tools for UPlanet</h4>
            <p style="color: #a0a0a0; margin: 0; font-size: 12px; line-height: 1.4;">Sovereign digital identity ‚Ä¢ Decentralized communication ‚Ä¢ Cryptographic security</p>
        </div>
        
        <!-- Browser Section -->
        <div style="margin-bottom: 15px;">
            <h5 style="color: #ffffff; margin: 0 0 8px 0; font-size: 14px; font-weight: 600; text-align: center;">üåê Web3-Ready Browser</h5>
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <a href="https://www.firefox.com/" target="_blank" 
                   style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, #ff7139, #ff4500); color: white; text-decoration: none; border-radius: 20px; font-size: 13px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 113, 57, 0.3); min-width: 140px; justify-content: center;"
                   onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(255, 113, 57, 0.5)';"
                   onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 15px rgba(255, 113, 57, 0.3)';"
                   title="Open-source browser supporting decentralized web extensions">
                    ü¶ä <span>Firefox is the best!</span>
                </a>
            </div>
        </div>
        
        <!-- NOSTR Extension Section -->
        <div>
            <h5 style="color: #ffffff; margin: 0 0 8px 0; font-size: 14px; font-weight: 600; text-align: center;">üîê NOSTR Identity Extensions</h5>
            <p style="color: #a0a0a0; margin: 0 0 10px 0; font-size: 11px; text-align: center; line-height: 1.3;">Sign events without exposing your private keys ‚Ä¢ Essential for MULTIPASS authentication</p>
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <!-- Nostr Connect -->
                <a href="https://addons.mozilla.org/fr/firefox/addon/nostr-connect/" target="_blank"
                   style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; text-decoration: none; border-radius: 20px; font-size: 13px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); width: 130px; max-width: 130px; justify-content: center; white-space: nowrap; overflow: hidden;"
                   onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(155, 89, 182, 0.5)';"
                   onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 15px rgba(155, 89, 182, 0.3)';"
                   title="NOSTR signer by Reya - Secure key management for decentralized identity">
                    üì° <span>"NOSTR Connect"</span>
                </a>

            </div>
        </div>

        <div style="flex: 0; min-width: auto;">
            <button onclick="toggleRecommendations()" 
                    style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='scale(1.1)';"
                    onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='none';"
                    title="Hide recommendations">
                ‚úñ
            </button>
        </div>
    </div>
</div>

<!-- Toggle button for recommendations -->
<button id="show-recommendations-btn" onclick="toggleRecommendations()" 
        style="position: fixed; bottom: 10px; right: 20px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; z-index: 1051; box-shadow: 0 4px 20px rgba(52, 152, 219, 0.4); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;"
        onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 8px 30px rgba(52, 152, 219, 0.6)';"
        onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 20px rgba(52, 152, 219, 0.4)';"
        title="Show software recommendations">
    üîß
</button>

<script>
// Software recommendations toggle functionality
let recommendationsVisible = false;

function toggleRecommendations() {
    const panel = document.getElementById('software-recommendations');
    const toggleBtn = document.getElementById('show-recommendations-btn');
    
    if (recommendationsVisible) {
        // Hide panel
        panel.style.transform = 'translateY(100%)';
        toggleBtn.style.display = 'flex';
        recommendationsVisible = false;
    } else {
        // Show panel
        panel.style.transform = 'translateY(0)';
        toggleBtn.style.display = 'none';
        recommendationsVisible = true;
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            if (recommendationsVisible) {
                toggleRecommendations();
            }
        }, 10000);
    }
}

// Mobile responsiveness for recommendations
window.addEventListener('resize', function() {
    const panel = document.getElementById('software-recommendations');
    if (window.innerWidth <= 768) {
        panel.style.padding = '10px 15px';
    } else {
        panel.style.padding = '15px 20px';
    }
});

// Bang App modal functionality
function openBangApp() {
    const modal = document.getElementById('bang-app-modal');
    const iframe = document.getElementById('bang-app-iframe');
    
    // Set the iframe source
    iframe.src = 'bang.html';
    
    // Show the modal
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Add animation
    modal.style.animation = 'modalFadeIn 0.4s ease-out';
}

function closeBangApp() {
    const modal = document.getElementById('bang-app-modal');
    const iframe = document.getElementById('bang-app-iframe');
    
    // Hide the modal
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Clear iframe source to stop any ongoing processes
    iframe.src = '';
}

// Close Bang App modal with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const bangModal = document.getElementById('bang-app-modal');
        if (bangModal.style.display === 'block') {
            closeBangApp();
        }
    }
});

// Close Bang App modal by clicking outside
document.getElementById('bang-app-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBangApp();
    }
});
</script>

</body></html>