<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç UPlanet Inventory - Collect & Protect with ORE</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="fonts/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="leaflet.css"/>
    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="bootstrap.bundle.min.js"></script>
    
    <!-- Nostr integration -->
    <script src="nostr.bundle.js"></script>
    <!-- Common UPlanet JavaScript -->
    <script src="common.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="leaflet.js"></script>
    <!-- Astronomy Engine for precise lunar calculations -->
    <script src="astronomy.browser.min.js"></script>
    <!-- Lunar Calendar Functions -->
    <script src="lunar-calendar.js"></script>
    
    <style>
        :root {
            --bs-primary: #4ade80;
            --bs-success: #22c55e;
            --bs-warning: #fbbf24;
            --bs-dark: #0f172a;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #e8e8e8;
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(15, 23, 42, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(74, 222, 128, 0.3);
        }
        
        .navbar-brand {
            color: #4ade80 !important;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: #cbd5e1 !important;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #4ade80 !important;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 8px;
        }

        /* Mobile menu navigation links */
        @media (max-width: 991px) {
            .navbar-nav {
                border-bottom: 1px solid rgba(74, 222, 128, 0.3);
                padding-bottom: 1rem;
                margin-bottom: 1rem;
            }

            .navbar-nav .nav-item {
                margin: 0.25rem 0;
            }

            .navbar-nav .nav-link {
                padding: 0.75rem 1rem;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .navbar-nav .nav-link i {
                font-size: 1.1rem;
            }
        }
        
        .card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 15px;
            color: #e8e8e8;
        }
        
        .card-header {
            background: rgba(74, 222, 128, 0.1);
            border-bottom: 1px solid rgba(74, 222, 128, 0.3);
            color: #4ade80;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
        }
        
        .btn-outline-primary {
            border-color: #4ade80;
            color: #4ade80;
        }
        
        .btn-outline-primary:hover {
            background: #4ade80;
            border-color: #4ade80;
            color: #0f172a;
        }
        
        .progress {
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #fbbf24);
            border-radius: 15px;
        }
        
        .badge {
            font-size: 0.9rem;
            padding: 0.5em 0.75em;
        }
        
        .section-anchor {
            scroll-margin-top: 100px;
        }

        /* Bootstrap Tabs Styles */
        #mainTabs {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 15px 15px 0 0;
            padding: 0.5rem;
            margin-bottom: 0 !important;
        }

        #mainTabs .nav-link {
            color: #cbd5e1;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin: 0 0.25rem;
            transition: all 0.3s ease;
            font-weight: 500;
            background: transparent;
        }

        #mainTabs .nav-link:hover {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        #mainTabs .nav-link.active {
            color: #0f172a;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            font-weight: 600;
        }

        #mainTabs .nav-link i {
            font-size: 1.1rem;
            margin-right: 0.5rem;
        }

        /* Mobile optimizations for tabs */
        @media (max-width: 576px) {
            #mainTabs {
                padding: 0.25rem;
                border-radius: 10px 10px 0 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #mainTabs .nav-link {
                padding: 0.5rem 0.5rem;
                font-size: 0.8rem;
                margin: 0 0.05rem;
                white-space: nowrap;
            }

            #mainTabs .nav-link i {
                margin-right: 0.25rem;
                font-size: 0.9rem;
            }

            .navbar-brand {
                font-size: 1.1rem !important;
            }

            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .card {
                border-radius: 10px;
            }

            .card-body {
                padding: 1rem;
            }

            .tab-content {
                padding: 1rem;
                border-radius: 0 0 10px 10px;
            }

            .btn-group {
                flex-wrap: wrap;
            }

            .btn-group .btn {
                flex: 1 1 auto;
                min-width: 80px;
            }
        }

        /* Tab content styles */
        .tab-content {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0 0 15px 15px;
            padding: 1.5rem;
            min-height: 400px;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .container-fluid[style*="padding-top"] {
                padding-top: 80px !important;
            }

            .lunar-calendar-header {
                padding: 0.75rem !important;
            }

            .display-4 {
                font-size: 2rem;
            }

            .display-md-3 {
                font-size: 1.75rem;
            }

            .lead {
                font-size: 1rem;
            }

            .fs-5 {
                font-size: 0.95rem !important;
            }

            .fs-4 {
                font-size: 1.1rem !important;
            }

            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
                gap: 0.75rem !important;
            }
        }

        @media (max-width: 992px) {
            .row.g-4 > * {
                margin-bottom: 1rem;
            }
        }

        /* Text readability improvements */
        .card-body p,
        .card-body .small {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* Ensure text is not truncated on mobile */
        @media (max-width: 768px) {
            .card-body p,
            .card-body .small,
            .lead {
                word-break: break-word;
                overflow-wrap: break-word;
                white-space: normal;
            }

            .text-muted {
                color: #cbd5e1 !important;
            }

            /* Improve contrast for better readability */
            p, .small {
                color: #e8e8e8 !important;
            }

            p.text-muted,
            .small.text-muted {
                color: #cbd5e1 !important;
            }
        }

        /* Lunar Calendar Styles */
        .lunar-calendar-header {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 15px;
            padding: 1rem;
            transition: padding 0.3s ease;
        }
        
        /* Thinner header when collapsed */
        .lunar-calendar-header:has(#lunar-calendar-collapse:not(.show)) {
            padding: 0.5rem 1rem;
        }
        
        .lunar-calendar-header:has(#lunar-calendar-collapse.collapse:not(.show)) {
            padding: 0.5rem 1rem;
        }

        .lunar-status {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Lunar calendar toggle button */
        #lunar-calendar-toggle {
            transition: all 0.3s ease;
        }
        
        #lunar-calendar-toggle .bi-chevron-up {
            transition: transform 0.3s ease;
        }
        
        #lunar-calendar-toggle[aria-expanded="false"] .bi-chevron-up {
            transform: rotate(180deg);
        }

        .lunar-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lunar-status-indicator.montante {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.2));
            border: 1px solid rgba(74, 222, 128, 0.5);
            color: #4ade80;
        }

        .lunar-status-indicator.descendante {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #3b82f6;
        }

        .lunar-phase-display {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        @media (max-width: 576px) {
            .lunar-phase-display {
                flex-direction: column;
                padding: 0.5rem;
                text-align: center;
            }
            
            .lunar-phase-display span {
                margin-right: 0 !important;
                margin-bottom: 0.25rem;
            }
        }

        .lunar-timeline {
            position: relative;
            height: 60px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            margin: 10px 0;
            padding: 5px;
            overflow: hidden;
        }

        .lunar-timeline-bar {
            height: 100%;
            border-radius: 25px;
            position: relative;
            display: flex;
            transition: all 0.3s ease;
        }
        
        .lunar-period {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .lunar-period:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .lunar-period.montante {
            background: linear-gradient(to bottom, rgba(74, 222, 128, 0.3), rgba(74, 222, 128, 0.1));
        }

        .lunar-period.descendante {
            background: linear-gradient(to bottom, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.1));
        }

        .lunar-period.optimal {
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            border: 2px solid rgba(251, 191, 36, 0.8);
        }

        .lunar-period.today {
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        .lunar-day-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2px;
        }

        .lunar-action-icon {
            font-size: 1rem;
            margin-top: 2px;
        }

        .lunar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            color: #e8e8e8;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(74, 222, 128, 0.3);
            font-size: 0.85rem;
            white-space: nowrap;
            margin-bottom: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .lunar-period:hover .lunar-tooltip {
            opacity: 1;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .gallery-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .gallery-item:hover {
            transform: scale(1.05);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-icon {
                font-size: 2.5em;
            display: block;
            margin-bottom: 10px;
            }
            
            .stat-value {
                font-size: 2em;
            font-weight: bold;
            color: #4ade80;
            display: block;
        }
        
        /* Improved text colors for better readability */
        .stat-card .text-muted,
        .stat-card span.text-muted {
            color: #cbd5e1 !important; /* Light gray instead of muted */
            font-weight: 500;
        }
        
        .ore-progress-text {
            color: #e2e8f0 !important; /* Very light gray for better contrast */
            font-weight: 500;
        }
        
        .plant-observation-text {
            color: #e2e8f0 !important; /* Light text for overlays */
        }
        
        /* Gallery overlay text improvements */
        .gallery-item .overlay {
            color: #e2e8f0 !important;
        }
        
        .gallery-item .overlay .small {
            color: #f1f5f9 !important; /* Even lighter for small text */
        }
        
        /* Modal viewer styles */
        #profile-viewer-modal .modal-content,
        #message-viewer-modal .modal-content {
            min-height: 80vh;
        }
        
        #profile-viewer-modal iframe,
        #message-viewer-modal iframe {
            border-radius: 0 0 15px 15px;
        }
        
        #profile-viewer-modal .modal-body,
        #message-viewer-modal .modal-body {
            overflow: hidden;
            }
            
            .photo-upload {
            border: 2px dashed rgba(74, 222, 128, 0.5);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(74, 222, 128, 0.05);
        }
        
        .photo-upload:hover {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        #unified-map {
            border-radius: 12px;
        }
        
        /* User position marker styles */
        .user-position-marker {
            background: transparent !important;
            border: none !important;
        }
        
        /* Map control buttons */
        #map-get-location, #map-load-events {
            transition: all 0.2s ease;
        }
        
        #map-get-location:hover, #map-load-events:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
        }
        
        @media (max-width: 768px) {
            .navbar-collapse {
                background: rgba(15, 23, 42, 0.98);
            border-radius: 10px;
                padding: 10px;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bootstrap with Tabs -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-globe-europe-africa"></i> UPlanet Inventory</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto d-lg-none mb-3 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="scrollToSection('overview'); return false;">
                            <i class="bi bi-bar-chart"></i> Atlas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="scrollToSection('gallery'); return false;">
                            <i class="bi bi-images"></i> Inventaire
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="scrollToSection('share'); return false;">
                            <i class="bi bi-camera"></i> Contribuer
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="scrollToSection('calendar'); return false;">
                            <i class="bi bi-heart-pulse"></i> Autonomie
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="calendars.html">
                            <i class="bi bi-calendar-week"></i> Mes Calendriers
                        </a>
                    </li>
                </ul>
                <div id="nostr-header-actions" class="ms-auto d-flex align-items-center flex-column flex-lg-row">
                    <button class="btn btn-outline-primary me-0 me-lg-2 mb-2 mb-lg-0 w-100 w-lg-auto" id="nav-menu-connect" onclick="handleNostrLogin()">
                        <i class="bi bi-key"></i> <span class="d-none d-md-inline">Connexion</span>
                    </button>
                    <a class="btn btn-outline-success me-0 me-lg-2 w-100 w-lg-auto" id="nav-link-profile" href="#" onclick="openProfile(); return false;" style="display: none;">
                        <i class="bi bi-person"></i> <span class="d-none d-md-inline">Mon Profil</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid" style="padding-top: 80px;">
    <div class="container">
            
            <!-- Bootstrap Tabs Navigation - En haut, sous le header -->
            <ul class="nav nav-tabs nav-justified mb-4" id="mainTabs" role="tablist" style="border-bottom: 2px solid rgba(74, 222, 128, 0.3);">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-overview" data-bs-toggle="tab" data-bs-target="#section-overview" type="button" role="tab" aria-controls="section-overview" aria-selected="true">
                        <i class="bi bi-bar-chart"></i> <span class="d-none d-sm-inline">Atlas</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-gallery" data-bs-toggle="tab" data-bs-target="#section-gallery" type="button" role="tab" aria-controls="section-gallery" aria-selected="false">
                        <i class="bi bi-images"></i> <span class="d-none d-sm-inline">Inventaire</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-share" data-bs-toggle="tab" data-bs-target="#section-share" type="button" role="tab" aria-controls="section-share" aria-selected="false">
                        <i class="bi bi-camera"></i> <span class="d-none d-sm-inline">Contribuer</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-calendar" data-bs-toggle="tab" data-bs-target="#section-calendar" type="button" role="tab" aria-controls="section-calendar" aria-selected="false">
                        <i class="bi bi-heart-pulse"></i> <span class="d-none d-sm-inline">Autonomie</span>
                    </button>
                </li>
            </ul>
            
            <!-- Hero Header - Emotional Engagement -->
            <div class="text-center mb-4">
                <h1 class="display-4 display-md-3 fw-bold mb-3" style="background: linear-gradient(135deg, #4ade80, #fbbf24, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    üåç Prenez soin de votre territoire
                </h1>
                <p class="lead text-white fs-5 fs-md-4 mb-3">
                    Inventoriez ce qui vous tient √† c≈ìur ‚Ä¢ Proposez des am√©liorations ‚Ä¢ Participez √† la gestion collective
                </p>
                <div class="row justify-content-center mb-3">
                    <div class="col-12 col-md-8">
                        <div class="card" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(251, 191, 36, 0.2)); border: 2px solid rgba(74, 222, 128, 0.5);">
                            <div class="card-body py-3 py-md-4">
                                <p class="fs-6 fs-md-5 mb-2 mb-md-3" style="color: #e8e8e8;">
                                    <strong>Qu'est-ce qui m√©rite d'√™tre pr√©serv√© autour de vous ?</strong>
                                </p>
                                <p class="mb-3 mb-md-4 small" style="color: #cbd5e1;">
                                    Un arbre centenaire, un outil partag√©, un potager communautaire, un banc public, 
                                    une fontaine, un nichoir... <strong>Photographiez-le et partagez votre engagement !</strong>
                                </p>
                                <button class="btn btn-lg btn-primary px-4 px-md-5 py-2 py-md-3" id="hero-connect-btn" onclick="handleNostrLogin()">
                                    <i class="bi bi-key me-2"></i> <span class="d-none d-sm-inline">Connectez-vous pour commencer</span><span class="d-sm-none">Connexion</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
            <!-- Section: Overview - Gestion des Communs -->
            <section id="section-overview" class="tab-pane fade show active section-anchor mb-5" role="tabpanel" aria-labelledby="tab-overview">
                
                <!-- Call to Action - What do you care about? -->
                <div class="card mb-4" style="border: 2px solid #ec4899;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.3), rgba(139, 92, 246, 0.3));">
                        <h2 class="mb-0"><i class="bi bi-heart-fill text-danger"></i> De quoi souhaitez-vous prendre soin ?</h2>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="card h-100 text-center" style="background: rgba(34, 197, 94, 0.1); border-color: #22c55e;">
                                    <div class="card-body">
                                        <div class="display-4 mb-3">üå±</div>
                                        <h5 class="text-success">Nature & Biodiversit√©</h5>
                                        <p class="small mb-3" style="color: #cbd5e1;">Arbres, plantes, fleurs, haies, pollinisateurs, oiseaux, faune locale...</p>
                                        <span class="badge bg-success">PlantNet int√©gr√©</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 text-center" style="background: rgba(99, 102, 241, 0.1); border-color: #6366f1;">
                                    <div class="card-body">
                                        <div class="display-4 mb-3">üîß</div>
                                        <h5 style="color: #6366f1;">√âquipements & Outils</h5>
                                        <p class="small mb-3" style="color: #cbd5e1;">Outils partag√©s, mobilier urbain, panneaux, infrastructures, jeux d'enfants...</p>
                                        <span class="badge" style="background: #6366f1;">Maintenance IA</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 text-center" style="background: rgba(20, 184, 166, 0.1); border-color: #14b8a6;">
                                    <div class="card-body">
                                        <div class="display-4 mb-3">üè†</div>
                                        <h5 style="color: #14b8a6;">Lieux & Espaces</h5>
                                        <p class="small mb-3" style="color: #cbd5e1;">Jardins, places, chemins, b√¢timents, points d'eau, zones de rencontre...</p>
                                        <span class="badge" style="background: #14b8a6;">G√©olocalisation</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- How the system works -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-gear-wide-connected"></i> Comment fonctionne l'inventaire participatif ?</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #4ade80, #22c55e);">
                                        <i class="bi bi-camera-fill text-white fs-2"></i>
                                    </div>
                                    <h5 class="text-success">1. Photographiez</h5>
                                    <p class="small" style="color: #cbd5e1;">Prenez en photo ce que vous souhaitez pr√©server ou am√©liorer</p>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                                        <i class="bi bi-robot text-white fs-2"></i>
                                    </div>
                                    <h5 style="color: #6366f1;">2. L'IA identifie</h5>
                                    <p class="small" style="color: #cbd5e1;">Classification automatique et g√©n√©ration d'un contrat de maintenance</p>
                                    </div>
                                </div>
                                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                                        <i class="bi bi-hand-thumbs-up-fill text-white fs-2"></i>
                        </div>
                                    <h5 class="text-warning">3. La communaut√© vote</h5>
                                    <p class="small" style="color: #cbd5e1;">Les Likes cr√©ditent des ·∫êen et rendent visible dans le Journal N¬≤</p>
                    </div>
                </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #ec4899, #db2777);">
                                        <i class="bi bi-people-fill text-white fs-2"></i>
                                    </div>
                                    <h5 style="color: #ec4899;">4. Action collective</h5>
                                    <p class="small" style="color: #cbd5e1;">Coordination des gestionnaires et r√©alisation des am√©liorations</p>
                                </div>
                    </div>
                </div>
                            </div>
                        </div>

                <!-- Proposals and Voting Section -->
                <div class="card mb-4" style="border: 2px solid #fbbf24;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3));">
                        <h3 class="mb-0"><i class="bi bi-lightbulb-fill text-warning"></i> Proposez des am√©liorations</h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <p class="lead mb-3">
                                    <strong>Chaque √©l√©ment inventori√© peut avoir un plan d'am√©lioration !</strong>
                                </p>
                                <p class="mb-4" style="color: #e8e8e8; line-height: 1.7;">
                                    Quand vous photographiez un √©l√©ment, l'IA g√©n√®re automatiquement un <strong style="color: #4ade80;">contrat de maintenance</strong> 
                                    qui d√©crit les actions n√©cessaires pour le maintenir ou l'am√©liorer. Ce contrat est ensuite 
                                    soumis au vote de la communaut√© via le syst√®me de <strong style="color: #fbbf24;">Likes = ·∫êen</strong>.
                                </p>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge fs-6 py-2 px-3" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                                        üëç 1 Like = 1 ·∫êen cr√©dit√©
                                    </span>
                                    <span class="badge fs-6 py-2 px-3" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                                        üìä Visible dans le Journal N¬≤
                                    </span>
                                    <span class="badge fs-6 py-2 px-3" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                                        üèÜ R√©compense les gestionnaires
                                    </span>
                                </div>
                                    </div>
                            <div class="col-md-4 text-center">
                                <div class="p-4" style="background: rgba(251, 191, 36, 0.1); border-radius: 15px;">
                                    <div class="display-1 mb-2">üí∞</div>
                                    <h4 class="text-warning mb-1">Collecte de ·∫êen</h4>
                                    <p class="small mb-0" style="color: #cbd5e1;">
                                        Les ·∫êen collect√©s financent les am√©liorations propos√©es
                                    </p>
                                </div>
                            </div>
                                </div>
                            </div>
                </div>

                <!-- Map Section -->
                <div class="card mb-4" style="background: rgba(15, 23, 42, 0.6);">
                    <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(74, 222, 128, 0.15);">
                        <h3 class="mb-0"><i class="bi bi-map"></i> Carte de l'inventaire territorial</h3>
                        <button class="btn btn-outline-primary btn-sm" id="toggle-ore-map-btn" onclick="toggleOREMapView()">
                            <i class="bi bi-x-square"></i> Masquer
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert mb-3" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(74, 222, 128, 0.3);">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <strong><i class="bi bi-geo-alt-fill text-success"></i> √âl√©ments inventori√©s:</strong> 
                                    <span id="ore-umap-count" class="badge bg-success fs-6">0</span>
                                </div>
                                <button class="btn btn-sm btn-outline-success" onclick="loadMapEvents()">
                                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                                </button>
                            </div>
                        </div>

                        <!-- Inventory Type Filters -->
                        <div class="mb-3 p-3" style="background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                                <strong class="text-white"><i class="bi bi-filter"></i> Filtrer par type :</strong>
                                    </div>
                            <div class="btn-group flex-wrap" role="group" id="inventory-type-filters">
                                <button type="button" class="btn btn-sm btn-outline-light active" data-type="all" title="Tous les types">
                                    üîç Tous
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" data-type="plant" title="Plantes">
                                    üå± Nature
                                </button>
                                <button type="button" class="btn btn-sm" style="border-color: #f59e0b; color: #f59e0b;" data-type="insect" title="Insectes">
                                    üêõ Insectes
                                </button>
                                <button type="button" class="btn btn-sm" style="border-color: #ec4899; color: #ec4899;" data-type="animal" title="Animaux">
                                    ü¶ä Animaux
                                </button>
                                <button type="button" class="btn btn-sm" style="border-color: #8b5cf6; color: #8b5cf6;" data-type="person" title="Personnes">
                                    üë§ Personnes
                                </button>
                                <button type="button" class="btn btn-sm" style="border-color: #6366f1; color: #6366f1;" data-type="object" title="Objets">
                                    üîß √âquipements
                                </button>
                                <button type="button" class="btn btn-sm" style="border-color: #14b8a6; color: #14b8a6;" data-type="place" title="Lieux">
                                    üè† Lieux
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning" data-type="contract" title="Contrats">
                                    üìÑ Contrats
                                </button>
                                </div>
                            </div>
                        
                        <div id="ore-map-container" style="display: block;">
                            <!-- Unified map for events and position selection -->
                            <div id="unified-map" style="height: 500px; width: 100%; border-radius: 10px;"></div>
                            <div class="mt-2 mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-success" id="map-get-location" title="Centrer sur ma position">
                                        <i class="bi bi-crosshair"></i> Ma position
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" id="map-load-events" title="Recharger les √©v√©nements">
                                        <i class="bi bi-arrow-clockwise"></i> Actualiser
                                    </button>
                                    </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Cliquez sur un marqueur pour voir les d√©tails et voter
                                </small>
                                </div>
                            </div>
                                    </div>
                                </div>

                <!-- Quick Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-lg-3">
                        <div class="card text-center py-3" style="background: rgba(34, 197, 94, 0.1); border-color: #22c55e;">
                            <div class="display-5">üåø</div>
                            <span class="stat-value fs-3 fw-bold text-success" id="total-plants">0</span>
                            <span class="small text-muted">√âl√©ments naturels</span>
                            </div>
                                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card text-center py-3" style="background: rgba(99, 102, 241, 0.1); border-color: #6366f1;">
                            <div class="display-5">üîß</div>
                            <span class="stat-value fs-3 fw-bold" style="color: #6366f1;" id="total-umaps">0</span>
                            <span class="small text-muted">√âquipements</span>
                                </div>
                            </div>
                    <div class="col-6 col-lg-3">
                        <div class="card text-center py-3" style="background: rgba(251, 191, 36, 0.1); border-color: #fbbf24;">
                            <div class="display-5">üìÑ</div>
                            <span class="stat-value fs-3 fw-bold text-warning" id="total-badges">0</span>
                            <span class="small text-muted">Contrats actifs</span>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card text-center py-3" style="background: rgba(236, 72, 153, 0.1); border-color: #ec4899;">
                            <div class="display-5">üíé</div>
                            <span class="stat-value fs-3 fw-bold" style="color: #ec4899;" id="ore-potential">0</span>
                            <span class="small text-muted">·∫êen collect√©s</span>
                        </div>
                    </div>
                </div>

                <!-- Progress towards ORE activation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-trophy"></i> Progression vers l'activation ORE</h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <p class="mb-0">
                                    <span id="ore-progress-count" class="text-warning fw-bold fs-4">0</span> 
                                    <span class="text-white">/ 8</span> 
                                    <span style="color: #cbd5e1; font-weight: 500;">√©l√©ments inventori√©s pour activer le contrat ORE</span>
                                </p>
                    </div>
                            <div class="text-end">
                                <span class="display-6 fw-bold text-warning" id="ore-progress-percent">0</span><span class="text-warning">%</span>
        </div>
            </div>
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                                 id="ore-progress-bar" style="width: 0%; background: linear-gradient(90deg, #22c55e, #fbbf24);">
                                <span id="ore-progress-text" class="fw-bold">0 / 8</span>
                    </div>
            </div>
                        <div class="alert mb-0" id="ore-status-message" role="alert" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3);">
                            <i class="bi bi-camera"></i> <strong>Commencez !</strong> Photographiez un √©l√©ment de votre territoire pour cr√©er son contrat de maintenance.
                        </div>
            </div>
        </div>
        
        <!-- Oracle Badges (NIP-58) - will be shown dynamically if user is connected -->
        <div class="card mb-4" id="oracle-badges-section" style="display: none;">
            <div class="card-header">
                <h3 class="mb-0"><i class="bi bi-award-fill"></i> Badges Oracle NIP-58</h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle"></i> 
                    Badges de comp√©tences valid√©es par le syst√®me Oracle (Web of Trust)
                </p>
                <div id="oracle-badges-container" style="min-height: 100px;">
                    <div style="text-align: center; color: #94a3b8;">
                        <i class="bi bi-hourglass-split"></i> Chargement des badges Oracle...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Achievement Badges -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-award"></i> COLLECTION ACHIEVEMENTS</h3>
                </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-first">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üå±</div>
                                        <div class="fw-bold">First Step</div>
                                        <small class="text-muted">0/1</small>
                </div>
                </div>
                </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-explorer">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üîç</div>
                                        <div class="fw-bold">Explorer</div>
                                        <small class="text-muted">0/10</small>
                </div>
                </div>
                </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-botanist">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üå∫</div>
                                        <div class="fw-bold">Botanist</div>
                                        <small class="text-muted">0/50</small>
                </div>
            </div>
        </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-master">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üå≥</div>
                                        <div class="fw-bold">Master</div>
                                        <small class="text-muted">0/100</small>
            </div>
                        </div>
                    </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-pioneer">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üöÄ</div>
                                        <div class="fw-bold">Pioneer</div>
                                        <small class="text-muted">‚úì</small>
                    </div>
                </div>
                    </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-guardian">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üõ°Ô∏è</div>
                                        <div class="fw-bold">Guardian</div>
                                        <small class="text-muted">ORE</small>
                        </div>
                        </div>
                        </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-nomad">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üåç</div>
                                        <div class="fw-bold">Nomad</div>
                                        <small class="text-muted">0/5</small>
                        </div>
                    </div>
                </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-legend">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">‚≠ê</div>
                                        <div class="fw-bold">Legend</div>
                                        <small class="text-muted">TOP 1%</small>
            </div>
        </div>
            </div>
        </div>
                </div>
            </div>
            </section>

            <!-- Section: Map - ORE UMAPs (moved to Overview section above) -->
            <!-- This section is now embedded in the Overview section -->

            <!-- Section: Gallery - Inventaire -->
            <section id="section-gallery" class="tab-pane fade section-anchor mb-5" role="tabpanel" aria-labelledby="tab-gallery">
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));">
                        <h3 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Inventaire du territoire</h3>
                        <p class="mb-0 mt-2" style="font-size: 0.9em; opacity: 0.9;">Tous les √©l√©ments inventori√©s avec leurs contrats de maintenance ‚Ä¢ Votez avec üëç pour cr√©diter des ·∫êen</p>
                </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="text-success mb-1"><i class="bi bi-grid-3x3-gap"></i> <span id="gallery-title">√âl√©ments Inventori√©s</span></h5>
                                <p class="text-muted mb-0"><span id="gallery-count">0</span> √©l√©ment(s) r√©pertori√©(s)</p>
                </div>
                            <button class="btn btn-primary" onclick="scrollToSection('share')" id="gallery-add-btn">
                                <i class="bi bi-plus-circle"></i> Ajouter un √©l√©ment
                            </button>
                </div>
                        <div id="gallery-grid" class="gallery-grid">
                            <div id="gallery-empty" class="text-center py-5" style="grid-column: 1 / -1; display: none;">
                                <div class="fs-1 mb-3"><i class="bi bi-grid-3x3-gap"></i></div>
                                <p class="lead">Aucun √©l√©ment r√©pertori√© pour le moment.</p>
                                <p class="text-muted">Commencez par ajouter votre premier √©l√©ment √† l'inventaire !</p>
            </div>
                    </div>
                            </div>
                            </div>
            </section>

            <!-- Section: Share - Contribuer √† l'inventaire -->
            <section id="section-share" class="tab-pane fade section-anchor mb-5" role="tabpanel" aria-labelledby="tab-share">
                <div class="card" style="border: 2px solid #4ade80;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.2));">
                        <h3 class="mb-0"><i class="bi bi-plus-circle"></i> Contribuer √† l'inventaire</h3>
                        <p class="mb-0 mt-2" style="font-size: 0.9em; opacity: 0.9;">Photographiez un √©l√©ment de votre territoire et l'IA g√©n√©rera automatiquement son contrat de maintenance</p>
                        </div>
                    <div class="card-body">
                        <!-- Type selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="bi bi-tag"></i> Type d'√©l√©ment (optionnel - l'IA peut deviner)</label>
                            <div class="btn-group flex-wrap w-100" role="group" id="inventory-type-selector">
                                <input type="radio" class="btn-check" name="inventoryType" id="type-auto" value="inventory" checked>
                                <label class="btn btn-outline-light" for="type-auto">üîç Auto</label>
                                
                                <input type="radio" class="btn-check" name="inventoryType" id="type-plant" value="plant">
                                <label class="btn btn-outline-success" for="type-plant">üå± Plante</label>
                                
                                <input type="radio" class="btn-check" name="inventoryType" id="type-insect" value="insect">
                                <label class="btn" style="border-color: #f59e0b; color: #f59e0b;" for="type-insect">üêõ Insecte</label>
                                
                                <input type="radio" class="btn-check" name="inventoryType" id="type-animal" value="animal">
                                <label class="btn" style="border-color: #ec4899; color: #ec4899;" for="type-animal">ü¶ä Animal</label>
                                
                                <input type="radio" class="btn-check" name="inventoryType" id="type-object" value="object">
                                <label class="btn" style="border-color: #6366f1; color: #6366f1;" for="type-object">üîß Objet</label>
                                
                                <input type="radio" class="btn-check" name="inventoryType" id="type-place" value="place">
                                <label class="btn" style="border-color: #14b8a6; color: #14b8a6;" for="type-place">üè† Lieu</label>
                            </div>
                        </div>
                        
                        <div class="alert" id="nostr-message-section" style="display: none; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 1px solid rgba(251, 191, 36, 0.5);">
                            <h5 class="alert-heading"><i class="bi bi-key"></i> Rejoignez la communaut√© !</h5>
                            <p class="mb-2">Connectez-vous pour :</p>
                            <ul class="mb-3">
                                <li>üì∏ Inventorier des √©l√©ments de votre territoire</li>
                                <li>üìÑ Cr√©er des contrats de maintenance</li>
                                <li>üëç Voter et cr√©diter des ·∫êen</li>
                                <li>üèÜ Rejoindre la toile de confiance</li>
                            </ul>
                            <button class="btn btn-warning" id="nostrLoginBtn" onclick="handleNostrLogin()">
                                <i class="bi bi-key"></i> Se connecter avec Nostr
                            </button>
                        </div>

                        <div id="nostr-message-form" style="display: none;">
                            <div class="mb-3">
                                <div class="photo-upload" onclick="document.getElementById('photoInput').click()" style="border: 3px dashed rgba(74, 222, 128, 0.5); background: rgba(74, 222, 128, 0.05);">
                                    <div id="photoUploadText">
                                        <i class="bi bi-camera fs-1 text-success"></i><br>
                                        <span class="text-success fw-bold">Photographiez ce qui vous tient √† c≈ìur</span><br>
                                        <small class="text-muted">Cliquez ou glissez une image</small>
                                    </div>
                                    <img id="photoPreview" class="photo-preview" style="display: none;">
                                </div>
                                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoUpload(event)">
                                </div>
                            
                            <div class="mb-3">
                                <label for="messageText" class="form-label"><i class="bi bi-chat-text"></i> Pourquoi cet √©l√©ment est-il important pour vous ?</label>
                                <textarea class="form-control" id="messageText" rows="3" placeholder="Expliquez ce que vous aimeriez pr√©server ou am√©liorer... L'IA utilisera votre description pour enrichir le contrat de maintenance."></textarea>
                                </div>
                            
                            <button class="btn btn-primary btn-lg w-100" id="sendMessageBtn" onclick="sendGeolocatedMessage()" disabled style="background: linear-gradient(135deg, #4ade80, #22c55e);">
                                <i class="bi bi-send"></i> Cr√©er le contrat de maintenance
                            </button>
                            <p class="text-muted text-center mt-2 small" id="send-message-hint">
                                <i class="bi bi-info-circle"></i> Votre observation sera analys√©e par l'IA et un contrat sera publi√© sur votre profil
                            </p>
                            <style>
                                #sendMessageBtn:disabled {
                                    opacity: 0.5;
                                    cursor: not-allowed;
                                }
                            </style>
                            
                            <div class="mt-3">
                                <div id="locationInfo" class="alert alert-info" style="display: none;">
                                    <strong><i class="bi bi-geo-alt"></i> Position:</strong> <span id="locationText"></span>
                            </div>
                                <div id="plantnetResult" class="alert alert-success" style="display: none;">
                                    <strong><i class="bi bi-flower2"></i> PlantNet:</strong> <span id="plantnetText"></span>
                        </div>
                    </div>

                            <!-- Location Controls -->
                            <div class="accordion mt-3" id="locationAccordion">
                                <div class="accordion-item" style="background: rgba(255, 255, 255, 0.05); border-color: rgba(74, 222, 128, 0.3);">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#locationCollapse">
                                            <i class="bi bi-geo-alt"></i> Localisation
                                        </button>
                                    </h2>
                                    <div id="locationCollapse" class="accordion-collapse collapse" data-bs-parent="#locationAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-2 mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">Latitude</label>
                                                    <input type="number" class="form-control" id="lat-display" step="0.000001" min="-90" max="90" value="48.86" placeholder="Latitude">
                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Longitude</label>
                                                    <input type="number" class="form-control" id="lon-display" step="0.000001" min="-180" max="180" value="2.35" placeholder="Longitude">
            </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <div class="btn-group w-100">
                                                        <button type="button" class="btn btn-outline-primary" id="update-map">Y aller</button>
                                                        <button type="button" class="btn btn-outline-secondary" id="get-location">Ma position</button>
        </div>
            </div>
                </div>
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> <strong>Position de la carte</strong><br>
                                                <small>Utilisez la carte principale ci-dessus pour s√©lectionner et ajuster votre position. Les coordonn√©es seront automatiquement mises √† jour.</small>
                    </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
                </div>
            </section>

            <!-- Section: Calendar -->
            <section id="section-calendar" class="tab-pane fade section-anchor mb-5" role="tabpanel" aria-labelledby="tab-calendar">
                
                <!-- Introduction - Autonomie Alimentaire Collective -->
                <div class="card mb-4" style="border: 2px solid #22c55e; background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(74, 222, 128, 0.1));">
                    <div class="card-body">
                        <h3 class="mb-3" style="color: #4ade80;"><i class="bi bi-heart-pulse"></i> Autonomie Alimentaire Collective</h3>
                        <p class="lead mb-3" style="color: #e8e8e8;">
                            <strong>Objectif :</strong> Coordonner les efforts de la communaut√© UMAP pour assurer l'autonomie alimentaire collective, 
                            en partageant la gestion de toute la cha√Æne de transformation de valeur.
                        </p>
                        
                        <!-- Cha√Æne de valeur - Design am√©lior√© -->
                        <div class="d-flex flex-wrap justify-content-center align-items-stretch gap-2 mb-4">
                            <div class="text-center p-3 rounded flex-fill" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.25), rgba(74, 222, 128, 0.1)); border: 2px solid rgba(74, 222, 128, 0.5); min-width: 100px;">
                                <div class="fs-2 mb-1">üå±</div>
                                <div class="fw-bold" style="color: #4ade80;">Graine</div>
                                <div style="color: #cbd5e1; font-size: 0.85rem;">S√©lection & √©change</div>
                            </div>
                            <div class="d-flex align-items-center" style="color: #4ade80; font-size: 1.5rem;">‚Üí</div>
                            <div class="text-center p-3 rounded flex-fill" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.1)); border: 2px solid rgba(34, 197, 94, 0.5); min-width: 100px;">
                                <div class="fs-2 mb-1">üåø</div>
                                <div class="fw-bold" style="color: #22c55e;">Plantation</div>
                                <div style="color: #cbd5e1; font-size: 0.85rem;">Semis & repiquage</div>
                            </div>
                            <div class="d-flex align-items-center" style="color: #fbbf24; font-size: 1.5rem;">‚Üí</div>
                            <div class="text-center p-3 rounded flex-fill" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.25), rgba(251, 191, 36, 0.1)); border: 2px solid rgba(251, 191, 36, 0.5); min-width: 100px;">
                                <div class="fs-2 mb-1">üíß</div>
                                <div class="fw-bold" style="color: #fbbf24;">Entretien</div>
                                <div style="color: #cbd5e1; font-size: 0.85rem;">Arrosage & soins</div>
                            </div>
                            <div class="d-flex align-items-center" style="color: #ec4899; font-size: 1.5rem;">‚Üí</div>
                            <div class="text-center p-3 rounded flex-fill" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(236, 72, 153, 0.1)); border: 2px solid rgba(236, 72, 153, 0.5); min-width: 100px;">
                                <div class="fs-2 mb-1">üçÖ</div>
                                <div class="fw-bold" style="color: #ec4899;">R√©colte</div>
                                <div style="color: #cbd5e1; font-size: 0.85rem;">Cueillette optimale</div>
                            </div>
                            <div class="d-flex align-items-center" style="color: #a78bfa; font-size: 1.5rem;">‚Üí</div>
                            <div class="text-center p-3 rounded flex-fill" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(139, 92, 246, 0.1)); border: 2px solid rgba(139, 92, 246, 0.5); min-width: 100px;">
                                <div class="fs-2 mb-1">ü•´</div>
                                <div class="fw-bold" style="color: #a78bfa;">Conserve</div>
                                <div style="color: #cbd5e1; font-size: 0.85rem;">Stockage & partage</div>
                            </div>
                        </div>
                        
                        <div class="p-3 rounded mb-0" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(34, 197, 94, 0.1)); border: 2px solid rgba(74, 222, 128, 0.4);">
                            <div class="row align-items-center g-3">
                                <div class="col-lg-8">
                                    <h6 class="mb-2" style="color: #4ade80;"><i class="bi bi-people-fill"></i> Production partag√©e</h6>
                                    <p class="mb-0" style="color: #e2e8f0;">
                                        Chaque participant peut se sp√©cialiser sur une √©tape de la cha√Æne. 
                                        Le calendrier <strong style="color: #fbbf24;">synchronise les efforts</strong> pour que les r√©coltes des uns deviennent les semences des autres.
                                    </p>
                                </div>
                                <div class="col-lg-4 text-center">
                                    <div class="p-2 rounded" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                                        <div class="fs-5 fw-bold text-white">üë• 1 UMAP</div>
                                        <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">= 1 communaut√© = 1 potager collectif</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lunar Calendar Header -->
                <div class="lunar-calendar-header mb-4" id="lunar-calendar-header">
                    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                        <div class="lunar-status-indicator" id="lunar-status-indicator">
                            <i class="bi bi-moon-stars"></i>
                            <span id="lunar-status-text">Chargement...</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div id="lunar-phase-display" class="lunar-phase-display" style="display: none;">
                                <span id="lunar-phase-icon" style="font-size: 1.5rem; margin-right: 0.5rem;"></span>
                                <div>
                                    <div id="lunar-phase-name" style="font-weight: 600; font-size: 0.9rem;"></div>
                                    <div id="lunar-phase-illumination" style="font-size: 0.75rem; opacity: 0.8;"></div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-success" type="button" data-bs-toggle="collapse" data-bs-target="#lunar-calendar-collapse" aria-expanded="true" aria-controls="lunar-calendar-collapse" id="lunar-calendar-toggle">
                                <i class="bi bi-chevron-up"></i> Masquer
                            </button>
                        </div>
                    </div>
                    <div class="collapse show" id="lunar-calendar-collapse">
                        <div class="lunar-timeline" id="lunar-timeline">
                            <div class="lunar-timeline-bar" id="lunar-timeline-bar"></div>
                        </div>
                    </div>
                </div>

                <!-- Important distinction explanation -->
                <div class="alert alert-info mb-4">
                    <h5 class="alert-heading"><i class="bi bi-info-circle"></i> Calendrier Lunaire Biodynamique</h5>
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <strong>‚Üë‚Üì Montante / Descendante</strong><br>
                            <small>Cycle ~27 jours. Position dans le ciel. Influence la circulation de la s√®ve.</small>
                        </div>
                        <div class="col-md-4">
                            <strong>üåë‚Üíüåï Croissante / D√©croissante</strong><br>
                            <small>Cycle ~29.5 jours. Illumination visible. De nouvelle √† pleine lune et retour.</small>
                        </div>
                        <div class="col-md-4">
                            <strong>üå±üßÑüåºü´ê Jours Types</strong><br>
                            <small>Calcul√©s selon les constellations du zodiaque (biodynamie).</small>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-12">
                            <small><strong>‚ùå P√©riodes √† √©viter (calcul√©es automatiquement):</strong> N≈ìuds lunaires (~2√ó/mois), P√©rig√©e (lune proche), Apog√©e (lune √©loign√©e)</small>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-arrow-up-circle"></i> Lune Montante ‚Üë</h5>
                                <small class="opacity-75">La lune monte plus haut dans le ciel chaque jour</small>
                            </div>
                            <div class="card-body">
                <p><strong>La s√®ve monte</strong> dans les parties a√©riennes de la plante.</p>
                                <ul class="mb-0">
                                    <li><strong>Semis</strong> de graines</li>
                                    <li><strong>Greffes</strong></li>
                                    <li><strong>R√©colte</strong> des fruits, l√©gumes-fruits, fleurs</li>
                                    <li><strong>Travail du sol</strong> l√©ger</li>
                </ul>
            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-arrow-down-circle"></i> Lune Descendante ‚Üì</h5>
                                <small class="opacity-75">La lune descend plus bas dans le ciel chaque jour</small>
                            </div>
                            <div class="card-body">
                <p><strong>La s√®ve redescend</strong> vers les racines.</p>
                                <ul class="mb-0">
                                    <li><strong>Plantation</strong> et repiquage</li>
                                    <li><strong>Tailles</strong> et √©lagages</li>
                                    <li><strong>Bouturages</strong></li>
                                    <li><strong>Travail du sol</strong> profond, engrais</li>
                </ul>
            </div>
        </div>
                    </div>
                </div>
                
                <!-- Moon phases explanation -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">üåíüåìüåî Lune Croissante</h5>
                                <small class="opacity-75">De la nouvelle lune √† la pleine lune</small>
                            </div>
                            <div class="card-body">
                                <p>L'√©clairage de la lune <strong>augmente</strong>.</p>
                                <ul class="mb-0">
                                    <li>üåë Nouvelle Lune ‚Üí üåì Premier Quartier ‚Üí üåï Pleine Lune</li>
                                    <li>Favorable aux r√©coltes de parties a√©riennes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">üåñüåóüåò Lune D√©croissante</h5>
                                <small class="opacity-75">De la pleine lune √† la nouvelle lune</small>
                            </div>
                            <div class="card-body">
                                <p>L'√©clairage de la lune <strong>diminue</strong>.</p>
                                <ul class="mb-0">
                                    <li>üåï Pleine Lune ‚Üí üåó Dernier Quartier ‚Üí üåë Nouvelle Lune</li>
                                    <li>Favorable aux r√©coltes de racines et conservation</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Jours Types (biodynamie) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calendar2-week"></i> Jours Types (Biodynamie)</h5>
                        <small class="opacity-75">Bas√©s sur les constellations du zodiaque travers√©es par la lune</small>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6 col-md-3">
                                <div class="text-center p-3 rounded" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3);">
                                    <div class="fs-2">üå±</div>
                                    <strong>Jour Feuille</strong>
                                    <p class="small mb-0 mt-1">Salades, √©pinards, aromatiques, choux</p>
                                    <small class="text-muted">Cancer, Scorpion, Poissons</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="text-center p-3 rounded" style="background: rgba(139, 92, 42, 0.2); border: 1px solid rgba(139, 92, 42, 0.4);">
                                    <div class="fs-2">üßÑ</div>
                                    <strong>Jour Racine</strong>
                                    <p class="small mb-0 mt-1">Carottes, navets, pommes de terre, ail</p>
                                    <small class="text-muted">Taureau, Vierge, Capricorne</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="text-center p-3 rounded" style="background: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.3);">
                                    <div class="fs-2">üåº</div>
                                    <strong>Jour Fleur</strong>
                                    <p class="small mb-0 mt-1">Fleurs, artichauts, brocolis, choux-fleurs</p>
                                    <small class="text-muted">G√©meaux, Balance, Verseau</small>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="text-center p-3 rounded" style="background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.4);">
                                    <div class="fs-2">ü´ê</div>
                                    <strong>Jour Fruit</strong>
                                    <p class="small mb-0 mt-1">Tomates, courges, haricots, arbres fruitiers</p>
                                    <small class="text-muted">B√©lier, Lion, Sagittaire</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0">
                            <strong><i class="bi bi-exclamation-triangle"></i> P√©riodes √† √©viter (calcul√©es automatiquement):</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>N≈ìuds lunaires</strong> - Quand la lune croise l'√©cliptique (~2 fois/mois) - Marqu√©s ‚ùå sur la frise</li>
                                <li><strong>P√©rig√©e</strong> - Lune au plus proche de la Terre (influence trop forte)</li>
                                <li><strong>Apog√©e</strong> - Lune au plus loin de la Terre (influence trop faible)</li>
                            </ul>
                            <small class="text-muted mt-2 d-block"><i class="bi bi-calculator"></i> Toutes les donn√©es sont calcul√©es par des algorithmes astronomiques int√©gr√©s.</small>
                        </div>
                    </div>
                </div>
                <!-- Styles de Production Expliqu√©s -->
                <div class="card mb-4" style="border: 2px solid #fbbf24;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.2));">
                        <h4 class="mb-0"><i class="bi bi-gear-wide-connected"></i> Choisissez votre Style de Production</h4>
                    </div>
                    <div class="card-body">
                        <p class="mb-4" style="color: #e2e8f0; font-size: 1.05rem;">
                            <i class="bi bi-info-circle text-warning"></i> 
                            Le calendrier s'adapte √† votre contexte. Chaque style g√©n√®re des rappels sp√©cifiques pour les <strong style="color: #4ade80;">semis</strong>, 
                            <strong style="color: #fbbf24;">entretien</strong> et <strong style="color: #ec4899;">r√©coltes</strong>, synchronis√©s avec les cycles lunaires.
                        </p>
                        
                        <div class="row g-3">
                            <!-- UMAP Optimis√© - Le plus important -->
                            <div class="col-12">
                                <div class="card h-100" style="border: 2px solid #4ade80; background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(34, 197, 94, 0.1));">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start flex-wrap">
                                            <div class="fs-1 me-3 mb-2">üèôÔ∏è</div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-2" style="color: #4ade80;">UMAP Optimis√© <span class="badge bg-success ms-2">Recommand√©</span></h5>
                                                <p class="mb-3" style="color: #e2e8f0;"><strong style="color: #fff;">Objectif :</strong> Maximiser la diversit√© alimentaire sur une petite surface partag√©e (~1km¬≤)</p>
                                                <div class="row g-2">
                                                    <div class="col-md-4">
                                                        <div class="p-2 rounded" style="background: rgba(74, 222, 128, 0.15); border: 1px solid rgba(74, 222, 128, 0.3);">
                                                            <strong style="color: #4ade80;">üå± Cultures verticales</strong><br>
                                                            <span style="color: #cbd5e1; font-size: 0.9rem;">Tomates cerises en cage, haricots grimpants, courges paliss√©es</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="p-2 rounded" style="background: rgba(74, 222, 128, 0.15); border: 1px solid rgba(74, 222, 128, 0.3);">
                                                            <strong style="color: #4ade80;">ü•ó Associations b√©n√©fiques</strong><br>
                                                            <span style="color: #cbd5e1; font-size: 0.9rem;">Trois s≈ìurs (ma√Øs+haricot+courge), basilic+tomate, carotte+poireau</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="p-2 rounded" style="background: rgba(74, 222, 128, 0.15); border: 1px solid rgba(74, 222, 128, 0.3);">
                                                            <strong style="color: #4ade80;">üîÑ Rotations rapides</strong><br>
                                                            <span style="color: #cbd5e1; font-size: 0.9rem;">Radis 25j, laitue 45j, √©pinards 40j - plusieurs r√©coltes/saison</span>
                                                        </div>
                                                    </div>
                                                </div>
                        <div class="mt-3">
                                                    <span class="badge me-1" style="background: rgba(74, 222, 128, 0.3); color: #4ade80; border: 1px solid #4ade80;">Vari√©t√©s naines</span>
                                                    <span class="badge me-1" style="background: rgba(74, 222, 128, 0.3); color: #4ade80; border: 1px solid #4ade80;">Cultures √©tag√©es</span>
                                                    <span class="badge me-1" style="background: rgba(74, 222, 128, 0.3); color: #4ade80; border: 1px solid #4ade80;">Compost collectif</span>
                                                    <span class="badge" style="background: rgba(74, 222, 128, 0.3); color: #4ade80; border: 1px solid #4ade80;">Graines partag√©es</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Autres styles - Am√©lioration lisibilit√© -->
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.4);">
                                    <div class="card-body text-center py-4">
                                        <div class="fs-1 mb-2">üåø</div>
                                        <h6 class="fw-bold mb-2" style="color: #a78bfa;">Vari√©t√© Nutritionnelle</h6>
                                        <p class="mb-0" style="color: #e2e8f0; font-size: 0.9rem;">
                                            Couvrir tous les besoins : <strong style="color: #a78bfa;">prot√©ines</strong> (l√©gumineuses), 
                                            <strong style="color: #a78bfa;">vitamines</strong> (l√©gumes-feuilles), 
                                            <strong style="color: #a78bfa;">glucides</strong> (racines)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.4);">
                                    <div class="card-body text-center py-4">
                                        <div class="fs-1 mb-2">üè°</div>
                                        <h6 class="fw-bold mb-2" style="color: #fbbf24;">Autonomie Compl√®te</h6>
                                        <p class="mb-0" style="color: #e2e8f0; font-size: 0.9rem;">
                                            Produire <strong style="color: #fbbf24;">100%</strong> de sa nourriture : 
                                            grandes quantit√©s, stockage long terme, r√©serves pour l'ann√©e
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="background: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.4);">
                                    <div class="card-body text-center py-4">
                                        <div class="fs-1 mb-2">ü•´</div>
                                        <h6 class="fw-bold mb-2" style="color: #ec4899;">Conservation Longue Dur√©e</h6>
                                        <p class="mb-0" style="color: #e2e8f0; font-size: 0.9rem;">
                                            L√©gumes de garde : pommes de terre, courges, oignons. 
                                            <strong style="color: #ec4899;">St√©rilisation</strong>, s√©chage, lacto-fermentation
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.4);">
                                    <div class="card-body text-center py-4">
                                        <div class="fs-1 mb-2">üîÑ</div>
                                        <h6 class="fw-bold mb-2" style="color: #3b82f6;">Production Continue</h6>
                                        <p class="mb-0" style="color: #e2e8f0; font-size: 0.9rem;">
                                            R√©coltes <strong style="color: #3b82f6;">toute l'ann√©e</strong> : 
                                            semis √©chelonn√©s, cultures d'hiver, tunnel/serre, l√©gumes perp√©tuels
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Calendrier -->
                <div class="card" style="border: 2px solid #3b82f6;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(99, 102, 241, 0.2));">
                        <h3 class="mb-0" style="color: #93c5fd;"><i class="bi bi-calendar3"></i> Calendrier Lunaire <span id="current-year"></span></h3>
                    </div>
                    <div class="card-body">
                        <div id="calendar-table-container"></div>
                        <div class="mt-4 p-4 rounded" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.1)); border: 2px solid rgba(59, 130, 246, 0.4);">
                            <h5 class="mb-3" style="color: #93c5fd;"><i class="bi bi-download"></i> Exporter vers votre Calendrier</h5>
                            <p class="mb-3" style="color: #e2e8f0;">
                                T√©l√©chargez un fichier <code style="background: rgba(59, 130, 246, 0.3); padding: 2px 6px; border-radius: 4px;">.ics</code> contenant tous les rappels de semis, entretien et r√©coltes, 
                                synchronis√©s avec les cycles lunaires. Importez-le dans <strong style="color: #93c5fd;">Google Calendar</strong>, <strong style="color: #93c5fd;">Apple Calendar</strong>, <strong style="color: #93c5fd;">Outlook</strong>, etc.
                            </p>
                            <div class="row g-3 align-items-end">
                                <div class="col-sm-auto">
                                    <label for="lunar-year-select" class="form-label mb-1 fw-bold" style="color: #e2e8f0;">Ann√©e</label>
                                    <select class="form-select" id="lunar-year-select" style="width: 120px;">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <div class="col-sm-auto">
                                    <label for="lunar-style-select" class="form-label mb-1 fw-bold" style="color: #e2e8f0;">Style de production</label>
                                    <select class="form-select" id="lunar-style-select" style="min-width: 260px;">
                                        <option value="foret">üå≥ For√™t Jardin (recommand√©)</option>
                                        <option value="umap">üèôÔ∏è UMAP Optimis√©</option>
                                        <option value="variety">üåø Vari√©t√© Nutritionnelle</option>
                                        <option value="autonomy">üè° Autonomie Compl√®te</option>
                                        <option value="conservation">ü•´ Conservation Longue Dur√©e</option>
                                        <option value="continuous">üîÑ Production Continue</option>
                                    </select>
                                </div>
                                <div class="col-sm-auto">
                                    <button class="btn btn-lg" onclick="generateICalFile()" style="background: linear-gradient(135deg, #3b82f6, #6366f1); border: none; color: white;">
                                        <i class="bi bi-download"></i> .ics
                            </button>
                                </div>
                                <div class="col-sm-auto">
                                    <button class="btn btn-lg" onclick="publishCalendarWithUI()" style="background: linear-gradient(135deg, #8b5cf6, #a855f7); border: none; color: white;" title="Publier sur NOSTR (NIP-52)">
                                        <i class="bi bi-cloud-upload"></i> NOSTR
                                    </button>
                            </div>
                                <div class="col-sm-auto">
                                    <button class="btn btn-lg btn-outline-secondary" onclick="syncCalendarsFromNostr()" title="Synchroniser depuis NOSTR">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                </div>
                                <div class="col-sm-auto">
                                    <a href="calendars.html" class="btn btn-lg btn-outline-info" title="G√©rer mes calendriers">
                                        <i class="bi bi-calendar-week"></i> G√©rer
                                    </a>
                                </div>
                            </div>
                            
                            <!-- NOSTR Status -->
                            <div class="mt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div id="nostr-publish-status" class="small text-muted">
                                    <i class="bi bi-info-circle"></i> Connectez-vous pour publier votre calendrier sur NOSTR
                                </div>
                                <div id="nostr-sync-status" class="small text-muted"></div>
                            </div>
                            
                            <div class="mt-3" style="color: #cbd5e1; font-size: 0.95rem;">
                                <i class="bi bi-calendar-check" style="color: #3b82f6;"></i> Le calendrier inclut :
                                <strong style="color: #4ade80;">Semis optimaux</strong> selon la lune ‚Ä¢ 
                                <strong style="color: #fbbf24;">Rappels d'entretien</strong> hebdomadaires ‚Ä¢ 
                                <strong style="color: #ec4899;">Dates de r√©colte</strong> estim√©es ‚Ä¢ 
                                <strong style="color: #a78bfa;">Conseils nutritionnels</strong> saisonniers ‚Ä¢
                            </div>
                            
                            <!-- NOSTR Calendars List -->
                            <div id="nostr-calendars-list" class="mt-3"></div>
                            
                            <!-- Pr√©visualisation des conseils pour les 7 prochains jours -->
                            <div class="mt-4">
                                <h5 class="mb-3"><i class="bi bi-eye" style="color: #a78bfa;"></i> Pr√©visualisation des 7 prochains jours</h5>
                                <div id="preview-container" class="row g-2">
                                    <!-- G√©n√©r√© dynamiquement par JS -->
                                    <div class="col-12 text-center py-3">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Chargement des conseils...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- L√©gende des ic√¥nes -->
                    <div class="card mt-4" style="border: 1px solid rgba(167, 139, 250, 0.3); background: rgba(167, 139, 250, 0.05);">
                        <div class="card-body py-3">
                            <div class="row g-2 text-center">
                                <div class="col-auto">
                                    <span class="badge" style="background: rgba(74, 222, 128, 0.2); color: #4ade80;">üå± Semis</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">üçÉ R√©colte</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">üíß Arrosage</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge" style="background: rgba(236, 72, 153, 0.2); color: #ec4899;">‚úÇÔ∏è Taille</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;">üå≥ Plantation</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">‚ùå Repos</span>
                                </div>
                            </div>
                        </div> 
                    </div>
        </div>
        </div>
                </div>
            </section>
            </div>
            <!-- End Tab Content -->

        </div>
    </div>

    <script>
        // ========================================
        // TAB NAVIGATION SYSTEM (Bootstrap Tabs)
        // ========================================
        // Make function globally accessible
        window.scrollToSection = function(sectionName) {
            const tabButton = document.getElementById(`tab-${sectionName}`);
            if (tabButton) {
                // Close mobile menu if open
                const navbarCollapse = document.getElementById('navbarNav');
                if (navbarCollapse && navbarCollapse.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse) || new bootstrap.Collapse(navbarCollapse);
                    bsCollapse.hide();
                }
                
                // Use Bootstrap's tab API to switch tabs
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
                
                // Special handling for each section
                tabButton.addEventListener('shown.bs.tab', function onShown() {
                    // Remove listener after first trigger
                    tabButton.removeEventListener('shown.bs.tab', onShown);
                    
                    // Scroll to top of tab content
                setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
                
                // Special handling for overview section (contains map now)
                if (sectionName === 'overview') {
                    setTimeout(() => {
                        const mapContainer = document.getElementById('ore-map-container');
                        if (mapContainer && mapContainer.style.display !== 'none') {
                            if (!unifiedMap) {
                                initializeUnifiedMap();
                            } else {
                                // Refresh data if map already exists
                                loadMapEvents();
                            }
                        }
                    }, 500);
                } else if (sectionName === 'gallery') {
                    // Load gallery even if not connected
                    setTimeout(() => {
                        if (getUserPubkey()) {
                            loadUserStats();
                        } else {
                            loadPublicGallery();
                        }
                    }, 200);
                }
                }, { once: true });
            }
        };
        
        // Update active nav item (now for tabs)
        function updateActiveNavItem() {
            // This function is now handled by Bootstrap tabs automatically
            // But we keep it for compatibility with existing code
            const activeTab = document.querySelector('#mainTabs .nav-link.active');
            if (activeTab) {
                // Tab is already active, Bootstrap handles it
                return;
            }
        }
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(updateActiveNavItem, 100);
        });
        
        // ========================================
        // PLANTNET SPECIFIC VARIABLES
        // ========================================
        let currentLocation = null;
        let selectedPhoto = null;
        
        // Message navigation variables
        let fetchedMessages = [];
        let currentMessageIndex = 0;
        const MESSAGES_PER_PAGE = 20;

        // User stats
        let userStats = {
            plantsCount: 0,
            umapsCount: 0,
            badges: {
                first: false,
                explorer: false,
                botanist: false,
                master: false,
                pioneer: false,
                guardian: false,
                nomad: false,
                legend: false
            }
        };
        
        // NOSTR variables are declared in common.js
        // Use references without redeclaring to avoid "redeclaration" errors
        // These will be available after common.js loads
        const getNostrRelay = () => window.nostrRelay || null;
        const getIsNostrConnected = () => window.isNostrConnected !== undefined ? window.isNostrConnected : false;
        const getUserPubkey = () => window.userPubkey || null;
        
        // Helper functions to get/set these values
        const setNostrRelay = (value) => { window.nostrRelay = value; };
        const setIsNostrConnected = (value) => { window.isNostrConnected = value; };
        const setUserPubkey = (value) => { window.userPubkey = value; };
        
        // Map variables - unified map
        let unifiedMap = null;
        let mapMarkers = [];
        let userPositionMarker = null;
        let currentTypeFilter = 'all'; // Current inventory type filter
        let allInventoryData = null; // Store all data for filtering
        
        // Inventory types configuration
        const INVENTORY_TYPES = {
            plant: { icon: 'üå±', color: '#22c55e', name: 'Plante', radius: 10 },
            insect: { icon: 'üêõ', color: '#f59e0b', name: 'Insecte', radius: 9 },
            animal: { icon: 'ü¶ä', color: '#ec4899', name: 'Animal', radius: 9 },
            person: { icon: 'üë§', color: '#8b5cf6', name: 'Personne', radius: 9 },
            object: { icon: 'üîß', color: '#6366f1', name: 'Objet', radius: 9 },
            place: { icon: 'üè†', color: '#14b8a6', name: 'Lieu', radius: 9 },
            contract: { icon: 'üìÑ', color: '#fbbf24', name: 'Contrat', radius: 12 }
        };
        
        // ========================================
        // ORE PROGRESS FUNCTIONS
        // ========================================
        function calculateOREProgress(events) {
            if (!events || events.length === 0) {
                return { count: 0, percent: 0, umap: null };
            }
            
            const umapCounts = {};
            events.forEach(event => {
                const geoTag = event.tags?.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const umapKey = geoTag[1];
                    umapCounts[umapKey] = (umapCounts[umapKey] || 0) + 1;
                }
            });
            
            let maxCount = 0;
            let currentUmap = null;
            for (const [umap, count] of Object.entries(umapCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    currentUmap = umap;
                }
            }
            
            if (currentLocation) {
                const currentUmapKey = `${currentLocation.latitude.toFixed(2)},${currentLocation.longitude.toFixed(2)}`;
                if (umapCounts[currentUmapKey]) {
                    maxCount = umapCounts[currentUmapKey];
                    currentUmap = currentUmapKey;
                }
            }
            
            const percent = Math.min((maxCount / 8) * 100, 100);
            
            return {
                count: maxCount,
                percent: Math.round(percent),
                umap: currentUmap,
                allUmaps: umapCounts
            };
        }
        
        function updateOREProgress(progress) {
            const countEl = document.getElementById('ore-progress-count');
            const percentEl = document.getElementById('ore-progress-percent');
            const barEl = document.getElementById('ore-progress-bar');
            const textEl = document.getElementById('ore-progress-text');
            const statusEl = document.getElementById('ore-status-message');
            
            if (countEl) countEl.textContent = progress.count;
            if (percentEl) percentEl.textContent = progress.percent;
            if (barEl) barEl.style.width = `${progress.percent}%`;
            if (textEl) textEl.textContent = `${progress.count} / 8`;
            
            if (statusEl) {
                if (progress.count >= 8) {
                    statusEl.className = 'alert alert-success';
                    statusEl.innerHTML = '<i class="bi bi-check-circle"></i> <strong>Contrat ORE activ√© !</strong> Les primes sont maintenant effectives.';
                } else if (progress.count >= 5) {
                    statusEl.className = 'alert alert-warning';
                    statusEl.innerHTML = `<i class="bi bi-fire"></i> <strong>Presque l√† !</strong> Plus que ${8 - progress.count} plante(s) pour activer le contrat ORE.`;
                } else if (progress.count > 0) {
                    statusEl.className = 'alert alert-info';
                    statusEl.innerHTML = `üí™ <strong>Continuez !</strong> ${8 - progress.count} plante(s) restante(s) pour activer le contrat ORE.`;
                } else {
                    statusEl.className = 'alert alert-info';
                    statusEl.innerHTML = '<i class="bi bi-camera"></i> <strong>Commencez !</strong> Prenez une photo de plante pour participer au concours.';
                }
            }
        }
        
        // ========================================
        // USER STATS FUNCTIONS
        // ========================================
        async function loadUserStats() {
            const currentUserPubkey = getUserPubkey();
            if (!currentUserPubkey) {
                console.log('‚è≥ No user logged in yet, stats will load after connection');
                // Load public gallery even without connection
                await loadPublicGallery();
                return;
            }
            
            console.log('üåø Loading flora stats from NOSTR...');
            
            try {
                // Ensure relay is connected
                const currentRelay = getNostrRelay();
                if (!currentRelay) {
                    console.log('üîå Connecting to relay...');
                    await connectToRelay();
                }
                
                // Fetch confirmed identifications (bot responses with UPlanet + plantnet) for stats only
                const nostrStats = await fetchUserFloraStats(currentUserPubkey);
                
                // Fetch ONLY user's observations (BRO + plantnet) for gallery images
                const userObservations = await fetchUserObservations(currentUserPubkey);
                
                userStats.plantsCount = nostrStats.plantsCount;
                userStats.umapsCount = nostrStats.umapsCount;
                
                const badgeResults = calculateFloraBadges(nostrStats);
                userStats.badges = badgeResults.badges;
                
                console.log(`‚úÖ Loaded: ${userStats.plantsCount} plants, ${userStats.umapsCount} UMAPs`);
                
                // Extract images ONLY from user observations (BRO + plantnet), NOT from bot responses
                // Enhanced extraction with all Nostr tag metadata
                const observationImages = extractImagesWithMetadata(userObservations);
                
                // Sort by date (most recent first)
                observationImages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Calculate and update ORE progress
                if (nostrStats.events && nostrStats.events.length > 0) {
                    const oreProgress = calculateOREProgress(nostrStats.events);
                    updateOREProgress(oreProgress);
                } else {
                    updateOREProgress({ count: 0, percent: 0, umap: null });
                }
                
                updateStatsDisplay();
                updateBadges();
                
                // Show Oracle badges section for connected users
                const oracleBadgesSection = document.getElementById('oracle-badges-section');
                if (oracleBadgesSection) {
                    oracleBadgesSection.style.display = 'block';
                }
                
                // Load Oracle badges (NIP-58) if user is connected
                if (currentUserPubkey && typeof window.displayUserBadges === 'function') {
                    const userNpub = window.userNpub || (window.hexToNpub ? window.hexToNpub(currentUserPubkey) : null);
                    if (userNpub) {
                        window.displayUserBadges('oracle-badges-container', userNpub, {
                            size: 'medium',
                            showName: true,
                            showTooltip: true,
                            emptyMessage: 'Aucun badge Oracle pour le moment'
                        });
                    }
                }
                
                // Display ONLY observation images (BRO + plantnet), not bot responses
                displayPhotoGallery(observationImages);
                
                const galleryCountEl = document.getElementById('gallery-count');
                if (galleryCountEl) {
                    galleryCountEl.textContent = observationImages.length;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading flora stats:', error);
            }
        }
        
        // Load public gallery (works without connection)
        async function loadPublicGallery() {
            console.log('üåø Loading public gallery (observations BRO + plantnet + inventory)...');
            
            try {
                // Ensure relay connection (but don't require user to be logged in)
                let currentRelay = getNostrRelay();
                if (!currentRelay) {
                    console.log('üîå Connecting to relay for public gallery...');
                    // Use connectToRelay without requiring authentication
                    await connectToRelay();
                    currentRelay = getNostrRelay();
                }
                
                if (!currentRelay) {
                    console.warn('‚ö†Ô∏è Could not connect to relay for public gallery');
                    return;
                }
                
                // Fetch ALL public observations (plantnet + inventory) from anyone
                const plantObservations = await fetchPlantObservations(currentRelay);
                await new Promise(r => setTimeout(r, 100)); // Small delay between requests
                const inventoryObservations = await fetchInventoryObservations(currentRelay);
                
                // Combine and deduplicate by event ID
                const allObservations = [...plantObservations];
                const seenIds = new Set(plantObservations.map(e => e.id));
                inventoryObservations.forEach(obs => {
                    if (!seenIds.has(obs.id)) {
                        allObservations.push(obs);
                        seenIds.add(obs.id);
                    }
                });
                
                console.log(`‚úÖ Found ${allObservations.length} public observations (${plantObservations.length} plants, ${inventoryObservations.length} inventory)`);
                
                // Extract images with metadata
                const observationImages = extractImagesWithMetadata(allObservations);
                
                // Sort by date (most recent first)
                observationImages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Limit to most recent 50 for performance
                const limitedImages = observationImages.slice(0, 50);
                
                // Display gallery
                displayPhotoGallery(limitedImages);
                
                const galleryCountEl = document.getElementById('gallery-count');
                if (galleryCountEl) {
                    galleryCountEl.textContent = limitedImages.length;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading public gallery:', error);
            }
        }
        
        // Fetch inventory observations (kind 1 with tags BRO and inventory)
        async function fetchInventoryObservations(relay) {
            if (!relay) {
                console.warn('‚ö†Ô∏è No relay provided to fetchInventoryObservations');
                return [];
            }
            
            const filter = {
                kinds: [1],
                '#t': ['BRO', 'inventory'],
                limit: 500,
                since: Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60) // Last 90 days
            };
            
            // Use SubscriptionQueue if available
            if (window.SubscriptionQueue) {
                const allEvents = await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
                // Filter events that have both BRO and inventory tags with geo or image
                return allEvents.filter(event => {
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    const hasGeo = event.tags.find(t => t[0] === 'g');
                    const hasImage = event.tags.find(t => t[0] === 'imeta' || t[0] === 'image') || 
                                    event.content.match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i);
                    return tags.includes('BRO') && tags.includes('inventory') && (hasGeo || hasImage);
                });
            }
            
            // Fallback to direct subscription
            return new Promise((resolve) => {
                const observations = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => {
                    try { sub.unsub(); } catch(e) {}
                    resolve(observations);
                }, 8000);
                
                sub.on('event', (event) => {
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    if (tags.includes('BRO') && tags.includes('inventory')) {
                        const hasGeo = event.tags.find(t => t[0] === 'g');
                        const hasImage = event.tags.find(t => t[0] === 'imeta' || t[0] === 'image') || 
                                        event.content.match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i);
                        if (hasGeo || hasImage) {
                            observations.push(event);
                        }
                    }
                });
                
                sub.on('eose', () => {
                    clearTimeout(timeout);
                    try { sub.unsub(); } catch(e) {}
                    resolve(observations);
                });
            });
        }
        
        // Fetch user's observations (kind 1 with tags BRO and plantnet OR inventory)
        async function fetchUserObservations(pubkey) {
            const currentRelay = getNostrRelay();
            if (!currentRelay) {
                console.warn('‚ö†Ô∏è No relay available for fetching user observations');
                return [];
            }
            
            // Fetch plantnet observations
            const plantnetFilter = {
                kinds: [1],
                authors: [pubkey],
                '#t': ['BRO', 'plantnet'],
                limit: 200,
                since: Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60) // Last year
            };
            
            // Fetch inventory observations
            const inventoryFilter = {
                kinds: [1],
                authors: [pubkey],
                '#t': ['BRO', 'inventory'],
                limit: 200,
                since: Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60) // Last year
            };
            
            const allObservations = [];
            const seenIds = new Set();
            
            // Helper to add observations without duplicates
            const addObservation = (event, requiredTags) => {
                if (seenIds.has(event.id)) return;
                const tags = event.tags.map(t => t[1]).filter(Boolean);
                if (requiredTags.every(t => tags.includes(t))) {
                    allObservations.push(event);
                    seenIds.add(event.id);
                }
            };
            
            // Use SubscriptionQueue if available
            if (window.SubscriptionQueue) {
                const plantnetEvents = await window.SubscriptionQueue.createSubscription(currentRelay, [plantnetFilter], { timeout: 10000 });
                plantnetEvents.forEach(e => addObservation(e, ['BRO', 'plantnet']));
                
                await new Promise(r => setTimeout(r, 100)); // Small delay
                
                const inventoryEvents = await window.SubscriptionQueue.createSubscription(currentRelay, [inventoryFilter], { timeout: 10000 });
                inventoryEvents.forEach(e => addObservation(e, ['BRO', 'inventory']));
                
                return allObservations;
            }
            
            // Fallback: sequential subscriptions
            return new Promise((resolve) => {
                const sub1 = currentRelay.sub([plantnetFilter]);
                const timeout1 = setTimeout(() => {
                    try { sub1.unsub(); } catch(e) {}
                    fetchInventoryObs();
                }, 10000);
                
                sub1.on('event', (event) => addObservation(event, ['BRO', 'plantnet']));
                sub1.on('eose', () => {
                    clearTimeout(timeout1);
                    try { sub1.unsub(); } catch(e) {}
                    fetchInventoryObs();
                });
                
                function fetchInventoryObs() {
                    const sub2 = currentRelay.sub([inventoryFilter]);
                    const timeout2 = setTimeout(() => {
                        try { sub2.unsub(); } catch(e) {}
                        resolve(allObservations);
                    }, 10000);
                    
                    sub2.on('event', (event) => addObservation(event, ['BRO', 'inventory']));
                    sub2.on('eose', () => {
                        clearTimeout(timeout2);
                        try { sub2.unsub(); } catch(e) {}
                        resolve(allObservations);
                    });
                }
            });
        }
        
        function updateStatsDisplay() {
            const totalPlants = document.getElementById('total-plants');
            const totalUmaps = document.getElementById('total-umaps');
            const totalBadges = document.getElementById('total-badges');
            const orePotential = document.getElementById('ore-potential');
            
            if (totalPlants) totalPlants.textContent = userStats.plantsCount;
            if (totalUmaps) totalUmaps.textContent = userStats.umapsCount;
            
            const unlockedBadges = Object.values(userStats.badges).filter(b => b).length;
            if (totalBadges) totalBadges.textContent = `${unlockedBadges}/8`;
            
            const oreScore = calculateORERewards({
                plantsCount: userStats.plantsCount,
                species: Math.floor(userStats.plantsCount / 3),
                observers: 1,
                complianceScore: 0.7
            });
            if (orePotential) orePotential.textContent = oreScore;
        }
        
        function updateBadges() {
            Object.keys(userStats.badges).forEach(badgeName => {
                const badgeElement = document.getElementById(`badge-${badgeName}`);
                if (!badgeElement) return;
                
                if (userStats.badges[badgeName]) {
                        badgeElement.classList.remove('locked');
                        badgeElement.classList.add('unlocked');
                    badgeElement.style.borderColor = '#4ade80';
                    badgeElement.style.background = 'rgba(74, 222, 128, 0.1)';
                } else {
                    badgeElement.classList.remove('unlocked');
                    badgeElement.classList.add('locked');
                    badgeElement.style.opacity = '0.5';
                }
            });
        }
        
        // Enhanced image extraction with full Nostr tag metadata
        function extractImagesWithMetadata(messages) {
            const images = [];
            
            messages.forEach(msg => {
                let imageUrl = null;
                let imageMetadata = {};
                let location = null;
                let plantInfo = null;
                
                // 1. Check NIP-94 imeta tags (most reliable)
                // Format can be: ["imeta", "url https://...", "m image/jpeg", "dim 1920x1080"]
                // Or: ["imeta", "url", "https://...", "m", "image/jpeg", "dim", "1920x1080"]
                const imetaTag = msg.tags.find(tag => tag[0] === 'imeta');
                if (imetaTag) {
                    // Handle array format where each value is a separate element
                    if (imetaTag.length > 1) {
                        for (let i = 1; i < imetaTag.length; i++) {
                            const item = imetaTag[i];
                            
                            if (typeof item === 'string') {
                                // Check if it's a key-value pair in one string: "url https://..."
                                if (item.includes(' ') && item.length > 4) {
                                    const [key, ...valueParts] = item.split(' ');
                                    const value = valueParts.join(' ');
                                    
                                    if (key === 'url' && !imageUrl) {
                                        imageUrl = value;
                                    } else if (key === 'm') {
                                        imageMetadata.mimeType = value;
                                    } else if (key === 'dim') {
                                        imageMetadata.dimensions = value;
                                    } else if (key === 'x') {
                                        imageMetadata.hash = value;
                                    } else if (key === 'alt') {
                                        imageMetadata.alt = value;
                                    }
                                }
                                // Or check if current item is a key and next is value
                                else if (i + 1 < imetaTag.length) {
                                    const nextItem = imetaTag[i + 1];
                                    if (typeof nextItem === 'string') {
                                        if (item === 'url' && !imageUrl) {
                                            imageUrl = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'm') {
                                            imageMetadata.mimeType = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'dim') {
                                            imageMetadata.dimensions = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'x') {
                                            imageMetadata.hash = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'alt') {
                                            imageMetadata.alt = nextItem;
                                            i++; // Skip next item
                                        }
                                    }
                                }
                                // Or check if it looks like a URL
                                else if (!imageUrl && item.startsWith('http')) {
                                    imageUrl = item;
                                }
                            }
                        }
                    }
                }
                
                // 2. Check standard image tags (fallback)
                if (!imageUrl) {
                    const imageTag = msg.tags.find(tag => tag[0] === 'image');
                    if (imageTag && imageTag[1]) {
                        imageUrl = imageTag[1];
                    }
                }
                
                // 3. Extract from content (last resort)
                if (!imageUrl) {
                    const contentUrlMatch = msg.content.match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i);
                    if (contentUrlMatch) {
                        imageUrl = contentUrlMatch[0];
                    }
                }
                
                // Extract geolocation tag if present
                const geoTag = msg.tags.find(tag => tag[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(coord => parseFloat(coord));
                    if (!isNaN(lat) && !isNaN(lon)) {
                        location = { lat, lon, umap: `${lat.toFixed(2)},${lon.toFixed(2)}` };
                    }
                }
                
                // Extract plant information from content if available
                const content = msg.content || '';
                const plantMatch = content.match(/üå±|PlantNet|scientific[_\s]name|common[_\s]name/i);
                if (plantMatch) {
                    // Try to extract scientific name
                    const scientificMatch = content.match(/[Ss]cientific[_\s]name[:\s]+([A-Z][a-z]+\s+[a-z]+)/);
                    // Try to extract common name
                    const commonMatch = content.match(/[Cc]ommon[_\s]name[:\s]+([^\n]+)/);
                    
                    plantInfo = {
                        scientificName: scientificMatch ? scientificMatch[1] : null,
                        commonName: commonMatch ? commonMatch[1].trim() : null
                    };
                }
                
                // Add to images array if URL found
                if (imageUrl) {
                    images.push({
                        url: imageUrl,
                        eventId: msg.id,
                        date: new Date(msg.created_at * 1000),
                        timestamp: msg.created_at,
                        location: location,
                        content: content.substring(0, 200),
                        metadata: imageMetadata,
                        plantInfo: plantInfo,
                        pubkey: msg.pubkey,
                        createdAt: msg.created_at
                    });
                }
            });
            
            return images;
        }
        
        function displayPhotoGallery(images) {
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryEmpty = document.getElementById('gallery-empty');
            
            if (!images || images.length === 0) {
                if (galleryGrid) galleryGrid.innerHTML = '';
                if (galleryEmpty) galleryEmpty.style.display = 'block';
                return;
            }
            
            if (galleryEmpty) galleryEmpty.style.display = 'none';
            if (galleryGrid) galleryGrid.innerHTML = '';
            
            // Detect if touch device
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item position-relative';
                item.style.cssText = 'cursor: pointer; overflow: hidden; border-radius: 12px;';
                
                // Create image element
                            const img = document.createElement('img');
                img.src = image.url;
                img.alt = image.metadata?.alt || image.plantInfo?.commonName || `Plant observation ${index + 1}`;
                img.loading = 'lazy';
                img.style.cssText = 'width: 100%; height: 200px; object-fit: cover; transition: transform 0.3s;';
                
                img.onerror = () => item.style.display = 'none';
                
                // Create permanent bottom bar for mobile (always visible)
                const mobileBar = document.createElement('div');
                mobileBar.className = 'gallery-mobile-bar';
                mobileBar.style.cssText = `
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0));
                    padding: 8px 10px;
                    color: white;
                    display: ${isTouchDevice ? 'block' : 'none'};
                `;
                
                // Simple mobile bar content
                let mobileBarContent = '';
                if (image.plantInfo?.commonName) {
                    mobileBarContent = `<div class="fw-bold small" style="color: #f1f5f9; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">${image.plantInfo.commonName}</div>`;
                } else if (image.date) {
                    mobileBarContent = `<div class="small" style="color: #e2e8f0;">${image.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}</div>`;
                } else {
                    mobileBarContent = `<div class="small" style="color: #e2e8f0;">üåø Observation</div>`;
                }
                mobileBar.innerHTML = mobileBarContent;
                
                // Create full overlay with metadata (for hover on desktop)
                const overlay = document.createElement('div');
                overlay.className = 'gallery-overlay';
                overlay.style.cssText = `
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
                    padding: 15px 10px 10px;
                    color: white;
                    transform: translateY(${isTouchDevice ? '100%' : '100%'});
                    transition: transform 0.3s;
                `;
                
                let overlayContent = '';
                
                // Add plant info if available
                if (image.plantInfo) {
                    if (image.plantInfo.commonName) {
                        overlayContent += `<div class="fw-bold mb-1" style="color: #f1f5f9;">${image.plantInfo.commonName}</div>`;
                    }
                    if (image.plantInfo.scientificName) {
                        overlayContent += `<div class="small" style="color: #e2e8f0; opacity: 0.9;"><em>${image.plantInfo.scientificName}</em></div>`;
                    }
                }
                
                // Add location if available
                if (image.location) {
                    overlayContent += `<div class="small mt-1" style="color: #e2e8f0;"><i class="bi bi-geo-alt"></i> ${image.location.umap}</div>`;
                }
                
                // Add date
                if (image.date) {
                    const dateStr = image.date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'short',
                        year: 'numeric'
                    });
                    overlayContent += `<div class="small mt-1" style="color: #e2e8f0;"><i class="bi bi-calendar"></i> ${dateStr}</div>`;
                }
                
                // Add dimensions if available
                if (image.metadata?.dimensions) {
                    overlayContent += `<div class="small mt-1" style="color: #e2e8f0;"><i class="bi bi-arrows-fullscreen"></i> ${image.metadata.dimensions}</div>`;
                }
                
                overlay.innerHTML = overlayContent || '<div class="small" style="color: #e2e8f0;">Plant observation</div>';
                
                // Track overlay state for touch devices
                let overlayVisible = false;
                
                if (isTouchDevice) {
                    // Touch device: first tap shows overlay, second tap opens lightbox
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (!overlayVisible) {
                            // First tap: show overlay
                            overlay.style.transform = 'translateY(0)';
                            mobileBar.style.display = 'none';
                            overlayVisible = true;
                            
                            // Hide overlay after 3 seconds if not tapped again
                            setTimeout(() => {
                                if (overlayVisible) {
                                    overlay.style.transform = 'translateY(100%)';
                                    mobileBar.style.display = 'block';
                                    overlayVisible = false;
                                }
                            }, 3000);
                        } else {
                            // Second tap: open lightbox
                            openLightboxWithMetadata(image);
                        }
                    });
                    
                    // Close overlay when clicking elsewhere
                    document.addEventListener('click', (e) => {
                        if (!item.contains(e.target) && overlayVisible) {
                            overlay.style.transform = 'translateY(100%)';
                            mobileBar.style.display = 'block';
                            overlayVisible = false;
                        }
                    });
                } else {
                    // Desktop: hover effect
                item.addEventListener('mouseenter', () => {
                    overlay.style.transform = 'translateY(0)';
                    img.style.transform = 'scale(1.1)';
                });
                
                item.addEventListener('mouseleave', () => {
                    overlay.style.transform = 'translateY(100%)';
                    img.style.transform = 'scale(1)';
                });
                
                // Click to open lightbox
                item.onclick = () => {
                    openLightboxWithMetadata(image);
                };
                }
                
                item.appendChild(img);
                item.appendChild(mobileBar);
                item.appendChild(overlay);
                if (galleryGrid) galleryGrid.appendChild(item);
            });
        }
        
        // Enhanced lightbox with metadata
        function openLightboxWithMetadata(image) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.style.zIndex = '9999';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(74, 222, 128, 0.3);">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title text-success">
                                <span class="text-white">${image.plantInfo?.commonName || 'Plant Observation'}</span>
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center" style="background: rgba(15, 23, 42, 0.98); color: #e2e8f0;">
                            <img src="${image.url}" class="img-fluid rounded mb-3" alt="${image.plantInfo?.commonName || 'Plant observation'}" style="max-height: 70vh;">
                            <div class="text-start" style="color: #e2e8f0;">
                                ${image.plantInfo?.scientificName ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><strong style="color: #4ade80;">Scientific Name:</strong> <em style="color: #cbd5e1;">${image.plantInfo.scientificName}</em></p>
                                ` : ''}
                                ${image.location ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-geo-alt" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Location:</strong> <span style="color: #cbd5e1;">${image.location.umap}</span> <span style="color: #94a3b8;">(${image.location.lat}, ${image.location.lon})</span></p>
                                ` : ''}
                                ${image.date ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-calendar" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Date:</strong> <span style="color: #cbd5e1;">${image.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></p>
                                ` : ''}
                                ${image.metadata?.dimensions ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-arrows-fullscreen" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Dimensions:</strong> <span style="color: #cbd5e1;">${image.metadata.dimensions}</span></p>
                                ` : ''}
                                ${image.metadata?.mimeType ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-file-image" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Type:</strong> <span style="color: #cbd5e1;">${image.metadata.mimeType}</span></p>
                                ` : ''}
                                ${image.content ? `
                                    <div class="mt-3 p-3 rounded" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3);">
                                        <strong style="color: #4ade80;">Description:</strong>
                                        <p class="mb-0 mt-2" style="color: #cbd5e1;">${image.content}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button onclick="openMessageModal('${image.eventId}'); return false;" class="btn btn-outline-primary">
                                <i class="bi bi-chat-dots"></i> Voir le message
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
        
        // Keep old function for backward compatibility
        function openLightbox(imageUrl) {
            openLightboxWithMetadata({ url: imageUrl });
        }

        // ========================================
        // NOSTR CONNECTION
        // ========================================
        // Make function globally accessible
        window.handleNostrLogin = async function() {
            try {
                // Force authentication by passing true to forceAuth
                const pubkey = await connectNostr(true);
                if (pubkey) {
                    setUserPubkey(pubkey);
                    setIsNostrConnected(true);
                    setNostrRelay(getNostrRelay()); // Ensure relay is set
                    
                    // NIP-42 auth is handled automatically by common.js - no duplicate needed
                    
                    updateNostrUI(true);
                    await loadUserStats();
                    
                    // Scroll to share section to show the enabled button
                    scrollToSection('share');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la connexion:', error);
                showErrorModal(
                    'Une erreur est survenue lors de la connexion √† Nostr. Veuillez v√©rifier votre extension et r√©essayer.',
                    'Erreur de connexion'
                );
            }
        };

        function updateNostrUI(isLoggedIn) {
            const messageSection = document.getElementById('nostr-message-section');
            const messageForm = document.getElementById('nostr-message-form');
            const navMenuConnect = document.getElementById('nav-menu-connect');
            const navLinkProfile = document.getElementById('nav-link-profile');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const sendMessageHint = document.getElementById('send-message-hint');
            const galleryTitle = document.getElementById('gallery-title');
            const galleryAddBtn = document.getElementById('gallery-add-btn');
            const heroConnectBtn = document.getElementById('hero-connect-btn');
            
            const currentUserPubkey = getUserPubkey();
            
            if (isLoggedIn && currentUserPubkey) {
                // Keep connection button visible but change style/text to show reconnection option
                if (navMenuConnect) {
                    navMenuConnect.style.display = 'inline-block';
                    navMenuConnect.innerHTML = '<i class="bi bi-arrow-repeat"></i> Reconnecter';
                    navMenuConnect.className = 'btn btn-outline-success me-2';
                    navMenuConnect.title = 'Reconnecter et renouveler l\'authentification';
                }
                
                // Update hero button to show connected state
                if (heroConnectBtn) {
                    heroConnectBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Connect√© - Commencer l\'inventaire';
                    heroConnectBtn.className = 'btn btn-lg btn-success px-5 py-3';
                    heroConnectBtn.onclick = () => scrollToSection('share');
                }
                
                // Show profile link
                if (navLinkProfile) {
                    navLinkProfile.style.display = 'inline-block';
                    navLinkProfile.href = `nostr_profile_viewer.html?hex=${currentUserPubkey}`;
                }
                
                // Show message form
                if (messageSection) messageSection.style.display = 'none';
                if (messageForm) messageForm.style.display = 'block';
                
                // Enable contribution button
                if (sendMessageBtn) {
                    sendMessageBtn.disabled = false;
                }
                if (sendMessageHint) {
                    sendMessageHint.style.display = 'none';
                }
                
                // Update gallery title
                if (galleryTitle) {
                    galleryTitle.textContent = 'Mes Contributions √† l\'Inventaire';
                }
                if (galleryAddBtn) {
                    galleryAddBtn.disabled = false;
                }
                
                // Show Oracle badges section
                const oracleBadgesSection = document.getElementById('oracle-badges-section');
                if (oracleBadgesSection) {
                    oracleBadgesSection.style.display = 'block';
                }
                } else {
                // Show connection button, hide profile link
                if (navMenuConnect) navMenuConnect.style.display = 'inline-block';
                if (navLinkProfile) navLinkProfile.style.display = 'none';
                
                // Show connection message
                if (messageSection) messageSection.style.display = 'block';
                if (messageForm) messageForm.style.display = 'none';
                
                // Disable "Ajouter une Plante" button
                if (sendMessageBtn) {
                    sendMessageBtn.disabled = true;
                }
                if (sendMessageHint) {
                    sendMessageHint.style.display = 'block';
                }
                
                // Update gallery title to "√âl√©ments Inventori√©s" (public)
                if (galleryTitle) {
                    galleryTitle.textContent = '√âl√©ments Inventori√©s';
                }
                if (galleryAddBtn) {
                    galleryAddBtn.disabled = true;
                    galleryAddBtn.title = 'Connectez-vous pour ajouter une plante';
                }
                
                // Hide Oracle badges section
                const oracleBadgesSection = document.getElementById('oracle-badges-section');
                if (oracleBadgesSection) {
                    oracleBadgesSection.style.display = 'none';
                }
            }
        }
        
        // ========================================
        // MODAL VIEWERS FOR PROFILES AND MESSAGES
        // ========================================
        
        // Open profile viewer in modal
        function openProfile() {
            const currentUserPubkey = getUserPubkey();
            if (currentUserPubkey) {
                openProfileModal(currentUserPubkey);
            }
        }
        
        function openProfileModal(pubkey) {
            // Check if modal already exists
            let modal = document.getElementById('profile-viewer-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'profile-viewer-modal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'profile-viewer-modal-label');
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content" style="background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(74, 222, 128, 0.3);">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title text-success" id="profile-viewer-modal-label">
                                    <i class="bi bi-person"></i> Profil Nostr
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0" id="profile-viewer-content">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <p class="text-white mt-3">Chargement du profil...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Load content via iframe
            const contentDiv = document.getElementById('profile-viewer-content');
            contentDiv.innerHTML = `
                <iframe 
                    src="nostr_profile_viewer.html?hex=${pubkey}" 
                    style="width: 100%; height: 80vh; border: none; background: rgba(15, 23, 42, 0.98);"
                    frameborder="0">
                </iframe>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Open message viewer in modal
        function openMessageModal(eventId) {
            // Check if modal already exists
            let modal = document.getElementById('message-viewer-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'message-viewer-modal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'message-viewer-modal-label');
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content" style="background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(74, 222, 128, 0.3);">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title text-success" id="message-viewer-modal-label">
                                    <i class="bi bi-chat-dots"></i> Message Nostr
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0" id="message-viewer-content">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <p class="text-white mt-3">Chargement du message...</p>
                                </div>
                            </div>
                        </div>
                </div>
            `;
                document.body.appendChild(modal);
            }
            
            // Load content via iframe
            const contentDiv = document.getElementById('message-viewer-content');
            contentDiv.innerHTML = `
                <iframe 
                    src="nostr_message_viewer.html?event=${eventId}" 
                    style="width: 100%; height: 80vh; border: none; background: rgba(15, 23, 42, 0.98);"
                    frameborder="0">
                </iframe>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // ========================================
        // PHOTO UPLOAD
        // ========================================
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedPhoto = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('photoPreview');
                    const uploadText = document.getElementById('photoUploadText');
                    if (preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    }
                    if (uploadText) uploadText.style.display = 'none';
                };
                reader.readAsDataURL(file);
                
                handleIPFSUpload(file);
            }
        }

        async function handleIPFSUpload(file) {
            try {
                const result = await uploadPhotoToIPFS(file);
                if (result.success && selectedPhoto) {
                    selectedPhoto.ipfsUrl = result.url;
                    
                    // Store metadata if available
                    if (result.metadata) {
                        selectedPhoto.metadata = result.metadata;
                        console.log('üìã Metadata stored:', result.metadata);
                    }
                    
                    // Update comment field with description from API or metadata
                    const messageTextEl = document.getElementById('messageText');
                    if (messageTextEl) {
                        let descriptionToUse = result.description;
                        
                        // Try to get description from metadata if not provided directly
                        if (!descriptionToUse && result.metadata && result.metadata.metadata) {
                            descriptionToUse = result.metadata.metadata.description;
                        }
                        
                        if (descriptionToUse) {
                            // Use description directly (AI-generated for images)
                            messageTextEl.value = descriptionToUse;
                            console.log('‚úÖ Description updated:', descriptionToUse);
                        } else if (result.fileName) {
                            // Fallback: use filename if no description available
                            // Remove extension and replace underscores with spaces
                            const fileName = result.fileName.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
                            const cleanName = fileName.replace(/_/g, ' ');
                            messageTextEl.value = cleanName;
                            console.log('‚úÖ Description updated with filename:', cleanName);
                        }
                    }
                    
                    // Display file info if metadata is available
                    if (result.metadata) {
                        displayFileInfo(result.metadata);
                    }
                }
            } catch (error) {
                console.error('Error uploading to IPFS:', error);
            }
        }
        
        function displayFileInfo(metadata) {
            // Create or update an info display element
            let infoDiv = document.getElementById('file-info-display');
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = 'file-info-display';
                infoDiv.className = 'alert alert-info mt-3';
                
                const formSection = document.getElementById('nostr-message-form');
                if (formSection) {
                    const locationInfo = document.getElementById('locationInfo');
                    if (locationInfo && locationInfo.parentNode) {
                        locationInfo.parentNode.insertBefore(infoDiv, locationInfo);
            } else {
                        formSection.appendChild(infoDiv);
                    }
                }
            }
            
            // Build info HTML
            let infoHTML = '<strong><i class="bi bi-info-circle"></i> Informations du fichier:</strong><ul class="mb-0 mt-2">';
            
            if (metadata.file) {
                if (metadata.file.size) {
                    const sizeMB = (metadata.file.size / (1024 * 1024)).toFixed(2);
                    infoHTML += `<li><strong>Taille:</strong> ${sizeMB} MB</li>`;
                }
                if (metadata.file.type) {
                    infoHTML += `<li><strong>Type:</strong> ${metadata.file.type}</li>`;
                }
            }
            
            if (metadata.image && metadata.image.dimensions) {
                infoHTML += `<li><strong>Dimensions:</strong> ${metadata.image.dimensions}</li>`;
            }
            
            if (metadata.media) {
                if (metadata.media.duration) {
                    const minutes = Math.floor(metadata.media.duration / 60);
                    const seconds = Math.floor(metadata.media.duration % 60);
                    infoHTML += `<li><strong>Dur√©e:</strong> ${minutes}:${seconds.toString().padStart(2, '0')}</li>`;
                }
                if (metadata.media.dimensions) {
                    infoHTML += `<li><strong>Dimensions:</strong> ${metadata.media.dimensions}</li>`;
                }
            }
            
            if (metadata.metadata && metadata.metadata.description) {
                infoHTML += `<li><strong>Description:</strong> ${metadata.metadata.description}</li>`;
            }
            
            infoHTML += '</ul>';
            infoDiv.innerHTML = infoHTML;
            infoDiv.style.display = 'block';
        }
        
        // ========================================
        // GEOLOCATED MESSAGE
        // ========================================
        async function sendGeolocatedMessage() {
            const currentUserPubkey = getUserPubkey();
            const currentIsConnected = getIsNostrConnected();
            const currentRelay = getNostrRelay();
            
            if (!currentUserPubkey || !currentIsConnected) {
                showWarningModal(
                    'Vous devez √™tre connect√© avec Nostr pour publier une observation.<br><br>Utilisez le bouton "Connexion" dans la barre de navigation.',
                    'Connexion requise'
                );
                return;
            }
            
            if (!selectedPhoto || !selectedPhoto.ipfsUrl) {
                showWarningModal(
                    'Veuillez d\'abord s√©lectionner ou prendre une photo de l\'√©l√©ment √† inventorier.',
                    'Photo requise'
                );
                return;
            }

            if (!currentLocation) {
                showWarningModal(
                    'Une position g√©ographique est requise pour enregistrer l\'observation.<br><br>Utilisez la carte ou le bouton "Ma position" pour d√©finir votre localisation.',
                    'Position requise'
                );
                return;
            }

            const messageText = document.getElementById('messageText')?.value || '';
            const adjustedLocation = {
                latitude: parseFloat(document.getElementById('lat-display')?.value || currentLocation.latitude),
                longitude: parseFloat(document.getElementById('lon-display')?.value || currentLocation.longitude)
            };
            
            // Get selected inventory type
            const selectedType = document.querySelector('input[name="inventoryType"]:checked')?.value || 'inventory';
            const typeIcons = {
                'inventory': 'üîç',
                'plant': 'üå±',
                'insect': 'üêõ',
                'animal': 'ü¶ä',
                'object': 'üîß',
                'place': 'üè†'
            };
            const typeIcon = typeIcons[selectedType] || 'üîç';
            
            // Build content based on type
            const content = `${typeIcon} Inventaire UPlanet\nüìç Position: ${adjustedLocation.latitude}, ${adjustedLocation.longitude}\nüì∏ Photo: ${selectedPhoto.ipfsUrl}\n${messageText ? messageText + '\n' : ''}#${selectedType} #UPlanet #BRO #inventory`;
            
            // Build tags based on type
            const tags = [
                ["t", selectedType],
                    ["t", "UPlanet"],
                    ["t", "BRO"],
                ["t", "inventory"],
                    ["g", `${adjustedLocation.latitude},${adjustedLocation.longitude}`]
            ];
            
            // Add plantnet tag for plants (for PlantNet recognition)
            if (selectedType === 'plant') {
                tags.push(["t", "plantnet"]);
            }
            
            const eventTemplate = {
                kind: 1,
                created_at: Math.floor(Date.now() / 1000),
                tags: tags,
                    content: content
                };

            if (selectedPhoto.ipfsUrl) {
                eventTemplate.tags.push(["imeta", `url ${selectedPhoto.ipfsUrl}`, "m image/jpeg"]);
            }
            
            try {
                const signedEvent = await window.nostr.signEvent(eventTemplate);
                if (currentRelay) {
                    await currentRelay.publish(signedEvent);
                } else {
                    // Fallback: use common.js publish function if available
                    if (typeof publishToNostr === 'function') {
                        await publishToNostr(signedEvent);
                    } else {
                        throw new Error('No relay available');
                    }
                }
                
                const typeMessages = {
                    'plant': 'PlantNet va identifier la plante',
                    'insect': 'L\'IA va identifier l\'insecte',
                    'animal': 'L\'IA va identifier l\'animal',
                    'object': 'L\'IA va analyser l\'objet',
                    'place': 'L\'IA va analyser le lieu',
                    'inventory': 'L\'IA va classifier et identifier l\'√©l√©ment'
                };
                
                showSuccessModal(
                    `Votre contribution a √©t√© publi√©e avec succ√®s !<br><br>${typeMessages[selectedType]} et un contrat de maintenance sera g√©n√©r√© automatiquement.`,
                    'Contribution enregistr√©e',
                    4000
                );
                
                selectedPhoto = null;
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('photoUploadText').style.display = 'block';
                document.getElementById('messageText').value = '';
                
                setTimeout(() => {
                    loadUserStats();
                }, 2000);

            } catch (error) {
                console.error('Error sending message:', error);
                showErrorModal(
                    'Impossible de publier votre observation. Veuillez v√©rifier votre connexion au relay et r√©essayer.',
                    'Erreur de publication'
                );
            }
        }
        
        // ========================================
        // MAP FUNCTIONS (Keep existing logic)
        // ========================================
        function toggleOREMapView() {
            const container = document.getElementById('ore-map-container');
            const btn = document.getElementById('toggle-ore-map-btn');
            if (container) {
                const isVisible = container.style.display !== 'none';
                container.style.display = isVisible ? 'none' : 'block';
                if (btn) {
                    btn.innerHTML = isVisible ? '<i class="bi bi-map"></i> Afficher la Carte' : '<i class="bi bi-x-square"></i> Masquer la Carte';
                }
                if (!isVisible && !unifiedMap) {
                    setTimeout(() => initializeUnifiedMap(), 300);
                }
            }
        }
        
        // Initialize unified map (events + position selection)
        function initializeUnifiedMap() {
            if (typeof L === 'undefined') {
                console.warn('Leaflet not loaded');
                return;
            }
            
            const mapEl = document.getElementById('unified-map');
            if (!mapEl) {
                console.warn('Map element not found');
                return;
            }
            
            // Remove existing map if present
            if (unifiedMap) {
                unifiedMap.remove();
                unifiedMap = null;
                mapMarkers = [];
                userPositionMarker = null;
            }
            
            // Initialize map with default view (France)
            unifiedMap = L.map('unified-map').setView([46.0, 2.0], 6);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(unifiedMap);
            
            // Add click handler for position selection (only if not clicking on a marker/popup)
            unifiedMap.on('click', function(e) {
                // Check if click was on a marker or popup
                const originalEvent = e.originalEvent;
                if (originalEvent && originalEvent.target.closest('.leaflet-marker-icon, .leaflet-popup, .leaflet-popup-content')) {
                    return; // Don't update position if clicking on marker/popup
                }
                
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                
                // Update position inputs
                const latInput = document.getElementById('lat-display');
                const lonInput = document.getElementById('lon-display');
                if (latInput) latInput.value = lat.toFixed(6);
                if (lonInput) lonInput.value = lon.toFixed(6);
                
                // Update currentLocation
                currentLocation = { latitude: lat, longitude: lon };
                
                // Update or create user position marker
                updateUserPositionMarker(lat, lon);
                
                // Show feedback
                if (userPositionMarker) {
                    userPositionMarker.bindPopup('<strong>üìç Position mise √† jour</strong>').openPopup();
                    setTimeout(() => {
                        if (userPositionMarker) userPositionMarker.closePopup();
                    }, 2000);
                }
            });
            
            // Load events when map is ready
            loadMapEvents();
            
            // Center on user location if available
            if (currentLocation) {
                updateUserPositionMarker(currentLocation.latitude, currentLocation.longitude);
                unifiedMap.setView([currentLocation.latitude, currentLocation.longitude], 13);
            }
        }
        
        // Update user position marker
        function updateUserPositionMarker(lat, lon) {
            if (!unifiedMap) return;
            
            // Remove existing user marker
            if (userPositionMarker) {
                unifiedMap.removeLayer(userPositionMarker);
            }
            
            // Create custom icon for user position (blue marker with shadow)
            const userIcon = L.divIcon({
                className: 'user-position-marker',
                html: '<div style="background: #3b82f6; width: 28px; height: 28px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.8), 0 0 5px rgba(0, 0, 0, 0.3); cursor: move;"></div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
            
            // Add draggable marker
            userPositionMarker = L.marker([lat, lon], { 
                icon: userIcon,
                draggable: true,
                zIndexOffset: 1000,
                keyboard: true
            }).addTo(unifiedMap);
            
            userPositionMarker.bindPopup('<strong>üìç Votre position</strong><br><small>Cliquez-glissez pour ajuster<br>ou cliquez sur la carte</small>').openPopup();
            
            // Handle drag end to update position
            userPositionMarker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                const latInput = document.getElementById('lat-display');
                const lonInput = document.getElementById('lon-display');
                if (latInput) latInput.value = pos.lat.toFixed(6);
                if (lonInput) lonInput.value = pos.lng.toFixed(6);
                currentLocation = { latitude: pos.lat, longitude: pos.lng };
                
                // Show feedback
                userPositionMarker.bindPopup('<strong>‚úÖ Position mise √† jour</strong><br><small>Coordonn√©es: ' + pos.lat.toFixed(6) + ', ' + pos.lng.toFixed(6) + '</small>').openPopup();
                setTimeout(() => {
                    if (userPositionMarker) {
                        userPositionMarker.bindPopup('<strong>üìç Votre position</strong><br><small>Cliquez-glissez pour ajuster</small>');
                        userPositionMarker.closePopup();
                    }
                }, 2000);
            });
            
            // Center map on marker if zoomed out too much
            if (unifiedMap.getZoom() < 10) {
                unifiedMap.setView([lat, lon], 13);
            }
        }
        
        // Load events on unified map
        async function loadMapEvents() {
            if (!unifiedMap) {
                console.warn('Map not initialized');
                return;
            }
            
            console.log('üó∫Ô∏è Loading ORE events and plant observations...');
            
            // Use relay from common.js
            let currentRelay = getNostrRelay();
            if (!currentRelay) {
                console.warn('‚ö†Ô∏è No relay available, connecting...');
                await connectToRelay();
                currentRelay = getNostrRelay();
                if (!currentRelay) {
                    console.warn('‚ö†Ô∏è Could not connect to relay');
                    return;
                }
            }
            
            // Clear existing event markers (keep user position marker)
            mapMarkers.forEach(marker => {
                if (unifiedMap && marker !== userPositionMarker) {
                    unifiedMap.removeLayer(marker);
                }
            });
            mapMarkers = userPositionMarker ? [userPositionMarker] : [];
            
            try {
                // Load event types SEQUENTIALLY to avoid "too many concurrent REQs" error
                // Strfry relay limits concurrent subscriptions per connection
                console.log('üì° Loading events sequentially to respect relay limits...');
                
                const observations = await fetchPlantObservations(currentRelay);
                await new Promise(r => setTimeout(r, 100)); // Small delay between requests
                
                const recognizedPlants = await fetchRecognizedPlants(currentRelay);
                await new Promise(r => setTimeout(r, 100));
                
                const inventoryItems = await fetchInventoryItems(currentRelay);
                await new Promise(r => setTimeout(r, 100));
                
                const maintenanceContracts = await fetchMaintenanceContracts(currentRelay);
                await new Promise(r => setTimeout(r, 100));
                
                const umapDIDs = await fetchUMAPDIDs(currentRelay);
                await new Promise(r => setTimeout(r, 100));
                
                const oreContracts = await fetchOREContracts(currentRelay);
                
                console.log(`üìä Events loaded: ${observations.length} observations, ${recognizedPlants.length} recognized, ${inventoryItems.length} inventory items, ${maintenanceContracts.length} contracts`);
                
                // Store all data for filtering
                const allData = {
                    observations,
                    recognizedPlants,
                    umapDIDs,
                    oreContracts,
                    inventoryItems,
                    maintenanceContracts
                };
                
                // Display all markers on map with current filter
                displayMapMarkers(allData, currentTypeFilter);
                
                // Update count
                updateEventCount(observations, recognizedPlants, umapDIDs, oreContracts);
                
            } catch (error) {
                console.error('‚ùå Error loading map data:', error);
                // Show user-friendly error
                if (unifiedMap) {
                    unifiedMap.eachLayer(layer => {
                        if (layer instanceof L.Marker && layer !== userPositionMarker) {
                            unifiedMap.removeLayer(layer);
                        }
                    });
                }
            }
        }
        
        // Update event count display
        function updateEventCount(observations, recognizedPlants, umapDIDs, oreContracts) {
            const countEl = document.getElementById('ore-umap-count');
            if (countEl) {
                const uniqueUmaps = new Set();
                [...observations, ...recognizedPlants, ...umapDIDs, ...oreContracts].forEach(event => {
                    const geoTag = event.tags?.find(t => t[0] === 'g');
                    if (geoTag && geoTag[1]) {
                        uniqueUmaps.add(geoTag[1]);
                    }
                });
                countEl.textContent = uniqueUmaps.size;
            }
        }
        
        // Fetch plant observations (kind 1 with tags BRO and plantnet)
        async function fetchPlantObservations(relay) {
            if (!relay) {
                console.warn('‚ö†Ô∏è No relay provided to fetchPlantObservations');
                return [];
            }
            
                const filter = {
                    kinds: [1],
                    '#t': ['BRO', 'plantnet'],
                    limit: 500,
                    since: Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60) // Last 90 days
                };
                
            // Use SubscriptionQueue if available
            if (window.SubscriptionQueue) {
                const allEvents = await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
                // Filter events that have both BRO and plantnet tags with geo
                return allEvents.filter(event => {
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    const hasGeo = event.tags.find(t => t[0] === 'g');
                    return tags.includes('BRO') && tags.includes('plantnet') && hasGeo;
                });
            }
            
            // Fallback to direct subscription
            return new Promise((resolve) => {
                const observations = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => {
                    try { sub.unsub(); } catch(e) {}
                    resolve(observations);
                }, 8000);
                
                sub.on('event', (event) => {
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    if (tags.includes('BRO') && tags.includes('plantnet')) {
                        const geoTag = event.tags.find(t => t[0] === 'g');
                        if (geoTag && geoTag[1]) {
                            observations.push(event);
                        }
                    }
                });
                
                sub.on('eose', () => {
                    clearTimeout(timeout);
                    try { sub.unsub(); } catch(e) {}
                    resolve(observations);
                });
            });
        }
        
        // Fetch recognized plants (kind 1 with tags UPlanet and plantnet)
        async function fetchRecognizedPlants(relay) {
            if (!relay) return [];
            
                const filter = {
                    kinds: [1],
                    '#t': ['UPlanet', 'plantnet'],
                    limit: 500,
                since: Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60)
            };
            
            if (window.SubscriptionQueue) {
                const allEvents = await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
                return allEvents.filter(event => {
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    const hasGeo = event.tags.find(t => t[0] === 'g');
                    return tags.includes('UPlanet') && tags.includes('plantnet') && hasGeo;
                });
            }
            
            return new Promise((resolve) => {
                const recognized = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => { try { sub.unsub(); } catch(e) {} resolve(recognized); }, 8000);
                sub.on('event', (event) => {
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    if (tags.includes('UPlanet') && tags.includes('plantnet') && event.tags.find(t => t[0] === 'g')) {
                            recognized.push(event);
                    }
                });
                sub.on('eose', () => { clearTimeout(timeout); try { sub.unsub(); } catch(e) {} resolve(recognized); });
            });
        }
        
        // Fetch UMAP DIDs (kind 30800)
        async function fetchUMAPDIDs(relay) {
            if (!relay) return [];
            
            const filter = { kinds: [30800], '#d': ['did'], limit: 200 };
            
            if (window.SubscriptionQueue) {
                const allEvents = await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
                return allEvents.filter(event => {
                    try {
                        const content = JSON.parse(event.content || '{}');
                        if (content.type === 'UMAPGeographicCell' && content.geographicMetadata?.coordinates) {
                            const coords = content.geographicMetadata.coordinates;
                            if (!event.tags.find(t => t[0] === 'g')) {
                                event.tags.push(['g', `${coords.lat},${coords.lon}`]);
                            }
                            return true;
                        }
                    } catch (e) {}
                    return false;
                });
            }
            
            return new Promise((resolve) => {
                const dids = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => { try { sub.unsub(); } catch(e) {} resolve(dids); }, 8000);
                sub.on('event', (event) => {
                    try {
                        const content = JSON.parse(event.content || '{}');
                        if (content.type === 'UMAPGeographicCell' && content.geographicMetadata?.coordinates) {
                            const coords = content.geographicMetadata.coordinates;
                            if (!event.tags.find(t => t[0] === 'g')) {
                                event.tags.push(['g', `${coords.lat},${coords.lon}`]);
                            }
                            dids.push(event);
                        }
                    } catch (e) {}
                });
                sub.on('eose', () => { clearTimeout(timeout); try { sub.unsub(); } catch(e) {} resolve(dids); });
            });
        }
        
        // Fetch ORE contracts (kind 30312)
        async function fetchOREContracts(relay) {
            if (!relay) return [];
            
            const filter = { kinds: [30312], '#t': ['ORE'], limit: 200 };
            
            if (window.SubscriptionQueue) {
                return await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
            }
            
            return new Promise((resolve) => {
                const contracts = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => { try { sub.unsub(); } catch(e) {} resolve(contracts); }, 8000);
                sub.on('event', (event) => { contracts.push(event); });
                sub.on('eose', () => { clearTimeout(timeout); try { sub.unsub(); } catch(e) {} resolve(contracts); });
            });
        }
        
        // Fetch inventory items (kind 1 with #inventory tag)
        async function fetchInventoryItems(relay) {
            if (!relay) return [];
            
                const filter = {
                    kinds: [1],
                    '#t': ['inventory', 'UPlanet'],
                    limit: 500,
                since: Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60)
            };
            
            if (window.SubscriptionQueue) {
                const allEvents = await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
                return allEvents.filter(event => {
                    const geoTag = event.tags.find(t => t[0] === 'g');
                    if (geoTag && geoTag[1]) {
                        const inventoryTypeTag = event.tags.find(t => t[0] === 'inventory_type');
                        event.inventoryType = inventoryTypeTag ? inventoryTypeTag[1] : 'object';
                        return true;
                    }
                    return false;
                });
            }
            
            return new Promise((resolve) => {
                const items = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => { try { sub.unsub(); } catch(e) {} resolve(items); }, 8000);
                sub.on('event', (event) => {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                        const inventoryTypeTag = event.tags.find(t => t[0] === 'inventory_type');
                        event.inventoryType = inventoryTypeTag ? inventoryTypeTag[1] : 'object';
                        items.push(event);
                    }
                });
                sub.on('eose', () => { clearTimeout(timeout); try { sub.unsub(); } catch(e) {} resolve(items); });
            });
        }
        
        // Fetch maintenance contracts (kind 30023 with #contract tag)
        async function fetchMaintenanceContracts(relay) {
            if (!relay) return [];
            
            const filter = { kinds: [30023], '#t': ['contract', 'maintenance'], limit: 200 };
            
            if (window.SubscriptionQueue) {
                const allEvents = await window.SubscriptionQueue.createSubscription(relay, [filter], { timeout: 8000 });
                return allEvents.filter(event => {
                    const geoTag = event.tags.find(t => t[0] === 'g');
                    if (geoTag && geoTag[1]) {
                        const inventoryTypeTag = event.tags.find(t => t[0] === 'inventory_type');
                        event.inventoryType = inventoryTypeTag ? inventoryTypeTag[1] : 'object';
                        return true;
                    }
                    return false;
                });
            }
            
            return new Promise((resolve) => {
                const contracts = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => { try { sub.unsub(); } catch(e) {} resolve(contracts); }, 8000);
                sub.on('event', (event) => {
                    const geoTag = event.tags.find(t => t[0] === 'g');
                    if (geoTag && geoTag[1]) {
                        const inventoryTypeTag = event.tags.find(t => t[0] === 'inventory_type');
                        event.inventoryType = inventoryTypeTag ? inventoryTypeTag[1] : 'object';
                        contracts.push(event);
                    }
                });
                sub.on('eose', () => { clearTimeout(timeout); try { sub.unsub(); } catch(e) {} resolve(contracts); });
            });
        }
        
        // Get marker options based on inventory type
        function getInventoryMarkerOptions(inventoryType) {
            const typeConfig = INVENTORY_TYPES[inventoryType] || INVENTORY_TYPES.object;
            return {
                radius: typeConfig.radius,
                fillColor: typeConfig.color,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                fillOpacity: 0.9
            };
        }
        
        // Display markers on unified map with filtering support
        function displayMapMarkers(data, filterType = 'all') {
            if (!unifiedMap) return;
            
            // Store data for filtering
            allInventoryData = data;
            
            // Clear existing markers (except user position)
            mapMarkers.forEach(marker => {
                if (marker !== userPositionMarker) {
                    unifiedMap.removeLayer(marker);
                }
            });
            mapMarkers = userPositionMarker ? [userPositionMarker] : [];
            
            const { observations, recognizedPlants, umapDIDs, oreContracts, inventoryItems, maintenanceContracts } = data;
            
            // Helper function to add a marker with type info
            function addInventoryMarker(event, inventoryType, customPopup = null) {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (!geoTag || !geoTag[1]) return;
                
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                if (isNaN(lat) || isNaN(lon)) return;
                
                // Apply filter
                if (filterType !== 'all' && inventoryType !== filterType) return;
                
                const typeConfig = INVENTORY_TYPES[inventoryType] || INVENTORY_TYPES.object;
                const markerOptions = getInventoryMarkerOptions(inventoryType);
                
                const marker = L.circleMarker([lat, lon], markerOptions).addTo(unifiedMap);
                        
                        const content = event.content || '';
                        const preview = content.substring(0, 100);
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                // Get inventory name from tags
                const nameTag = event.tags.find(t => t[0] === 'inventory_name');
                const itemName = nameTag ? nameTag[1] : 'Non identifi√©';
                
                // Check for associated contract
                const contractTag = event.tags.find(t => t[0] === 'contract');
                const contractLink = contractTag ? `<a href="#" onclick="openMessageModal('${contractTag[1]}'); return false;" class="text-warning">üìÑ Voir contrat</a><br>` : '';
                
                const popupContent = customPopup || `
                    <div style="min-width: 220px; background: #1e293b; border-radius: 8px; padding: 10px;">
                        <div style="font-size: 1.5em; text-align: center; margin-bottom: 8px;">${typeConfig.icon}</div>
                        <strong style="color: ${typeConfig.color};">${typeConfig.name}</strong><br>
                        <span style="color: #e8e8e8; font-weight: 500;">${itemName}</span><br>
                        <small style="color: #94a3b8;">${preview}...</small><br>
                        ${contractLink}
                        <small style="color: #64748b;">üìÖ ${dateStr}</small><br>
                        <div class="d-flex gap-2 mt-2">
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                               class="btn btn-sm flex-fill" 
                               style="background: ${typeConfig.color}; color: white; border: none;">
                                üìñ D√©tails
                            </button>
                            <button onclick="likeInventoryItem('${event.id}'); return false;" 
                               class="btn btn-sm" 
                               style="background: #fbbf24; color: #0f172a; border: none;" 
                               title="Cr√©diter ·∫êen">
                                üëç
                                </button>
                            </div>
                    </div>
                `;
                        
                marker.bindPopup(popupContent);
                marker.inventoryType = inventoryType;
                        mapMarkers.push(marker);
                    }
            
            // 1. Inventory items (kind 1 with #inventory) - Multi-type markers
            if (inventoryItems) {
                inventoryItems.forEach(event => {
                    const inventoryType = event.inventoryType || 'object';
                    addInventoryMarker(event, inventoryType);
                });
            }
            
            // 2. Recognized plants (kind 1 with UPlanet and plantnet) - Plant markers
            if (recognizedPlants) {
                recognizedPlants.forEach(event => {
                    addInventoryMarker(event, 'plant');
                });
            }
            
            // 3. Maintenance contracts (kind 30023) - Contract markers
            if (maintenanceContracts) {
                maintenanceContracts.forEach(event => {
                    if (filterType === 'all' || filterType === 'contract') {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                    if (!isNaN(lat) && !isNaN(lon)) {
                                const marker = L.circleMarker([lat, lon], {
                                    radius: 12,
                                    fillColor: '#fbbf24',
                                    color: '#fff',
                                    weight: 3,
                                    opacity: 1,
                                    fillOpacity: 0.9
                        }).addTo(unifiedMap);
                        
                                const titleTag = event.tags.find(t => t[0] === 'title');
                                const title = titleTag ? titleTag[1] : 'Contrat de maintenance';
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                        marker.bindPopup(`
                                    <div style="min-width: 220px; background: #1e293b; border-radius: 8px; padding: 10px;">
                                        <div style="font-size: 1.5em; text-align: center; margin-bottom: 8px;">üìÑ</div>
                                        <strong style="color: #fbbf24;">Contrat de Maintenance</strong><br>
                                        <span style="color: #e8e8e8; font-weight: 500;">${title}</span><br>
                                        <small style="color: #64748b;">üìÖ ${dateStr}</small><br>
                                        <div class="d-flex gap-2 mt-2">
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                                               class="btn btn-sm flex-fill" 
                                               style="background: #fbbf24; color: #0f172a; border: none;">
                                                üìñ Lire le contrat
                                            </button>
                                            <button onclick="likeInventoryItem('${event.id}'); return false;" 
                                               class="btn btn-sm" 
                                               style="background: #22c55e; color: white; border: none;" 
                                               title="Cr√©diter ·∫êen">
                                                üëç
                                </button>
                                        </div>
                            </div>
                        `);
                        
                                marker.inventoryType = 'contract';
                        mapMarkers.push(marker);
                            }
                    }
                }
            });
            }
            
            // 4. Legacy: Observations (kind 1 with BRO and plantnet) - Orange markers (pending)
            if (observations && (filterType === 'all' || filterType === 'plant')) {
                observations.forEach(event => {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.circleMarker([lat, lon], {
                                radius: 7,
                                fillColor: '#f97316',
                            color: '#fff',
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0.7
                        }).addTo(unifiedMap);
                        
                        const content = event.content || '';
                            const preview = content.substring(0, 80);
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                    <strong style="color: #f97316;">üîç Observation en attente</strong><br>
                                    <small>${preview}...</small><br>
                                <small style="color: #888;">üìÖ ${dateStr}</small><br>
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                                       class="btn btn-sm mt-2" 
                                       style="background: #f97316; color: white; border: none;">
                                        üìñ Voir
                                </button>
                            </div>
                        `);
                        
                            marker.inventoryType = 'pending';
                        mapMarkers.push(marker);
                    }
                }
            });
            }
            
            // Fit map to show all markers
            const markersToFit = mapMarkers.filter(m => m !== userPositionMarker);
            if (markersToFit.length > 0) {
                const group = new L.featureGroup(markersToFit);
                if (userPositionMarker) {
                    group.addLayer(userPositionMarker);
                }
                unifiedMap.fitBounds(group.getBounds().pad(0.1));
            }
            
            // Update marker count display
            updateMarkerCounts(data, filterType);
        }
        
        // Update marker counts in UI
        function updateMarkerCounts(data, filterType) {
            const counts = {
                all: 0,
                plant: 0,
                insect: 0,
                animal: 0,
                person: 0,
                object: 0,
                place: 0,
                contract: 0
            };
            
            // Count inventory items by type
            if (data.inventoryItems) {
                data.inventoryItems.forEach(item => {
                    const type = item.inventoryType || 'object';
                    if (counts[type] !== undefined) counts[type]++;
                    counts.all++;
                });
            }
            
            // Count recognized plants
            if (data.recognizedPlants) {
                counts.plant += data.recognizedPlants.length;
                counts.all += data.recognizedPlants.length;
            }
            
            // Count maintenance contracts
            if (data.maintenanceContracts) {
                counts.contract += data.maintenanceContracts.length;
                counts.all += data.maintenanceContracts.length;
            }
            
            // Update filter buttons with counts
            document.querySelectorAll('#inventory-type-filters button').forEach(btn => {
                const type = btn.dataset.type;
                if (type && counts[type] !== undefined) {
                    const countBadge = btn.querySelector('.count-badge');
                    if (countBadge) {
                        countBadge.textContent = counts[type];
                    } else if (counts[type] > 0) {
                        btn.innerHTML += ` <span class="count-badge badge bg-dark">${counts[type]}</span>`;
                    }
                }
            });
        }
        
        // Like an inventory item (send kind 7 reaction)
        async function likeInventoryItem(eventId) {
            if (!window.nostr) {
                showModal('Connexion requise', 'Veuillez vous connecter avec une extension Nostr (NIP-07) pour cr√©diter des ·∫êen.', 'warning');
                return;
            }
            
            try {
                const event = {
                    kind: 7,
                    content: '+',
                    tags: [['e', eventId]],
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                const signedEvent = await window.nostr.signEvent(event);
                
                if (currentRelay) {
                    const pub = currentRelay.publish(signedEvent);
                    pub.on('ok', () => {
                        showModal('·∫êen cr√©dit√©!', 'üëç Votre like a √©t√© enregistr√©. Merci de soutenir la gestion des communs!', 'success', 3000);
                    });
                    pub.on('failed', (reason) => {
                        console.error('Failed to publish like:', reason);
                        showModal('Erreur', 'Impossible de publier votre like.', 'error');
                    });
                }
            } catch (error) {
                console.error('Error liking item:', error);
                showModal('Erreur', 'Une erreur est survenue lors du like.', 'error');
            }
        }
        
        // Initialize inventory type filter buttons
        function initInventoryFilters() {
            const filterContainer = document.getElementById('inventory-type-filters');
            if (!filterContainer) return;
            
            filterContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn || !btn.dataset.type) return;
                
                // Update active state
                filterContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Apply filter
                currentTypeFilter = btn.dataset.type;
                if (allInventoryData) {
                    displayMapMarkers(allInventoryData, currentTypeFilter);
                }
            });
        }
        
        // Profile functions removed - now using nostr_profile_viewer.html
        
        // ========================================
        // MODAL UTILITIES
        // ========================================
        
        /**
         * Show a Bootstrap modal with custom title, message, and type
         * @param {string} title - Modal title
         * @param {string} message - Modal message/body
         * @param {string} type - 'error', 'success', 'warning', 'info' (default: 'info')
         * @param {number} autoClose - Auto-close delay in ms (0 = no auto-close, default: 0)
         */
        function showModal(title, message, type = 'info', autoClose = 0) {
            // Remove existing modal if any
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Determine icon and colors based on type
            let icon, bgColor, textColor, btnColor;
            switch (type) {
                case 'error':
                    icon = '<i class="bi bi-exclamation-triangle-fill"></i>';
                    bgColor = '#dc3545';
                    textColor = '#fff';
                    btnColor = 'btn-danger';
                            break;
                case 'success':
                    icon = '<i class="bi bi-check-circle-fill"></i>';
                    bgColor = '#22c55e';
                    textColor = '#fff';
                    btnColor = 'btn-success';
                            break;
                case 'warning':
                    icon = '<i class="bi bi-exclamation-triangle-fill"></i>';
                    bgColor = '#f59e0b';
                    textColor = '#fff';
                    btnColor = 'btn-warning';
                            break;
                default: // info
                    icon = '<i class="bi bi-info-circle-fill"></i>';
                    bgColor = '#3b82f6';
                    textColor = '#fff';
                    btnColor = 'btn-info';
            }
            
            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="custom-modal" tabindex="-1" aria-labelledby="custom-modal-label" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="border: none; border-radius: 12px; overflow: hidden;">
                            <div class="modal-header" style="background: ${bgColor}; color: ${textColor}; border: none;">
                                <h5 class="modal-title" id="custom-modal-label" style="color: ${textColor};">
                                    ${icon} ${title}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" style="background: #1e293b; color: #e2e8f0; padding: 1.5rem;">
                                ${message}
                            </div>
                            <div class="modal-footer" style="background: #1e293b; border: none; padding: 1rem 1.5rem;">
                                <button type="button" class="btn ${btnColor}" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Get modal element
            const modalEl = document.getElementById('custom-modal');
            const modal = new bootstrap.Modal(modalEl);
            
            // Show modal
            modal.show();
            
            // Auto-close if specified
            if (autoClose > 0) {
                setTimeout(() => {
                    modal.hide();
                    setTimeout(() => modalEl.remove(), 300);
                }, autoClose);
            }
            
            // Cleanup on hidden
            modalEl.addEventListener('hidden.bs.modal', () => {
                modalEl.remove();
            });
        }
        
        /**
         * Show error modal
         * @param {string} message - Error message
         * @param {string} title - Optional custom title (default: 'Erreur')
         */
        function showErrorModal(message, title = 'Erreur') {
            showModal(title, message, 'error');
        }
        
        /**
         * Show success modal
         * @param {string} message - Success message
         * @param {string} title - Optional custom title (default: 'Succ√®s')
         * @param {number} autoClose - Auto-close delay in ms (default: 3000)
         */
        function showSuccessModal(message, title = 'Succ√®s', autoClose = 3000) {
            showModal(title, message, 'success', autoClose);
        }
        
        /**
         * Show warning modal
         * @param {string} message - Warning message
         * @param {string} title - Optional custom title (default: 'Attention')
         */
        function showWarningModal(message, title = 'Attention') {
            showModal(title, message, 'warning');
        }
        
        /**
         * Show info modal
         * @param {string} message - Info message
         * @param {string} title - Optional custom title (default: 'Information')
         */
        function showInfoModal(message, title = 'Information') {
            showModal(title, message, 'info');
        }
        
        // Make modal functions globally accessible for common.js
        if (typeof window !== 'undefined') {
            window.showErrorModal = showErrorModal;
            window.showWarningModal = showWarningModal;
            window.showSuccessModal = showSuccessModal;
            window.showInfoModal = showInfoModal;
            window.showModal = showModal;
        }
        
        // ========================================
        // LUNAR CALENDAR FUNCTIONS
        // ========================================
        // NOTE: All lunar calendar functions are now in lunar-calendar.js
        // Functions below are kept as fallback ONLY if JS file is not loaded
        // Primary functions are imported from lunar-calendar.js:
        // - getMoonDeclination, getMoonPhase, getMoonZodiac
        // - getLunarEvents, getBiodynamicInfo
        // - initializeLunarCalendar, buildLunarTimeline
        // - generateVegetarianGardenerICal
        // ========================================
        
        // All lunar calendar functions are now in lunar-calendar.js
        // Check if functions are available, otherwise show error
        if (typeof getBiodynamicInfo === 'undefined' || typeof initializeLunarCalendar === 'undefined') {
            console.error('lunar-calendar.js is required but not loaded. Please ensure the file is included.');
            // Minimal fallback: just show error
            window.getBiodynamicInfo = function() {
                return { error: 'lunar-calendar.js not loaded' };
            };
            window.initializeLunarCalendar = function() {
                const statusText = document.getElementById('lunar-status-text');
                if (statusText) {
                    statusText.innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è lunar-calendar.js non charg√©</span>';
                }
            };
        }
        
        // Legacy fallback functions removed - all in lunar-calendar.js now
        // If you need fallback, ensure lunar-calendar.js is loaded
        
        // ========================================
        // CALENDAR FUNCTIONS (Keep from original)
        // ========================================
        // Calendar functions are in common.js - use them if available
        // Otherwise use placeholder
        
        // All lunar calendar functions (getMoonPhase, getMoonZodiac, getLunarEvents, getBiodynamicInfo)
        // are now in lunar-calendar.js - no need to duplicate them here
        
        // Removed duplicate code: getMoonPhase, getMoonZodiac, getLunarEvents, getBiodynamicInfo
        // All these functions are imported from lunar-calendar.js
        // All functions (initializeLunarCalendar, buildLunarTimeline, formatDate) are in lunar-calendar.js
        // No need to duplicate them here
        
        // ========================================
        // CALENDAR FUNCTIONS (Keep from original)
        // ========================================
        // Calendar functions are in common.js - use them if available
        // Otherwise use placeholder

        // Make function globally accessible
        window.generateICalFile = function() {
            const yearSelect = document.getElementById('lunar-year-select');
            const styleSelect = document.getElementById('lunar-style-select');
            const selectedYear = parseInt(yearSelect.value);
            const selectedStyle = styleSelect ? styleSelect.value : 'umap';
            
            if (!selectedYear || isNaN(selectedYear)) {
                if (typeof showWarningModal === 'function') {
                    showWarningModal('Veuillez s√©lectionner une ann√©e d\'abord.', 'Ann√©e requise');
                } else {
                    alert('Veuillez s√©lectionner une ann√©e d\'abord.');
                }
                return;
            }
            
            // Use enhanced vegetarian gardener calendar with selected style
            let icalContent;
            if (typeof generateVegetarianGardenerICal === 'function') {
                icalContent = generateVegetarianGardenerICal(selectedYear, selectedStyle);
            } else if (typeof generateLunarICalContent === 'function') {
                // Fallback to basic lunar calendar
                icalContent = generateLunarICalContent(selectedYear);
            } else {
                if (typeof showErrorModal === 'function') {
                    showErrorModal('Fonction d\'export non disponible. V√©rifiez que lunar-calendar.js est charg√©.', 'Erreur');
                } else {
                    alert('Fonction d\'export non disponible.');
                }
                return;
            }
            
            // Create and download the file
            const blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `jardin_vegetarien_${selectedYear}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            if (typeof showSuccessModal === 'function') {
            showSuccessModal(
                    `Calendrier jardinier v√©g√©tarien ${selectedYear} t√©l√©charg√© avec succ√®s !<br><br>` +
                    `Le fichier contient :<br>` +
                    `‚Ä¢ Semis optimaux selon cycles lunaires<br>` +
                    `‚Ä¢ R√©coltes avec conseils nutrition<br>` +
                    `‚Ä¢ Rappels saisonniers et m√©t√©o<br><br>` +
                    `Importez le fichier .ics dans votre application de calendrier.`,
                    'T√©l√©chargement r√©ussi',
                    5000
                );
            } else {
                alert(`Calendrier jardinier v√©g√©tarien ${selectedYear} t√©l√©charg√© avec succ√®s !`);
            }
        };
        
        // Generate iCal content for lunar calendar
        function generateLunarICalContent(year) {
            let ical = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//UPlanet Inventory//Lunar Calendar//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                `X-WR-CALNAME:Lunar Calendar ${year}`,
                'X-WR-TIMEZONE:Europe/Paris'
            ];
            
            // Generate events for each lunar phase transition
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            
            let currentDate = new Date(startDate);
            let previousPhase = null;
            let phaseStartDate = null;
            
            while (currentDate <= endDate) {
                const jd = toJulianDay(currentDate);
                const moonData = getMoonDeclination(jd);
                const currentPhase = moonData.isAscending ? 'ascending' : 'descending';
                
                // Detect phase transition
                if (previousPhase !== null && previousPhase !== currentPhase) {
                    // End previous phase event
                    if (phaseStartDate) {
                        const event = createLunarPhaseEvent(
                            phaseStartDate,
                            new Date(currentDate.getTime() - 86400000), // Day before transition
                            previousPhase
                        );
                        ical.push(event);
                    }
                    
                    // Start new phase
                    phaseStartDate = new Date(currentDate);
                }
                
                // Initialize on first day
                if (previousPhase === null) {
                    phaseStartDate = new Date(currentDate);
                }
                
                previousPhase = currentPhase;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Add last phase of the year
            if (phaseStartDate && previousPhase) {
                const event = createLunarPhaseEvent(phaseStartDate, endDate, previousPhase);
                ical.push(event);
            }
            
            // Add optimal periods (last 2 days of each phase)
            addOptimalPeriodEvents(ical, year);
            
            // Add moon phase milestone events (new moon, full moon, quarters)
            addMoonPhaseEvents(ical, year);
            
            ical.push('END:VCALENDAR');
            return ical.join('\r\n');
        }
        
        // Add moon phase milestone events (new moon, full moon, quarters)
        function addMoonPhaseEvents(ical, year) {
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            
            let currentDate = new Date(startDate);
            let previousPhaseType = null;
            
            // Key phases to track (indices: 0=new, 2=first quarter, 4=full, 6=last quarter)
            const keyPhases = [0, 2, 4, 6];
            
            // Descriptions for each key phase
            const phaseDescriptions = {
                0: 'Nouvelle Lune - D√©but de la phase croissante.\\nBon moment pour planifier les semis.\\nEviter les travaux de jardinage importants.',
                2: 'Premier Quartier - Lune croissante √† 50%.\\nFavorable aux semis de l√©gumes-feuilles.\\nBonne p√©riode pour les greffes.',
                4: 'Pleine Lune - Illumination maximale.\\nR√©coltes optimales (parties a√©riennes).\\nEviter les tailles (s√®ve tr√®s active).',
                6: 'Dernier Quartier - Lune d√©croissante √† 50%.\\nFavorable aux r√©coltes de racines.\\nBon moment pour les conserves.'
            };
            
            while (currentDate <= endDate) {
                const jd = toJulianDay(currentDate);
                const moonPhase = getMoonPhase(jd);
                
                // Check if we've entered a key phase
                if (keyPhases.includes(moonPhase.index) && moonPhase.index !== previousPhaseType) {
                    const uid = `moonphase-${moonPhase.type}-${currentDate.getTime()}@floraquest`;
                    const description = phaseDescriptions[moonPhase.index] || `${moonPhase.name}\\n${moonPhase.illumination}% illumination`;
                    
                    const event = [
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${formatICalDateTime(new Date())}`,
                        `DTSTART;VALUE=DATE:${formatICalDate(currentDate)}`,
                        `DTEND;VALUE=DATE:${formatICalDate(new Date(currentDate.getTime() + 86400000))}`,
                        `SUMMARY:${moonPhase.icon} ${moonPhase.name}`,
                        `DESCRIPTION:${description}`,
                        'CATEGORIES:Lunar Calendar,Moon Phase',
                        'TRANSP:TRANSPARENT',
                        'END:VEVENT'
                    ].join('\r\n');
                    
                    ical.push(event);
                }
                
                previousPhaseType = moonPhase.index;
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }
        
        // Create a lunar phase event for iCal
        function createLunarPhaseEvent(startDate, endDate, phase) {
            const uid = `lunar-${phase}-${startDate.getTime()}@floraquest`;
            const isAscending = phase === 'ascending';
            
            // Get moon phase icons for start and end dates
            const startJD = toJulianDay(startDate);
            const endJD = toJulianDay(endDate);
            const moonPhaseStart = getMoonPhase(startJD);
            const moonPhaseEnd = getMoonPhase(endJD);
            
            // Create summary with moon phase icons
            const summary = isAscending 
                ? `${moonPhaseStart.icon}‚Üí${moonPhaseEnd.icon} ‚Üë Lune Montante (Ascending Moon)`
                : `${moonPhaseStart.icon}‚Üí${moonPhaseEnd.icon} ‚Üì Lune Descendante (Descending Moon)`;
            
            const description = isAscending
                ? `Phase: ${moonPhaseStart.name} ‚Üí ${moonPhaseEnd.name}\\n\\nSap rises in aerial parts.\\n\\nRecommended activities:\\n- Sowing and planting\\n- Grafting\\n- Harvesting fruits\\n- Light soil work`
                : `Phase: ${moonPhaseStart.name} ‚Üí ${moonPhaseEnd.name}\\n\\nSap descends to roots.\\n\\nRecommended activities:\\n- Planting and transplanting\\n- Pruning\\n- Cuttings\\n- Deep soil work\\n- Fertilizing`;
            
            const dtstart = formatICalDate(startDate);
            const dtend = formatICalDate(new Date(endDate.getTime() + 86400000)); // +1 day for all-day event
            const dtstamp = formatICalDateTime(new Date());
            
            return [
                'BEGIN:VEVENT',
                `UID:${uid}`,
                `DTSTAMP:${dtstamp}`,
                `DTSTART;VALUE=DATE:${dtstart}`,
                `DTEND;VALUE=DATE:${dtend}`,
                `SUMMARY:${summary}`,
                `DESCRIPTION:${description}`,
                `CATEGORIES:Lunar Calendar,${isAscending ? 'Ascending' : 'Descending'}`,
                'TRANSP:TRANSPARENT',
                'END:VEVENT'
            ].join('\r\n');
        }
        
        // Add optimal period events (last 2 days before phase transition)
        function addOptimalPeriodEvents(ical, year) {
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            
            let currentDate = new Date(startDate);
            let previousPhase = null;
            
            while (currentDate <= endDate) {
                const jd = toJulianDay(currentDate);
                const moonData = getMoonDeclination(jd);
                const currentPhase = moonData.isAscending ? 'ascending' : 'descending';
                
                // Detect phase transition - mark optimal period 2 days before
                if (previousPhase !== null && previousPhase !== currentPhase) {
                    const optimalStart = new Date(currentDate.getTime() - 2 * 86400000);
                    const optimalEnd = new Date(currentDate.getTime() - 86400000);
                    
                    const isAscending = previousPhase === 'ascending';
                    const uid = `optimal-${previousPhase}-${optimalStart.getTime()}@floraquest`;
                    
                    const summary = isAscending 
                        ? 'üçé Optimal: Fruit pruning'
                        : 'ü™µ Optimal: Construction wood cutting';
                    
                    const description = isAscending
                        ? 'End of ascending moon phase.\\nOptimal period for fruit tree pruning.'
                        : 'End of descending moon phase.\\nOptimal period for cutting construction wood.';
                    
                    const event = [
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${formatICalDateTime(new Date())}`,
                        `DTSTART;VALUE=DATE:${formatICalDate(optimalStart)}`,
                        `DTEND;VALUE=DATE:${formatICalDate(new Date(optimalEnd.getTime() + 86400000))}`,
                        `SUMMARY:${summary}`,
                        `DESCRIPTION:${description}`,
                        'CATEGORIES:Lunar Calendar,Optimal Period',
                        'TRANSP:TRANSPARENT',
                        'END:VEVENT'
                    ].join('\r\n');
                    
                    ical.push(event);
                }
                
                previousPhase = currentPhase;
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }
        
        // Format date for iCal (YYYYMMDD)
        function formatICalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // Format date-time for iCal (YYYYMMDDTHHMMSSZ)
        function formatICalDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
        }
        
        // Populate year selector
        function populateLunarYearSelector() {
            const select = document.getElementById('lunar-year-select');
            if (!select) return;
            
            const currentYear = new Date().getFullYear();
            select.innerHTML = '';
            
            // Add years from current-1 to current+5
            for (let year = currentYear - 1; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }
        
        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function openLightbox(imageUrl) {
            // Simple modal for image viewing
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content bg-dark">
                        <div class="modal-header">
                            <h5 class="modal-title">Image</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageUrl}" class="img-fluid" alt="Plant observation">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
        
        // Unified map controls - update position from inputs
        document.getElementById('update-map')?.addEventListener('click', function() {
            const lat = parseFloat(document.getElementById('lat-display')?.value);
            const lon = parseFloat(document.getElementById('lon-display')?.value);
            if (unifiedMap && lat && lon && !isNaN(lat) && !isNaN(lon)) {
                unifiedMap.setView([lat, lon], 13);
                currentLocation = { latitude: lat, longitude: lon };
                updateUserPositionMarker(lat, lon);
            }
        });
        
        // Get current location using geolocation API
        document.getElementById('get-location')?.addEventListener('click', function() {
            if (navigator.geolocation) {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Localisation...';
                
                navigator.geolocation.getCurrentPosition((position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    const latInput = document.getElementById('lat-display');
                    const lonInput = document.getElementById('lon-display');
                    if (latInput) latInput.value = currentLocation.latitude.toFixed(6);
                    if (lonInput) lonInput.value = currentLocation.longitude.toFixed(6);
                    
                    // Initialize map if not already done
                    if (!unifiedMap) {
                        const mapEl = document.getElementById('unified-map');
                        if (mapEl) {
                            initializeUnifiedMap();
                        }
                    }
                    
                    // Update position marker if map exists
                    if (unifiedMap) {
                        unifiedMap.setView([currentLocation.latitude, currentLocation.longitude], 13);
                        updateUserPositionMarker(currentLocation.latitude, currentLocation.longitude);
                    }
                    
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, (error) => {
                    console.error('Geolocation error:', error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    showErrorModal(
                        'Impossible d\'obtenir votre position g√©ographique.<br><br>' +
                        'V√©rifiez que :<br>' +
                        '‚Ä¢ La g√©olocalisation est activ√©e dans les param√®tres de votre navigateur<br>' +
                        '‚Ä¢ Vous avez autoris√© l\'acc√®s √† votre position pour ce site<br>' +
                        '‚Ä¢ Votre appareil/GPS est activ√©',
                        'Erreur de g√©olocalisation'
                    );
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                } else {
                showWarningModal(
                    'La g√©olocalisation n\'est pas support√©e par votre navigateur.<br><br>Vous pouvez toujours saisir manuellement vos coordonn√©es dans les champs Latitude/Longitude.',
                    'G√©olocalisation non support√©e'
                );
            }
        });
        
        // Unified map controls - from map buttons
        document.getElementById('map-get-location')?.addEventListener('click', function() {
            document.getElementById('get-location')?.click();
        });
        
        document.getElementById('map-load-events')?.addEventListener('click', function() {
            if (unifiedMap) {
                loadMapEvents();
                } else {
                initializeUnifiedMap();
                }
        });
        
        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            const yearEl = document.getElementById('current-year');
            if (yearEl) yearEl.textContent = new Date().getFullYear();
            
            // Initialize lunar calendar in header
            initializeLunarCalendar();
            
            // Initialize weekly preview for selected production style
            if (typeof initializePreview === 'function') {
                initializePreview();
            }
            
            // Initialize inventory type filters
            initInventoryFilters();
            
            // Setup lunar calendar collapse toggle
            const lunarCollapse = document.getElementById('lunar-calendar-collapse');
            const lunarToggle = document.getElementById('lunar-calendar-toggle');
            const lunarHeader = document.getElementById('lunar-calendar-header');
            if (lunarCollapse && lunarToggle && lunarHeader) {
                lunarCollapse.addEventListener('show.bs.collapse', function() {
                    lunarToggle.innerHTML = '<i class="bi bi-chevron-up"></i> Masquer';
                    lunarHeader.style.padding = '1rem';
                });
                lunarCollapse.addEventListener('hide.bs.collapse', function() {
                    lunarToggle.innerHTML = '<i class="bi bi-chevron-down"></i> Afficher';
                    lunarHeader.style.padding = '0.5rem 1rem';
                });
                // Set initial padding based on current state
                if (!lunarCollapse.classList.contains('show')) {
                    lunarHeader.style.padding = '0.5rem 1rem';
                }
            }
            
            
            // Populate lunar year selector for download
            populateLunarYearSelector();
            
            // Check if user is already connected (from common.js)
            // Wait a bit for common.js to initialize
            setTimeout(() => {
                const currentUserPubkey = getUserPubkey();
                const currentIsConnected = getIsNostrConnected();
                if (currentUserPubkey && currentIsConnected) {
                    updateNostrUI(true);
                } else {
                    updateNostrUI(false);
                }
            }, 500);
            
            // Initialize gallery (loads public observations even if not connected)
            if (getUserPubkey()) {
                loadUserStats();
            } else {
                loadPublicGallery();
            }
            
            // Initialize USPOT API detection if available
            if (typeof detectUSPOTAPI === 'function') {
                detectUSPOTAPI();
            }
            
            // Initialize mini map if location is available
            if (navigator.geolocation && typeof L !== 'undefined') {
                navigator.geolocation.getCurrentPosition((position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    const latInput = document.getElementById('lat-display');
                    const lonInput = document.getElementById('lon-display');
                    if (latInput) latInput.value = currentLocation.latitude.toFixed(2);
                    if (lonInput) lonInput.value = currentLocation.longitude.toFixed(2);
                    
                    // Initialize unified map if not already done
                    if (!unifiedMap) {
                        const mapEl = document.getElementById('unified-map');
                        if (mapEl) {
                            initializeUnifiedMap();
                        }
                    }
                    
                    // Update position marker if map exists
                    if (unifiedMap) {
                        unifiedMap.setView([currentLocation.latitude, currentLocation.longitude], 13);
                        updateUserPositionMarker(currentLocation.latitude, currentLocation.longitude);
                    }
                }, (error) => {
                    console.error('Geolocation error:', error);
                    showErrorModal(
                        'Impossible d\'obtenir votre position g√©ographique.<br><br>V√©rifiez que la g√©olocalisation est activ√©e dans les param√®tres de votre navigateur.',
                        'Erreur de g√©olocalisation'
                    );
                });
            }
            
            // Initialize unified map on page load (since overview tab is active by default)
            setTimeout(() => {
                const mapContainer = document.getElementById('ore-map-container');
                if (mapContainer && mapContainer.style.display !== 'none') {
                    initializeUnifiedMap();
                }
            }, 1000);
            
            // Setup Bootstrap tab event listeners
            const tabButtons = document.querySelectorAll('#mainTabs button[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    const sectionName = targetId.replace('#section-', '');
                    
                    // Update mobile menu active state
                    const mobileNavLinks = document.querySelectorAll('#navbarNav .navbar-nav .nav-link');
                    mobileNavLinks.forEach(link => {
                        link.classList.remove('active');
                        const linkSection = link.getAttribute('onclick');
                        if (linkSection && linkSection.includes(`scrollToSection('${sectionName}')`)) {
                            link.classList.add('active');
                        }
                    });
                    
                    // Load content when tab is shown
                    if (sectionName === 'overview') {
                        setTimeout(() => {
                            const mapContainer = document.getElementById('ore-map-container');
                            if (mapContainer && mapContainer.style.display !== 'none') {
                                if (!unifiedMap) {
                                    initializeUnifiedMap();
                                } else {
                                    loadMapEvents();
                                }
                            }
                        }, 300);
                    } else if (sectionName === 'gallery') {
                        setTimeout(() => {
                            if (getUserPubkey()) {
                                loadUserStats();
                            } else {
                                loadPublicGallery();
                            }
                        }, 200);
                    }
                });
            });
            
            // Update active nav on initial load (now handled by Bootstrap tabs)
            // updateActiveNavItem(); // No longer needed with Bootstrap tabs
            
            // Check Nostr extension availability
            setTimeout(() => {
                const navMenuConnect = document.getElementById('nav-menu-connect');
                if (navMenuConnect) {
                    if (typeof window.nostr === 'undefined' || typeof window.nostr.getPublicKey !== 'function') {
                        navMenuConnect.disabled = true;
                        navMenuConnect.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Extension requise';
                        navMenuConnect.className = 'btn btn-outline-secondary me-2';
                    }
                }
            }, 1000);
        });
    </script>
</body>
</html>


