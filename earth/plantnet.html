<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Flora Quest - Collect & Protect with ORE</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="fonts/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="leaflet.css"/>
    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="bootstrap.bundle.min.js"></script>
    
    <!-- Nostr integration -->
    <script src="nostr.bundle.js"></script>
    <!-- Common UPlanet JavaScript -->
    <script src="common.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="leaflet.js"></script>
    
    <style>
        :root {
            --bs-primary: #4ade80;
            --bs-success: #22c55e;
            --bs-warning: #fbbf24;
            --bs-dark: #0f172a;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #e8e8e8;
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(15, 23, 42, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(74, 222, 128, 0.3);
        }
        
        .navbar-brand {
            color: #4ade80 !important;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: #cbd5e1 !important;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #4ade80 !important;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 8px;
        }
        
        .card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 15px;
            color: #e8e8e8;
        }
        
        .card-header {
            background: rgba(74, 222, 128, 0.1);
            border-bottom: 1px solid rgba(74, 222, 128, 0.3);
            color: #4ade80;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
        }
        
        .btn-outline-primary {
            border-color: #4ade80;
            color: #4ade80;
        }
        
        .btn-outline-primary:hover {
            background: #4ade80;
            border-color: #4ade80;
            color: #0f172a;
        }
        
        .progress {
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #fbbf24);
            border-radius: 15px;
        }
        
        .badge {
            font-size: 0.9rem;
            padding: 0.5em 0.75em;
        }
        
        .section-anchor {
            scroll-margin-top: 100px;
        }

        /* Lunar Calendar Styles */
        .lunar-calendar-header {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 2px solid rgba(74, 222, 128, 0.3);
            padding: 10px 0;
            position: sticky;
            top: 56px;
            z-index: 998;
            transition: padding 0.3s ease;
        }
        
        /* Thinner header when collapsed */
        .lunar-calendar-header:has(#lunar-calendar-collapse:not(.show)) {
            padding: 4px 0;
        }
        
        .lunar-calendar-header:has(#lunar-calendar-collapse.collapse:not(.show)) {
            padding: 4px 0;
        }

        .lunar-status {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Lunar calendar toggle button */
        #lunar-calendar-toggle {
            transition: all 0.3s ease;
        }
        
        #lunar-calendar-toggle .bi-chevron-up {
            transition: transform 0.3s ease;
        }
        
        #lunar-calendar-toggle[aria-expanded="false"] .bi-chevron-up {
            transform: rotate(180deg);
        }

        .lunar-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lunar-status-indicator.montante {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.2));
            border: 1px solid rgba(74, 222, 128, 0.5);
            color: #4ade80;
        }

        .lunar-status-indicator.descendante {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #3b82f6;
        }

        .lunar-timeline {
            position: relative;
            height: 60px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            margin: 10px 0;
            padding: 5px;
            overflow: hidden;
        }

        .lunar-timeline-bar {
            height: 100%;
            border-radius: 25px;
            position: relative;
            display: flex;
            transition: all 0.3s ease;
        }
        
        .lunar-period {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .lunar-period:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .lunar-period.montante {
            background: linear-gradient(to bottom, rgba(74, 222, 128, 0.3), rgba(74, 222, 128, 0.1));
        }

        .lunar-period.descendante {
            background: linear-gradient(to bottom, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.1));
        }

        .lunar-period.optimal {
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            border: 2px solid rgba(251, 191, 36, 0.8);
        }

        .lunar-period.today {
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        .lunar-day-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2px;
        }

        .lunar-action-icon {
            font-size: 1rem;
            margin-top: 2px;
        }

        .lunar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            color: #e8e8e8;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(74, 222, 128, 0.3);
            font-size: 0.85rem;
            white-space: nowrap;
            margin-bottom: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .lunar-period:hover .lunar-tooltip {
            opacity: 1;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .gallery-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .gallery-item:hover {
            transform: scale(1.05);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-icon {
                font-size: 2.5em;
            display: block;
            margin-bottom: 10px;
            }
            
            .stat-value {
                font-size: 2em;
            font-weight: bold;
            color: #4ade80;
            display: block;
        }
        
        /* Improved text colors for better readability */
        .stat-card .text-muted,
        .stat-card span.text-muted {
            color: #cbd5e1 !important; /* Light gray instead of muted */
            font-weight: 500;
        }
        
        .ore-progress-text {
            color: #e2e8f0 !important; /* Very light gray for better contrast */
            font-weight: 500;
        }
        
        .plant-observation-text {
            color: #e2e8f0 !important; /* Light text for overlays */
        }
        
        /* Gallery overlay text improvements */
        .gallery-item .overlay {
            color: #e2e8f0 !important;
        }
        
        .gallery-item .overlay .small {
            color: #f1f5f9 !important; /* Even lighter for small text */
        }
        
        /* Modal viewer styles */
        #profile-viewer-modal .modal-content,
        #message-viewer-modal .modal-content {
            min-height: 80vh;
        }
        
        #profile-viewer-modal iframe,
        #message-viewer-modal iframe {
            border-radius: 0 0 15px 15px;
        }
        
        #profile-viewer-modal .modal-body,
        #message-viewer-modal .modal-body {
            overflow: hidden;
            }
            
            .photo-upload {
            border: 2px dashed rgba(74, 222, 128, 0.5);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(74, 222, 128, 0.05);
        }
        
        .photo-upload:hover {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        #unified-map {
            border-radius: 12px;
        }
        
        /* User position marker styles */
        .user-position-marker {
            background: transparent !important;
            border: none !important;
        }
        
        /* Map control buttons */
        #map-get-location, #map-load-events {
            transition: all 0.2s ease;
        }
        
        #map-get-location:hover, #map-load-events:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
        }
        
        @media (max-width: 768px) {
            .navbar-collapse {
                background: rgba(15, 23, 42, 0.98);
            border-radius: 10px;
                padding: 10px;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bootstrap -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-flower1"></i> FLORA QUEST</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#section-overview" onclick="scrollToSection('overview'); return false;">
                            <i class="bi bi-bar-chart"></i> Atlas
                        </a>
                    </li>
                    <!-- Map section removed - now embedded in Overview -->
                    <li class="nav-item">
                        <a class="nav-link" href="#section-gallery" onclick="scrollToSection('gallery'); return false;">
                            <i class="bi bi-images"></i> Galerie
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#section-share" onclick="scrollToSection('share'); return false;">
                            <i class="bi bi-camera"></i> Ajouter
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#section-calendar" onclick="scrollToSection('calendar'); return false;">
                            <i class="bi bi-calendar"></i> Calendrier
                        </a>
                    </li>
                </ul>
                <div id="nostr-header-actions">
                    <button class="btn btn-outline-primary me-2" id="nav-menu-connect" onclick="handleNostrLogin()">
                        <i class="bi bi-key"></i> Connexion
                    </button>
                    <a class="btn btn-outline-success me-2" id="nav-link-profile" href="#" onclick="openProfile(); return false;" style="display: none;">
                        <i class="bi bi-person"></i> Mon Profil
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Lunar Calendar Header -->
    <div class="lunar-calendar-header" id="lunar-calendar-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="lunar-status-indicator" id="lunar-status-indicator">
                    <i class="bi bi-moon-stars"></i>
                    <span id="lunar-status-text">Chargement...</span>
                </div>
                <button class="btn btn-sm btn-outline-success" type="button" data-bs-toggle="collapse" data-bs-target="#lunar-calendar-collapse" aria-expanded="true" aria-controls="lunar-calendar-collapse" id="lunar-calendar-toggle">
                    <i class="bi bi-chevron-up"></i> Masquer
                </button>
            </div>
            <div class="collapse show" id="lunar-calendar-collapse">
                <div class="lunar-timeline" id="lunar-timeline">
                    <div class="lunar-timeline-bar" id="lunar-timeline-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid" style="padding-top: 150px;">
    <div class="container">
            
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-success mb-3">
                    <i class="bi bi-flower1"></i> FLORA QUEST
                </h1>
                <p class="lead text-warning">Reconnaissez les plantes ‚Ä¢ Activez les contrats ORE ‚Ä¢ Gagnez des r√©compenses</p>
            </div>

            <!-- Section: Overview - Concours ORE -->
            <section id="section-overview" class="section-anchor mb-5">
                <!-- Concours ORE Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="mb-0"><i class="bi bi-trophy"></i> CONCOURS ORE - Reconnaissance de Plantes</h2>
                        <p class="mb-0 mt-2" style="font-size: 0.9em; opacity: 0.8;">R√©pertoriez 8 plantes pour activer un contrat ORE et d√©bloquer les r√©compenses !</p>
                    </div>
                    <div class="card-body">
                        <!-- Section: Map - ORE UMAPs (moved here) -->
                        <div class="card mb-4" style="background: rgba(15, 23, 42, 0.6);">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(74, 222, 128, 0.15);">
                                <h3 class="mb-0"><i class="bi bi-geo-alt"></i> CARTE ORE - UMAPs avec Plantes</h3>
                                <button class="btn btn-outline-primary btn-sm" id="toggle-ore-map-btn" onclick="toggleOREMapView()">
                                    <i class="bi bi-x-square"></i> Masquer la Carte
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <strong><i class="bi bi-info-circle"></i> UMAPs avec contrats ORE actifs:</strong> <span id="ore-umap-count">0</span>
                                <button class="btn btn-sm btn-outline-primary float-end" onclick="loadMapEvents()">
                                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                                </button>
                                </div>
                                <div class="mb-3 p-3" style="background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
                                    <h6 class="text-success mb-2"><i class="bi bi-info-circle"></i> Types de messages affich√©s sur la carte:</h6>
                                    <ul class="mb-0 small" style="color: #cbd5e1;">
                                        <li><span class="badge bg-orange" style="background-color: #f97316;">üîµ</span> <strong style="color: #e8e8e8;">Observations</strong> (kind 1 avec tags #BRO #plantnet) - Demandes de reconnaissance</li>
                                        <li><span class="badge bg-success">üü¢</span> <strong style="color: #e8e8e8;">Plantes reconnues</strong> (kind 1 avec tags #UPlanet #plantnet) - R√©ponses avec identification</li>
                                        <li><span class="badge bg-info" style="background-color: #0ea5e9;">üìç</span> <strong style="color: #e8e8e8;">DID UMAP</strong> (kind 30800) - Identit√©s d√©centralis√©es des parcelles</li>
                                        <li><span class="badge bg-warning" style="background-color: #fbbf24;">üèÜ</span> <strong style="color: #e8e8e8;">Contrat ORE actif</strong> (kind 30312) - UMAP avec engagement environnemental</li>
                                    </ul>
                                </div>
                                <div id="ore-map-container" style="display: block;">
                                    <!-- Unified map for events and position selection -->
                                    <div id="unified-map" style="height: 600px; width: 100%; border-radius: 10px;"></div>
                                    <div class="mt-2 mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-sm btn-outline-success" id="map-get-location" title="Centrer sur ma position">
                                                <i class="bi bi-crosshair"></i> Ma position
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" id="map-load-events" title="Recharger les √©v√©nements">
                                                <i class="bi bi-arrow-clockwise"></i> Actualiser
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i> Cliquez sur la carte pour ajuster votre position
                                        </small>
                                    </div>
                                    <div class="mt-3">
                                        <h5><i class="bi bi-gift"></i> L√©gende des R√©compenses ORE:</h5>
                                        <div class="row g-2">
                                            <div class="col-md-3">
                                                <div class="card border-success">
                                                    <div class="card-body p-2">
                                        <strong>Base:</strong> 0,5 ·∫êen par observation
                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card border-success">
                                                    <div class="card-body p-2">
                                        <strong>Esp√®ces:</strong> +1 ·∫êen par esp√®ce unique
                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card border-warning">
                                                    <div class="card-body p-2">
                                        <strong>Biodiversit√©:</strong> +10-100 ·∫êen bonus
                                    </div>
                                    </div>
                                </div>
                                            <div class="col-md-3">
                                                <div class="card border-primary">
                                                    <div class="card-body p-2">
                                                        <strong>Engagement:</strong> +25-50 ·∫êen communaut√©
                        </div>
                    </div>
                </div>
                    </div>
                </div>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h4 class="text-success mb-1"><i class="bi bi-flower2"></i> Plantes r√©pertori√©es</h4>
                                    <p class="ore-progress-text mb-0">
                                        <span id="ore-progress-count" class="text-warning fw-bold">0</span> <span class="text-white">/ 8</span> <span class="text-white-50">plantes n√©cessaires pour activer le contrat ORE</span>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="display-4 fw-bold text-warning mb-0">
                                        <span id="ore-progress-percent">0</span>%
                                    </div>
                                    <small class="text-muted">Progression</small>
                                </div>
                            </div>
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                                     id="ore-progress-bar" style="width: 0%">
                                    <span id="ore-progress-text">0 / 8</span>
                                </div>
                            </div>
                            <div class="alert alert-info mb-0" id="ore-status-message" role="alert">
                                <i class="bi bi-camera"></i> <strong>Commencez !</strong> Prenez une photo de plante pour participer.
                            </div>
                        </div>

                        <!-- Steps Grid -->
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="border-left: 4px solid #4ade80;">
                                    <div class="card-body text-center">
                                        <div class="fs-1 mb-3"><i class="bi bi-camera"></i></div>
                                        <h5 class="text-success">1. Reconnaissez</h5>
                                        <p class="small mb-0">Prenez une photo de plante. PlantNet identifiera automatiquement l'esp√®ce.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="border-left: 4px solid #fbbf24;">
                                    <div class="card-body text-center">
                                        <div class="fs-1 mb-3"><i class="bi bi-cash-coin"></i></div>
                                        <h5 class="text-warning">2. Gagnez</h5>
                                        <p class="small mb-0">Chaque plante r√©pertori√©e rapporte des ·∫êen. Plus vous contribuez, plus vous gagnez !</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="border-left: 4px solid #6366f1;">
                                    <div class="card-body text-center">
                                        <div class="fs-1 mb-3"><i class="bi bi-tree"></i></div>
                                        <h5 class="text-primary">3. Activez ORE</h5>
                                        <p class="small mb-0">√Ä 8 plantes, le contrat ORE s'active. Les primes deviennent effectives !</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card h-100" style="border-left: 4px solid #ec4899;">
                                    <div class="card-body text-center">
                                        <div class="fs-1 mb-3"><i class="bi bi-people"></i></div>
                                        <h5 style="color: #ec4899;">4. Toile de Confiance</h5>
                                        <p class="small mb-0">Les participants deviennent "Explorateurs" et "Jardiniers" dans le syst√®me Oracle.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- How it works -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-question-circle"></i> Comment √ßa marche ?</h3>
                    </div>
                    <div class="card-body">
                        <p class="lead"><strong>Pas besoin de permis</strong> pour participer ! Chaque photo de plante que vous partagez :</p>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Est automatiquement identifi√©e</strong> par PlantNet</li>
                            <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Est associ√©e √† votre UMAP</strong> (zone g√©ographique)</li>
                            <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Vous rapporte des ·∫êen</strong> imm√©diatement</li>
                            <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Contribue au concours</strong> pour activer le contrat ORE</li>
                        </ul>
                    </div>
        </div>
        
        <!-- Stats Dashboard -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-icon">üåø</div>
                <span class="stat-value" id="total-plants">0</span>
                            <span class="text-muted">Plants Cataloged</span>
            </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-icon">üìç</div>
                <span class="stat-value" id="total-umaps">0</span>
                            <span class="text-muted">UMAPs Explored</span>
            </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-icon">üèÜ</div>
                <span class="stat-value" id="total-badges">0/8</span>
                            <span class="text-muted">Achievements</span>
            </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-icon">üíé</div>
                <span class="stat-value" id="ore-potential">0</span>
                            <span class="text-muted">ORE Contribution</span>
                        </div>
            </div>
        </div>
        
        <!-- Oracle Badges (NIP-58) - will be shown dynamically if user is connected -->
        <div class="card mb-4" id="oracle-badges-section" style="display: none;">
            <div class="card-header">
                <h3 class="mb-0"><i class="bi bi-award-fill"></i> Badges Oracle NIP-58</h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle"></i> 
                    Badges de comp√©tences valid√©es par le syst√®me Oracle (Web of Trust)
                </p>
                <div id="oracle-badges-container" style="min-height: 100px;">
                    <div style="text-align: center; color: #94a3b8;">
                        <i class="bi bi-hourglass-split"></i> Chargement des badges Oracle...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Achievement Badges -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-award"></i> COLLECTION ACHIEVEMENTS</h3>
                </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-first">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üå±</div>
                                        <div class="fw-bold">First Step</div>
                                        <small class="text-muted">0/1</small>
                </div>
                </div>
                </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-explorer">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üîç</div>
                                        <div class="fw-bold">Explorer</div>
                                        <small class="text-muted">0/10</small>
                </div>
                </div>
                </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-botanist">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üå∫</div>
                                        <div class="fw-bold">Botanist</div>
                                        <small class="text-muted">0/50</small>
                </div>
            </div>
        </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-master">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üå≥</div>
                                        <div class="fw-bold">Master</div>
                                        <small class="text-muted">0/100</small>
            </div>
                        </div>
                    </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-pioneer">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üöÄ</div>
                                        <div class="fw-bold">Pioneer</div>
                                        <small class="text-muted">‚úì</small>
                    </div>
                </div>
                    </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-guardian">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üõ°Ô∏è</div>
                                        <div class="fw-bold">Guardian</div>
                                        <small class="text-muted">ORE</small>
                        </div>
                        </div>
                        </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-nomad">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">üåç</div>
                                        <div class="fw-bold">Nomad</div>
                                        <small class="text-muted">0/5</small>
                        </div>
                    </div>
                </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center badge locked" id="badge-legend">
                                    <div class="card-body">
                                        <div class="fs-1 mb-2">‚≠ê</div>
                                        <div class="fw-bold">Legend</div>
                                        <small class="text-muted">TOP 1%</small>
            </div>
        </div>
            </div>
        </div>
                </div>
            </div>
            </section>

            <!-- Section: Map - ORE UMAPs (moved to Overview section above) -->
            <!-- This section is now embedded in the Overview section -->

            <!-- Section: Gallery -->
            <section id="section-gallery" class="section-anchor mb-5">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-images"></i> Plantes R√©pertori√©es</h3>
                        <p class="mb-0 mt-2" style="font-size: 0.9em; opacity: 0.8;">D√©couvrez toutes les plantes identifi√©es dans votre r√©gion</p>
                </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="text-success mb-1"><i class="bi bi-flower2"></i> <span id="gallery-title">Plantes Identifi√©es</span></h5>
                                <p class="text-muted mb-0"><span id="gallery-count">0</span> plante(s) r√©pertori√©e(s)</p>
                </div>
                            <button class="btn btn-primary" onclick="scrollToSection('share')" id="gallery-add-btn">
                                <i class="bi bi-plus-circle"></i> Ajouter une Plante
                            </button>
                </div>
                        <div id="gallery-grid" class="gallery-grid">
                            <div id="gallery-empty" class="text-center py-5" style="grid-column: 1 / -1; display: none;">
                                <div class="fs-1 mb-3"><i class="bi bi-flower1"></i></div>
                                <p class="lead">Aucune plante r√©pertori√©e pour le moment.</p>
                                <p class="text-muted">Commencez par ajouter votre premi√®re plante !</p>
            </div>
                    </div>
                            </div>
                            </div>
            </section>

            <!-- Section: Share - Ajouter une plante -->
            <section id="section-share" class="section-anchor mb-5">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-camera"></i> Ajouter une Plante</h3>
                        <p class="mb-0 mt-2" style="font-size: 0.9em; opacity: 0.8;">Prenez une photo et laissez PlantNet identifier l'esp√®ce automatiquement</p>
                        </div>
                    <div class="card-body">
                        <div class="alert alert-warning" id="nostr-message-section" style="display: none;">
                            <h5 class="alert-heading"><i class="bi bi-key"></i> Connexion requise</h5>
                            <p class="mb-0">Connectez-vous avec Nostr pour participer</p>
                            <button class="btn btn-primary mt-2" id="nostrLoginBtn" onclick="handleNostrLogin()" style="display: none;">Nostr Connect</button>
                        </div>

                        <div id="nostr-message-form" style="display: none;">
                            <div class="mb-3">
                                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                                    <div id="photoUploadText"><i class="bi bi-camera fs-1"></i><br>Ajouter une photo</div>
                                    <img id="photoPreview" class="photo-preview" style="display: none;">
                                </div>
                                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoUpload(event)">
                                </div>
                            
                            <div class="mb-3">
                                <label for="messageText" class="form-label">Description (optionnel)</label>
                                <textarea class="form-control" id="messageText" rows="3" placeholder="D√©crivez la plante ou ajoutez des observations..."></textarea>
                                </div>
                            
                            <button class="btn btn-primary btn-lg w-100" id="sendMessageBtn" onclick="sendGeolocatedMessage()" disabled>
                                <i class="bi bi-send"></i> Partager l'observation
                            </button>
                            <p class="text-muted text-center mt-2 small" id="send-message-hint">
                                <i class="bi bi-info-circle"></i> Connectez-vous pour partager une observation
                            </p>
                            <style>
                                #sendMessageBtn:disabled {
                                    opacity: 0.5;
                                    cursor: not-allowed;
                                }
                            </style>
                            
                            <div class="mt-3">
                                <div id="locationInfo" class="alert alert-info" style="display: none;">
                                    <strong><i class="bi bi-geo-alt"></i> Position:</strong> <span id="locationText"></span>
                            </div>
                                <div id="plantnetResult" class="alert alert-success" style="display: none;">
                                    <strong><i class="bi bi-flower2"></i> PlantNet:</strong> <span id="plantnetText"></span>
                        </div>
                    </div>

                            <!-- Location Controls -->
                            <div class="accordion mt-3" id="locationAccordion">
                                <div class="accordion-item" style="background: rgba(255, 255, 255, 0.05); border-color: rgba(74, 222, 128, 0.3);">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#locationCollapse">
                                            <i class="bi bi-geo-alt"></i> Localisation
                                        </button>
                                    </h2>
                                    <div id="locationCollapse" class="accordion-collapse collapse" data-bs-parent="#locationAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-2 mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label">Latitude</label>
                                                    <input type="number" class="form-control" id="lat-display" step="0.000001" min="-90" max="90" value="48.86" placeholder="Latitude">
                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Longitude</label>
                                                    <input type="number" class="form-control" id="lon-display" step="0.000001" min="-180" max="180" value="2.35" placeholder="Longitude">
            </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <div class="btn-group w-100">
                                                        <button type="button" class="btn btn-outline-primary" id="update-map">Y aller</button>
                                                        <button type="button" class="btn btn-outline-secondary" id="get-location">Ma position</button>
        </div>
            </div>
                </div>
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle"></i> <strong>Position de la carte</strong><br>
                                                <small>Utilisez la carte principale ci-dessus pour s√©lectionner et ajuster votre position. Les coordonn√©es seront automatiquement mises √† jour.</small>
                    </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
                </div>
            </section>

            <!-- Section: Calendar -->
            <section id="section-calendar" class="section-anchor mb-5">
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-moon"></i> Lune Montante</h5>
                            </div>
                            <div class="card-body">
                <p><strong>La s√®ve monte</strong> dans les parties a√©riennes de la plante.</p>
                <ul>
                    <li>Semis et plantations</li>
                    <li>Greffes</li>
                    <li>R√©colte des fruits et l√©gumes-fruits</li>
                    <li>Travail du sol l√©ger</li>
                </ul>
            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-moon-fill"></i> Lune Descendante</h5>
                            </div>
                            <div class="card-body">
                <p><strong>La s√®ve redescend</strong> vers les racines.</p>
                <ul>
                    <li>Plantation et repiquage</li>
                    <li>Tailles et √©lagages</li>
                    <li>Bouturages</li>
                    <li>Travail du sol profond</li>
                    <li>Apports d'engrais</li>
                </ul>
            </div>
        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-calendar3"></i> Calendrier Lunaire de l'Ann√©e <span id="current-year"></span></h3>
                    </div>
                    <div class="card-body">
            <div id="calendar-table-container"></div>
                        <div class="mt-3">
                            <h5>Exporter le Calendrier</h5>
                            <p class="text-muted">T√©l√©chargez le calendrier lunaire complet au format iCal pour l'importer dans votre application de calendrier.</p>
                            <button class="btn btn-outline-primary" onclick="generateICalFile()">
                                <i class="bi bi-download"></i> T√©l√©charger le fichier .ics
                            </button>
        </div>
        </div>
                </div>
            </section>

        </div>
    </div>

    <script>
        // ========================================
        // SIDEBAR NAVIGATION SYSTEM (Simplified for Bootstrap)
        // ========================================
        function scrollToSection(sectionName) {
            const section = document.getElementById(`section-${sectionName}`);
            if (section) {
                // Update active nav item
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const activeLink = document.querySelector(`a[href="#section-${sectionName}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                
                // Close mobile menu
                const navbarCollapse = document.getElementById('navbarNav');
                if (navbarCollapse.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(navbarCollapse);
                    bsCollapse.hide();
                }
                
                // Smooth scroll
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                // Special handling for overview section (contains map now)
                if (sectionName === 'overview') {
                    setTimeout(() => {
                        const mapContainer = document.getElementById('ore-map-container');
                        if (mapContainer && mapContainer.style.display !== 'none') {
                            if (!unifiedMap) {
                                initializeUnifiedMap();
                            } else {
                                // Refresh data if map already exists
                                loadMapEvents();
                            }
                        }
                    }, 500);
                } else if (sectionName === 'gallery') {
                    // Load gallery even if not connected
                    setTimeout(() => {
                        if (getUserPubkey()) {
                            loadUserStats();
                        } else {
                            loadPublicGallery();
                        }
                    }, 200);
                }
            }
        }
        
        // Update active nav on scroll
        function updateActiveNavItem() {
            const sections = document.querySelectorAll('[id^="section-"]');
            const navLinks = document.querySelectorAll('.nav-link');
            let currentSection = '';
            const scrollPos = window.scrollY + 150;
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;
                const sectionId = section.id.replace('section-', '');
                
                if (scrollPos >= sectionTop && scrollPos < sectionTop + sectionHeight) {
                    currentSection = sectionId;
                }
            });
            
            if (currentSection) {
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#section-${currentSection}`) {
                        link.classList.add('active');
                    }
                });
            }
        }
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(updateActiveNavItem, 100);
        });
        
        // ========================================
        // PLANTNET SPECIFIC VARIABLES
        // ========================================
        let currentLocation = null;
        let selectedPhoto = null;
        
        // Message navigation variables
        let fetchedMessages = [];
        let currentMessageIndex = 0;
        const MESSAGES_PER_PAGE = 20;

        // User stats
        let userStats = {
            plantsCount: 0,
            umapsCount: 0,
            badges: {
                first: false,
                explorer: false,
                botanist: false,
                master: false,
                pioneer: false,
                guardian: false,
                nomad: false,
                legend: false
            }
        };
        
        // NOSTR variables are declared in common.js
        // Use references without redeclaring to avoid "redeclaration" errors
        // These will be available after common.js loads
        const getNostrRelay = () => window.nostrRelay || null;
        const getIsNostrConnected = () => window.isNostrConnected !== undefined ? window.isNostrConnected : false;
        const getUserPubkey = () => window.userPubkey || null;
        
        // Helper functions to get/set these values
        const setNostrRelay = (value) => { window.nostrRelay = value; };
        const setIsNostrConnected = (value) => { window.isNostrConnected = value; };
        const setUserPubkey = (value) => { window.userPubkey = value; };
        
        // Map variables - unified map
        let unifiedMap = null;
        let mapMarkers = [];
        let userPositionMarker = null;
        
        // ========================================
        // ORE PROGRESS FUNCTIONS
        // ========================================
        function calculateOREProgress(events) {
            if (!events || events.length === 0) {
                return { count: 0, percent: 0, umap: null };
            }
            
            const umapCounts = {};
            events.forEach(event => {
                const geoTag = event.tags?.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const umapKey = geoTag[1];
                    umapCounts[umapKey] = (umapCounts[umapKey] || 0) + 1;
                }
            });
            
            let maxCount = 0;
            let currentUmap = null;
            for (const [umap, count] of Object.entries(umapCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    currentUmap = umap;
                }
            }
            
            if (currentLocation) {
                const currentUmapKey = `${currentLocation.latitude.toFixed(2)},${currentLocation.longitude.toFixed(2)}`;
                if (umapCounts[currentUmapKey]) {
                    maxCount = umapCounts[currentUmapKey];
                    currentUmap = currentUmapKey;
                }
            }
            
            const percent = Math.min((maxCount / 8) * 100, 100);
            
            return {
                count: maxCount,
                percent: Math.round(percent),
                umap: currentUmap,
                allUmaps: umapCounts
            };
        }
        
        function updateOREProgress(progress) {
            const countEl = document.getElementById('ore-progress-count');
            const percentEl = document.getElementById('ore-progress-percent');
            const barEl = document.getElementById('ore-progress-bar');
            const textEl = document.getElementById('ore-progress-text');
            const statusEl = document.getElementById('ore-status-message');
            
            if (countEl) countEl.textContent = progress.count;
            if (percentEl) percentEl.textContent = progress.percent;
            if (barEl) barEl.style.width = `${progress.percent}%`;
            if (textEl) textEl.textContent = `${progress.count} / 8`;
            
            if (statusEl) {
                if (progress.count >= 8) {
                    statusEl.className = 'alert alert-success';
                    statusEl.innerHTML = '<i class="bi bi-check-circle"></i> <strong>Contrat ORE activ√© !</strong> Les primes sont maintenant effectives.';
                } else if (progress.count >= 5) {
                    statusEl.className = 'alert alert-warning';
                    statusEl.innerHTML = `<i class="bi bi-fire"></i> <strong>Presque l√† !</strong> Plus que ${8 - progress.count} plante(s) pour activer le contrat ORE.`;
                } else if (progress.count > 0) {
                    statusEl.className = 'alert alert-info';
                    statusEl.innerHTML = `üí™ <strong>Continuez !</strong> ${8 - progress.count} plante(s) restante(s) pour activer le contrat ORE.`;
                } else {
                    statusEl.className = 'alert alert-info';
                    statusEl.innerHTML = '<i class="bi bi-camera"></i> <strong>Commencez !</strong> Prenez une photo de plante pour participer au concours.';
                }
            }
        }
        
        // ========================================
        // USER STATS FUNCTIONS
        // ========================================
        async function loadUserStats() {
            const currentUserPubkey = getUserPubkey();
            if (!currentUserPubkey) {
                console.log('‚è≥ No user logged in yet, stats will load after connection');
                // Load public gallery even without connection
                await loadPublicGallery();
                return;
            }
            
            console.log('üåø Loading flora stats from NOSTR...');
            
            try {
                // Ensure relay is connected
                const currentRelay = getNostrRelay();
                if (!currentRelay) {
                    console.log('üîå Connecting to relay...');
                    await connectToRelay();
                }
                
                // Fetch confirmed identifications (bot responses with UPlanet + plantnet) for stats only
                const nostrStats = await fetchUserFloraStats(currentUserPubkey);
                
                // Fetch ONLY user's observations (BRO + plantnet) for gallery images
                const userObservations = await fetchUserObservations(currentUserPubkey);
                
                userStats.plantsCount = nostrStats.plantsCount;
                userStats.umapsCount = nostrStats.umapsCount;
                
                const badgeResults = calculateFloraBadges(nostrStats);
                userStats.badges = badgeResults.badges;
                
                console.log(`‚úÖ Loaded: ${userStats.plantsCount} plants, ${userStats.umapsCount} UMAPs`);
                
                // Extract images ONLY from user observations (BRO + plantnet), NOT from bot responses
                // Enhanced extraction with all Nostr tag metadata
                const observationImages = extractImagesWithMetadata(userObservations);
                
                // Sort by date (most recent first)
                observationImages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Calculate and update ORE progress
                if (nostrStats.events && nostrStats.events.length > 0) {
                    const oreProgress = calculateOREProgress(nostrStats.events);
                    updateOREProgress(oreProgress);
                } else {
                    updateOREProgress({ count: 0, percent: 0, umap: null });
                }
                
                updateStatsDisplay();
                updateBadges();
                
                // Show Oracle badges section for connected users
                const oracleBadgesSection = document.getElementById('oracle-badges-section');
                if (oracleBadgesSection) {
                    oracleBadgesSection.style.display = 'block';
                }
                
                // Load Oracle badges (NIP-58) if user is connected
                if (currentUserPubkey && typeof window.displayUserBadges === 'function') {
                    const userNpub = window.userNpub || (window.hexToNpub ? window.hexToNpub(currentUserPubkey) : null);
                    if (userNpub) {
                        window.displayUserBadges('oracle-badges-container', userNpub, {
                            size: 'medium',
                            showName: true,
                            showTooltip: true,
                            emptyMessage: 'Aucun badge Oracle pour le moment'
                        });
                    }
                }
                
                // Display ONLY observation images (BRO + plantnet), not bot responses
                displayPhotoGallery(observationImages);
                
                const galleryCountEl = document.getElementById('gallery-count');
                if (galleryCountEl) {
                    galleryCountEl.textContent = observationImages.length;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading flora stats:', error);
            }
        }
        
        // Load public gallery (works without connection)
        async function loadPublicGallery() {
            console.log('üåø Loading public gallery (observations BRO + plantnet)...');
            
            try {
                // Ensure relay connection (but don't require user to be logged in)
                let currentRelay = getNostrRelay();
                if (!currentRelay) {
                    console.log('üîå Connecting to relay for public gallery...');
                    // Use connectToRelay without requiring authentication
                    await connectToRelay();
                    currentRelay = getNostrRelay();
                }
                
                if (!currentRelay) {
                    console.warn('‚ö†Ô∏è Could not connect to relay for public gallery');
                    return;
                }
                
                // Fetch ALL public observations (BRO + plantnet) from anyone
                const publicObservations = await fetchPlantObservations(currentRelay);
                
                console.log(`‚úÖ Found ${publicObservations.length} public plant observations`);
                
                // Extract images with metadata
                const observationImages = extractImagesWithMetadata(publicObservations);
                
                // Sort by date (most recent first)
                observationImages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Limit to most recent 50 for performance
                const limitedImages = observationImages.slice(0, 50);
                
                // Display gallery
                displayPhotoGallery(limitedImages);
                
                const galleryCountEl = document.getElementById('gallery-count');
                if (galleryCountEl) {
                    galleryCountEl.textContent = limitedImages.length;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading public gallery:', error);
            }
        }
        
        // Fetch user's observations (kind 1 with tags BRO and plantnet)
        async function fetchUserObservations(pubkey) {
            const currentRelay = getNostrRelay();
            if (!currentRelay) {
                console.warn('‚ö†Ô∏è No relay available for fetching user observations');
                return [];
            }
            
            return new Promise((resolve, reject) => {
                const filter = {
                    kinds: [1],
                    authors: [pubkey],
                    '#t': ['BRO', 'plantnet'],
                    limit: 200,
                    since: Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60) // Last year
                };
                
                const observations = [];
                const sub = currentRelay.sub([filter]);
                const timeout = setTimeout(() => {
                        sub.unsub();
                    resolve(observations);
                    }, 10000);

                    sub.on('event', (event) => {
                    // Verify event has both BRO and plantnet tags
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    if (tags.includes('BRO') && tags.includes('plantnet')) {
                        observations.push(event);
                    }
                    });

                    sub.on('eose', () => {
                        clearTimeout(timeout);
                        sub.unsub();
                    resolve(observations);
                    });
                });
        }
        
        function updateStatsDisplay() {
            const totalPlants = document.getElementById('total-plants');
            const totalUmaps = document.getElementById('total-umaps');
            const totalBadges = document.getElementById('total-badges');
            const orePotential = document.getElementById('ore-potential');
            
            if (totalPlants) totalPlants.textContent = userStats.plantsCount;
            if (totalUmaps) totalUmaps.textContent = userStats.umapsCount;
            
            const unlockedBadges = Object.values(userStats.badges).filter(b => b).length;
            if (totalBadges) totalBadges.textContent = `${unlockedBadges}/8`;
            
            const oreScore = calculateORERewards({
                plantsCount: userStats.plantsCount,
                species: Math.floor(userStats.plantsCount / 3),
                observers: 1,
                complianceScore: 0.7
            });
            if (orePotential) orePotential.textContent = oreScore;
        }
        
        function updateBadges() {
            Object.keys(userStats.badges).forEach(badgeName => {
                const badgeElement = document.getElementById(`badge-${badgeName}`);
                if (!badgeElement) return;
                
                if (userStats.badges[badgeName]) {
                        badgeElement.classList.remove('locked');
                        badgeElement.classList.add('unlocked');
                    badgeElement.style.borderColor = '#4ade80';
                    badgeElement.style.background = 'rgba(74, 222, 128, 0.1)';
                } else {
                    badgeElement.classList.remove('unlocked');
                    badgeElement.classList.add('locked');
                    badgeElement.style.opacity = '0.5';
                }
            });
        }
        
        // Enhanced image extraction with full Nostr tag metadata
        function extractImagesWithMetadata(messages) {
            const images = [];
            
            messages.forEach(msg => {
                let imageUrl = null;
                let imageMetadata = {};
                let location = null;
                let plantInfo = null;
                
                // 1. Check NIP-94 imeta tags (most reliable)
                // Format can be: ["imeta", "url https://...", "m image/jpeg", "dim 1920x1080"]
                // Or: ["imeta", "url", "https://...", "m", "image/jpeg", "dim", "1920x1080"]
                const imetaTag = msg.tags.find(tag => tag[0] === 'imeta');
                if (imetaTag) {
                    // Handle array format where each value is a separate element
                    if (imetaTag.length > 1) {
                        for (let i = 1; i < imetaTag.length; i++) {
                            const item = imetaTag[i];
                            
                            if (typeof item === 'string') {
                                // Check if it's a key-value pair in one string: "url https://..."
                                if (item.includes(' ') && item.length > 4) {
                                    const [key, ...valueParts] = item.split(' ');
                                    const value = valueParts.join(' ');
                                    
                                    if (key === 'url' && !imageUrl) {
                                        imageUrl = value;
                                    } else if (key === 'm') {
                                        imageMetadata.mimeType = value;
                                    } else if (key === 'dim') {
                                        imageMetadata.dimensions = value;
                                    } else if (key === 'x') {
                                        imageMetadata.hash = value;
                                    } else if (key === 'alt') {
                                        imageMetadata.alt = value;
                                    }
                                }
                                // Or check if current item is a key and next is value
                                else if (i + 1 < imetaTag.length) {
                                    const nextItem = imetaTag[i + 1];
                                    if (typeof nextItem === 'string') {
                                        if (item === 'url' && !imageUrl) {
                                            imageUrl = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'm') {
                                            imageMetadata.mimeType = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'dim') {
                                            imageMetadata.dimensions = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'x') {
                                            imageMetadata.hash = nextItem;
                                            i++; // Skip next item
                                        } else if (item === 'alt') {
                                            imageMetadata.alt = nextItem;
                                            i++; // Skip next item
                                        }
                                    }
                                }
                                // Or check if it looks like a URL
                                else if (!imageUrl && item.startsWith('http')) {
                                    imageUrl = item;
                                }
                            }
                        }
                    }
                }
                
                // 2. Check standard image tags (fallback)
                if (!imageUrl) {
                    const imageTag = msg.tags.find(tag => tag[0] === 'image');
                    if (imageTag && imageTag[1]) {
                        imageUrl = imageTag[1];
                    }
                }
                
                // 3. Extract from content (last resort)
                if (!imageUrl) {
                    const contentUrlMatch = msg.content.match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i);
                    if (contentUrlMatch) {
                        imageUrl = contentUrlMatch[0];
                    }
                }
                
                // Extract geolocation tag if present
                const geoTag = msg.tags.find(tag => tag[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(coord => parseFloat(coord));
                    if (!isNaN(lat) && !isNaN(lon)) {
                        location = { lat, lon, umap: `${lat.toFixed(2)},${lon.toFixed(2)}` };
                    }
                }
                
                // Extract plant information from content if available
                const content = msg.content || '';
                const plantMatch = content.match(/üå±|PlantNet|scientific[_\s]name|common[_\s]name/i);
                if (plantMatch) {
                    // Try to extract scientific name
                    const scientificMatch = content.match(/[Ss]cientific[_\s]name[:\s]+([A-Z][a-z]+\s+[a-z]+)/);
                    // Try to extract common name
                    const commonMatch = content.match(/[Cc]ommon[_\s]name[:\s]+([^\n]+)/);
                    
                    plantInfo = {
                        scientificName: scientificMatch ? scientificMatch[1] : null,
                        commonName: commonMatch ? commonMatch[1].trim() : null
                    };
                }
                
                // Add to images array if URL found
                if (imageUrl) {
                    images.push({
                        url: imageUrl,
                        eventId: msg.id,
                        date: new Date(msg.created_at * 1000),
                        timestamp: msg.created_at,
                        location: location,
                        content: content.substring(0, 200),
                        metadata: imageMetadata,
                        plantInfo: plantInfo,
                        pubkey: msg.pubkey,
                        createdAt: msg.created_at
                    });
                }
            });
            
            return images;
        }
        
        function displayPhotoGallery(images) {
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryEmpty = document.getElementById('gallery-empty');
            
            if (!images || images.length === 0) {
                if (galleryGrid) galleryGrid.innerHTML = '';
                if (galleryEmpty) galleryEmpty.style.display = 'block';
                return;
            }
            
            if (galleryEmpty) galleryEmpty.style.display = 'none';
            if (galleryGrid) galleryGrid.innerHTML = '';
            
            images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item position-relative';
                item.style.cssText = 'cursor: pointer; overflow: hidden; border-radius: 12px;';
                
                // Create image element
                            const img = document.createElement('img');
                img.src = image.url;
                img.alt = image.metadata?.alt || image.plantInfo?.commonName || `Plant observation ${index + 1}`;
                img.loading = 'lazy';
                img.style.cssText = 'width: 100%; height: 200px; object-fit: cover; transition: transform 0.3s;';
                
                img.onerror = () => item.style.display = 'none';
                
                // Create overlay with metadata
                const overlay = document.createElement('div');
                overlay.className = 'gallery-overlay';
                overlay.style.cssText = `
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
                    padding: 15px 10px 10px;
                    color: white;
                    transform: translateY(100%);
                    transition: transform 0.3s;
                `;
                
                let overlayContent = '';
                
                // Add plant info if available
                if (image.plantInfo) {
                    if (image.plantInfo.commonName) {
                        overlayContent += `<div class="fw-bold mb-1" style="color: #f1f5f9;">${image.plantInfo.commonName}</div>`;
                    }
                    if (image.plantInfo.scientificName) {
                        overlayContent += `<div class="small" style="color: #e2e8f0; opacity: 0.9;"><em>${image.plantInfo.scientificName}</em></div>`;
                    }
                }
                
                // Add location if available
                if (image.location) {
                    overlayContent += `<div class="small mt-1" style="color: #e2e8f0;"><i class="bi bi-geo-alt"></i> ${image.location.umap}</div>`;
                }
                
                // Add date
                if (image.date) {
                    const dateStr = image.date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'short',
                        year: 'numeric'
                    });
                    overlayContent += `<div class="small mt-1" style="color: #e2e8f0;"><i class="bi bi-calendar"></i> ${dateStr}</div>`;
                }
                
                // Add dimensions if available
                if (image.metadata?.dimensions) {
                    overlayContent += `<div class="small mt-1" style="color: #e2e8f0;"><i class="bi bi-arrows-fullscreen"></i> ${image.metadata.dimensions}</div>`;
                }
                
                overlay.innerHTML = overlayContent || '<div class="small" style="color: #e2e8f0;">Plant observation</div>';
                
                // Hover effect
                item.addEventListener('mouseenter', () => {
                    overlay.style.transform = 'translateY(0)';
                    img.style.transform = 'scale(1.1)';
                });
                
                item.addEventListener('mouseleave', () => {
                    overlay.style.transform = 'translateY(100%)';
                    img.style.transform = 'scale(1)';
                });
                
                // Click to open lightbox
                item.onclick = () => {
                    openLightboxWithMetadata(image);
                };
                
                item.appendChild(img);
                item.appendChild(overlay);
                if (galleryGrid) galleryGrid.appendChild(item);
            });
        }
        
        // Enhanced lightbox with metadata
        function openLightboxWithMetadata(image) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.style.zIndex = '9999';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(74, 222, 128, 0.3);">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title text-success">
                                <span class="text-white">${image.plantInfo?.commonName || 'Plant Observation'}</span>
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center" style="background: rgba(15, 23, 42, 0.98); color: #e2e8f0;">
                            <img src="${image.url}" class="img-fluid rounded mb-3" alt="${image.plantInfo?.commonName || 'Plant observation'}" style="max-height: 70vh;">
                            <div class="text-start" style="color: #e2e8f0;">
                                ${image.plantInfo?.scientificName ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><strong style="color: #4ade80;">Scientific Name:</strong> <em style="color: #cbd5e1;">${image.plantInfo.scientificName}</em></p>
                                ` : ''}
                                ${image.location ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-geo-alt" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Location:</strong> <span style="color: #cbd5e1;">${image.location.umap}</span> <span style="color: #94a3b8;">(${image.location.lat}, ${image.location.lon})</span></p>
                                ` : ''}
                                ${image.date ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-calendar" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Date:</strong> <span style="color: #cbd5e1;">${image.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></p>
                                ` : ''}
                                ${image.metadata?.dimensions ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-arrows-fullscreen" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Dimensions:</strong> <span style="color: #cbd5e1;">${image.metadata.dimensions}</span></p>
                                ` : ''}
                                ${image.metadata?.mimeType ? `
                                    <p class="mb-2" style="color: #f1f5f9;"><i class="bi bi-file-image" style="color: #4ade80;"></i> <strong style="color: #4ade80;">Type:</strong> <span style="color: #cbd5e1;">${image.metadata.mimeType}</span></p>
                                ` : ''}
                                ${image.content ? `
                                    <div class="mt-3 p-3 rounded" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3);">
                                        <strong style="color: #4ade80;">Description:</strong>
                                        <p class="mb-0 mt-2" style="color: #cbd5e1;">${image.content}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button onclick="openMessageModal('${image.eventId}'); return false;" class="btn btn-outline-primary">
                                <i class="bi bi-chat-dots"></i> Voir le message
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
        
        // Keep old function for backward compatibility
        function openLightbox(imageUrl) {
            openLightboxWithMetadata({ url: imageUrl });
        }

        // ========================================
        // NOSTR CONNECTION
        // ========================================
        async function handleNostrLogin() {
            try {
                // Force authentication by passing true to forceAuth
                const pubkey = await connectNostr(true);
                if (pubkey) {
                    setUserPubkey(pubkey);
                    setIsNostrConnected(true);
                    setNostrRelay(getNostrRelay()); // Ensure relay is set
                    
                    // Force send NIP42 auth event for server verification
                    // sendNIP42Auth is in common.js, wait a bit for relay to be fully connected
                    const relay = getNostrRelay();
                    if (relay && window.nostrRelay) {
                        console.log('üîê Waiting for relay connection before sending NIP42 auth...');
                        // Wait a moment for relay connection to stabilize
                        setTimeout(async () => {
                            if (typeof window.sendNIP42Auth === 'function') {
                                await window.sendNIP42Auth(relay, true);
                            } else if (typeof sendNIP42Auth === 'function') {
                                await sendNIP42Auth(relay, true);
                            } else {
                                console.warn('‚ö†Ô∏è sendNIP42Auth function not available');
                            }
                        }, 1000);
                    }
                    
                    updateNostrUI(true);
                    await loadUserStats();
                    
                    // Scroll to share section to show the enabled button
                    scrollToSection('share');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la connexion:', error);
                showErrorModal(
                    'Une erreur est survenue lors de la connexion √† Nostr. Veuillez v√©rifier votre extension et r√©essayer.',
                    'Erreur de connexion'
                );
            }
        }

        function updateNostrUI(isLoggedIn) {
            const messageSection = document.getElementById('nostr-message-section');
            const messageForm = document.getElementById('nostr-message-form');
            const navMenuConnect = document.getElementById('nav-menu-connect');
            const navLinkProfile = document.getElementById('nav-link-profile');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const sendMessageHint = document.getElementById('send-message-hint');
            const galleryTitle = document.getElementById('gallery-title');
            const galleryAddBtn = document.getElementById('gallery-add-btn');
            
            const currentUserPubkey = getUserPubkey();
            
            if (isLoggedIn && currentUserPubkey) {
                // Keep connection button visible but change style/text to show reconnection option
                if (navMenuConnect) {
                    navMenuConnect.style.display = 'inline-block';
                    navMenuConnect.innerHTML = '<i class="bi bi-arrow-repeat"></i> Reconnecter';
                    navMenuConnect.className = 'btn btn-outline-success me-2';
                    navMenuConnect.title = 'Reconnecter et renouveler l\'authentification';
                }
                
                // Show profile link
                if (navLinkProfile) {
                    navLinkProfile.style.display = 'inline-block';
                    navLinkProfile.href = `nostr_profile_viewer.html?hex=${currentUserPubkey}`;
                }
                
                // Show message form
                if (messageSection) messageSection.style.display = 'none';
                if (messageForm) messageForm.style.display = 'block';
                
                // Enable "Ajouter une Plante" button
                if (sendMessageBtn) {
                    sendMessageBtn.disabled = false;
                }
                if (sendMessageHint) {
                    sendMessageHint.style.display = 'none';
                }
                
                // Update gallery title to "Mes Identifications"
                if (galleryTitle) {
                    galleryTitle.textContent = 'Mes Identifications';
                }
                if (galleryAddBtn) {
                    galleryAddBtn.disabled = false;
                }
                
                // Show Oracle badges section
                const oracleBadgesSection = document.getElementById('oracle-badges-section');
                if (oracleBadgesSection) {
                    oracleBadgesSection.style.display = 'block';
                }
                } else {
                // Show connection button, hide profile link
                if (navMenuConnect) navMenuConnect.style.display = 'inline-block';
                if (navLinkProfile) navLinkProfile.style.display = 'none';
                
                // Show connection message
                if (messageSection) messageSection.style.display = 'block';
                if (messageForm) messageForm.style.display = 'none';
                
                // Disable "Ajouter une Plante" button
                if (sendMessageBtn) {
                    sendMessageBtn.disabled = true;
                }
                if (sendMessageHint) {
                    sendMessageHint.style.display = 'block';
                }
                
                // Update gallery title to "Plantes Identifi√©es" (public)
                if (galleryTitle) {
                    galleryTitle.textContent = 'Plantes Identifi√©es';
                }
                if (galleryAddBtn) {
                    galleryAddBtn.disabled = true;
                    galleryAddBtn.title = 'Connectez-vous pour ajouter une plante';
                }
                
                // Hide Oracle badges section
                const oracleBadgesSection = document.getElementById('oracle-badges-section');
                if (oracleBadgesSection) {
                    oracleBadgesSection.style.display = 'none';
                }
            }
        }
        
        // ========================================
        // MODAL VIEWERS FOR PROFILES AND MESSAGES
        // ========================================
        
        // Open profile viewer in modal
        function openProfile() {
            const currentUserPubkey = getUserPubkey();
            if (currentUserPubkey) {
                openProfileModal(currentUserPubkey);
            }
        }
        
        function openProfileModal(pubkey) {
            // Check if modal already exists
            let modal = document.getElementById('profile-viewer-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'profile-viewer-modal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'profile-viewer-modal-label');
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content" style="background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(74, 222, 128, 0.3);">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title text-success" id="profile-viewer-modal-label">
                                    <i class="bi bi-person"></i> Profil Nostr
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0" id="profile-viewer-content">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <p class="text-white mt-3">Chargement du profil...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Load content via iframe
            const contentDiv = document.getElementById('profile-viewer-content');
            contentDiv.innerHTML = `
                <iframe 
                    src="nostr_profile_viewer.html?hex=${pubkey}" 
                    style="width: 100%; height: 80vh; border: none; background: rgba(15, 23, 42, 0.98);"
                    frameborder="0">
                </iframe>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Open message viewer in modal
        function openMessageModal(eventId) {
            // Check if modal already exists
            let modal = document.getElementById('message-viewer-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'message-viewer-modal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'message-viewer-modal-label');
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content" style="background: rgba(15, 23, 42, 0.98); border: 1px solid rgba(74, 222, 128, 0.3);">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title text-success" id="message-viewer-modal-label">
                                    <i class="bi bi-chat-dots"></i> Message Nostr
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0" id="message-viewer-content">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <p class="text-white mt-3">Chargement du message...</p>
                                </div>
                            </div>
                        </div>
                </div>
            `;
                document.body.appendChild(modal);
            }
            
            // Load content via iframe
            const contentDiv = document.getElementById('message-viewer-content');
            contentDiv.innerHTML = `
                <iframe 
                    src="nostr_message_viewer.html?event=${eventId}" 
                    style="width: 100%; height: 80vh; border: none; background: rgba(15, 23, 42, 0.98);"
                    frameborder="0">
                </iframe>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // ========================================
        // PHOTO UPLOAD
        // ========================================
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedPhoto = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('photoPreview');
                    const uploadText = document.getElementById('photoUploadText');
                    if (preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    }
                    if (uploadText) uploadText.style.display = 'none';
                };
                reader.readAsDataURL(file);
                
                handleIPFSUpload(file);
            }
        }

        async function handleIPFSUpload(file) {
            try {
                const result = await uploadPhotoToIPFS(file);
                if (result.success && selectedPhoto) {
                    selectedPhoto.ipfsUrl = result.url;
                    
                    // Store metadata if available
                    if (result.metadata) {
                        selectedPhoto.metadata = result.metadata;
                        console.log('üìã Metadata stored:', result.metadata);
                    }
                    
                    // Update comment field with description from API or metadata
                    const messageTextEl = document.getElementById('messageText');
                    if (messageTextEl) {
                        let descriptionToUse = result.description;
                        
                        // Try to get description from metadata if not provided directly
                        if (!descriptionToUse && result.metadata && result.metadata.metadata) {
                            descriptionToUse = result.metadata.metadata.description;
                        }
                        
                        if (descriptionToUse) {
                            // Use description directly (AI-generated for images)
                            messageTextEl.value = descriptionToUse;
                            console.log('‚úÖ Description updated:', descriptionToUse);
                        } else if (result.fileName) {
                            // Fallback: use filename if no description available
                            // Remove extension and replace underscores with spaces
                            const fileName = result.fileName.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
                            const cleanName = fileName.replace(/_/g, ' ');
                            messageTextEl.value = cleanName;
                            console.log('‚úÖ Description updated with filename:', cleanName);
                        }
                    }
                    
                    // Display file info if metadata is available
                    if (result.metadata) {
                        displayFileInfo(result.metadata);
                    }
                }
            } catch (error) {
                console.error('Error uploading to IPFS:', error);
            }
        }
        
        function displayFileInfo(metadata) {
            // Create or update an info display element
            let infoDiv = document.getElementById('file-info-display');
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = 'file-info-display';
                infoDiv.className = 'alert alert-info mt-3';
                
                const formSection = document.getElementById('nostr-message-form');
                if (formSection) {
                    const locationInfo = document.getElementById('locationInfo');
                    if (locationInfo && locationInfo.parentNode) {
                        locationInfo.parentNode.insertBefore(infoDiv, locationInfo);
            } else {
                        formSection.appendChild(infoDiv);
                    }
                }
            }
            
            // Build info HTML
            let infoHTML = '<strong><i class="bi bi-info-circle"></i> Informations du fichier:</strong><ul class="mb-0 mt-2">';
            
            if (metadata.file) {
                if (metadata.file.size) {
                    const sizeMB = (metadata.file.size / (1024 * 1024)).toFixed(2);
                    infoHTML += `<li><strong>Taille:</strong> ${sizeMB} MB</li>`;
                }
                if (metadata.file.type) {
                    infoHTML += `<li><strong>Type:</strong> ${metadata.file.type}</li>`;
                }
            }
            
            if (metadata.image && metadata.image.dimensions) {
                infoHTML += `<li><strong>Dimensions:</strong> ${metadata.image.dimensions}</li>`;
            }
            
            if (metadata.media) {
                if (metadata.media.duration) {
                    const minutes = Math.floor(metadata.media.duration / 60);
                    const seconds = Math.floor(metadata.media.duration % 60);
                    infoHTML += `<li><strong>Dur√©e:</strong> ${minutes}:${seconds.toString().padStart(2, '0')}</li>`;
                }
                if (metadata.media.dimensions) {
                    infoHTML += `<li><strong>Dimensions:</strong> ${metadata.media.dimensions}</li>`;
                }
            }
            
            if (metadata.metadata && metadata.metadata.description) {
                infoHTML += `<li><strong>Description:</strong> ${metadata.metadata.description}</li>`;
            }
            
            infoHTML += '</ul>';
            infoDiv.innerHTML = infoHTML;
            infoDiv.style.display = 'block';
        }
        
        // ========================================
        // GEOLOCATED MESSAGE
        // ========================================
        async function sendGeolocatedMessage() {
            const currentUserPubkey = getUserPubkey();
            const currentIsConnected = getIsNostrConnected();
            const currentRelay = getNostrRelay();
            
            if (!currentUserPubkey || !currentIsConnected) {
                showWarningModal(
                    'Vous devez √™tre connect√© avec Nostr pour publier une observation.<br><br>Utilisez le bouton "Connexion" dans la barre de navigation.',
                    'Connexion requise'
                );
                return;
            }
            
            if (!selectedPhoto || !selectedPhoto.ipfsUrl) {
                showWarningModal(
                    'Veuillez d\'abord s√©lectionner ou prendre une photo de la plante √† identifier.',
                    'Photo requise'
                );
                return;
            }

            if (!currentLocation) {
                showWarningModal(
                    'Une position g√©ographique est requise pour enregistrer l\'observation.<br><br>Utilisez la carte ou le bouton "Ma position" pour d√©finir votre localisation.',
                    'Position requise'
                );
                return;
            }

            const messageText = document.getElementById('messageText')?.value || '';
            const adjustedLocation = {
                latitude: parseFloat(document.getElementById('lat-display')?.value || currentLocation.latitude),
                longitude: parseFloat(document.getElementById('lon-display')?.value || currentLocation.longitude)
            };
            
            const content = `üå± Observation\nüìç Position: ${adjustedLocation.latitude}, ${adjustedLocation.longitude}\nüì∏ Photo: ${selectedPhoto.ipfsUrl}\n${messageText ? messageText + '\n' : ''}#plantnet #UPlanet #BRO #uplanet`;
            
                const eventTemplate = {
                kind: 1,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ["t", "plantnet"],
                    ["t", "UPlanet"],
                    ["t", "BRO"],
                    ["t", "uplanet"],
                    ["g", `${adjustedLocation.latitude},${adjustedLocation.longitude}`]
                    ],
                    content: content
                };

            if (selectedPhoto.ipfsUrl) {
                eventTemplate.tags.push(["imeta", `url ${selectedPhoto.ipfsUrl}`, "m image/jpeg"]);
            }
            
            try {
                const signedEvent = await window.nostr.signEvent(eventTemplate);
                if (currentRelay) {
                    await currentRelay.publish(signedEvent);
                } else {
                    // Fallback: use common.js publish function if available
                    if (typeof publishToNostr === 'function') {
                        await publishToNostr(signedEvent);
                    } else {
                        throw new Error('No relay available');
                    }
                }
                
                showSuccessModal(
                    'Votre observation a √©t√© publi√©e avec succ√®s !<br><br>PlantNet va identifier la plante et vous serez notifi√© une fois la reconnaissance termin√©e.',
                    'Observation publi√©e',
                    4000
                );
                
                selectedPhoto = null;
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('photoUploadText').style.display = 'block';
                document.getElementById('messageText').value = '';
                
                setTimeout(() => {
                    loadUserStats();
                }, 2000);

            } catch (error) {
                console.error('Error sending message:', error);
                showErrorModal(
                    'Impossible de publier votre observation. Veuillez v√©rifier votre connexion au relay et r√©essayer.',
                    'Erreur de publication'
                );
            }
        }
        
        // ========================================
        // MAP FUNCTIONS (Keep existing logic)
        // ========================================
        function toggleOREMapView() {
            const container = document.getElementById('ore-map-container');
            const btn = document.getElementById('toggle-ore-map-btn');
            if (container) {
                const isVisible = container.style.display !== 'none';
                container.style.display = isVisible ? 'none' : 'block';
                if (btn) {
                    btn.innerHTML = isVisible ? '<i class="bi bi-map"></i> Afficher la Carte' : '<i class="bi bi-x-square"></i> Masquer la Carte';
                }
                if (!isVisible && !unifiedMap) {
                    setTimeout(() => initializeUnifiedMap(), 300);
                }
            }
        }
        
        // Initialize unified map (events + position selection)
        function initializeUnifiedMap() {
            if (typeof L === 'undefined') {
                console.warn('Leaflet not loaded');
                return;
            }
            
            const mapEl = document.getElementById('unified-map');
            if (!mapEl) {
                console.warn('Map element not found');
                return;
            }
            
            // Remove existing map if present
            if (unifiedMap) {
                unifiedMap.remove();
                unifiedMap = null;
                mapMarkers = [];
                userPositionMarker = null;
            }
            
            // Initialize map with default view (France)
            unifiedMap = L.map('unified-map').setView([46.0, 2.0], 6);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(unifiedMap);
            
            // Add click handler for position selection (only if not clicking on a marker/popup)
            unifiedMap.on('click', function(e) {
                // Check if click was on a marker or popup
                const originalEvent = e.originalEvent;
                if (originalEvent && originalEvent.target.closest('.leaflet-marker-icon, .leaflet-popup, .leaflet-popup-content')) {
                    return; // Don't update position if clicking on marker/popup
                }
                
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                
                // Update position inputs
                const latInput = document.getElementById('lat-display');
                const lonInput = document.getElementById('lon-display');
                if (latInput) latInput.value = lat.toFixed(6);
                if (lonInput) lonInput.value = lon.toFixed(6);
                
                // Update currentLocation
                currentLocation = { latitude: lat, longitude: lon };
                
                // Update or create user position marker
                updateUserPositionMarker(lat, lon);
                
                // Show feedback
                if (userPositionMarker) {
                    userPositionMarker.bindPopup('<strong>üìç Position mise √† jour</strong>').openPopup();
                    setTimeout(() => {
                        if (userPositionMarker) userPositionMarker.closePopup();
                    }, 2000);
                }
            });
            
            // Load events when map is ready
            loadMapEvents();
            
            // Center on user location if available
            if (currentLocation) {
                updateUserPositionMarker(currentLocation.latitude, currentLocation.longitude);
                unifiedMap.setView([currentLocation.latitude, currentLocation.longitude], 13);
            }
        }
        
        // Update user position marker
        function updateUserPositionMarker(lat, lon) {
            if (!unifiedMap) return;
            
            // Remove existing user marker
            if (userPositionMarker) {
                unifiedMap.removeLayer(userPositionMarker);
            }
            
            // Create custom icon for user position (blue marker with shadow)
            const userIcon = L.divIcon({
                className: 'user-position-marker',
                html: '<div style="background: #3b82f6; width: 28px; height: 28px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.8), 0 0 5px rgba(0, 0, 0, 0.3); cursor: move;"></div>',
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });
            
            // Add draggable marker
            userPositionMarker = L.marker([lat, lon], { 
                icon: userIcon,
                draggable: true,
                zIndexOffset: 1000,
                keyboard: true
            }).addTo(unifiedMap);
            
            userPositionMarker.bindPopup('<strong>üìç Votre position</strong><br><small>Cliquez-glissez pour ajuster<br>ou cliquez sur la carte</small>').openPopup();
            
            // Handle drag end to update position
            userPositionMarker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                const latInput = document.getElementById('lat-display');
                const lonInput = document.getElementById('lon-display');
                if (latInput) latInput.value = pos.lat.toFixed(6);
                if (lonInput) lonInput.value = pos.lng.toFixed(6);
                currentLocation = { latitude: pos.lat, longitude: pos.lng };
                
                // Show feedback
                userPositionMarker.bindPopup('<strong>‚úÖ Position mise √† jour</strong><br><small>Coordonn√©es: ' + pos.lat.toFixed(6) + ', ' + pos.lng.toFixed(6) + '</small>').openPopup();
                setTimeout(() => {
                    if (userPositionMarker) {
                        userPositionMarker.bindPopup('<strong>üìç Votre position</strong><br><small>Cliquez-glissez pour ajuster</small>');
                        userPositionMarker.closePopup();
                    }
                }, 2000);
            });
            
            // Center map on marker if zoomed out too much
            if (unifiedMap.getZoom() < 10) {
                unifiedMap.setView([lat, lon], 13);
            }
        }
        
        // Load events on unified map
        async function loadMapEvents() {
            if (!unifiedMap) {
                console.warn('Map not initialized');
                return;
            }
            
            console.log('üó∫Ô∏è Loading ORE events and plant observations...');
            
            // Use relay from common.js
            let currentRelay = getNostrRelay();
            if (!currentRelay) {
                console.warn('‚ö†Ô∏è No relay available, connecting...');
                await connectToRelay();
                currentRelay = getNostrRelay();
                if (!currentRelay) {
                    console.warn('‚ö†Ô∏è Could not connect to relay');
                    return;
                }
            }
            
            // Clear existing event markers (keep user position marker)
            mapMarkers.forEach(marker => {
                if (unifiedMap && marker !== userPositionMarker) {
                    unifiedMap.removeLayer(marker);
                }
            });
            mapMarkers = userPositionMarker ? [userPositionMarker] : [];
            
            try {
                // Load all event types in parallel for better performance
                const [observations, recognizedPlants, umapDIDs, oreContracts] = await Promise.all([
                    fetchPlantObservations(currentRelay),
                    fetchRecognizedPlants(currentRelay),
                    fetchUMAPDIDs(currentRelay),
                    fetchOREContracts(currentRelay)
                ]);
                
                console.log(`üìä Events loaded: ${observations.length} observations, ${recognizedPlants.length} recognized, ${umapDIDs.length} DIDs, ${oreContracts.length} contracts`);
                
                // Display all markers on map
                displayMapMarkers({
                    observations,
                    recognizedPlants,
                    umapDIDs,
                    oreContracts
                });
                
                // Update count
                updateEventCount(observations, recognizedPlants, umapDIDs, oreContracts);
                
            } catch (error) {
                console.error('‚ùå Error loading map data:', error);
                // Show user-friendly error
                if (unifiedMap) {
                    unifiedMap.eachLayer(layer => {
                        if (layer instanceof L.Marker && layer !== userPositionMarker) {
                            unifiedMap.removeLayer(layer);
                        }
                    });
                }
            }
        }
        
        // Update event count display
        function updateEventCount(observations, recognizedPlants, umapDIDs, oreContracts) {
            const countEl = document.getElementById('ore-umap-count');
            if (countEl) {
                const uniqueUmaps = new Set();
                [...observations, ...recognizedPlants, ...umapDIDs, ...oreContracts].forEach(event => {
                    const geoTag = event.tags?.find(t => t[0] === 'g');
                    if (geoTag && geoTag[1]) {
                        uniqueUmaps.add(geoTag[1]);
                    }
                });
                countEl.textContent = uniqueUmaps.size;
            }
        }
        
        // Fetch plant observations (kind 1 with tags BRO and plantnet)
        async function fetchPlantObservations(relay) {
            if (!relay) {
                console.warn('‚ö†Ô∏è No relay provided to fetchPlantObservations');
                return [];
            }
            
            return new Promise((resolve, reject) => {
                const filter = {
                    kinds: [1],
                    '#t': ['BRO', 'plantnet'],
                    limit: 500,
                    since: Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60) // Last 90 days
                };
                
                const observations = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => {
                    sub.unsub();
                    resolve(observations);
                }, 10000);
                
                sub.on('event', (event) => {
                    // Verify event has both BRO and plantnet tags
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    if (tags.includes('BRO') && tags.includes('plantnet')) {
                        const geoTag = event.tags.find(t => t[0] === 'g');
                        if (geoTag && geoTag[1]) {
                            observations.push(event);
                        }
                    }
                });
                
                sub.on('eose', () => {
                    clearTimeout(timeout);
                    sub.unsub();
                    resolve(observations);
                });
            });
        }
        
        // Fetch recognized plants (kind 1 with tags UPlanet and plantnet)
        async function fetchRecognizedPlants(relay) {
            if (!relay) {
                console.warn('‚ö†Ô∏è No relay provided to fetchRecognizedPlants');
                return [];
            }
            
            return new Promise((resolve, reject) => {
                const filter = {
                    kinds: [1],
                    '#t': ['UPlanet', 'plantnet'],
                    limit: 500,
                    since: Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60) // Last 90 days
                };
                
                const recognized = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => {
                    sub.unsub();
                    resolve(recognized);
                }, 10000);
                
                sub.on('event', (event) => {
                    // Verify event has both UPlanet and plantnet tags
                    const tags = event.tags.map(t => t[1]).filter(Boolean);
                    if (tags.includes('UPlanet') && tags.includes('plantnet')) {
                        const geoTag = event.tags.find(t => t[0] === 'g');
                        if (geoTag && geoTag[1]) {
                            recognized.push(event);
                        }
                    }
                });
                
                sub.on('eose', () => {
                    clearTimeout(timeout);
                    sub.unsub();
                    resolve(recognized);
                });
            });
        }
        
        // Fetch UMAP DIDs (kind 30800)
        async function fetchUMAPDIDs(relay) {
            if (!relay) {
                console.warn('‚ö†Ô∏è No relay provided to fetchUMAPDIDs');
                return [];
            }
            
            return new Promise((resolve, reject) => {
                const filter = {
                    kinds: [30800],
                    '#d': ['did'],
                    limit: 200
                };
                
                const dids = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => {
                    sub.unsub();
                    resolve(dids);
                }, 10000);
                
                sub.on('event', (event) => {
                    try {
                        // Parse DID document to check if it's a UMAP
                        const content = JSON.parse(event.content || '{}');
                        if (content.type === 'UMAPGeographicCell' && content.geographicMetadata?.coordinates) {
                            const coords = content.geographicMetadata.coordinates;
                            // Add geographic tag if not present
                            if (!event.tags.find(t => t[0] === 'g')) {
                                event.tags.push(['g', `${coords.lat},${coords.lon}`]);
                            }
                            dids.push(event);
                        }
                    } catch (e) {
                        // Skip invalid JSON
                    }
                });
                
                sub.on('eose', () => {
                    clearTimeout(timeout);
                    sub.unsub();
                    resolve(dids);
                });
            });
        }
        
        // Fetch ORE contracts (kind 30312)
        async function fetchOREContracts(relay) {
            if (!relay) {
                console.warn('‚ö†Ô∏è No relay provided to fetchOREContracts');
                return [];
            }
            
            return new Promise((resolve, reject) => {
                const filter = {
                    kinds: [30312],
                    '#t': ['ORE'],
                    limit: 200
                };
                
                const contracts = [];
                const sub = relay.sub([filter]);
                const timeout = setTimeout(() => {
                    sub.unsub();
                    resolve(contracts);
                }, 10000);
                
                sub.on('event', (event) => {
                    contracts.push(event);
                });
                
                sub.on('eose', () => {
                    clearTimeout(timeout);
                    sub.unsub();
                    resolve(contracts);
                });
            });
        }
        
        // Display markers on unified map
        function displayMapMarkers(data) {
            if (!unifiedMap) return;
            
            const { observations, recognizedPlants, umapDIDs, oreContracts } = data;
            
            // 1. Observations (kind 1 with BRO and plantnet) - Orange markers
            observations.forEach(event => {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.circleMarker([lat, lon], {
                            radius: 8,
                            fillColor: '#f97316', // Orange
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(unifiedMap);
                        
                        const content = event.content || '';
                        const preview = content.substring(0, 100);
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>üîµ Observation</strong><br>
                                <small>${preview}...</small><br>
                                <em>Kind 1: #BRO #plantnet</em><br>
                                <small style="color: #888;">üìÖ ${dateStr}</small><br>
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                                   class="btn btn-sm mt-2" 
                                   style="background: #f97316; color: white; border: none;">
                                    üìñ Voir le message
                                </button>
                            </div>
                        `);
                        
                        mapMarkers.push(marker);
                    }
                }
            });
            
            // 2. Recognized plants (kind 1 with UPlanet and plantnet) - Green markers
            recognizedPlants.forEach(event => {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.circleMarker([lat, lon], {
                            radius: 10,
                            fillColor: '#22c55e', // Green
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(unifiedMap);
                        
                        const content = event.content || '';
                        const preview = content.substring(0, 100);
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>üü¢ Plante Reconnue</strong><br>
                                <small>${preview}...</small><br>
                                <em>Kind 1: #UPlanet #plantnet</em><br>
                                <small style="color: #888;">üìÖ ${dateStr}</small><br>
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                                   class="btn btn-sm mt-2" 
                                   style="background: #22c55e; color: white; border: none;">
                                    üìñ Voir le message
                                </button>
                            </div>
                        `);
                        
                        mapMarkers.push(marker);
                    }
                }
            });
            
            // 3. UMAP DIDs (kind 30800) - Blue markers
            umapDIDs.forEach(event => {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'umap-did-marker',
                                html: '<div style="background: #0ea5e9; border: 2px solid #fff; border-radius: 50%; width: 12px; height: 12px;"></div>',
                                iconSize: [12, 12]
                            })
                        }).addTo(unifiedMap);
                        
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>üìç UMAP DID</strong><br>
                                <small>Kind 30800 - Identit√© d√©centralis√©e</small><br>
                                <small style="color: #888;">üìÖ ${dateStr}</small><br>
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                                   class="btn btn-sm mt-2" 
                                   style="background: #0ea5e9; color: white; border: none;">
                                    üìñ Voir le DID
                                </button>
                            </div>
                        `);
                        
                        mapMarkers.push(marker);
                    }
                }
            });
            
            // 4. ORE Contracts (kind 30312) - Yellow/gold markers (larger)
            oreContracts.forEach(event => {
                const geoTag = event.tags.find(t => t[0] === 'g');
                if (geoTag && geoTag[1]) {
                    const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.circleMarker([lat, lon], {
                            radius: 15,
                            fillColor: '#fbbf24', // Gold/Yellow
                            color: '#fff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(unifiedMap);
                        
                        const content = event.content || '';
                        const date = new Date(event.created_at * 1000);
                        const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>üèÜ Contrat ORE Actif</strong><br>
                                <small>${content.substring(0, 150)}...</small><br>
                                <em>Kind 30312 - Espace g√©ographique persistant</em><br>
                                <small style="color: #888;">üìÖ ${dateStr}</small><br>
                                <button onclick="openMessageModal('${event.id}'); return false;" 
                                   class="btn btn-sm mt-2 fw-bold" 
                                   style="background: #fbbf24; color: #0f172a; border: none;">
                                    üìñ Voir le contrat
                                </button>
                            </div>
                        `);
                        
                        mapMarkers.push(marker);
                    }
                }
            });
            
            // Fit map to show all markers (only if no user position marker or if markers exist)
            const markersToFit = mapMarkers.filter(m => m !== userPositionMarker);
            if (markersToFit.length > 0) {
                const group = new L.featureGroup(markersToFit);
                // If user position exists, include it in bounds
                if (userPositionMarker) {
                    group.addLayer(userPositionMarker);
                }
                unifiedMap.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Profile functions removed - now using nostr_profile_viewer.html
        
        // ========================================
        // MODAL UTILITIES
        // ========================================
        
        /**
         * Show a Bootstrap modal with custom title, message, and type
         * @param {string} title - Modal title
         * @param {string} message - Modal message/body
         * @param {string} type - 'error', 'success', 'warning', 'info' (default: 'info')
         * @param {number} autoClose - Auto-close delay in ms (0 = no auto-close, default: 0)
         */
        function showModal(title, message, type = 'info', autoClose = 0) {
            // Remove existing modal if any
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Determine icon and colors based on type
            let icon, bgColor, textColor, btnColor;
            switch (type) {
                case 'error':
                    icon = '<i class="bi bi-exclamation-triangle-fill"></i>';
                    bgColor = '#dc3545';
                    textColor = '#fff';
                    btnColor = 'btn-danger';
                            break;
                case 'success':
                    icon = '<i class="bi bi-check-circle-fill"></i>';
                    bgColor = '#22c55e';
                    textColor = '#fff';
                    btnColor = 'btn-success';
                            break;
                case 'warning':
                    icon = '<i class="bi bi-exclamation-triangle-fill"></i>';
                    bgColor = '#f59e0b';
                    textColor = '#fff';
                    btnColor = 'btn-warning';
                            break;
                default: // info
                    icon = '<i class="bi bi-info-circle-fill"></i>';
                    bgColor = '#3b82f6';
                    textColor = '#fff';
                    btnColor = 'btn-info';
            }
            
            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="custom-modal" tabindex="-1" aria-labelledby="custom-modal-label" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="border: none; border-radius: 12px; overflow: hidden;">
                            <div class="modal-header" style="background: ${bgColor}; color: ${textColor}; border: none;">
                                <h5 class="modal-title" id="custom-modal-label" style="color: ${textColor};">
                                    ${icon} ${title}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" style="background: #1e293b; color: #e2e8f0; padding: 1.5rem;">
                                ${message}
                            </div>
                            <div class="modal-footer" style="background: #1e293b; border: none; padding: 1rem 1.5rem;">
                                <button type="button" class="btn ${btnColor}" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Get modal element
            const modalEl = document.getElementById('custom-modal');
            const modal = new bootstrap.Modal(modalEl);
            
            // Show modal
            modal.show();
            
            // Auto-close if specified
            if (autoClose > 0) {
                setTimeout(() => {
                    modal.hide();
                    setTimeout(() => modalEl.remove(), 300);
                }, autoClose);
            }
            
            // Cleanup on hidden
            modalEl.addEventListener('hidden.bs.modal', () => {
                modalEl.remove();
            });
        }
        
        /**
         * Show error modal
         * @param {string} message - Error message
         * @param {string} title - Optional custom title (default: 'Erreur')
         */
        function showErrorModal(message, title = 'Erreur') {
            showModal(title, message, 'error');
        }
        
        /**
         * Show success modal
         * @param {string} message - Success message
         * @param {string} title - Optional custom title (default: 'Succ√®s')
         * @param {number} autoClose - Auto-close delay in ms (default: 3000)
         */
        function showSuccessModal(message, title = 'Succ√®s', autoClose = 3000) {
            showModal(title, message, 'success', autoClose);
        }
        
        /**
         * Show warning modal
         * @param {string} message - Warning message
         * @param {string} title - Optional custom title (default: 'Attention')
         */
        function showWarningModal(message, title = 'Attention') {
            showModal(title, message, 'warning');
        }
        
        /**
         * Show info modal
         * @param {string} message - Info message
         * @param {string} title - Optional custom title (default: 'Information')
         */
        function showInfoModal(message, title = 'Information') {
            showModal(title, message, 'info');
        }
        
        // Make modal functions globally accessible for common.js
        if (typeof window !== 'undefined') {
            window.showErrorModal = showErrorModal;
            window.showWarningModal = showWarningModal;
            window.showSuccessModal = showSuccessModal;
            window.showInfoModal = showInfoModal;
            window.showModal = showModal;
        }
        
        // ========================================
        // LUNAR CALENDAR FUNCTIONS
        // ========================================
        
        // Calculate moon's declination to determine ascending/descending
        // The lunar cycle for declination is approximately 27.3 days (draconic month)
        function getMoonDeclination(julianDay) {
            // Simplified calculation: Moon's declination oscillates roughly between -28.5¬∞ and +28.5¬∞
            // Using a sine wave approximation with period ~27.3 days
            const DRACONIC_MONTH = 27.321582; // days
            const MAX_DECLINATION = 28.5; // degrees
            
            // Reference date: January 1, 2000, 12:00 UTC (JD 2451545.0)
            const REFERENCE_JD = 2451545.0;
            const daysSinceRef = julianDay - REFERENCE_JD;
            
            // Calculate phase in the draconic cycle
            const phase = (2 * Math.PI * daysSinceRef) / DRACONIC_MONTH;
            
            // Declination oscillates like a sine wave
            const declination = MAX_DECLINATION * Math.sin(phase);
            
            return {
                declination: declination,
                phase: phase,
                isAscending: Math.cos(phase) > 0 // ascending when derivative is positive
            };
        }
        
        // Convert date to Julian Day
        function toJulianDay(date) {
            const time = date.getTime();
            return (time / 86400000) + 2440587.5;
        }
        
        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }
        
        // Initialize lunar calendar
        function initializeLunarCalendar() {
            const today = new Date();
            const todayJD = toJulianDay(today);
            const todayMoon = getMoonDeclination(todayJD);
            
            // Update status indicator
            const statusIndicator = document.getElementById('lunar-status-indicator');
            const statusText = document.getElementById('lunar-status-text');
            
            const isMontante = todayMoon.isAscending;
            const statusClass = isMontante ? 'montante' : 'descendante';
            const statusLabel = isMontante ? 'Lune Montante ‚Üë' : 'Lune Descendante ‚Üì';
            const statusDescription = isMontante 
                ? 'La s√®ve monte dans les parties a√©riennes' 
                : 'La s√®ve redescend vers les racines';
            
            statusIndicator.className = `lunar-status-indicator ${statusClass}`;
            statusText.innerHTML = `
                <strong>${statusLabel}</strong><br>
                <small style="font-size: 0.75em; opacity: 0.8;">${statusDescription}</small>
            `;
            
            // Build timeline for next 28 days
            buildLunarTimeline(today);
        }
        
        // Build lunar timeline
        function buildLunarTimeline(startDate) {
            const timelineBar = document.getElementById('lunar-timeline-bar');
            timelineBar.innerHTML = '';
            
            const days = 28;
            const today = new Date(startDate);
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateJD = toJulianDay(date);
                const moonData = getMoonDeclination(dateJD);
                
                const periodDiv = document.createElement('div');
                periodDiv.className = `lunar-period ${moonData.isAscending ? 'montante' : 'descendante'}`;
                
                // Mark today
                if (i === 0) {
                    periodDiv.classList.add('today');
                }
                
                // Check if we're near the end of a phase (optimal periods)
                let isOptimal = false;
                let optimalAction = '';
                
                // Check tomorrow's phase to detect phase transitions
                const tomorrowDate = new Date(date);
                tomorrowDate.setDate(date.getDate() + 1);
                const tomorrowJD = toJulianDay(tomorrowDate);
                const tomorrowMoon = getMoonDeclination(tomorrowJD);
                
                // End of ascending phase (last 2-3 days) - optimal for fruit pruning
                if (moonData.isAscending && !tomorrowMoon.isAscending) {
                    isOptimal = true;
                    optimalAction = 'üçé Taille fruits';
                }
                // Last days of ascending (check if we're near transition)
                else if (moonData.isAscending) {
                    // Check 2 days ahead
                    const dayAfterTomorrow = new Date(date);
                    dayAfterTomorrow.setDate(date.getDate() + 2);
                    const dayAfterTomorrowJD = toJulianDay(dayAfterTomorrow);
                    const dayAfterTomorrowMoon = getMoonDeclination(dayAfterTomorrowJD);
                    
                    if (!dayAfterTomorrowMoon.isAscending) {
                        isOptimal = true;
                        optimalAction = 'üçé Taille fruits';
                    }
                }
                
                // End of descending phase (last 2-3 days) - optimal for construction wood
                // Only check if not already optimal for fruit pruning
                if (!isOptimal && !moonData.isAscending && tomorrowMoon.isAscending) {
                    isOptimal = true;
                    optimalAction = 'ü™µ Coupe bois';
                }
                // Last days of descending (check if we're near transition)
                else if (!isOptimal && !moonData.isAscending) {
                    // Check 2 days ahead
                    const dayAfterTomorrow = new Date(date);
                    dayAfterTomorrow.setDate(date.getDate() + 2);
                    const dayAfterTomorrowJD = toJulianDay(dayAfterTomorrow);
                    const dayAfterTomorrowMoon = getMoonDeclination(dayAfterTomorrowJD);
                    
                    if (dayAfterTomorrowMoon.isAscending) {
                        isOptimal = true;
                        optimalAction = 'ü™µ Coupe bois';
                    }
                }
                
                if (isOptimal) {
                    periodDiv.classList.add('optimal');
                }
                
                // Add content
                const dayLabel = document.createElement('div');
                dayLabel.className = 'lunar-day-label';
                dayLabel.textContent = i === 0 ? 'Auj' : formatDate(date).split(' ')[0];
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'lunar-action-icon';
                if (isOptimal) {
                    iconDiv.innerHTML = moonData.isAscending ? 'üçé' : 'ü™µ';
                } else {
                    iconDiv.innerHTML = moonData.isAscending ? '‚Üë' : '‚Üì';
                }
                
                // Tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'lunar-tooltip';
                let tooltipText = `${formatDate(date)}<br>`;
                tooltipText += moonData.isAscending ? 'Lune Montante ‚Üë' : 'Lune Descendante ‚Üì';
                if (isOptimal) {
                    tooltipText += `<br><strong>${optimalAction}</strong>`;
                }
                if (moonData.isAscending) {
                    tooltipText += '<br>‚úì Semis, plantations, greffes';
                } else {
                    tooltipText += '<br>‚úì Plantation, repiquage, tailles';
                }
                tooltip.innerHTML = tooltipText;
                
                periodDiv.appendChild(tooltip);
                periodDiv.appendChild(dayLabel);
                periodDiv.appendChild(iconDiv);
                
                timelineBar.appendChild(periodDiv);
            }
        }
        
        // ========================================
        // CALENDAR FUNCTIONS (Keep from original)
        // ========================================
        // Calendar functions are in common.js - use them if available
        // Otherwise use placeholder

        function generateICalFile() {
            // Generate iCal file for lunar calendar
            showInfoModal(
                'L\'export du calendrier lunaire au format iCal sera bient√¥t disponible.<br><br>Cette fonctionnalit√© permettra d\'importer le calendrier dans votre application de calendrier pr√©f√©r√©e.',
                'Fonctionnalit√© √† venir'
            );
        }
        
        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function openLightbox(imageUrl) {
            // Simple modal for image viewing
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content bg-dark">
                        <div class="modal-header">
                            <h5 class="modal-title">Image</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageUrl}" class="img-fluid" alt="Plant observation">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
        
        // Unified map controls - update position from inputs
        document.getElementById('update-map')?.addEventListener('click', function() {
            const lat = parseFloat(document.getElementById('lat-display')?.value);
            const lon = parseFloat(document.getElementById('lon-display')?.value);
            if (unifiedMap && lat && lon && !isNaN(lat) && !isNaN(lon)) {
                unifiedMap.setView([lat, lon], 13);
                currentLocation = { latitude: lat, longitude: lon };
                updateUserPositionMarker(lat, lon);
            }
        });
        
        // Get current location using geolocation API
        document.getElementById('get-location')?.addEventListener('click', function() {
            if (navigator.geolocation) {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Localisation...';
                
                navigator.geolocation.getCurrentPosition((position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    const latInput = document.getElementById('lat-display');
                    const lonInput = document.getElementById('lon-display');
                    if (latInput) latInput.value = currentLocation.latitude.toFixed(6);
                    if (lonInput) lonInput.value = currentLocation.longitude.toFixed(6);
                    
                    // Initialize map if not already done
                    if (!unifiedMap) {
                        const mapEl = document.getElementById('unified-map');
                        if (mapEl) {
                            initializeUnifiedMap();
                        }
                    }
                    
                    // Update position marker if map exists
                    if (unifiedMap) {
                        unifiedMap.setView([currentLocation.latitude, currentLocation.longitude], 13);
                        updateUserPositionMarker(currentLocation.latitude, currentLocation.longitude);
                    }
                    
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, (error) => {
                    console.error('Geolocation error:', error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    showErrorModal(
                        'Impossible d\'obtenir votre position g√©ographique.<br><br>' +
                        'V√©rifiez que :<br>' +
                        '‚Ä¢ La g√©olocalisation est activ√©e dans les param√®tres de votre navigateur<br>' +
                        '‚Ä¢ Vous avez autoris√© l\'acc√®s √† votre position pour ce site<br>' +
                        '‚Ä¢ Votre appareil/GPS est activ√©',
                        'Erreur de g√©olocalisation'
                    );
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                } else {
                showWarningModal(
                    'La g√©olocalisation n\'est pas support√©e par votre navigateur.<br><br>Vous pouvez toujours saisir manuellement vos coordonn√©es dans les champs Latitude/Longitude.',
                    'G√©olocalisation non support√©e'
                );
            }
        });
        
        // Unified map controls - from map buttons
        document.getElementById('map-get-location')?.addEventListener('click', function() {
            document.getElementById('get-location')?.click();
        });
        
        document.getElementById('map-load-events')?.addEventListener('click', function() {
            if (unifiedMap) {
                loadMapEvents();
                } else {
                initializeUnifiedMap();
                }
        });
        
        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            const yearEl = document.getElementById('current-year');
            if (yearEl) yearEl.textContent = new Date().getFullYear();
            
            // Initialize lunar calendar in header
            initializeLunarCalendar();
            
            // Setup lunar calendar collapse toggle
            const lunarCollapse = document.getElementById('lunar-calendar-collapse');
            const lunarToggle = document.getElementById('lunar-calendar-toggle');
            const lunarHeader = document.getElementById('lunar-calendar-header');
            if (lunarCollapse && lunarToggle && lunarHeader) {
                lunarCollapse.addEventListener('show.bs.collapse', function() {
                    lunarToggle.innerHTML = '<i class="bi bi-chevron-up"></i> Masquer';
                    lunarHeader.style.padding = '10px 0';
                });
                lunarCollapse.addEventListener('hide.bs.collapse', function() {
                    lunarToggle.innerHTML = '<i class="bi bi-chevron-down"></i> Afficher';
                    lunarHeader.style.padding = '4px 0';
                });
                // Set initial padding based on current state
                if (!lunarCollapse.classList.contains('show')) {
                    lunarHeader.style.padding = '4px 0';
                }
            }
            
            // Calendar - call from common.js if available
            if (typeof calculateLunarCalendar === 'function') {
                calculateLunarCalendar();
            } else {
                const container = document.getElementById('calendar-table-container');
                if (container) {
                    container.innerHTML = `<p class="text-muted">Calendrier lunaire pour ${new Date().getFullYear()}</p>`;
                }
            }
            
            // Check if user is already connected (from common.js)
            // Wait a bit for common.js to initialize
            setTimeout(() => {
                const currentUserPubkey = getUserPubkey();
                const currentIsConnected = getIsNostrConnected();
                if (currentUserPubkey && currentIsConnected) {
                    updateNostrUI(true);
                } else {
                    updateNostrUI(false);
                }
            }, 500);
            
            // Initialize gallery (loads public observations even if not connected)
            if (getUserPubkey()) {
                loadUserStats();
            } else {
                loadPublicGallery();
            }
            
            // Initialize USPOT API detection if available
            if (typeof detectUSPOTAPI === 'function') {
                detectUSPOTAPI();
            }
            
            // Initialize mini map if location is available
            if (navigator.geolocation && typeof L !== 'undefined') {
                navigator.geolocation.getCurrentPosition((position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    const latInput = document.getElementById('lat-display');
                    const lonInput = document.getElementById('lon-display');
                    if (latInput) latInput.value = currentLocation.latitude.toFixed(2);
                    if (lonInput) lonInput.value = currentLocation.longitude.toFixed(2);
                    
                    // Initialize unified map if not already done
                    if (!unifiedMap) {
                        const mapEl = document.getElementById('unified-map');
                        if (mapEl) {
                            initializeUnifiedMap();
                        }
                    }
                    
                    // Update position marker if map exists
                    if (unifiedMap) {
                        unifiedMap.setView([currentLocation.latitude, currentLocation.longitude], 13);
                        updateUserPositionMarker(currentLocation.latitude, currentLocation.longitude);
                    }
                }, (error) => {
                    console.error('Geolocation error:', error);
                    showErrorModal(
                        'Impossible d\'obtenir votre position g√©ographique.<br><br>V√©rifiez que la g√©olocalisation est activ√©e dans les param√®tres de votre navigateur.',
                        'Erreur de g√©olocalisation'
                    );
                });
            }
            
            // Initialize unified map on page load (since it's expanded by default)
            setTimeout(() => {
                const mapContainer = document.getElementById('ore-map-container');
                if (mapContainer && mapContainer.style.display !== 'none') {
                    initializeUnifiedMap();
                }
            }, 1000);
            
            // Update active nav on initial load
            updateActiveNavItem();
            
            // Check Nostr extension availability
            setTimeout(() => {
                const navMenuConnect = document.getElementById('nav-menu-connect');
                if (navMenuConnect) {
                    if (typeof window.nostr === 'undefined' || typeof window.nostr.getPublicKey !== 'function') {
                        navMenuConnect.disabled = true;
                        navMenuConnect.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Extension requise';
                        navMenuConnect.className = 'btn btn-outline-secondary me-2';
                    }
                }
            }, 1000);
        });
    </script>
</body>
</html>


